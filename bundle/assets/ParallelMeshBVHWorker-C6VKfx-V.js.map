{"version":3,"file":"ParallelMeshBVHWorker-C6VKfx-V.js","sources":["../../node_modules/three-mesh-bvh/src/workers/ParallelMeshBVHWorker.js"],"sourcesContent":["import { Box3, BufferAttribute } from 'three';\nimport { MeshBVH } from '../core/MeshBVH.js';\nimport { WorkerBase } from './utils/WorkerBase.js';\nimport { convertToBufferType, isSharedArrayBufferSupported } from '../utils/BufferUtils.js';\nimport { GenerateMeshBVHWorker } from './GenerateMeshBVHWorker.js';\nimport { ensureIndex } from '../core/build/geometryUtils.js';\n\nconst DEFAULT_WORKER_COUNT = typeof navigator !== 'undefined' ? navigator.hardwareConcurrency : 4;\nclass _ParallelMeshBVHWorker extends WorkerBase {\n\n\tconstructor() {\n\n\t\tconst worker = new Worker( new URL( './parallelMeshBVH.worker.js', import.meta.url ), { type: 'module' } );\n\t\tsuper( worker );\n\n\t\tthis.name = 'ParallelMeshBVHWorker';\n\t\tthis.maxWorkerCount = Math.max( DEFAULT_WORKER_COUNT, 4 );\n\n\t\tif ( ! isSharedArrayBufferSupported() ) {\n\n\t\t\tthrow new Error( 'ParallelMeshBVHWorker: Shared Array Buffers are not supported.' );\n\n\t\t}\n\n\t}\n\n\trunTask( worker, geometry, options = {} ) {\n\n\t\treturn new Promise( ( resolve, reject ) => {\n\n\t\t\tif ( ! options.indirect ) {\n\n\t\t\t\tensureIndex( geometry, options );\n\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tgeometry.getAttribute( 'position' ).isInterleavedBufferAttribute ||\n\t\t\t\tgeometry.index && geometry.index.isInterleavedBufferAttribute\n\t\t\t) {\n\n\t\t\t\tthrow new Error( 'ParallelMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.' );\n\n\t\t\t}\n\n\t\t\tworker.onerror = e => {\n\n\t\t\t\treject( new Error( `ParallelMeshBVHWorker: ${ e.message }` ) );\n\n\t\t\t};\n\n\t\t\tworker.onmessage = e => {\n\n\t\t\t\tconst { data } = e;\n\n\t\t\t\tif ( data.error ) {\n\n\t\t\t\t\treject( new Error( data.error ) );\n\t\t\t\t\tworker.onmessage = null;\n\n\t\t\t\t} else if ( data.serialized ) {\n\n\t\t\t\t\tconst { serialized, position } = data;\n\t\t\t\t\tconst bvh = MeshBVH.deserialize( serialized, geometry, { setIndex: false } );\n\t\t\t\t\tconst boundsOptions = {\n\t\t\t\t\t\tsetBoundingBox: true,\n\t\t\t\t\t\t...options,\n\t\t\t\t\t};\n\n\t\t\t\t\t// we need to replace the arrays because they're neutered entirely by the\n\t\t\t\t\t// webworker transfer.\n\t\t\t\t\tgeometry.attributes.position.array = position;\n\t\t\t\t\tif ( serialized.index ) {\n\n\t\t\t\t\t\tif ( geometry.index ) {\n\n\t\t\t\t\t\t\tgeometry.index.array = serialized.index;\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tconst newIndex = new BufferAttribute( serialized.index, 1, false );\n\t\t\t\t\t\t\tgeometry.setIndex( newIndex );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( boundsOptions.setBoundingBox ) {\n\n\t\t\t\t\t\tgeometry.boundingBox = bvh.getBoundingBox( new Box3() );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( options.onProgress ) {\n\n\t\t\t\t\t\toptions.onProgress( data.progress );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve( bvh );\n\t\t\t\t\tworker.onmessage = null;\n\n\t\t\t\t} else if ( options.onProgress ) {\n\n\t\t\t\t\toptions.onProgress( data.progress );\n\n\t\t\t\t}\n\n\t\t\t};\n\n\t\t\tconst index = geometry.index ? geometry.index.array : null;\n\t\t\tconst position = geometry.attributes.position.array;\n\t\t\tworker.postMessage( {\n\n\t\t\t\toperation: 'BUILD_BVH',\n\t\t\t\tmaxWorkerCount: this.maxWorkerCount,\n\t\t\t\tindex: convertToBufferType( index, SharedArrayBuffer ),\n\t\t\t\tposition: convertToBufferType( position, SharedArrayBuffer ),\n\t\t\t\toptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\tonProgress: null,\n\t\t\t\t\tincludedProgressCallback: Boolean( options.onProgress ),\n\t\t\t\t\tgroups: [ ...geometry.groups ],\n\t\t\t\t},\n\n\t\t\t} );\n\n\t\t} );\n\n\t}\n\n}\n\nexport class ParallelMeshBVHWorker {\n\n\tconstructor() {\n\n\t\tif ( isSharedArrayBufferSupported() ) {\n\n\t\t\treturn new _ParallelMeshBVHWorker();\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'ParallelMeshBVHWorker: SharedArrayBuffers not supported. Falling back to single-threaded GenerateMeshBVHWorker.' );\n\n\t\t\tconst object = new GenerateMeshBVHWorker();\n\t\t\tobject.maxWorkerCount = DEFAULT_WORKER_COUNT;\n\t\t\treturn object;\n\n\t\t}\n\n\t}\n\n}\n"],"names":["DEFAULT_WORKER_COUNT","_ParallelMeshBVHWorker","WorkerBase","worker","isSharedArrayBufferSupported","geometry","options","resolve","reject","ensureIndex","e","data","serialized","position","bvh","MeshBVH","boundsOptions","newIndex","BufferAttribute","Box3","index","convertToBufferType","ParallelMeshBVHWorker","object","GenerateMeshBVHWorker"],"mappings":"qLAOA,MAAMA,EAAuB,OAAO,UAAc,IAAc,UAAU,oBAAsB,EAChG,MAAMC,UAA+BC,CAAW,CAE/C,aAAc,CAEb,MAAMC,EAAS,IAAI,OAAQ,IAAA,IAAA,GAAA,IAAA,IAAA,qCAAA,YAAA,GAAA,EAAA,KAAA,YAAA,GAAA,EAA2D,CAAE,KAAM,QAAQ,CAAE,EAMxG,GALA,MAAOA,CAAM,EAEb,KAAK,KAAO,wBACZ,KAAK,eAAiB,KAAK,IAAKH,EAAsB,CAAC,EAElD,CAAEI,EAA4B,EAElC,MAAM,IAAI,MAAO,gEAAgE,CAInF,CAEA,QAASD,EAAQE,EAAUC,EAAU,CAAA,EAAK,CAEzC,OAAO,IAAI,QAAS,CAAEC,EAASC,IAAY,CAQ1C,GANOF,EAAQ,UAEdG,EAAaJ,EAAUC,CAAO,EAK9BD,EAAS,aAAc,UAAU,EAAG,8BACpCA,EAAS,OAASA,EAAS,MAAM,6BAGjC,MAAM,IAAI,MAAO,kGAAkG,EAIpHF,EAAO,QAAUO,GAAK,CAErBF,EAAQ,IAAI,MAAO,0BAA2BE,EAAE,OAAO,GAAK,CAE7D,EAEAP,EAAO,UAAYO,GAAK,CAEvB,KAAM,CAAE,KAAAC,CAAI,EAAKD,EAEjB,GAAKC,EAAK,MAETH,EAAQ,IAAI,MAAOG,EAAK,KAAK,CAAE,EAC/BR,EAAO,UAAY,aAERQ,EAAK,WAAa,CAE7B,KAAM,CAAE,WAAAC,EAAY,SAAAC,CAAQ,EAAKF,EAC3BG,EAAMC,EAAQ,YAAaH,EAAYP,EAAU,CAAE,SAAU,GAAO,EACpEW,EAAgB,CACrB,eAAgB,GAChB,GAAGV,CACT,EAKK,GADAD,EAAS,WAAW,SAAS,MAAQQ,EAChCD,EAAW,MAEf,GAAKP,EAAS,MAEbA,EAAS,MAAM,MAAQO,EAAW,UAE5B,CAEN,MAAMK,EAAW,IAAIC,EAAiBN,EAAW,MAAO,EAAG,EAAK,EAChEP,EAAS,SAAUY,CAAQ,CAE5B,CAIID,EAAc,iBAElBX,EAAS,YAAcS,EAAI,eAAgB,IAAIK,CAAM,GAIjDb,EAAQ,YAEZA,EAAQ,WAAYK,EAAK,QAAQ,EAIlCJ,EAASO,CAAG,EACZX,EAAO,UAAY,IAEpB,MAAYG,EAAQ,YAEnBA,EAAQ,WAAYK,EAAK,QAAQ,CAInC,EAEA,MAAMS,EAAQf,EAAS,MAAQA,EAAS,MAAM,MAAQ,KAChDQ,EAAWR,EAAS,WAAW,SAAS,MAC9CF,EAAO,YAAa,CAEnB,UAAW,YACX,eAAgB,KAAK,eACrB,MAAOkB,EAAqBD,EAAO,iBAAiB,EACpD,SAAUC,EAAqBR,EAAU,iBAAiB,EAC1D,QAAS,CACR,GAAGP,EACH,WAAY,KACZ,yBAA0B,EAASA,EAAQ,WAC3C,OAAQ,CAAE,GAAGD,EAAS,MAAM,CACjC,CAEA,CAAI,CAEF,CAAC,CAEF,CAED,CAEO,MAAMiB,CAAsB,CAElC,aAAc,CAEb,GAAKlB,EAA4B,EAEhC,OAAO,IAAIH,EAEL,CAEN,QAAQ,KAAM,iHAAiH,EAE/H,MAAMsB,EAAS,IAAIC,EACnB,OAAAD,EAAO,eAAiBvB,EACjBuB,CAER,CAED,CAED","x_google_ignoreList":[0]}