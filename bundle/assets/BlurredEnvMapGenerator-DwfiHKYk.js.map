{"version":3,"file":"BlurredEnvMapGenerator-DwfiHKYk.js","sources":["../../src/utils/BlurredEnvMapGenerator.js"],"sourcesContent":["import { WebGLRenderTarget, RGBAFormat, HalfFloatType, PMREMGenerator, DataTexture, EquirectangularReflectionMapping, FloatType, DataUtils } from 'three';\r\nimport { FullScreenQuad } from 'three/examples/jsm/postprocessing/Pass.js';\r\nimport { MaterialBase } from '../materials/MaterialBase.js';\r\nimport * as CommonGLSL from '../shader/common/index.js';\r\n\r\nclass PMREMCopyMaterial extends MaterialBase {\r\n\r\n\tconstructor() {\r\n\r\n\t\tsuper( {\r\n\r\n\t\t\tuniforms: {\r\n\r\n\t\t\t\tenvMap: { value: null },\r\n\t\t\t\tblur: { value: 0 },\r\n\r\n\t\t\t},\r\n\r\n\t\t\tvertexShader: /* glsl */`\r\n\r\n\t\t\t\tvarying vec2 vUv;\r\n\t\t\t\tvoid main() {\r\n\t\t\t\t\tvUv = uv;\r\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\r\n\t\t\t\t}\r\n\r\n\t\t\t`,\r\n\r\n\t\t\tfragmentShader: /* glsl */`\r\n\r\n\t\t\t\t#include <common>\r\n\t\t\t\t#include <cube_uv_reflection_fragment>\r\n\r\n\t\t\t\t${ CommonGLSL.util_functions }\r\n\r\n\t\t\t\tuniform sampler2D envMap;\r\n\t\t\t\tuniform float blur;\r\n\t\t\t\tvarying vec2 vUv;\r\n\t\t\t\tvoid main() {\r\n\r\n\t\t\t\t\tvec3 rayDirection = equirectUvToDirection( vUv );\r\n\t\t\t\t\tgl_FragColor = textureCubeUV( envMap, rayDirection, blur );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t`,\r\n\r\n\t\t} );\r\n\r\n\t}\r\n\r\n}\r\n\r\nexport class BlurredEnvMapGenerator {\r\n\r\n\tconstructor( renderer ) {\r\n\r\n\t\tthis.renderer = renderer;\r\n\t\tthis.pmremGenerator = new PMREMGenerator( renderer );\r\n\t\tthis.copyQuad = new FullScreenQuad( new PMREMCopyMaterial() );\r\n\t\tthis.renderTarget = new WebGLRenderTarget( 1, 1, { type: FloatType, format: RGBAFormat } );\r\n\r\n\t}\r\n\r\n\tdispose() {\r\n\r\n\t\tthis.pmremGenerator.dispose();\r\n\t\tthis.copyQuad.dispose();\r\n\t\tthis.renderTarget.dispose();\r\n\r\n\t}\r\n\r\n\tgenerate( texture, blur ) {\r\n\r\n\t\tconst { pmremGenerator, renderTarget, copyQuad, renderer } = this;\r\n\r\n\t\t// get the pmrem target\r\n\t\tconst pmremTarget = pmremGenerator.fromEquirectangular( texture );\r\n\r\n\t\t// set up the material\r\n\t\tconst { width, height } = texture.image;\r\n\t\trenderTarget.setSize( width, height );\r\n\t\tcopyQuad.material.envMap = pmremTarget.texture;\r\n\t\tcopyQuad.material.blur = blur;\r\n\r\n\t\t// render\r\n\t\tconst prevRenderTarget = renderer.getRenderTarget();\r\n\t\tconst prevClear = renderer.autoClear;\r\n\r\n\t\trenderer.setRenderTarget( renderTarget );\r\n\t\trenderer.autoClear = true;\r\n\t\tcopyQuad.render( renderer );\r\n\r\n\t\trenderer.setRenderTarget( prevRenderTarget );\r\n\t\trenderer.autoClear = prevClear;\r\n\r\n\t\t// read the data back\r\n\t\tconst buffer = new Uint16Array( width * height * 4 );\r\n\t\tconst readBuffer = new Float32Array( width * height * 4 );\r\n\t\trenderer.readRenderTargetPixels( renderTarget, 0, 0, width, height, readBuffer );\r\n\r\n\t\tfor ( let i = 0, l = readBuffer.length; i < l; i ++ ) {\r\n\r\n\t\t\tbuffer[ i ] = DataUtils.toHalfFloat( readBuffer[ i ] );\r\n\r\n\t\t}\r\n\r\n\t\tconst result = new DataTexture( buffer, width, height, RGBAFormat, HalfFloatType );\r\n\t\tresult.minFilter = texture.minFilter;\r\n\t\tresult.magFilter = texture.magFilter;\r\n\t\tresult.wrapS = texture.wrapS;\r\n\t\tresult.wrapT = texture.wrapT;\r\n\t\tresult.mapping = EquirectangularReflectionMapping;\r\n\t\tresult.needsUpdate = true;\r\n\r\n\t\t// dispose of the now unneeded target\r\n\t\tpmremTarget.dispose();\r\n\r\n\t\treturn result;\r\n\r\n\t}\r\n\r\n}\r\n"],"names":["PMREMCopyMaterial","MaterialBase","CommonGLSL.util_functions","BlurredEnvMapGenerator","renderer","PMREMGenerator","FullScreenQuad","WebGLRenderTarget","FloatType","RGBAFormat","texture","blur","pmremGenerator","renderTarget","copyQuad","pmremTarget","width","height","prevRenderTarget","prevClear","buffer","readBuffer","i","l","DataUtils","result","DataTexture","HalfFloatType","EquirectangularReflectionMapping"],"mappings":"uMAKA,MAAMA,UAA0BC,CAAa,CAE5C,aAAc,CAEb,MAAO,CAEN,SAAU,CAET,OAAQ,CAAE,MAAO,IAAI,EACrB,KAAM,CAAE,MAAO,CAAC,CAEpB,EAEG,aAAwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAUxB,eAA0B;AAAA;AAAA;AAAA;AAAA;AAAA,MAKtBC,CAAyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAchC,EAEC,CAED,CAEO,MAAMC,CAAuB,CAEnC,YAAaC,EAAW,CAEvB,KAAK,SAAWA,EAChB,KAAK,eAAiB,IAAIC,EAAgBD,CAAQ,EAClD,KAAK,SAAW,IAAIE,EAAgB,IAAIN,CAAmB,EAC3D,KAAK,aAAe,IAAIO,EAAmB,EAAG,EAAG,CAAE,KAAMC,EAAW,OAAQC,CAAU,CAAE,CAEzF,CAEA,SAAU,CAET,KAAK,eAAe,UACpB,KAAK,SAAS,UACd,KAAK,aAAa,SAEnB,CAEA,SAAUC,EAASC,EAAO,CAEzB,KAAM,CAAE,eAAAC,EAAgB,aAAAC,EAAc,SAAAC,EAAU,SAAAV,CAAQ,EAAK,KAGvDW,EAAcH,EAAe,oBAAqBF,CAAO,EAGzD,CAAE,MAAAM,EAAO,OAAAC,GAAWP,EAAQ,MAClCG,EAAa,QAASG,EAAOC,GAC7BH,EAAS,SAAS,OAASC,EAAY,QACvCD,EAAS,SAAS,KAAOH,EAGzB,MAAMO,EAAmBd,EAAS,kBAC5Be,EAAYf,EAAS,UAE3BA,EAAS,gBAAiBS,GAC1BT,EAAS,UAAY,GACrBU,EAAS,OAAQV,GAEjBA,EAAS,gBAAiBc,GAC1Bd,EAAS,UAAYe,EAGrB,MAAMC,EAAS,IAAI,YAAaJ,EAAQC,EAAS,CAAC,EAC5CI,EAAa,IAAI,aAAcL,EAAQC,EAAS,CAAC,EACvDb,EAAS,uBAAwBS,EAAc,EAAG,EAAGG,EAAOC,EAAQI,GAEpE,QAAUC,EAAI,EAAGC,EAAIF,EAAW,OAAQC,EAAIC,EAAGD,IAE9CF,EAAQE,CAAC,EAAKE,EAAU,YAAaH,EAAYC,CAAC,GAInD,MAAMG,EAAS,IAAIC,EAAaN,EAAQJ,EAAOC,EAAQR,EAAYkB,GACnE,OAAAF,EAAO,UAAYf,EAAQ,UAC3Be,EAAO,UAAYf,EAAQ,UAC3Be,EAAO,MAAQf,EAAQ,MACvBe,EAAO,MAAQf,EAAQ,MACvBe,EAAO,QAAUG,EACjBH,EAAO,YAAc,GAGrBV,EAAY,QAAO,EAEZU,CAER,CAED"}