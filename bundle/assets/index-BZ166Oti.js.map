{"version":3,"file":"index-BZ166Oti.js","sources":["../../node_modules/three/examples/jsm/loaders/TGALoader.js","../../node_modules/three/examples/jsm/loaders/ColladaLoader.js","../../node_modules/three/examples/jsm/materials/LDrawConditionalLineMaterial.js","../../example/ImageRenderModal.js","../../example/index.js"],"sourcesContent":["import {\n\tDataTextureLoader,\n\tLinearMipmapLinearFilter\n} from 'three';\n\n/**\n * A loader for the TGA texture format.\n *\n * ```js\n * const loader = new TGALoader();\n * const texture = await loader.loadAsync( 'textures/crate_color8.tga' );\n * texture.colorSpace = THREE.SRGBColorSpace; // only for color textures\n * ```\n *\n * @augments DataTextureLoader\n * @three_import import { TGALoader } from 'three/addons/loaders/TGALoader.js';\n */\nclass TGALoader extends DataTextureLoader {\n\n\t/**\n\t * Constructs a new TGA loader.\n\t *\n\t * @param {LoadingManager} [manager] - The loading manager.\n\t */\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t}\n\n\t/**\n\t * Parses the given TGA texture data.\n\t *\n\t * @param {ArrayBuffer} buffer - The raw texture data.\n\t * @return {DataTextureLoader~TexData} An object representing the parsed texture data.\n\t */\n\tparse( buffer ) {\n\n\t\t// reference from vthibault, https://github.com/vthibault/roBrowser/blob/master/src/Loaders/Targa.js\n\n\t\tfunction tgaCheckHeader( header ) {\n\n\t\t\tswitch ( header.image_type ) {\n\n\t\t\t\t// check indexed type\n\n\t\t\t\tcase TGA_TYPE_INDEXED:\n\t\t\t\tcase TGA_TYPE_RLE_INDEXED:\n\t\t\t\t\tif ( header.colormap_length > 256 || header.colormap_size !== 24 || header.colormap_type !== 1 ) {\n\n\t\t\t\t\t\tthrow new Error( 'THREE.TGALoader: Invalid type colormap data for indexed type.' );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\n\t\t\t\t\t// check colormap type\n\n\t\t\t\tcase TGA_TYPE_RGB:\n\t\t\t\tcase TGA_TYPE_GREY:\n\t\t\t\tcase TGA_TYPE_RLE_RGB:\n\t\t\t\tcase TGA_TYPE_RLE_GREY:\n\t\t\t\t\tif ( header.colormap_type ) {\n\n\t\t\t\t\t\tthrow new Error( 'THREE.TGALoader: Invalid type colormap data for colormap type.' );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\n\t\t\t\t\t// What the need of a file without data ?\n\n\t\t\t\tcase TGA_TYPE_NO_DATA:\n\t\t\t\t\tthrow new Error( 'THREE.TGALoader: No data.' );\n\n\t\t\t\t\t// Invalid type ?\n\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error( 'THREE.TGALoader: Invalid type ' + header.image_type );\n\n\t\t\t}\n\n\t\t\t// check image width and height\n\n\t\t\tif ( header.width <= 0 || header.height <= 0 ) {\n\n\t\t\t\tthrow new Error( 'THREE.TGALoader: Invalid image size.' );\n\n\t\t\t}\n\n\t\t\t// check image pixel size\n\n\t\t\tif ( header.pixel_size !== 8 && header.pixel_size !== 16 &&\n\t\t\t\theader.pixel_size !== 24 && header.pixel_size !== 32 ) {\n\n\t\t\t\tthrow new Error( 'THREE.TGALoader: Invalid pixel size ' + header.pixel_size );\n\n\t\t\t}\n\n\t\t}\n\n\t\t// parse tga image buffer\n\n\t\tfunction tgaParse( use_rle, use_pal, header, offset, data ) {\n\n\t\t\tlet pixel_data,\n\t\t\t\tpalettes;\n\n\t\t\tconst pixel_size = header.pixel_size >> 3;\n\t\t\tconst pixel_total = header.width * header.height * pixel_size;\n\n\t\t\t // read palettes\n\n\t\t\t if ( use_pal ) {\n\n\t\t\t\t palettes = data.subarray( offset, offset += header.colormap_length * ( header.colormap_size >> 3 ) );\n\n\t\t\t }\n\n\t\t\t // read RLE\n\n\t\t\t if ( use_rle ) {\n\n\t\t\t\t pixel_data = new Uint8Array( pixel_total );\n\n\t\t\t\tlet c, count, i;\n\t\t\t\tlet shift = 0;\n\t\t\t\tconst pixels = new Uint8Array( pixel_size );\n\n\t\t\t\twhile ( shift < pixel_total ) {\n\n\t\t\t\t\tc = data[ offset ++ ];\n\t\t\t\t\tcount = ( c & 0x7f ) + 1;\n\n\t\t\t\t\t// RLE pixels\n\n\t\t\t\t\tif ( c & 0x80 ) {\n\n\t\t\t\t\t\t// bind pixel tmp array\n\n\t\t\t\t\t\tfor ( i = 0; i < pixel_size; ++ i ) {\n\n\t\t\t\t\t\t\tpixels[ i ] = data[ offset ++ ];\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// copy pixel array\n\n\t\t\t\t\t\tfor ( i = 0; i < count; ++ i ) {\n\n\t\t\t\t\t\t\tpixel_data.set( pixels, shift + i * pixel_size );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tshift += pixel_size * count;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\t// raw pixels\n\n\t\t\t\t\t\tcount *= pixel_size;\n\n\t\t\t\t\t\tfor ( i = 0; i < count; ++ i ) {\n\n\t\t\t\t\t\t\tpixel_data[ shift + i ] = data[ offset ++ ];\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tshift += count;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t } else {\n\n\t\t\t\t// raw pixels\n\n\t\t\t\tpixel_data = data.subarray(\n\t\t\t\t\t offset, offset += ( use_pal ? header.width * header.height : pixel_total )\n\t\t\t\t);\n\n\t\t\t }\n\n\t\t\t return {\n\t\t\t\tpixel_data: pixel_data,\n\t\t\t\tpalettes: palettes\n\t\t\t };\n\n\t\t}\n\n\t\tfunction tgaGetImageData8bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image, palettes ) {\n\n\t\t\tconst colormap = palettes;\n\t\t\tlet color, i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i ++ ) {\n\n\t\t\t\t\tcolor = image[ i ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = 255;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = colormap[ ( color * 3 ) + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = colormap[ ( color * 3 ) + 1 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = colormap[ ( color * 3 ) + 2 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageData16bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet color, i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 2 ) {\n\n\t\t\t\t\tcolor = image[ i + 0 ] + ( image[ i + 1 ] << 8 );\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = ( color & 0x7C00 ) >> 7;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = ( color & 0x03E0 ) >> 2;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = ( color & 0x001F ) << 3;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = ( color & 0x8000 ) ? 0 : 255;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageData24bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 3 ) {\n\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = 255;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = image[ i + 1 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = image[ i + 2 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageData32bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 4 ) {\n\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = image[ i + 1 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = image[ i + 2 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = image[ i + 3 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageDataGrey8bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet color, i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i ++ ) {\n\n\t\t\t\t\tcolor = image[ i ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = color;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = color;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = color;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = 255;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageDataGrey16bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 2 ) {\n\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = image[ i + 1 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction getTgaRGBA( data, width, height, image, palette ) {\n\n\t\t\tlet x_start,\n\t\t\t\ty_start,\n\t\t\t\tx_step,\n\t\t\t\ty_step,\n\t\t\t\tx_end,\n\t\t\t\ty_end;\n\n\t\t\tswitch ( ( header.flags & TGA_ORIGIN_MASK ) >> TGA_ORIGIN_SHIFT ) {\n\n\t\t\t\tdefault:\n\t\t\t\tcase TGA_ORIGIN_UL:\n\t\t\t\t\tx_start = 0;\n\t\t\t\t\tx_step = 1;\n\t\t\t\t\tx_end = width;\n\t\t\t\t\ty_start = 0;\n\t\t\t\t\ty_step = 1;\n\t\t\t\t\ty_end = height;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase TGA_ORIGIN_BL:\n\t\t\t\t\tx_start = 0;\n\t\t\t\t\tx_step = 1;\n\t\t\t\t\tx_end = width;\n\t\t\t\t\ty_start = height - 1;\n\t\t\t\t\ty_step = - 1;\n\t\t\t\t\ty_end = - 1;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase TGA_ORIGIN_UR:\n\t\t\t\t\tx_start = width - 1;\n\t\t\t\t\tx_step = - 1;\n\t\t\t\t\tx_end = - 1;\n\t\t\t\t\ty_start = 0;\n\t\t\t\t\ty_step = 1;\n\t\t\t\t\ty_end = height;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase TGA_ORIGIN_BR:\n\t\t\t\t\tx_start = width - 1;\n\t\t\t\t\tx_step = - 1;\n\t\t\t\t\tx_end = - 1;\n\t\t\t\t\ty_start = height - 1;\n\t\t\t\t\ty_step = - 1;\n\t\t\t\t\ty_end = - 1;\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tif ( use_grey ) {\n\n\t\t\t\tswitch ( header.pixel_size ) {\n\n\t\t\t\t\tcase 8:\n\t\t\t\t\t\ttgaGetImageDataGrey8bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 16:\n\t\t\t\t\t\ttgaGetImageDataGrey16bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tthrow new Error( 'THREE.TGALoader: Format not supported.' );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tswitch ( header.pixel_size ) {\n\n\t\t\t\t\tcase 8:\n\t\t\t\t\t\ttgaGetImageData8bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image, palette );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 16:\n\t\t\t\t\t\ttgaGetImageData16bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 24:\n\t\t\t\t\t\ttgaGetImageData24bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 32:\n\t\t\t\t\t\ttgaGetImageData32bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tthrow new Error( 'THREE.TGALoader: Format not supported.' );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// Load image data according to specific method\n\t\t\t// let func = 'tgaGetImageData' + (use_grey ? 'Grey' : '') + (header.pixel_size) + 'bits';\n\t\t\t// func(data, y_start, y_step, y_end, x_start, x_step, x_end, width, image, palette );\n\t\t\treturn data;\n\n\t\t}\n\n\t\t// TGA constants\n\n\t\tconst TGA_TYPE_NO_DATA = 0,\n\t\t\tTGA_TYPE_INDEXED = 1,\n\t\t\tTGA_TYPE_RGB = 2,\n\t\t\tTGA_TYPE_GREY = 3,\n\t\t\tTGA_TYPE_RLE_INDEXED = 9,\n\t\t\tTGA_TYPE_RLE_RGB = 10,\n\t\t\tTGA_TYPE_RLE_GREY = 11,\n\n\t\t\tTGA_ORIGIN_MASK = 0x30,\n\t\t\tTGA_ORIGIN_SHIFT = 0x04,\n\t\t\tTGA_ORIGIN_BL = 0x00,\n\t\t\tTGA_ORIGIN_BR = 0x01,\n\t\t\tTGA_ORIGIN_UL = 0x02,\n\t\t\tTGA_ORIGIN_UR = 0x03;\n\n\t\tif ( buffer.length < 19 ) throw new Error( 'THREE.TGALoader: Not enough data to contain header.' );\n\n\t\tlet offset = 0;\n\n\t\tconst content = new Uint8Array( buffer ),\n\t\t\theader = {\n\t\t\t\tid_length: content[ offset ++ ],\n\t\t\t\tcolormap_type: content[ offset ++ ],\n\t\t\t\timage_type: content[ offset ++ ],\n\t\t\t\tcolormap_index: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\tcolormap_length: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\tcolormap_size: content[ offset ++ ],\n\t\t\t\torigin: [\n\t\t\t\t\tcontent[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\t\tcontent[ offset ++ ] | content[ offset ++ ] << 8\n\t\t\t\t],\n\t\t\t\twidth: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\theight: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\tpixel_size: content[ offset ++ ],\n\t\t\t\tflags: content[ offset ++ ]\n\t\t\t};\n\n\t\t// check tga if it is valid format\n\n\t\ttgaCheckHeader( header );\n\n\t\tif ( header.id_length + offset > buffer.length ) {\n\n\t\t\tthrow new Error( 'THREE.TGALoader: No data.' );\n\n\t\t}\n\n\t\t// skip the needn't data\n\n\t\toffset += header.id_length;\n\n\t\t// get targa information about RLE compression and palette\n\n\t\tlet use_rle = false,\n\t\t\tuse_pal = false,\n\t\t\tuse_grey = false;\n\n\t\tswitch ( header.image_type ) {\n\n\t\t\tcase TGA_TYPE_RLE_INDEXED:\n\t\t\t\tuse_rle = true;\n\t\t\t\tuse_pal = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_INDEXED:\n\t\t\t\tuse_pal = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_RLE_RGB:\n\t\t\t\tuse_rle = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_RGB:\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_RLE_GREY:\n\t\t\t\tuse_rle = true;\n\t\t\t\tuse_grey = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_GREY:\n\t\t\t\tuse_grey = true;\n\t\t\t\tbreak;\n\n\t\t}\n\n\t\t//\n\n\t\tconst imageData = new Uint8Array( header.width * header.height * 4 );\n\t\tconst result = tgaParse( use_rle, use_pal, header, offset, content );\n\t\tgetTgaRGBA( imageData, header.width, header.height, result.pixel_data, result.palettes );\n\n\t\treturn {\n\n\t\t\tdata: imageData,\n\t\t\twidth: header.width,\n\t\t\theight: header.height,\n\t\t\tflipY: true,\n\t\t\tgenerateMipmaps: true,\n\t\t\tminFilter: LinearMipmapLinearFilter,\n\n\t\t};\n\n\t}\n\n}\n\nexport { TGALoader };\n","import {\n\tAmbientLight,\n\tAnimationClip,\n\tBone,\n\tBufferGeometry,\n\tClampToEdgeWrapping,\n\tColor,\n\tColorManagement,\n\tDirectionalLight,\n\tDoubleSide,\n\tFileLoader,\n\tFloat32BufferAttribute,\n\tFrontSide,\n\tGroup,\n\tLine,\n\tLineBasicMaterial,\n\tLineSegments,\n\tLoader,\n\tLoaderUtils,\n\tMathUtils,\n\tMatrix4,\n\tMesh,\n\tMeshBasicMaterial,\n\tMeshLambertMaterial,\n\tMeshPhongMaterial,\n\tOrthographicCamera,\n\tPerspectiveCamera,\n\tPointLight,\n\tQuaternion,\n\tQuaternionKeyframeTrack,\n\tRepeatWrapping,\n\tScene,\n\tSkeleton,\n\tSkinnedMesh,\n\tSpotLight,\n\tTextureLoader,\n\tVector2,\n\tVector3,\n\tVectorKeyframeTrack,\n\tSRGBColorSpace\n} from 'three';\nimport { TGALoader } from '../loaders/TGALoader.js';\n\n/**\n * A loader for the Collada format.\n *\n * The Collada format is very complex so this loader only supports a subset of what\n * is defined in the [official specification](https://www.khronos.org/files/collada_spec_1_5.pdf).\n *\n * Assets with a Z-UP coordinate system are transformed it into Y-UP by a simple rotation.\n * The vertex data are not converted.\n *\n * ```js\n * const loader = new ColladaLoader();\n *\n * const result = await loader.loadAsync( './models/collada/elf/elf.dae' );\n * scene.add( result.scene );\n * ```\n *\n * @augments Loader\n * @three_import import { ColladaLoader } from 'three/addons/loaders/ColladaLoader.js';\n */\nclass ColladaLoader extends Loader {\n\n\t/**\n\t * Starts loading from the given URL and passes the loaded Collada asset\n\t * to the `onLoad()` callback.\n\t *\n\t * @param {string} url - The path/URL of the file to be loaded. This can also be a data URI.\n\t * @param {function({scene:Group,animations:Array<AnimationClip>,kinematics:Object})} onLoad - Executed when the loading process has been finished.\n\t * @param {onProgressCallback} onProgress - Executed while the loading is in progress.\n\t * @param {onErrorCallback} onError - Executed when errors occur.\n\t */\n\tload( url, onLoad, onProgress, onError ) {\n\n\t\tconst scope = this;\n\n\t\tconst path = ( scope.path === '' ) ? LoaderUtils.extractUrlBase( url ) : scope.path;\n\n\t\tconst loader = new FileLoader( scope.manager );\n\t\tloader.setPath( scope.path );\n\t\tloader.setRequestHeader( scope.requestHeader );\n\t\tloader.setWithCredentials( scope.withCredentials );\n\t\tloader.load( url, function ( text ) {\n\n\t\t\ttry {\n\n\t\t\t\tonLoad( scope.parse( text, path ) );\n\n\t\t\t} catch ( e ) {\n\n\t\t\t\tif ( onError ) {\n\n\t\t\t\t\tonError( e );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.error( e );\n\n\t\t\t\t}\n\n\t\t\t\tscope.manager.itemError( url );\n\n\t\t\t}\n\n\t\t}, onProgress, onError );\n\n\t}\n\n\t/**\n\t * Parses the given Collada data and returns a result object holding the parsed scene,\n\t * an array of animation clips and kinematics.\n\t *\n\t * @param {string} text - The raw Collada data as a string.\n\t * @param {string} [path] - The asset path.\n\t * @return {?{scene:Group,animations:Array<AnimationClip>,kinematics:Object}} An object representing the parsed asset.\n\t */\n\tparse( text, path ) {\n\n\t\tfunction getElementsByTagName( xml, name ) {\n\n\t\t\t// Non recursive xml.getElementsByTagName() ...\n\n\t\t\tconst array = [];\n\t\t\tconst childNodes = xml.childNodes;\n\n\t\t\tfor ( let i = 0, l = childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = childNodes[ i ];\n\n\t\t\t\tif ( child.nodeName === name ) {\n\n\t\t\t\t\tarray.push( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn array;\n\n\t\t}\n\n\t\tfunction parseStrings( text ) {\n\n\t\t\tif ( text.length === 0 ) return [];\n\n\t\t\tconst parts = text.trim().split( /\\s+/ );\n\t\t\tconst array = new Array( parts.length );\n\n\t\t\tfor ( let i = 0, l = parts.length; i < l; i ++ ) {\n\n\t\t\t\tarray[ i ] = parts[ i ];\n\n\t\t\t}\n\n\t\t\treturn array;\n\n\t\t}\n\n\t\tfunction parseFloats( text ) {\n\n\t\t\tif ( text.length === 0 ) return [];\n\n\t\t\tconst parts = text.trim().split( /\\s+/ );\n\t\t\tconst array = new Array( parts.length );\n\n\t\t\tfor ( let i = 0, l = parts.length; i < l; i ++ ) {\n\n\t\t\t\tarray[ i ] = parseFloat( parts[ i ] );\n\n\t\t\t}\n\n\t\t\treturn array;\n\n\t\t}\n\n\t\tfunction parseInts( text ) {\n\n\t\t\tif ( text.length === 0 ) return [];\n\n\t\t\tconst parts = text.trim().split( /\\s+/ );\n\t\t\tconst array = new Array( parts.length );\n\n\t\t\tfor ( let i = 0, l = parts.length; i < l; i ++ ) {\n\n\t\t\t\tarray[ i ] = parseInt( parts[ i ] );\n\n\t\t\t}\n\n\t\t\treturn array;\n\n\t\t}\n\n\t\tfunction parseId( text ) {\n\n\t\t\treturn text.substring( 1 );\n\n\t\t}\n\n\t\tfunction generateId() {\n\n\t\t\treturn 'three_default_' + ( count ++ );\n\n\t\t}\n\n\t\tfunction isEmpty( object ) {\n\n\t\t\treturn Object.keys( object ).length === 0;\n\n\t\t}\n\n\t\t// asset\n\n\t\tfunction parseAsset( xml ) {\n\n\t\t\treturn {\n\t\t\t\tunit: parseAssetUnit( getElementsByTagName( xml, 'unit' )[ 0 ] ),\n\t\t\t\tupAxis: parseAssetUpAxis( getElementsByTagName( xml, 'up_axis' )[ 0 ] )\n\t\t\t};\n\n\t\t}\n\n\t\tfunction parseAssetUnit( xml ) {\n\n\t\t\tif ( ( xml !== undefined ) && ( xml.hasAttribute( 'meter' ) === true ) ) {\n\n\t\t\t\treturn parseFloat( xml.getAttribute( 'meter' ) );\n\n\t\t\t} else {\n\n\t\t\t\treturn 1; // default 1 meter\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parseAssetUpAxis( xml ) {\n\n\t\t\treturn xml !== undefined ? xml.textContent : 'Y_UP';\n\n\t\t}\n\n\t\t// library\n\n\t\tfunction parseLibrary( xml, libraryName, nodeName, parser ) {\n\n\t\t\tconst library = getElementsByTagName( xml, libraryName )[ 0 ];\n\n\t\t\tif ( library !== undefined ) {\n\n\t\t\t\tconst elements = getElementsByTagName( library, nodeName );\n\n\t\t\t\tfor ( let i = 0; i < elements.length; i ++ ) {\n\n\t\t\t\t\tparser( elements[ i ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction buildLibrary( data, builder ) {\n\n\t\t\tfor ( const name in data ) {\n\n\t\t\t\tconst object = data[ name ];\n\t\t\t\tobject.build = builder( data[ name ] );\n\n\t\t\t}\n\n\t\t}\n\n\t\t// get\n\n\t\tfunction getBuild( data, builder ) {\n\n\t\t\tif ( data.build !== undefined ) return data.build;\n\n\t\t\tdata.build = builder( data );\n\n\t\t\treturn data.build;\n\n\t\t}\n\n\t\t// animation\n\n\t\tfunction parseAnimation( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tsources: {},\n\t\t\t\tsamplers: {},\n\t\t\t\tchannels: {}\n\t\t\t};\n\n\t\t\tlet hasChildren = false;\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tlet id;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'source':\n\t\t\t\t\t\tid = child.getAttribute( 'id' );\n\t\t\t\t\t\tdata.sources[ id ] = parseSource( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'sampler':\n\t\t\t\t\t\tid = child.getAttribute( 'id' );\n\t\t\t\t\t\tdata.samplers[ id ] = parseAnimationSampler( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'channel':\n\t\t\t\t\t\tid = child.getAttribute( 'target' );\n\t\t\t\t\t\tdata.channels[ id ] = parseAnimationChannel( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'animation':\n\t\t\t\t\t\t// hierarchy of related animations\n\t\t\t\t\t\tparseAnimation( child );\n\t\t\t\t\t\thasChildren = true;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.log( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( hasChildren === false ) {\n\n\t\t\t\t// since 'id' attributes can be optional, it's necessary to generate a UUID for unique assignment\n\n\t\t\t\tlibrary.animations[ xml.getAttribute( 'id' ) || MathUtils.generateUUID() ] = data;\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parseAnimationSampler( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tinputs: {},\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'input':\n\t\t\t\t\t\tconst id = parseId( child.getAttribute( 'source' ) );\n\t\t\t\t\t\tconst semantic = child.getAttribute( 'semantic' );\n\t\t\t\t\t\tdata.inputs[ semantic ] = id;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseAnimationChannel( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tconst target = xml.getAttribute( 'target' );\n\n\t\t\t// parsing SID Addressing Syntax\n\n\t\t\tlet parts = target.split( '/' );\n\n\t\t\tconst id = parts.shift();\n\t\t\tlet sid = parts.shift();\n\n\t\t\t// check selection syntax\n\n\t\t\tconst arraySyntax = ( sid.indexOf( '(' ) !== - 1 );\n\t\t\tconst memberSyntax = ( sid.indexOf( '.' ) !== - 1 );\n\n\t\t\tif ( memberSyntax ) {\n\n\t\t\t\t//  member selection access\n\n\t\t\t\tparts = sid.split( '.' );\n\t\t\t\tsid = parts.shift();\n\t\t\t\tdata.member = parts.shift();\n\n\t\t\t} else if ( arraySyntax ) {\n\n\t\t\t\t// array-access syntax. can be used to express fields in one-dimensional vectors or two-dimensional matrices.\n\n\t\t\t\tconst indices = sid.split( '(' );\n\t\t\t\tsid = indices.shift();\n\n\t\t\t\tfor ( let i = 0; i < indices.length; i ++ ) {\n\n\t\t\t\t\tindices[ i ] = parseInt( indices[ i ].replace( /\\)/, '' ) );\n\n\t\t\t\t}\n\n\t\t\t\tdata.indices = indices;\n\n\t\t\t}\n\n\t\t\tdata.id = id;\n\t\t\tdata.sid = sid;\n\n\t\t\tdata.arraySyntax = arraySyntax;\n\t\t\tdata.memberSyntax = memberSyntax;\n\n\t\t\tdata.sampler = parseId( xml.getAttribute( 'source' ) );\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildAnimation( data ) {\n\n\t\t\tconst tracks = [];\n\n\t\t\tconst channels = data.channels;\n\t\t\tconst samplers = data.samplers;\n\t\t\tconst sources = data.sources;\n\n\t\t\tfor ( const target in channels ) {\n\n\t\t\t\tif ( channels.hasOwnProperty( target ) ) {\n\n\t\t\t\t\tconst channel = channels[ target ];\n\t\t\t\t\tconst sampler = samplers[ channel.sampler ];\n\n\t\t\t\t\tconst inputId = sampler.inputs.INPUT;\n\t\t\t\t\tconst outputId = sampler.inputs.OUTPUT;\n\n\t\t\t\t\tconst inputSource = sources[ inputId ];\n\t\t\t\t\tconst outputSource = sources[ outputId ];\n\n\t\t\t\t\tconst animation = buildAnimationChannel( channel, inputSource, outputSource );\n\n\t\t\t\t\tcreateKeyframeTracks( animation, tracks );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn tracks;\n\n\t\t}\n\n\t\tfunction getAnimation( id ) {\n\n\t\t\treturn getBuild( library.animations[ id ], buildAnimation );\n\n\t\t}\n\n\t\tfunction buildAnimationChannel( channel, inputSource, outputSource ) {\n\n\t\t\tconst node = library.nodes[ channel.id ];\n\t\t\tconst object3D = getNode( node.id );\n\n\t\t\tconst transform = node.transforms[ channel.sid ];\n\t\t\tconst defaultMatrix = node.matrix.clone().transpose();\n\n\t\t\tlet time, stride;\n\t\t\tlet i, il, j, jl;\n\n\t\t\tconst data = {};\n\n\t\t\t// the collada spec allows the animation of data in various ways.\n\t\t\t// depending on the transform type (matrix, translate, rotate, scale), we execute different logic\n\n\t\t\tswitch ( transform ) {\n\n\t\t\t\tcase 'matrix':\n\n\t\t\t\t\tfor ( i = 0, il = inputSource.array.length; i < il; i ++ ) {\n\n\t\t\t\t\t\ttime = inputSource.array[ i ];\n\t\t\t\t\t\tstride = i * outputSource.stride;\n\n\t\t\t\t\t\tif ( data[ time ] === undefined ) data[ time ] = {};\n\n\t\t\t\t\t\tif ( channel.arraySyntax === true ) {\n\n\t\t\t\t\t\t\tconst value = outputSource.array[ stride ];\n\t\t\t\t\t\t\tconst index = channel.indices[ 0 ] + 4 * channel.indices[ 1 ];\n\n\t\t\t\t\t\t\tdata[ time ][ index ] = value;\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tfor ( j = 0, jl = outputSource.stride; j < jl; j ++ ) {\n\n\t\t\t\t\t\t\t\tdata[ time ][ j ] = outputSource.array[ stride + j ];\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'translate':\n\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Animation transform type \"%s\" not yet implemented.', transform );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'rotate':\n\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Animation transform type \"%s\" not yet implemented.', transform );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'scale':\n\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Animation transform type \"%s\" not yet implemented.', transform );\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tconst keyframes = prepareAnimationData( data, defaultMatrix );\n\n\t\t\tconst animation = {\n\t\t\t\tname: object3D.uuid,\n\t\t\t\tkeyframes: keyframes\n\t\t\t};\n\n\t\t\treturn animation;\n\n\t\t}\n\n\t\tfunction prepareAnimationData( data, defaultMatrix ) {\n\n\t\t\tconst keyframes = [];\n\n\t\t\t// transfer data into a sortable array\n\n\t\t\tfor ( const time in data ) {\n\n\t\t\t\tkeyframes.push( { time: parseFloat( time ), value: data[ time ] } );\n\n\t\t\t}\n\n\t\t\t// ensure keyframes are sorted by time\n\n\t\t\tkeyframes.sort( ascending );\n\n\t\t\t// now we clean up all animation data, so we can use them for keyframe tracks\n\n\t\t\tfor ( let i = 0; i < 16; i ++ ) {\n\n\t\t\t\ttransformAnimationData( keyframes, i, defaultMatrix.elements[ i ] );\n\n\t\t\t}\n\n\t\t\treturn keyframes;\n\n\t\t\t// array sort function\n\n\t\t\tfunction ascending( a, b ) {\n\n\t\t\t\treturn a.time - b.time;\n\n\t\t\t}\n\n\t\t}\n\n\t\tconst position = new Vector3();\n\t\tconst scale = new Vector3();\n\t\tconst quaternion = new Quaternion();\n\n\t\tfunction createKeyframeTracks( animation, tracks ) {\n\n\t\t\tconst keyframes = animation.keyframes;\n\t\t\tconst name = animation.name;\n\n\t\t\tconst times = [];\n\t\t\tconst positionData = [];\n\t\t\tconst quaternionData = [];\n\t\t\tconst scaleData = [];\n\n\t\t\tfor ( let i = 0, l = keyframes.length; i < l; i ++ ) {\n\n\t\t\t\tconst keyframe = keyframes[ i ];\n\n\t\t\t\tconst time = keyframe.time;\n\t\t\t\tconst value = keyframe.value;\n\n\t\t\t\tmatrix.fromArray( value ).transpose();\n\t\t\t\tmatrix.decompose( position, quaternion, scale );\n\n\t\t\t\ttimes.push( time );\n\t\t\t\tpositionData.push( position.x, position.y, position.z );\n\t\t\t\tquaternionData.push( quaternion.x, quaternion.y, quaternion.z, quaternion.w );\n\t\t\t\tscaleData.push( scale.x, scale.y, scale.z );\n\n\t\t\t}\n\n\t\t\tif ( positionData.length > 0 ) tracks.push( new VectorKeyframeTrack( name + '.position', times, positionData ) );\n\t\t\tif ( quaternionData.length > 0 ) tracks.push( new QuaternionKeyframeTrack( name + '.quaternion', times, quaternionData ) );\n\t\t\tif ( scaleData.length > 0 ) tracks.push( new VectorKeyframeTrack( name + '.scale', times, scaleData ) );\n\n\t\t\treturn tracks;\n\n\t\t}\n\n\t\tfunction transformAnimationData( keyframes, property, defaultValue ) {\n\n\t\t\tlet keyframe;\n\n\t\t\tlet empty = true;\n\t\t\tlet i, l;\n\n\t\t\t// check, if values of a property are missing in our keyframes\n\n\t\t\tfor ( i = 0, l = keyframes.length; i < l; i ++ ) {\n\n\t\t\t\tkeyframe = keyframes[ i ];\n\n\t\t\t\tif ( keyframe.value[ property ] === undefined ) {\n\n\t\t\t\t\tkeyframe.value[ property ] = null; // mark as missing\n\n\t\t\t\t} else {\n\n\t\t\t\t\tempty = false;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( empty === true ) {\n\n\t\t\t\t// no values at all, so we set a default value\n\n\t\t\t\tfor ( i = 0, l = keyframes.length; i < l; i ++ ) {\n\n\t\t\t\t\tkeyframe = keyframes[ i ];\n\n\t\t\t\t\tkeyframe.value[ property ] = defaultValue;\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\t// filling gaps\n\n\t\t\t\tcreateMissingKeyframes( keyframes, property );\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction createMissingKeyframes( keyframes, property ) {\n\n\t\t\tlet prev, next;\n\n\t\t\tfor ( let i = 0, l = keyframes.length; i < l; i ++ ) {\n\n\t\t\t\tconst keyframe = keyframes[ i ];\n\n\t\t\t\tif ( keyframe.value[ property ] === null ) {\n\n\t\t\t\t\tprev = getPrev( keyframes, i, property );\n\t\t\t\t\tnext = getNext( keyframes, i, property );\n\n\t\t\t\t\tif ( prev === null ) {\n\n\t\t\t\t\t\tkeyframe.value[ property ] = next.value[ property ];\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( next === null ) {\n\n\t\t\t\t\t\tkeyframe.value[ property ] = prev.value[ property ];\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tinterpolate( keyframe, prev, next, property );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction getPrev( keyframes, i, property ) {\n\n\t\t\twhile ( i >= 0 ) {\n\n\t\t\t\tconst keyframe = keyframes[ i ];\n\n\t\t\t\tif ( keyframe.value[ property ] !== null ) return keyframe;\n\n\t\t\t\ti --;\n\n\t\t\t}\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tfunction getNext( keyframes, i, property ) {\n\n\t\t\twhile ( i < keyframes.length ) {\n\n\t\t\t\tconst keyframe = keyframes[ i ];\n\n\t\t\t\tif ( keyframe.value[ property ] !== null ) return keyframe;\n\n\t\t\t\ti ++;\n\n\t\t\t}\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tfunction interpolate( key, prev, next, property ) {\n\n\t\t\tif ( ( next.time - prev.time ) === 0 ) {\n\n\t\t\t\tkey.value[ property ] = prev.value[ property ];\n\t\t\t\treturn;\n\n\t\t\t}\n\n\t\t\tkey.value[ property ] = ( ( key.time - prev.time ) * ( next.value[ property ] - prev.value[ property ] ) / ( next.time - prev.time ) ) + prev.value[ property ];\n\n\t\t}\n\n\t\t// animation clips\n\n\t\tfunction parseAnimationClip( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'id' ) || 'default',\n\t\t\t\tstart: parseFloat( xml.getAttribute( 'start' ) || 0 ),\n\t\t\t\tend: parseFloat( xml.getAttribute( 'end' ) || 0 ),\n\t\t\t\tanimations: []\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'instance_animation':\n\t\t\t\t\t\tdata.animations.push( parseId( child.getAttribute( 'url' ) ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.clips[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction buildAnimationClip( data ) {\n\n\t\t\tconst tracks = [];\n\n\t\t\tconst name = data.name;\n\t\t\tconst duration = ( data.end - data.start ) || - 1;\n\t\t\tconst animations = data.animations;\n\n\t\t\tfor ( let i = 0, il = animations.length; i < il; i ++ ) {\n\n\t\t\t\tconst animationTracks = getAnimation( animations[ i ] );\n\n\t\t\t\tfor ( let j = 0, jl = animationTracks.length; j < jl; j ++ ) {\n\n\t\t\t\t\ttracks.push( animationTracks[ j ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn new AnimationClip( name, duration, tracks );\n\n\t\t}\n\n\t\tfunction getAnimationClip( id ) {\n\n\t\t\treturn getBuild( library.clips[ id ], buildAnimationClip );\n\n\t\t}\n\n\t\t// controller\n\n\t\tfunction parseController( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'skin':\n\t\t\t\t\t\t// there is exactly one skin per controller\n\t\t\t\t\t\tdata.id = parseId( child.getAttribute( 'source' ) );\n\t\t\t\t\t\tdata.skin = parseSkin( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'morph':\n\t\t\t\t\t\tdata.id = parseId( child.getAttribute( 'source' ) );\n\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Morph target animation not supported yet.' );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.controllers[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction parseSkin( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tsources: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'bind_shape_matrix':\n\t\t\t\t\t\tdata.bindShapeMatrix = parseFloats( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'source':\n\t\t\t\t\t\tconst id = child.getAttribute( 'id' );\n\t\t\t\t\t\tdata.sources[ id ] = parseSource( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'joints':\n\t\t\t\t\t\tdata.joints = parseJoints( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'vertex_weights':\n\t\t\t\t\t\tdata.vertexWeights = parseVertexWeights( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseJoints( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tinputs: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'input':\n\t\t\t\t\t\tconst semantic = child.getAttribute( 'semantic' );\n\t\t\t\t\t\tconst id = parseId( child.getAttribute( 'source' ) );\n\t\t\t\t\t\tdata.inputs[ semantic ] = id;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseVertexWeights( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tinputs: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'input':\n\t\t\t\t\t\tconst semantic = child.getAttribute( 'semantic' );\n\t\t\t\t\t\tconst id = parseId( child.getAttribute( 'source' ) );\n\t\t\t\t\t\tconst offset = parseInt( child.getAttribute( 'offset' ) );\n\t\t\t\t\t\tdata.inputs[ semantic ] = { id: id, offset: offset };\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'vcount':\n\t\t\t\t\t\tdata.vcount = parseInts( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'v':\n\t\t\t\t\t\tdata.v = parseInts( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildController( data ) {\n\n\t\t\tconst build = {\n\t\t\t\tid: data.id\n\t\t\t};\n\n\t\t\tconst geometry = library.geometries[ build.id ];\n\n\t\t\tif ( data.skin !== undefined ) {\n\n\t\t\t\tbuild.skin = buildSkin( data.skin );\n\n\t\t\t\t// we enhance the 'sources' property of the corresponding geometry with our skin data\n\n\t\t\t\tgeometry.sources.skinIndices = build.skin.indices;\n\t\t\t\tgeometry.sources.skinWeights = build.skin.weights;\n\n\t\t\t}\n\n\t\t\treturn build;\n\n\t\t}\n\n\t\tfunction buildSkin( data ) {\n\n\t\t\tconst BONE_LIMIT = 4;\n\n\t\t\tconst build = {\n\t\t\t\tjoints: [], // this must be an array to preserve the joint order\n\t\t\t\tindices: {\n\t\t\t\t\tarray: [],\n\t\t\t\t\tstride: BONE_LIMIT\n\t\t\t\t},\n\t\t\t\tweights: {\n\t\t\t\t\tarray: [],\n\t\t\t\t\tstride: BONE_LIMIT\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tconst sources = data.sources;\n\t\t\tconst vertexWeights = data.vertexWeights;\n\n\t\t\tconst vcount = vertexWeights.vcount;\n\t\t\tconst v = vertexWeights.v;\n\t\t\tconst jointOffset = vertexWeights.inputs.JOINT.offset;\n\t\t\tconst weightOffset = vertexWeights.inputs.WEIGHT.offset;\n\n\t\t\tconst jointSource = data.sources[ data.joints.inputs.JOINT ];\n\t\t\tconst inverseSource = data.sources[ data.joints.inputs.INV_BIND_MATRIX ];\n\n\t\t\tconst weights = sources[ vertexWeights.inputs.WEIGHT.id ].array;\n\t\t\tlet stride = 0;\n\n\t\t\tlet i, j, l;\n\n\t\t\t// process skin data for each vertex\n\n\t\t\tfor ( i = 0, l = vcount.length; i < l; i ++ ) {\n\n\t\t\t\tconst jointCount = vcount[ i ]; // this is the amount of joints that affect a single vertex\n\t\t\t\tconst vertexSkinData = [];\n\n\t\t\t\tfor ( j = 0; j < jointCount; j ++ ) {\n\n\t\t\t\t\tconst skinIndex = v[ stride + jointOffset ];\n\t\t\t\t\tconst weightId = v[ stride + weightOffset ];\n\t\t\t\t\tconst skinWeight = weights[ weightId ];\n\n\t\t\t\t\tvertexSkinData.push( { index: skinIndex, weight: skinWeight } );\n\n\t\t\t\t\tstride += 2;\n\n\t\t\t\t}\n\n\t\t\t\t// we sort the joints in descending order based on the weights.\n\t\t\t\t// this ensures, we only proceed the most important joints of the vertex\n\n\t\t\t\tvertexSkinData.sort( descending );\n\n\t\t\t\t// now we provide for each vertex a set of four index and weight values.\n\t\t\t\t// the order of the skin data matches the order of vertices\n\n\t\t\t\tfor ( j = 0; j < BONE_LIMIT; j ++ ) {\n\n\t\t\t\t\tconst d = vertexSkinData[ j ];\n\n\t\t\t\t\tif ( d !== undefined ) {\n\n\t\t\t\t\t\tbuild.indices.array.push( d.index );\n\t\t\t\t\t\tbuild.weights.array.push( d.weight );\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tbuild.indices.array.push( 0 );\n\t\t\t\t\t\tbuild.weights.array.push( 0 );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// setup bind matrix\n\n\t\t\tif ( data.bindShapeMatrix ) {\n\n\t\t\t\tbuild.bindMatrix = new Matrix4().fromArray( data.bindShapeMatrix ).transpose();\n\n\t\t\t} else {\n\n\t\t\t\tbuild.bindMatrix = new Matrix4().identity();\n\n\t\t\t}\n\n\t\t\t// process bones and inverse bind matrix data\n\n\t\t\tfor ( i = 0, l = jointSource.array.length; i < l; i ++ ) {\n\n\t\t\t\tconst name = jointSource.array[ i ];\n\t\t\t\tconst boneInverse = new Matrix4().fromArray( inverseSource.array, i * inverseSource.stride ).transpose();\n\n\t\t\t\tbuild.joints.push( { name: name, boneInverse: boneInverse } );\n\n\t\t\t}\n\n\t\t\treturn build;\n\n\t\t\t// array sort function\n\n\t\t\tfunction descending( a, b ) {\n\n\t\t\t\treturn b.weight - a.weight;\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction getController( id ) {\n\n\t\t\treturn getBuild( library.controllers[ id ], buildController );\n\n\t\t}\n\n\t\t// image\n\n\t\tfunction parseImage( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tinit_from: getElementsByTagName( xml, 'init_from' )[ 0 ].textContent\n\t\t\t};\n\n\t\t\tlibrary.images[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction buildImage( data ) {\n\n\t\t\tif ( data.build !== undefined ) return data.build;\n\n\t\t\treturn data.init_from;\n\n\t\t}\n\n\t\tfunction getImage( id ) {\n\n\t\t\tconst data = library.images[ id ];\n\n\t\t\tif ( data !== undefined ) {\n\n\t\t\t\treturn getBuild( data, buildImage );\n\n\t\t\t}\n\n\t\t\tconsole.warn( 'THREE.ColladaLoader: Couldn\\'t find image with ID:', id );\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\t// effect\n\n\t\tfunction parseEffect( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'profile_COMMON':\n\t\t\t\t\t\tdata.profile = parseEffectProfileCOMMON( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.effects[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction parseEffectProfileCOMMON( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tsurfaces: {},\n\t\t\t\tsamplers: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'newparam':\n\t\t\t\t\t\tparseEffectNewparam( child, data );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'technique':\n\t\t\t\t\t\tdata.technique = parseEffectTechnique( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'extra':\n\t\t\t\t\t\tdata.extra = parseEffectExtra( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectNewparam( xml, data ) {\n\n\t\t\tconst sid = xml.getAttribute( 'sid' );\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'surface':\n\t\t\t\t\t\tdata.surfaces[ sid ] = parseEffectSurface( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'sampler2D':\n\t\t\t\t\t\tdata.samplers[ sid ] = parseEffectSampler( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parseEffectSurface( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'init_from':\n\t\t\t\t\t\tdata.init_from = child.textContent;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectSampler( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'source':\n\t\t\t\t\t\tdata.source = child.textContent;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectTechnique( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'constant':\n\t\t\t\t\tcase 'lambert':\n\t\t\t\t\tcase 'blinn':\n\t\t\t\t\tcase 'phong':\n\t\t\t\t\t\tdata.type = child.nodeName;\n\t\t\t\t\t\tdata.parameters = parseEffectParameters( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'extra':\n\t\t\t\t\t\tdata.extra = parseEffectExtra( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectParameters( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'emission':\n\t\t\t\t\tcase 'diffuse':\n\t\t\t\t\tcase 'specular':\n\t\t\t\t\tcase 'bump':\n\t\t\t\t\tcase 'ambient':\n\t\t\t\t\tcase 'shininess':\n\t\t\t\t\tcase 'transparency':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseEffectParameter( child );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'transparent':\n\t\t\t\t\t\tdata[ child.nodeName ] = {\n\t\t\t\t\t\t\topaque: child.hasAttribute( 'opaque' ) ? child.getAttribute( 'opaque' ) : 'A_ONE',\n\t\t\t\t\t\t\tdata: parseEffectParameter( child )\n\t\t\t\t\t\t};\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectParameter( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'color':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseFloats( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'float':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseFloat( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'texture':\n\t\t\t\t\t\tdata[ child.nodeName ] = { id: child.getAttribute( 'texture' ), extra: parseEffectParameterTexture( child ) };\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectParameterTexture( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\ttechnique: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'extra':\n\t\t\t\t\t\tparseEffectParameterTextureExtra( child, data );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectParameterTextureExtra( xml, data ) {\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'technique':\n\t\t\t\t\t\tparseEffectParameterTextureExtraTechnique( child, data );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parseEffectParameterTextureExtraTechnique( xml, data ) {\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'repeatU':\n\t\t\t\t\tcase 'repeatV':\n\t\t\t\t\tcase 'offsetU':\n\t\t\t\t\tcase 'offsetV':\n\t\t\t\t\t\tdata.technique[ child.nodeName ] = parseFloat( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'wrapU':\n\t\t\t\t\tcase 'wrapV':\n\n\t\t\t\t\t\t// some files have values for wrapU/wrapV which become NaN via parseInt\n\n\t\t\t\t\t\tif ( child.textContent.toUpperCase() === 'TRUE' ) {\n\n\t\t\t\t\t\t\tdata.technique[ child.nodeName ] = 1;\n\n\t\t\t\t\t\t} else if ( child.textContent.toUpperCase() === 'FALSE' ) {\n\n\t\t\t\t\t\t\tdata.technique[ child.nodeName ] = 0;\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tdata.technique[ child.nodeName ] = parseInt( child.textContent );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'bump':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseEffectExtraTechniqueBump( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parseEffectExtra( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'technique':\n\t\t\t\t\t\tdata.technique = parseEffectExtraTechnique( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectExtraTechnique( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'double_sided':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseInt( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'bump':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseEffectExtraTechniqueBump( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseEffectExtraTechniqueBump( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'texture':\n\t\t\t\t\t\tdata[ child.nodeName ] = { id: child.getAttribute( 'texture' ), texcoord: child.getAttribute( 'texcoord' ), extra: parseEffectParameterTexture( child ) };\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildEffect( data ) {\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction getEffect( id ) {\n\n\t\t\treturn getBuild( library.effects[ id ], buildEffect );\n\n\t\t}\n\n\t\t// material\n\n\t\tfunction parseMaterial( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' )\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'instance_effect':\n\t\t\t\t\t\tdata.url = parseId( child.getAttribute( 'url' ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.materials[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction getTextureLoader( image ) {\n\n\t\t\tlet loader;\n\n\t\t\tlet extension = image.slice( ( image.lastIndexOf( '.' ) - 1 >>> 0 ) + 2 ); // http://www.jstips.co/en/javascript/get-file-extension/\n\t\t\textension = extension.toLowerCase();\n\n\t\t\tswitch ( extension ) {\n\n\t\t\t\tcase 'tga':\n\t\t\t\t\tloader = tgaLoader;\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tloader = textureLoader;\n\n\t\t\t}\n\n\t\t\treturn loader;\n\n\t\t}\n\n\t\tfunction buildMaterial( data ) {\n\n\t\t\tconst effect = getEffect( data.url );\n\t\t\tconst technique = effect.profile.technique;\n\n\t\t\tlet material;\n\n\t\t\tswitch ( technique.type ) {\n\n\t\t\t\tcase 'phong':\n\t\t\t\tcase 'blinn':\n\t\t\t\t\tmaterial = new MeshPhongMaterial();\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'lambert':\n\t\t\t\t\tmaterial = new MeshLambertMaterial();\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tmaterial = new MeshBasicMaterial();\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tmaterial.name = data.name || '';\n\n\t\t\tfunction getTexture( textureObject, colorSpace = null ) {\n\n\t\t\t\tconst sampler = effect.profile.samplers[ textureObject.id ];\n\t\t\t\tlet image = null;\n\n\t\t\t\t// get image\n\n\t\t\t\tif ( sampler !== undefined ) {\n\n\t\t\t\t\tconst surface = effect.profile.surfaces[ sampler.source ];\n\t\t\t\t\timage = getImage( surface.init_from );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530).' );\n\t\t\t\t\timage = getImage( textureObject.id );\n\n\t\t\t\t}\n\n\t\t\t\t// create texture if image is available\n\n\t\t\t\tif ( image !== null ) {\n\n\t\t\t\t\tconst loader = getTextureLoader( image );\n\n\t\t\t\t\tif ( loader !== undefined ) {\n\n\t\t\t\t\t\tconst texture = loader.load( image );\n\n\t\t\t\t\t\tconst extra = textureObject.extra;\n\n\t\t\t\t\t\tif ( extra !== undefined && extra.technique !== undefined && isEmpty( extra.technique ) === false ) {\n\n\t\t\t\t\t\t\tconst technique = extra.technique;\n\n\t\t\t\t\t\t\ttexture.wrapS = technique.wrapU ? RepeatWrapping : ClampToEdgeWrapping;\n\t\t\t\t\t\t\ttexture.wrapT = technique.wrapV ? RepeatWrapping : ClampToEdgeWrapping;\n\n\t\t\t\t\t\t\ttexture.offset.set( technique.offsetU || 0, technique.offsetV || 0 );\n\t\t\t\t\t\t\ttexture.repeat.set( technique.repeatU || 1, technique.repeatV || 1 );\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\ttexture.wrapS = RepeatWrapping;\n\t\t\t\t\t\t\ttexture.wrapT = RepeatWrapping;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif ( colorSpace !== null ) {\n\n\t\t\t\t\t\t\ttexture.colorSpace = colorSpace;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn texture;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Loader for texture %s not found.', image );\n\n\t\t\t\t\t\treturn null;\n\n\t\t\t\t\t}\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Couldn\\'t create texture with ID:', textureObject.id );\n\n\t\t\t\t\treturn null;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tconst parameters = technique.parameters;\n\n\t\t\tfor ( const key in parameters ) {\n\n\t\t\t\tconst parameter = parameters[ key ];\n\n\t\t\t\tswitch ( key ) {\n\n\t\t\t\t\tcase 'diffuse':\n\t\t\t\t\t\tif ( parameter.color ) material.color.fromArray( parameter.color );\n\t\t\t\t\t\tif ( parameter.texture ) material.map = getTexture( parameter.texture, SRGBColorSpace );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'specular':\n\t\t\t\t\t\tif ( parameter.color && material.specular ) material.specular.fromArray( parameter.color );\n\t\t\t\t\t\tif ( parameter.texture ) material.specularMap = getTexture( parameter.texture );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'bump':\n\t\t\t\t\t\tif ( parameter.texture ) material.normalMap = getTexture( parameter.texture );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'ambient':\n\t\t\t\t\t\tif ( parameter.texture ) material.lightMap = getTexture( parameter.texture, SRGBColorSpace );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'shininess':\n\t\t\t\t\t\tif ( parameter.float && material.shininess ) material.shininess = parameter.float;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'emission':\n\t\t\t\t\t\tif ( parameter.color && material.emissive ) material.emissive.fromArray( parameter.color );\n\t\t\t\t\t\tif ( parameter.texture ) material.emissiveMap = getTexture( parameter.texture, SRGBColorSpace );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tColorManagement.colorSpaceToWorking( material.color, SRGBColorSpace );\n\t\t\tif ( material.specular ) ColorManagement.colorSpaceToWorking( material.specular, SRGBColorSpace );\n\t\t\tif ( material.emissive ) ColorManagement.colorSpaceToWorking( material.emissive, SRGBColorSpace );\n\n\t\t\t//\n\n\t\t\tlet transparent = parameters[ 'transparent' ];\n\t\t\tlet transparency = parameters[ 'transparency' ];\n\n\t\t\t// <transparency> does not exist but <transparent>\n\n\t\t\tif ( transparency === undefined && transparent ) {\n\n\t\t\t\ttransparency = {\n\t\t\t\t\tfloat: 1\n\t\t\t\t};\n\n\t\t\t}\n\n\t\t\t// <transparent> does not exist but <transparency>\n\n\t\t\tif ( transparent === undefined && transparency ) {\n\n\t\t\t\ttransparent = {\n\t\t\t\t\topaque: 'A_ONE',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tcolor: [ 1, 1, 1, 1 ]\n\t\t\t\t\t} };\n\n\t\t\t}\n\n\t\t\tif ( transparent && transparency ) {\n\n\t\t\t\t// handle case if a texture exists but no color\n\n\t\t\t\tif ( transparent.data.texture ) {\n\n\t\t\t\t\t// we do not set an alpha map (see #13792)\n\n\t\t\t\t\tmaterial.transparent = true;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconst color = transparent.data.color;\n\n\t\t\t\t\tswitch ( transparent.opaque ) {\n\n\t\t\t\t\t\tcase 'A_ONE':\n\t\t\t\t\t\t\tmaterial.opacity = color[ 3 ] * transparency.float;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'RGB_ZERO':\n\t\t\t\t\t\t\tmaterial.opacity = 1 - ( color[ 0 ] * transparency.float );\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'A_ZERO':\n\t\t\t\t\t\t\tmaterial.opacity = 1 - ( color[ 3 ] * transparency.float );\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'RGB_ONE':\n\t\t\t\t\t\t\tmaterial.opacity = color[ 0 ] * transparency.float;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Invalid opaque type \"%s\" of transparent tag.', transparent.opaque );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( material.opacity < 1 ) material.transparent = true;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t//\n\n\n\t\t\tif ( technique.extra !== undefined && technique.extra.technique !== undefined ) {\n\n\t\t\t\tconst techniques = technique.extra.technique;\n\n\t\t\t\tfor ( const k in techniques ) {\n\n\t\t\t\t\tconst v = techniques[ k ];\n\n\t\t\t\t\tswitch ( k ) {\n\n\t\t\t\t\t\tcase 'double_sided':\n\t\t\t\t\t\t\tmaterial.side = ( v === 1 ? DoubleSide : FrontSide );\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'bump':\n\t\t\t\t\t\t\tmaterial.normalMap = getTexture( v.texture );\n\t\t\t\t\t\t\tmaterial.normalScale = new Vector2( 1, 1 );\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn material;\n\n\t\t}\n\n\t\tfunction getMaterial( id ) {\n\n\t\t\treturn getBuild( library.materials[ id ], buildMaterial );\n\n\t\t}\n\n\t\t// camera\n\n\t\tfunction parseCamera( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' )\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'optics':\n\t\t\t\t\t\tdata.optics = parseCameraOptics( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.cameras[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction parseCameraOptics( xml ) {\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'technique_common':\n\t\t\t\t\t\treturn parseCameraTechnique( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn {};\n\n\t\t}\n\n\t\tfunction parseCameraTechnique( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'perspective':\n\t\t\t\t\tcase 'orthographic':\n\n\t\t\t\t\t\tdata.technique = child.nodeName;\n\t\t\t\t\t\tdata.parameters = parseCameraParameters( child );\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseCameraParameters( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'xfov':\n\t\t\t\t\tcase 'yfov':\n\t\t\t\t\tcase 'xmag':\n\t\t\t\t\tcase 'ymag':\n\t\t\t\t\tcase 'znear':\n\t\t\t\t\tcase 'zfar':\n\t\t\t\t\tcase 'aspect_ratio':\n\t\t\t\t\t\tdata[ child.nodeName ] = parseFloat( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildCamera( data ) {\n\n\t\t\tlet camera;\n\n\t\t\tswitch ( data.optics.technique ) {\n\n\t\t\t\tcase 'perspective':\n\t\t\t\t\tcamera = new PerspectiveCamera(\n\t\t\t\t\t\tdata.optics.parameters.yfov,\n\t\t\t\t\t\tdata.optics.parameters.aspect_ratio,\n\t\t\t\t\t\tdata.optics.parameters.znear,\n\t\t\t\t\t\tdata.optics.parameters.zfar\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'orthographic':\n\t\t\t\t\tlet ymag = data.optics.parameters.ymag;\n\t\t\t\t\tlet xmag = data.optics.parameters.xmag;\n\t\t\t\t\tconst aspectRatio = data.optics.parameters.aspect_ratio;\n\n\t\t\t\t\txmag = ( xmag === undefined ) ? ( ymag * aspectRatio ) : xmag;\n\t\t\t\t\tymag = ( ymag === undefined ) ? ( xmag / aspectRatio ) : ymag;\n\n\t\t\t\t\txmag *= 0.5;\n\t\t\t\t\tymag *= 0.5;\n\n\t\t\t\t\tcamera = new OrthographicCamera(\n\t\t\t\t\t\t- xmag, xmag, ymag, - ymag, // left, right, top, bottom\n\t\t\t\t\t\tdata.optics.parameters.znear,\n\t\t\t\t\t\tdata.optics.parameters.zfar\n\t\t\t\t\t);\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tcamera = new PerspectiveCamera();\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tcamera.name = data.name || '';\n\n\t\t\treturn camera;\n\n\t\t}\n\n\t\tfunction getCamera( id ) {\n\n\t\t\tconst data = library.cameras[ id ];\n\n\t\t\tif ( data !== undefined ) {\n\n\t\t\t\treturn getBuild( data, buildCamera );\n\n\t\t\t}\n\n\t\t\tconsole.warn( 'THREE.ColladaLoader: Couldn\\'t find camera with ID:', id );\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\t// light\n\n\t\tfunction parseLight( xml ) {\n\n\t\t\tlet data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'technique_common':\n\t\t\t\t\t\tdata = parseLightTechnique( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.lights[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction parseLightTechnique( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'directional':\n\t\t\t\t\tcase 'point':\n\t\t\t\t\tcase 'spot':\n\t\t\t\t\tcase 'ambient':\n\n\t\t\t\t\t\tdata.technique = child.nodeName;\n\t\t\t\t\t\tdata.parameters = parseLightParameters( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseLightParameters( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'color':\n\t\t\t\t\t\tconst array = parseFloats( child.textContent );\n\t\t\t\t\t\tdata.color = new Color().fromArray( array );\n\t\t\t\t\t\tColorManagement.colorSpaceToWorking( data.color, SRGBColorSpace );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'falloff_angle':\n\t\t\t\t\t\tdata.falloffAngle = parseFloat( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'quadratic_attenuation':\n\t\t\t\t\t\tconst f = parseFloat( child.textContent );\n\t\t\t\t\t\tdata.distance = f ? Math.sqrt( 1 / f ) : 0;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildLight( data ) {\n\n\t\t\tlet light;\n\n\t\t\tswitch ( data.technique ) {\n\n\t\t\t\tcase 'directional':\n\t\t\t\t\tlight = new DirectionalLight();\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'point':\n\t\t\t\t\tlight = new PointLight();\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'spot':\n\t\t\t\t\tlight = new SpotLight();\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'ambient':\n\t\t\t\t\tlight = new AmbientLight();\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tif ( data.parameters.color ) light.color.copy( data.parameters.color );\n\t\t\tif ( data.parameters.distance ) light.distance = data.parameters.distance;\n\n\t\t\treturn light;\n\n\t\t}\n\n\t\tfunction getLight( id ) {\n\n\t\t\tconst data = library.lights[ id ];\n\n\t\t\tif ( data !== undefined ) {\n\n\t\t\t\treturn getBuild( data, buildLight );\n\n\t\t\t}\n\n\t\t\tconsole.warn( 'THREE.ColladaLoader: Couldn\\'t find light with ID:', id );\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\t// geometry\n\n\t\tfunction parseGeometry( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' ),\n\t\t\t\tsources: {},\n\t\t\t\tvertices: {},\n\t\t\t\tprimitives: []\n\t\t\t};\n\n\t\t\tconst mesh = getElementsByTagName( xml, 'mesh' )[ 0 ];\n\n\t\t\t// the following tags inside geometry are not supported yet (see https://github.com/mrdoob/three.js/pull/12606): convex_mesh, spline, brep\n\t\t\tif ( mesh === undefined ) return;\n\n\t\t\tfor ( let i = 0; i < mesh.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = mesh.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tconst id = child.getAttribute( 'id' );\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'source':\n\t\t\t\t\t\tdata.sources[ id ] = parseSource( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'vertices':\n\t\t\t\t\t\t// data.sources[ id ] = data.sources[ parseId( getElementsByTagName( child, 'input' )[ 0 ].getAttribute( 'source' ) ) ];\n\t\t\t\t\t\tdata.vertices = parseGeometryVertices( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'polygons':\n\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Unsupported primitive type: ', child.nodeName );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'lines':\n\t\t\t\t\tcase 'linestrips':\n\t\t\t\t\tcase 'polylist':\n\t\t\t\t\tcase 'triangles':\n\t\t\t\t\t\tdata.primitives.push( parseGeometryPrimitive( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.log( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.geometries[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction parseSource( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tarray: [],\n\t\t\t\tstride: 3\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'float_array':\n\t\t\t\t\t\tdata.array = parseFloats( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'Name_array':\n\t\t\t\t\t\tdata.array = parseStrings( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'technique_common':\n\t\t\t\t\t\tconst accessor = getElementsByTagName( child, 'accessor' )[ 0 ];\n\n\t\t\t\t\t\tif ( accessor !== undefined ) {\n\n\t\t\t\t\t\t\tdata.stride = parseInt( accessor.getAttribute( 'stride' ) );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseGeometryVertices( xml ) {\n\n\t\t\tconst data = {};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tdata[ child.getAttribute( 'semantic' ) ] = parseId( child.getAttribute( 'source' ) );\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseGeometryPrimitive( xml ) {\n\n\t\t\tconst primitive = {\n\t\t\t\ttype: xml.nodeName,\n\t\t\t\tmaterial: xml.getAttribute( 'material' ),\n\t\t\t\tcount: parseInt( xml.getAttribute( 'count' ) ),\n\t\t\t\tinputs: {},\n\t\t\t\tstride: 0,\n\t\t\t\thasUV: false\n\t\t\t};\n\n\t\t\tfor ( let i = 0, l = xml.childNodes.length; i < l; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'input':\n\t\t\t\t\t\tconst id = parseId( child.getAttribute( 'source' ) );\n\t\t\t\t\t\tconst semantic = child.getAttribute( 'semantic' );\n\t\t\t\t\t\tconst offset = parseInt( child.getAttribute( 'offset' ) );\n\t\t\t\t\t\tconst set = parseInt( child.getAttribute( 'set' ) );\n\t\t\t\t\t\tconst inputname = ( set > 0 ? semantic + set : semantic );\n\t\t\t\t\t\tprimitive.inputs[ inputname ] = { id: id, offset: offset };\n\t\t\t\t\t\tprimitive.stride = Math.max( primitive.stride, offset + 1 );\n\t\t\t\t\t\tif ( semantic === 'TEXCOORD' ) primitive.hasUV = true;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'vcount':\n\t\t\t\t\t\tprimitive.vcount = parseInts( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'p':\n\t\t\t\t\t\tprimitive.p = parseInts( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn primitive;\n\n\t\t}\n\n\t\tfunction groupPrimitives( primitives ) {\n\n\t\t\tconst build = {};\n\n\t\t\tfor ( let i = 0; i < primitives.length; i ++ ) {\n\n\t\t\t\tconst primitive = primitives[ i ];\n\n\t\t\t\tif ( build[ primitive.type ] === undefined ) build[ primitive.type ] = [];\n\n\t\t\t\tbuild[ primitive.type ].push( primitive );\n\n\t\t\t}\n\n\t\t\treturn build;\n\n\t\t}\n\n\t\tfunction checkUVCoordinates( primitives ) {\n\n\t\t\tlet count = 0;\n\n\t\t\tfor ( let i = 0, l = primitives.length; i < l; i ++ ) {\n\n\t\t\t\tconst primitive = primitives[ i ];\n\n\t\t\t\tif ( primitive.hasUV === true ) {\n\n\t\t\t\t\tcount ++;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( count > 0 && count < primitives.length ) {\n\n\t\t\t\tprimitives.uvsNeedsFix = true;\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction buildGeometry( data ) {\n\n\t\t\tconst build = {};\n\n\t\t\tconst sources = data.sources;\n\t\t\tconst vertices = data.vertices;\n\t\t\tconst primitives = data.primitives;\n\n\t\t\tif ( primitives.length === 0 ) return {};\n\n\t\t\t// our goal is to create one buffer geometry for a single type of primitives\n\t\t\t// first, we group all primitives by their type\n\n\t\t\tconst groupedPrimitives = groupPrimitives( primitives );\n\n\t\t\tfor ( const type in groupedPrimitives ) {\n\n\t\t\t\tconst primitiveType = groupedPrimitives[ type ];\n\n\t\t\t\t// second, ensure consistent uv coordinates for each type of primitives (polylist,triangles or lines)\n\n\t\t\t\tcheckUVCoordinates( primitiveType );\n\n\t\t\t\t// third, create a buffer geometry for each type of primitives\n\n\t\t\t\tbuild[ type ] = buildGeometryType( primitiveType, sources, vertices );\n\n\t\t\t}\n\n\t\t\treturn build;\n\n\t\t}\n\n\t\tfunction buildGeometryType( primitives, sources, vertices ) {\n\n\t\t\tconst build = {};\n\n\t\t\tconst position = { array: [], stride: 0 };\n\t\t\tconst normal = { array: [], stride: 0 };\n\t\t\tconst uv = { array: [], stride: 0 };\n\t\t\tconst uv1 = { array: [], stride: 0 };\n\t\t\tconst color = { array: [], stride: 0 };\n\n\t\t\tconst skinIndex = { array: [], stride: 4 };\n\t\t\tconst skinWeight = { array: [], stride: 4 };\n\n\t\t\tconst geometry = new BufferGeometry();\n\n\t\t\tconst materialKeys = [];\n\n\t\t\tlet start = 0;\n\n\t\t\tfor ( let p = 0; p < primitives.length; p ++ ) {\n\n\t\t\t\tconst primitive = primitives[ p ];\n\t\t\t\tconst inputs = primitive.inputs;\n\n\t\t\t\t// groups\n\n\t\t\t\tlet count = 0;\n\n\t\t\t\tswitch ( primitive.type ) {\n\n\t\t\t\t\tcase 'lines':\n\t\t\t\t\tcase 'linestrips':\n\t\t\t\t\t\tcount = primitive.count * 2;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'triangles':\n\t\t\t\t\t\tcount = primitive.count * 3;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'polylist':\n\n\t\t\t\t\t\tfor ( let g = 0; g < primitive.count; g ++ ) {\n\n\t\t\t\t\t\t\tconst vc = primitive.vcount[ g ];\n\n\t\t\t\t\t\t\tswitch ( vc ) {\n\n\t\t\t\t\t\t\t\tcase 3:\n\t\t\t\t\t\t\t\t\tcount += 3; // single triangle\n\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\tcase 4:\n\t\t\t\t\t\t\t\t\tcount += 6; // quad, subdivided into two triangles\n\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\tcount += ( vc - 2 ) * 3; // polylist with more than four vertices\n\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Unknown primitive type:', primitive.type );\n\n\t\t\t\t}\n\n\t\t\t\tgeometry.addGroup( start, count, p );\n\t\t\t\tstart += count;\n\n\t\t\t\t// material\n\n\t\t\t\tif ( primitive.material ) {\n\n\t\t\t\t\tmaterialKeys.push( primitive.material );\n\n\t\t\t\t}\n\n\t\t\t\t// geometry data\n\n\t\t\t\tfor ( const name in inputs ) {\n\n\t\t\t\t\tconst input = inputs[ name ];\n\n\t\t\t\t\tswitch ( name )\t{\n\n\t\t\t\t\t\tcase 'VERTEX':\n\t\t\t\t\t\t\tfor ( const key in vertices ) {\n\n\t\t\t\t\t\t\t\tconst id = vertices[ key ];\n\n\t\t\t\t\t\t\t\tswitch ( key ) {\n\n\t\t\t\t\t\t\t\t\tcase 'POSITION':\n\t\t\t\t\t\t\t\t\t\tconst prevLength = position.array.length;\n\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ id ], input.offset, position.array );\n\t\t\t\t\t\t\t\t\t\tposition.stride = sources[ id ].stride;\n\n\t\t\t\t\t\t\t\t\t\tif ( sources.skinWeights && sources.skinIndices ) {\n\n\t\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources.skinIndices, input.offset, skinIndex.array );\n\t\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources.skinWeights, input.offset, skinWeight.array );\n\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t// see #3803\n\n\t\t\t\t\t\t\t\t\t\tif ( primitive.hasUV === false && primitives.uvsNeedsFix === true ) {\n\n\t\t\t\t\t\t\t\t\t\t\tconst count = ( position.array.length - prevLength ) / position.stride;\n\n\t\t\t\t\t\t\t\t\t\t\tfor ( let i = 0; i < count; i ++ ) {\n\n\t\t\t\t\t\t\t\t\t\t\t\t// fill missing uv coordinates\n\n\t\t\t\t\t\t\t\t\t\t\t\tuv.array.push( 0, 0 );\n\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\tcase 'NORMAL':\n\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ id ], input.offset, normal.array );\n\t\t\t\t\t\t\t\t\t\tnormal.stride = sources[ id ].stride;\n\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\tcase 'COLOR':\n\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ id ], input.offset, color.array );\n\t\t\t\t\t\t\t\t\t\tcolor.stride = sources[ id ].stride;\n\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\tcase 'TEXCOORD':\n\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ id ], input.offset, uv.array );\n\t\t\t\t\t\t\t\t\t\tuv.stride = sources[ id ].stride;\n\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\tcase 'TEXCOORD1':\n\t\t\t\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ id ], input.offset, uv1.array );\n\t\t\t\t\t\t\t\t\t\tuv.stride = sources[ id ].stride;\n\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Semantic \"%s\" not handled in geometry build process.', key );\n\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'NORMAL':\n\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ input.id ], input.offset, normal.array );\n\t\t\t\t\t\t\tnormal.stride = sources[ input.id ].stride;\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'COLOR':\n\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ input.id ], input.offset, color.array, true );\n\t\t\t\t\t\t\tcolor.stride = sources[ input.id ].stride;\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'TEXCOORD':\n\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ input.id ], input.offset, uv.array );\n\t\t\t\t\t\t\tuv.stride = sources[ input.id ].stride;\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'TEXCOORD1':\n\t\t\t\t\t\t\tbuildGeometryData( primitive, sources[ input.id ], input.offset, uv1.array );\n\t\t\t\t\t\t\tuv1.stride = sources[ input.id ].stride;\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// build geometry\n\n\t\t\tif ( position.array.length > 0 ) geometry.setAttribute( 'position', new Float32BufferAttribute( position.array, position.stride ) );\n\t\t\tif ( normal.array.length > 0 ) geometry.setAttribute( 'normal', new Float32BufferAttribute( normal.array, normal.stride ) );\n\t\t\tif ( color.array.length > 0 ) geometry.setAttribute( 'color', new Float32BufferAttribute( color.array, color.stride ) );\n\t\t\tif ( uv.array.length > 0 ) geometry.setAttribute( 'uv', new Float32BufferAttribute( uv.array, uv.stride ) );\n\t\t\tif ( uv1.array.length > 0 ) geometry.setAttribute( 'uv1', new Float32BufferAttribute( uv1.array, uv1.stride ) );\n\n\t\t\tif ( skinIndex.array.length > 0 ) geometry.setAttribute( 'skinIndex', new Float32BufferAttribute( skinIndex.array, skinIndex.stride ) );\n\t\t\tif ( skinWeight.array.length > 0 ) geometry.setAttribute( 'skinWeight', new Float32BufferAttribute( skinWeight.array, skinWeight.stride ) );\n\n\t\t\tbuild.data = geometry;\n\t\t\tbuild.type = primitives[ 0 ].type;\n\t\t\tbuild.materialKeys = materialKeys;\n\n\t\t\treturn build;\n\n\t\t}\n\n\t\tfunction buildGeometryData( primitive, source, offset, array, isColor = false ) {\n\n\t\t\tconst indices = primitive.p;\n\t\t\tconst stride = primitive.stride;\n\t\t\tconst vcount = primitive.vcount;\n\n\t\t\tfunction pushVector( i ) {\n\n\t\t\t\tlet index = indices[ i + offset ] * sourceStride;\n\t\t\t\tconst length = index + sourceStride;\n\n\t\t\t\tfor ( ; index < length; index ++ ) {\n\n\t\t\t\t\tarray.push( sourceArray[ index ] );\n\n\t\t\t\t}\n\n\t\t\t\tif ( isColor ) {\n\n\t\t\t\t\t// convert the vertex colors from srgb to linear if present\n\t\t\t\t\tconst startIndex = array.length - sourceStride - 1;\n\t\t\t\t\ttempColor.setRGB(\n\t\t\t\t\t\tarray[ startIndex + 0 ],\n\t\t\t\t\t\tarray[ startIndex + 1 ],\n\t\t\t\t\t\tarray[ startIndex + 2 ],\n\t\t\t\t\t\tSRGBColorSpace\n\t\t\t\t\t);\n\n\t\t\t\t\tarray[ startIndex + 0 ] = tempColor.r;\n\t\t\t\t\tarray[ startIndex + 1 ] = tempColor.g;\n\t\t\t\t\tarray[ startIndex + 2 ] = tempColor.b;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tconst sourceArray = source.array;\n\t\t\tconst sourceStride = source.stride;\n\n\t\t\tif ( primitive.vcount !== undefined ) {\n\n\t\t\t\tlet index = 0;\n\n\t\t\t\tfor ( let i = 0, l = vcount.length; i < l; i ++ ) {\n\n\t\t\t\t\tconst count = vcount[ i ];\n\n\t\t\t\t\tif ( count === 4 ) {\n\n\t\t\t\t\t\tconst a = index + stride * 0;\n\t\t\t\t\t\tconst b = index + stride * 1;\n\t\t\t\t\t\tconst c = index + stride * 2;\n\t\t\t\t\t\tconst d = index + stride * 3;\n\n\t\t\t\t\t\tpushVector( a ); pushVector( b ); pushVector( d );\n\t\t\t\t\t\tpushVector( b ); pushVector( c ); pushVector( d );\n\n\t\t\t\t\t} else if ( count === 3 ) {\n\n\t\t\t\t\t\tconst a = index + stride * 0;\n\t\t\t\t\t\tconst b = index + stride * 1;\n\t\t\t\t\t\tconst c = index + stride * 2;\n\n\t\t\t\t\t\tpushVector( a ); pushVector( b ); pushVector( c );\n\n\t\t\t\t\t} else if ( count > 4 ) {\n\n\t\t\t\t\t\tfor ( let k = 1, kl = ( count - 2 ); k <= kl; k ++ ) {\n\n\t\t\t\t\t\t\tconst a = index + stride * 0;\n\t\t\t\t\t\t\tconst b = index + stride * k;\n\t\t\t\t\t\t\tconst c = index + stride * ( k + 1 );\n\n\t\t\t\t\t\t\tpushVector( a ); pushVector( b ); pushVector( c );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tindex += stride * count;\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tfor ( let i = 0, l = indices.length; i < l; i += stride ) {\n\n\t\t\t\t\tpushVector( i );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction getGeometry( id ) {\n\n\t\t\treturn getBuild( library.geometries[ id ], buildGeometry );\n\n\t\t}\n\n\t\t// kinematics\n\n\t\tfunction parseKinematicsModel( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' ) || '',\n\t\t\t\tjoints: {},\n\t\t\t\tlinks: []\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'technique_common':\n\t\t\t\t\t\tparseKinematicsTechniqueCommon( child, data );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.kinematicsModels[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction buildKinematicsModel( data ) {\n\n\t\t\tif ( data.build !== undefined ) return data.build;\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction getKinematicsModel( id ) {\n\n\t\t\treturn getBuild( library.kinematicsModels[ id ], buildKinematicsModel );\n\n\t\t}\n\n\t\tfunction parseKinematicsTechniqueCommon( xml, data ) {\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'joint':\n\t\t\t\t\t\tdata.joints[ child.getAttribute( 'sid' ) ] = parseKinematicsJoint( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'link':\n\t\t\t\t\t\tdata.links.push( parseKinematicsLink( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parseKinematicsJoint( xml ) {\n\n\t\t\tlet data;\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'prismatic':\n\t\t\t\t\tcase 'revolute':\n\t\t\t\t\t\tdata = parseKinematicsJointParameter( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseKinematicsJointParameter( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tsid: xml.getAttribute( 'sid' ),\n\t\t\t\tname: xml.getAttribute( 'name' ) || '',\n\t\t\t\taxis: new Vector3(),\n\t\t\t\tlimits: {\n\t\t\t\t\tmin: 0,\n\t\t\t\t\tmax: 0\n\t\t\t\t},\n\t\t\t\ttype: xml.nodeName,\n\t\t\t\tstatic: false,\n\t\t\t\tzeroPosition: 0,\n\t\t\t\tmiddlePosition: 0\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'axis':\n\t\t\t\t\t\tconst array = parseFloats( child.textContent );\n\t\t\t\t\t\tdata.axis.fromArray( array );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'limits':\n\t\t\t\t\t\tconst max = child.getElementsByTagName( 'max' )[ 0 ];\n\t\t\t\t\t\tconst min = child.getElementsByTagName( 'min' )[ 0 ];\n\n\t\t\t\t\t\tdata.limits.max = parseFloat( max.textContent );\n\t\t\t\t\t\tdata.limits.min = parseFloat( min.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// if min is equal to or greater than max, consider the joint static\n\n\t\t\tif ( data.limits.min >= data.limits.max ) {\n\n\t\t\t\tdata.static = true;\n\n\t\t\t}\n\n\t\t\t// calculate middle position\n\n\t\t\tdata.middlePosition = ( data.limits.min + data.limits.max ) / 2.0;\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseKinematicsLink( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tsid: xml.getAttribute( 'sid' ),\n\t\t\t\tname: xml.getAttribute( 'name' ) || '',\n\t\t\t\tattachments: [],\n\t\t\t\ttransforms: []\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'attachment_full':\n\t\t\t\t\t\tdata.attachments.push( parseKinematicsAttachment( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'matrix':\n\t\t\t\t\tcase 'translate':\n\t\t\t\t\tcase 'rotate':\n\t\t\t\t\t\tdata.transforms.push( parseKinematicsTransform( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseKinematicsAttachment( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tjoint: xml.getAttribute( 'joint' ).split( '/' ).pop(),\n\t\t\t\ttransforms: [],\n\t\t\t\tlinks: []\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'link':\n\t\t\t\t\t\tdata.links.push( parseKinematicsLink( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'matrix':\n\t\t\t\t\tcase 'translate':\n\t\t\t\t\tcase 'rotate':\n\t\t\t\t\t\tdata.transforms.push( parseKinematicsTransform( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseKinematicsTransform( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\ttype: xml.nodeName\n\t\t\t};\n\n\t\t\tconst array = parseFloats( xml.textContent );\n\n\t\t\tswitch ( data.type ) {\n\n\t\t\t\tcase 'matrix':\n\t\t\t\t\tdata.obj = new Matrix4();\n\t\t\t\t\tdata.obj.fromArray( array ).transpose();\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'translate':\n\t\t\t\t\tdata.obj = new Vector3();\n\t\t\t\t\tdata.obj.fromArray( array );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'rotate':\n\t\t\t\t\tdata.obj = new Vector3();\n\t\t\t\t\tdata.obj.fromArray( array );\n\t\t\t\t\tdata.angle = MathUtils.degToRad( array[ 3 ] );\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\t// physics\n\n\t\tfunction parsePhysicsModel( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' ) || '',\n\t\t\t\trigidBodies: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'rigid_body':\n\t\t\t\t\t\tdata.rigidBodies[ child.getAttribute( 'name' ) ] = {};\n\t\t\t\t\t\tparsePhysicsRigidBody( child, data.rigidBodies[ child.getAttribute( 'name' ) ] );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.physicsModels[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction parsePhysicsRigidBody( xml, data ) {\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'technique_common':\n\t\t\t\t\t\tparsePhysicsTechniqueCommon( child, data );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tfunction parsePhysicsTechniqueCommon( xml, data ) {\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'inertia':\n\t\t\t\t\t\tdata.inertia = parseFloats( child.textContent );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'mass':\n\t\t\t\t\t\tdata.mass = parseFloats( child.textContent )[ 0 ];\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\t// scene\n\n\t\tfunction parseKinematicsScene( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tbindJointAxis: []\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'bind_joint_axis':\n\t\t\t\t\t\tdata.bindJointAxis.push( parseKinematicsBindJointAxis( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tlibrary.kinematicsScenes[ parseId( xml.getAttribute( 'url' ) ) ] = data;\n\n\t\t}\n\n\t\tfunction parseKinematicsBindJointAxis( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\ttarget: xml.getAttribute( 'target' ).split( '/' ).pop()\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'axis':\n\t\t\t\t\t\tconst param = child.getElementsByTagName( 'param' )[ 0 ];\n\t\t\t\t\t\tdata.axis = param.textContent;\n\t\t\t\t\t\tconst tmpJointIndex = data.axis.split( 'inst_' ).pop().split( 'axis' )[ 0 ];\n\t\t\t\t\t\tdata.jointIndex = tmpJointIndex.substring( 0, tmpJointIndex.length - 1 );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildKinematicsScene( data ) {\n\n\t\t\tif ( data.build !== undefined ) return data.build;\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction getKinematicsScene( id ) {\n\n\t\t\treturn getBuild( library.kinematicsScenes[ id ], buildKinematicsScene );\n\n\t\t}\n\n\t\tfunction setupKinematics() {\n\n\t\t\tconst kinematicsModelId = Object.keys( library.kinematicsModels )[ 0 ];\n\t\t\tconst kinematicsSceneId = Object.keys( library.kinematicsScenes )[ 0 ];\n\t\t\tconst visualSceneId = Object.keys( library.visualScenes )[ 0 ];\n\n\t\t\tif ( kinematicsModelId === undefined || kinematicsSceneId === undefined ) return;\n\n\t\t\tconst kinematicsModel = getKinematicsModel( kinematicsModelId );\n\t\t\tconst kinematicsScene = getKinematicsScene( kinematicsSceneId );\n\t\t\tconst visualScene = getVisualScene( visualSceneId );\n\n\t\t\tconst bindJointAxis = kinematicsScene.bindJointAxis;\n\t\t\tconst jointMap = {};\n\n\t\t\tfor ( let i = 0, l = bindJointAxis.length; i < l; i ++ ) {\n\n\t\t\t\tconst axis = bindJointAxis[ i ];\n\n\t\t\t\t// the result of the following query is an element of type 'translate', 'rotate','scale' or 'matrix'\n\n\t\t\t\tconst targetElement = collada.querySelector( '[sid=\"' + axis.target + '\"]' );\n\n\t\t\t\tif ( targetElement ) {\n\n\t\t\t\t\t// get the parent of the transform element\n\n\t\t\t\t\tconst parentVisualElement = targetElement.parentElement;\n\n\t\t\t\t\t// connect the joint of the kinematics model with the element in the visual scene\n\n\t\t\t\t\tconnect( axis.jointIndex, parentVisualElement );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tfunction connect( jointIndex, visualElement ) {\n\n\t\t\t\tconst visualElementName = visualElement.getAttribute( 'name' );\n\t\t\t\tconst joint = kinematicsModel.joints[ jointIndex ];\n\n\t\t\t\tvisualScene.traverse( function ( object ) {\n\n\t\t\t\t\tif ( object.name === visualElementName ) {\n\n\t\t\t\t\t\tjointMap[ jointIndex ] = {\n\t\t\t\t\t\t\tobject: object,\n\t\t\t\t\t\t\ttransforms: buildTransformList( visualElement ),\n\t\t\t\t\t\t\tjoint: joint,\n\t\t\t\t\t\t\tposition: joint.zeroPosition\n\t\t\t\t\t\t};\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\tconst m0 = new Matrix4();\n\n\t\t\tkinematics = {\n\n\t\t\t\tjoints: kinematicsModel && kinematicsModel.joints,\n\n\t\t\t\tgetJointValue: function ( jointIndex ) {\n\n\t\t\t\t\tconst jointData = jointMap[ jointIndex ];\n\n\t\t\t\t\tif ( jointData ) {\n\n\t\t\t\t\t\treturn jointData.position;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Joint ' + jointIndex + ' doesn\\'t exist.' );\n\n\t\t\t\t\t}\n\n\t\t\t\t},\n\n\t\t\t\tsetJointValue: function ( jointIndex, value ) {\n\n\t\t\t\t\tconst jointData = jointMap[ jointIndex ];\n\n\t\t\t\t\tif ( jointData ) {\n\n\t\t\t\t\t\tconst joint = jointData.joint;\n\n\t\t\t\t\t\tif ( value > joint.limits.max || value < joint.limits.min ) {\n\n\t\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Joint ' + jointIndex + ' value ' + value + ' outside of limits (min: ' + joint.limits.min + ', max: ' + joint.limits.max + ').' );\n\n\t\t\t\t\t\t} else if ( joint.static ) {\n\n\t\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Joint ' + jointIndex + ' is static.' );\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tconst object = jointData.object;\n\t\t\t\t\t\t\tconst axis = joint.axis;\n\t\t\t\t\t\t\tconst transforms = jointData.transforms;\n\n\t\t\t\t\t\t\tmatrix.identity();\n\n\t\t\t\t\t\t\t// each update, we have to apply all transforms in the correct order\n\n\t\t\t\t\t\t\tfor ( let i = 0; i < transforms.length; i ++ ) {\n\n\t\t\t\t\t\t\t\tconst transform = transforms[ i ];\n\n\t\t\t\t\t\t\t\t// if there is a connection of the transform node with a joint, apply the joint value\n\n\t\t\t\t\t\t\t\tif ( transform.sid && transform.sid.indexOf( jointIndex ) !== - 1 ) {\n\n\t\t\t\t\t\t\t\t\tswitch ( joint.type ) {\n\n\t\t\t\t\t\t\t\t\t\tcase 'revolute':\n\t\t\t\t\t\t\t\t\t\t\tmatrix.multiply( m0.makeRotationAxis( axis, MathUtils.degToRad( value ) ) );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\tcase 'prismatic':\n\t\t\t\t\t\t\t\t\t\t\tmatrix.multiply( m0.makeTranslation( axis.x * value, axis.y * value, axis.z * value ) );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Unknown joint type: ' + joint.type );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\t\t\tswitch ( transform.type ) {\n\n\t\t\t\t\t\t\t\t\t\tcase 'matrix':\n\t\t\t\t\t\t\t\t\t\t\tmatrix.multiply( transform.obj );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\tcase 'translate':\n\t\t\t\t\t\t\t\t\t\t\tmatrix.multiply( m0.makeTranslation( transform.obj.x, transform.obj.y, transform.obj.z ) );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\tcase 'scale':\n\t\t\t\t\t\t\t\t\t\t\tmatrix.scale( transform.obj );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\tcase 'rotate':\n\t\t\t\t\t\t\t\t\t\t\tmatrix.multiply( m0.makeRotationAxis( transform.obj, transform.angle ) );\n\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tobject.matrix.copy( matrix );\n\t\t\t\t\t\t\tobject.matrix.decompose( object.position, object.quaternion, object.scale );\n\n\t\t\t\t\t\t\tjointMap[ jointIndex ].position = value;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tconsole.log( 'THREE.ColladaLoader: ' + jointIndex + ' does not exist.' );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t};\n\n\t\t}\n\n\t\tfunction buildTransformList( node ) {\n\n\t\t\tconst transforms = [];\n\n\t\t\tconst xml = collada.querySelector( '[id=\"' + node.id + '\"]' );\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tlet array, vector;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'matrix':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tconst matrix = new Matrix4().fromArray( array ).transpose();\n\t\t\t\t\t\ttransforms.push( {\n\t\t\t\t\t\t\tsid: child.getAttribute( 'sid' ),\n\t\t\t\t\t\t\ttype: child.nodeName,\n\t\t\t\t\t\t\tobj: matrix\n\t\t\t\t\t\t} );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'translate':\n\t\t\t\t\tcase 'scale':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tvector = new Vector3().fromArray( array );\n\t\t\t\t\t\ttransforms.push( {\n\t\t\t\t\t\t\tsid: child.getAttribute( 'sid' ),\n\t\t\t\t\t\t\ttype: child.nodeName,\n\t\t\t\t\t\t\tobj: vector\n\t\t\t\t\t\t} );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'rotate':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tvector = new Vector3().fromArray( array );\n\t\t\t\t\t\tconst angle = MathUtils.degToRad( array[ 3 ] );\n\t\t\t\t\t\ttransforms.push( {\n\t\t\t\t\t\t\tsid: child.getAttribute( 'sid' ),\n\t\t\t\t\t\t\ttype: child.nodeName,\n\t\t\t\t\t\t\tobj: vector,\n\t\t\t\t\t\t\tangle: angle\n\t\t\t\t\t\t} );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn transforms;\n\n\t\t}\n\n\t\t// nodes\n\n\t\tfunction prepareNodes( xml ) {\n\n\t\t\tconst elements = xml.getElementsByTagName( 'node' );\n\n\t\t\t// ensure all node elements have id attributes\n\n\t\t\tfor ( let i = 0; i < elements.length; i ++ ) {\n\n\t\t\t\tconst element = elements[ i ];\n\n\t\t\t\tif ( element.hasAttribute( 'id' ) === false ) {\n\n\t\t\t\t\telement.setAttribute( 'id', generateId() );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tconst matrix = new Matrix4();\n\t\tconst vector = new Vector3();\n\n\t\tfunction parseNode( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' ) || '',\n\t\t\t\ttype: xml.getAttribute( 'type' ),\n\t\t\t\tid: xml.getAttribute( 'id' ),\n\t\t\t\tsid: xml.getAttribute( 'sid' ),\n\t\t\t\tmatrix: new Matrix4(),\n\t\t\t\tnodes: [],\n\t\t\t\tinstanceCameras: [],\n\t\t\t\tinstanceControllers: [],\n\t\t\t\tinstanceLights: [],\n\t\t\t\tinstanceGeometries: [],\n\t\t\t\tinstanceNodes: [],\n\t\t\t\ttransforms: {}\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tif ( child.nodeType !== 1 ) continue;\n\n\t\t\t\tlet array;\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'node':\n\t\t\t\t\t\tdata.nodes.push( child.getAttribute( 'id' ) );\n\t\t\t\t\t\tparseNode( child );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'instance_camera':\n\t\t\t\t\t\tdata.instanceCameras.push( parseId( child.getAttribute( 'url' ) ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'instance_controller':\n\t\t\t\t\t\tdata.instanceControllers.push( parseNodeInstance( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'instance_light':\n\t\t\t\t\t\tdata.instanceLights.push( parseId( child.getAttribute( 'url' ) ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'instance_geometry':\n\t\t\t\t\t\tdata.instanceGeometries.push( parseNodeInstance( child ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'instance_node':\n\t\t\t\t\t\tdata.instanceNodes.push( parseId( child.getAttribute( 'url' ) ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'matrix':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tdata.matrix.multiply( matrix.fromArray( array ).transpose() );\n\t\t\t\t\t\tdata.transforms[ child.getAttribute( 'sid' ) ] = child.nodeName;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'translate':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tvector.fromArray( array );\n\t\t\t\t\t\tdata.matrix.multiply( matrix.makeTranslation( vector.x, vector.y, vector.z ) );\n\t\t\t\t\t\tdata.transforms[ child.getAttribute( 'sid' ) ] = child.nodeName;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'rotate':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tconst angle = MathUtils.degToRad( array[ 3 ] );\n\t\t\t\t\t\tdata.matrix.multiply( matrix.makeRotationAxis( vector.fromArray( array ), angle ) );\n\t\t\t\t\t\tdata.transforms[ child.getAttribute( 'sid' ) ] = child.nodeName;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'scale':\n\t\t\t\t\t\tarray = parseFloats( child.textContent );\n\t\t\t\t\t\tdata.matrix.scale( vector.fromArray( array ) );\n\t\t\t\t\t\tdata.transforms[ child.getAttribute( 'sid' ) ] = child.nodeName;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'extra':\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.log( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( hasNode( data.id ) ) {\n\n\t\t\t\tconsole.warn( 'THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.', data.id );\n\n\t\t\t} else {\n\n\t\t\t\tlibrary.nodes[ data.id ] = data;\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction parseNodeInstance( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tid: parseId( xml.getAttribute( 'url' ) ),\n\t\t\t\tmaterials: {},\n\t\t\t\tskeletons: []\n\t\t\t};\n\n\t\t\tfor ( let i = 0; i < xml.childNodes.length; i ++ ) {\n\n\t\t\t\tconst child = xml.childNodes[ i ];\n\n\t\t\t\tswitch ( child.nodeName ) {\n\n\t\t\t\t\tcase 'bind_material':\n\t\t\t\t\t\tconst instances = child.getElementsByTagName( 'instance_material' );\n\n\t\t\t\t\t\tfor ( let j = 0; j < instances.length; j ++ ) {\n\n\t\t\t\t\t\t\tconst instance = instances[ j ];\n\t\t\t\t\t\t\tconst symbol = instance.getAttribute( 'symbol' );\n\t\t\t\t\t\t\tconst target = instance.getAttribute( 'target' );\n\n\t\t\t\t\t\t\tdata.materials[ symbol ] = parseId( target );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'skeleton':\n\t\t\t\t\t\tdata.skeletons.push( parseId( child.textContent ) );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t\tfunction buildSkeleton( skeletons, joints ) {\n\n\t\t\tconst boneData = [];\n\t\t\tconst sortedBoneData = [];\n\n\t\t\tlet i, j, data;\n\n\t\t\t// a skeleton can have multiple root bones. collada expresses this\n\t\t\t// situation with multiple \"skeleton\" tags per controller instance\n\n\t\t\tfor ( i = 0; i < skeletons.length; i ++ ) {\n\n\t\t\t\tconst skeleton = skeletons[ i ];\n\n\t\t\t\tlet root;\n\n\t\t\t\tif ( hasNode( skeleton ) ) {\n\n\t\t\t\t\troot = getNode( skeleton );\n\t\t\t\t\tbuildBoneHierarchy( root, joints, boneData );\n\n\t\t\t\t} else if ( hasVisualScene( skeleton ) ) {\n\n\t\t\t\t\t// handle case where the skeleton refers to the visual scene (#13335)\n\n\t\t\t\t\tconst visualScene = library.visualScenes[ skeleton ];\n\t\t\t\t\tconst children = visualScene.children;\n\n\t\t\t\t\tfor ( let j = 0; j < children.length; j ++ ) {\n\n\t\t\t\t\t\tconst child = children[ j ];\n\n\t\t\t\t\t\tif ( child.type === 'JOINT' ) {\n\n\t\t\t\t\t\t\tconst root = getNode( child.id );\n\t\t\t\t\t\t\tbuildBoneHierarchy( root, joints, boneData );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.error( 'THREE.ColladaLoader: Unable to find root bone of skeleton with ID:', skeleton );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// sort bone data (the order is defined in the corresponding controller)\n\n\t\t\tfor ( i = 0; i < joints.length; i ++ ) {\n\n\t\t\t\tfor ( j = 0; j < boneData.length; j ++ ) {\n\n\t\t\t\t\tdata = boneData[ j ];\n\n\t\t\t\t\tif ( data.bone.name === joints[ i ].name ) {\n\n\t\t\t\t\t\tsortedBoneData[ i ] = data;\n\t\t\t\t\t\tdata.processed = true;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// add unprocessed bone data at the end of the list\n\n\t\t\tfor ( i = 0; i < boneData.length; i ++ ) {\n\n\t\t\t\tdata = boneData[ i ];\n\n\t\t\t\tif ( data.processed === false ) {\n\n\t\t\t\t\tsortedBoneData.push( data );\n\t\t\t\t\tdata.processed = true;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// setup arrays for skeleton creation\n\n\t\t\tconst bones = [];\n\t\t\tconst boneInverses = [];\n\n\t\t\tfor ( i = 0; i < sortedBoneData.length; i ++ ) {\n\n\t\t\t\tdata = sortedBoneData[ i ];\n\n\t\t\t\tbones.push( data.bone );\n\t\t\t\tboneInverses.push( data.boneInverse );\n\n\t\t\t}\n\n\t\t\treturn new Skeleton( bones, boneInverses );\n\n\t\t}\n\n\t\tfunction buildBoneHierarchy( root, joints, boneData ) {\n\n\t\t\t// setup bone data from visual scene\n\n\t\t\troot.traverse( function ( object ) {\n\n\t\t\t\tif ( object.isBone === true ) {\n\n\t\t\t\t\tlet boneInverse;\n\n\t\t\t\t\t// retrieve the boneInverse from the controller data\n\n\t\t\t\t\tfor ( let i = 0; i < joints.length; i ++ ) {\n\n\t\t\t\t\t\tconst joint = joints[ i ];\n\n\t\t\t\t\t\tif ( joint.name === object.name ) {\n\n\t\t\t\t\t\t\tboneInverse = joint.boneInverse;\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( boneInverse === undefined ) {\n\n\t\t\t\t\t\t// Unfortunately, there can be joints in the visual scene that are not part of the\n\t\t\t\t\t\t// corresponding controller. In this case, we have to create a dummy boneInverse matrix\n\t\t\t\t\t\t// for the respective bone. This bone won't affect any vertices, because there are no skin indices\n\t\t\t\t\t\t// and weights defined for it. But we still have to add the bone to the sorted bone list in order to\n\t\t\t\t\t\t// ensure a correct animation of the model.\n\n\t\t\t\t\t\tboneInverse = new Matrix4();\n\n\t\t\t\t\t}\n\n\t\t\t\t\tboneData.push( { bone: object, boneInverse: boneInverse, processed: false } );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t}\n\n\t\tfunction buildNode( data ) {\n\n\t\t\tconst objects = [];\n\n\t\t\tconst matrix = data.matrix;\n\t\t\tconst nodes = data.nodes;\n\t\t\tconst type = data.type;\n\t\t\tconst instanceCameras = data.instanceCameras;\n\t\t\tconst instanceControllers = data.instanceControllers;\n\t\t\tconst instanceLights = data.instanceLights;\n\t\t\tconst instanceGeometries = data.instanceGeometries;\n\t\t\tconst instanceNodes = data.instanceNodes;\n\n\t\t\t// nodes\n\n\t\t\tfor ( let i = 0, l = nodes.length; i < l; i ++ ) {\n\n\t\t\t\tobjects.push( getNode( nodes[ i ] ) );\n\n\t\t\t}\n\n\t\t\t// instance cameras\n\n\t\t\tfor ( let i = 0, l = instanceCameras.length; i < l; i ++ ) {\n\n\t\t\t\tconst instanceCamera = getCamera( instanceCameras[ i ] );\n\n\t\t\t\tif ( instanceCamera !== null ) {\n\n\t\t\t\t\tobjects.push( instanceCamera.clone() );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// instance controllers\n\n\t\t\tfor ( let i = 0, l = instanceControllers.length; i < l; i ++ ) {\n\n\t\t\t\tconst instance = instanceControllers[ i ];\n\t\t\t\tconst controller = getController( instance.id );\n\t\t\t\tconst geometries = getGeometry( controller.id );\n\t\t\t\tconst newObjects = buildObjects( geometries, instance.materials );\n\n\t\t\t\tconst skeletons = instance.skeletons;\n\t\t\t\tconst joints = controller.skin.joints;\n\n\t\t\t\tconst skeleton = buildSkeleton( skeletons, joints );\n\n\t\t\t\tfor ( let j = 0, jl = newObjects.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst object = newObjects[ j ];\n\n\t\t\t\t\tif ( object.isSkinnedMesh ) {\n\n\t\t\t\t\t\tobject.bind( skeleton, controller.skin.bindMatrix );\n\t\t\t\t\t\tobject.normalizeSkinWeights();\n\n\t\t\t\t\t}\n\n\t\t\t\t\tobjects.push( object );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// instance lights\n\n\t\t\tfor ( let i = 0, l = instanceLights.length; i < l; i ++ ) {\n\n\t\t\t\tconst instanceLight = getLight( instanceLights[ i ] );\n\n\t\t\t\tif ( instanceLight !== null ) {\n\n\t\t\t\t\tobjects.push( instanceLight.clone() );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// instance geometries\n\n\t\t\tfor ( let i = 0, l = instanceGeometries.length; i < l; i ++ ) {\n\n\t\t\t\tconst instance = instanceGeometries[ i ];\n\n\t\t\t\t// a single geometry instance in collada can lead to multiple object3Ds.\n\t\t\t\t// this is the case when primitives are combined like triangles and lines\n\n\t\t\t\tconst geometries = getGeometry( instance.id );\n\t\t\t\tconst newObjects = buildObjects( geometries, instance.materials );\n\n\t\t\t\tfor ( let j = 0, jl = newObjects.length; j < jl; j ++ ) {\n\n\t\t\t\t\tobjects.push( newObjects[ j ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// instance nodes\n\n\t\t\tfor ( let i = 0, l = instanceNodes.length; i < l; i ++ ) {\n\n\t\t\t\tobjects.push( getNode( instanceNodes[ i ] ).clone() );\n\n\t\t\t}\n\n\t\t\tlet object;\n\n\t\t\tif ( nodes.length === 0 && objects.length === 1 ) {\n\n\t\t\t\tobject = objects[ 0 ];\n\n\t\t\t} else {\n\n\t\t\t\tobject = ( type === 'JOINT' ) ? new Bone() : new Group();\n\n\t\t\t\tfor ( let i = 0; i < objects.length; i ++ ) {\n\n\t\t\t\t\tobject.add( objects[ i ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tobject.name = ( type === 'JOINT' ) ? data.sid : data.name;\n\t\t\tobject.matrix.copy( matrix );\n\t\t\tobject.matrix.decompose( object.position, object.quaternion, object.scale );\n\n\t\t\treturn object;\n\n\t\t}\n\n\t\tconst fallbackMaterial = new MeshBasicMaterial( {\n\t\t\tname: Loader.DEFAULT_MATERIAL_NAME,\n\t\t\tcolor: 0xff00ff\n\t\t} );\n\n\t\tfunction resolveMaterialBinding( keys, instanceMaterials ) {\n\n\t\t\tconst materials = [];\n\n\t\t\tfor ( let i = 0, l = keys.length; i < l; i ++ ) {\n\n\t\t\t\tconst id = instanceMaterials[ keys[ i ] ];\n\n\t\t\t\tif ( id === undefined ) {\n\n\t\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Material with key %s not found. Apply fallback material.', keys[ i ] );\n\t\t\t\t\tmaterials.push( fallbackMaterial );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tmaterials.push( getMaterial( id ) );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn materials;\n\n\t\t}\n\n\t\tfunction buildObjects( geometries, instanceMaterials ) {\n\n\t\t\tconst objects = [];\n\n\t\t\tfor ( const type in geometries ) {\n\n\t\t\t\tconst geometry = geometries[ type ];\n\n\t\t\t\tconst materials = resolveMaterialBinding( geometry.materialKeys, instanceMaterials );\n\n\t\t\t\t// handle case if no materials are defined\n\n\t\t\t\tif ( materials.length === 0 ) {\n\n\t\t\t\t\tif ( type === 'lines' || type === 'linestrips' ) {\n\n\t\t\t\t\t\tmaterials.push( new LineBasicMaterial() );\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tmaterials.push( new MeshPhongMaterial() );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t// Collada allows to use phong and lambert materials with lines. Replacing these cases with LineBasicMaterial.\n\n\t\t\t\tif ( type === 'lines' || type === 'linestrips' ) {\n\n\t\t\t\t\tfor ( let i = 0, l = materials.length; i < l; i ++ ) {\n\n\t\t\t\t\t\tconst material = materials[ i ];\n\n\t\t\t\t\t\tif ( material.isMeshPhongMaterial === true || material.isMeshLambertMaterial === true ) {\n\n\t\t\t\t\t\t\tconst lineMaterial = new LineBasicMaterial();\n\n\t\t\t\t\t\t\t// copy compatible properties\n\n\t\t\t\t\t\t\tlineMaterial.color.copy( material.color );\n\t\t\t\t\t\t\tlineMaterial.opacity = material.opacity;\n\t\t\t\t\t\t\tlineMaterial.transparent = material.transparent;\n\n\t\t\t\t\t\t\t// replace material\n\n\t\t\t\t\t\t\tmaterials[ i ] = lineMaterial;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t// regard skinning\n\n\t\t\t\tconst skinning = ( geometry.data.attributes.skinIndex !== undefined );\n\n\t\t\t\t// choose between a single or multi materials (material array)\n\n\t\t\t\tconst material = ( materials.length === 1 ) ? materials[ 0 ] : materials;\n\n\t\t\t\t// now create a specific 3D object\n\n\t\t\t\tlet object;\n\n\t\t\t\tswitch ( type ) {\n\n\t\t\t\t\tcase 'lines':\n\t\t\t\t\t\tobject = new LineSegments( geometry.data, material );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'linestrips':\n\t\t\t\t\t\tobject = new Line( geometry.data, material );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'triangles':\n\t\t\t\t\tcase 'polylist':\n\t\t\t\t\t\tif ( skinning ) {\n\n\t\t\t\t\t\t\tobject = new SkinnedMesh( geometry.data, material );\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tobject = new Mesh( geometry.data, material );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\tobjects.push( object );\n\n\t\t\t}\n\n\t\t\treturn objects;\n\n\t\t}\n\n\t\tfunction hasNode( id ) {\n\n\t\t\treturn library.nodes[ id ] !== undefined;\n\n\t\t}\n\n\t\tfunction getNode( id ) {\n\n\t\t\treturn getBuild( library.nodes[ id ], buildNode );\n\n\t\t}\n\n\t\t// visual scenes\n\n\t\tfunction parseVisualScene( xml ) {\n\n\t\t\tconst data = {\n\t\t\t\tname: xml.getAttribute( 'name' ),\n\t\t\t\tchildren: []\n\t\t\t};\n\n\t\t\tprepareNodes( xml );\n\n\t\t\tconst elements = getElementsByTagName( xml, 'node' );\n\n\t\t\tfor ( let i = 0; i < elements.length; i ++ ) {\n\n\t\t\t\tdata.children.push( parseNode( elements[ i ] ) );\n\n\t\t\t}\n\n\t\t\tlibrary.visualScenes[ xml.getAttribute( 'id' ) ] = data;\n\n\t\t}\n\n\t\tfunction buildVisualScene( data ) {\n\n\t\t\tconst group = new Group();\n\t\t\tgroup.name = data.name;\n\n\t\t\tconst children = data.children;\n\n\t\t\tfor ( let i = 0; i < children.length; i ++ ) {\n\n\t\t\t\tconst child = children[ i ];\n\n\t\t\t\tgroup.add( getNode( child.id ) );\n\n\t\t\t}\n\n\t\t\treturn group;\n\n\t\t}\n\n\t\tfunction hasVisualScene( id ) {\n\n\t\t\treturn library.visualScenes[ id ] !== undefined;\n\n\t\t}\n\n\t\tfunction getVisualScene( id ) {\n\n\t\t\treturn getBuild( library.visualScenes[ id ], buildVisualScene );\n\n\t\t}\n\n\t\t// scenes\n\n\t\tfunction parseScene( xml ) {\n\n\t\t\tconst instance = getElementsByTagName( xml, 'instance_visual_scene' )[ 0 ];\n\t\t\treturn getVisualScene( parseId( instance.getAttribute( 'url' ) ) );\n\n\t\t}\n\n\t\tfunction setupAnimations() {\n\n\t\t\tconst clips = library.clips;\n\n\t\t\tif ( isEmpty( clips ) === true ) {\n\n\t\t\t\tif ( isEmpty( library.animations ) === false ) {\n\n\t\t\t\t\t// if there are animations but no clips, we create a default clip for playback\n\n\t\t\t\t\tconst tracks = [];\n\n\t\t\t\t\tfor ( const id in library.animations ) {\n\n\t\t\t\t\t\tconst animationTracks = getAnimation( id );\n\n\t\t\t\t\t\tfor ( let i = 0, l = animationTracks.length; i < l; i ++ ) {\n\n\t\t\t\t\t\t\ttracks.push( animationTracks[ i ] );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tanimations.push( new AnimationClip( 'default', - 1, tracks ) );\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tfor ( const id in clips ) {\n\n\t\t\t\t\tanimations.push( getAnimationClip( id ) );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\t// convert the parser error element into text with each child elements text\n\t\t// separated by new lines.\n\n\t\tfunction parserErrorToText( parserError ) {\n\n\t\t\tlet result = '';\n\t\t\tconst stack = [ parserError ];\n\n\t\t\twhile ( stack.length ) {\n\n\t\t\t\tconst node = stack.shift();\n\n\t\t\t\tif ( node.nodeType === Node.TEXT_NODE ) {\n\n\t\t\t\t\tresult += node.textContent;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tresult += '\\n';\n\t\t\t\t\tstack.push( ...node.childNodes );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn result.trim();\n\n\t\t}\n\n\t\tif ( text.length === 0 ) {\n\n\t\t\treturn { scene: new Scene() };\n\n\t\t}\n\n\t\tconst xml = new DOMParser().parseFromString( text, 'application/xml' );\n\n\t\tconst collada = getElementsByTagName( xml, 'COLLADA' )[ 0 ];\n\n\t\tconst parserError = xml.getElementsByTagName( 'parsererror' )[ 0 ];\n\t\tif ( parserError !== undefined ) {\n\n\t\t\t// Chrome will return parser error with a div in it\n\n\t\t\tconst errorElement = getElementsByTagName( parserError, 'div' )[ 0 ];\n\t\t\tlet errorText;\n\n\t\t\tif ( errorElement ) {\n\n\t\t\t\terrorText = errorElement.textContent;\n\n\t\t\t} else {\n\n\t\t\t\terrorText = parserErrorToText( parserError );\n\n\t\t\t}\n\n\t\t\tconsole.error( 'THREE.ColladaLoader: Failed to parse collada file.\\n', errorText );\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\t// metadata\n\n\t\tconst version = collada.getAttribute( 'version' );\n\t\tconsole.debug( 'THREE.ColladaLoader: File version', version );\n\n\t\tconst asset = parseAsset( getElementsByTagName( collada, 'asset' )[ 0 ] );\n\t\tconst textureLoader = new TextureLoader( this.manager );\n\t\ttextureLoader.setPath( this.resourcePath || path ).setCrossOrigin( this.crossOrigin );\n\n\t\tlet tgaLoader;\n\n\t\tif ( TGALoader ) {\n\n\t\t\ttgaLoader = new TGALoader( this.manager );\n\t\t\ttgaLoader.setPath( this.resourcePath || path );\n\n\t\t}\n\n\t\t//\n\n\t\tconst tempColor = new Color();\n\t\tconst animations = [];\n\t\tlet kinematics = {};\n\t\tlet count = 0;\n\n\t\t//\n\n\t\tconst library = {\n\t\t\tanimations: {},\n\t\t\tclips: {},\n\t\t\tcontrollers: {},\n\t\t\timages: {},\n\t\t\teffects: {},\n\t\t\tmaterials: {},\n\t\t\tcameras: {},\n\t\t\tlights: {},\n\t\t\tgeometries: {},\n\t\t\tnodes: {},\n\t\t\tvisualScenes: {},\n\t\t\tkinematicsModels: {},\n\t\t\tphysicsModels: {},\n\t\t\tkinematicsScenes: {}\n\t\t};\n\n\t\tparseLibrary( collada, 'library_animations', 'animation', parseAnimation );\n\t\tparseLibrary( collada, 'library_animation_clips', 'animation_clip', parseAnimationClip );\n\t\tparseLibrary( collada, 'library_controllers', 'controller', parseController );\n\t\tparseLibrary( collada, 'library_images', 'image', parseImage );\n\t\tparseLibrary( collada, 'library_effects', 'effect', parseEffect );\n\t\tparseLibrary( collada, 'library_materials', 'material', parseMaterial );\n\t\tparseLibrary( collada, 'library_cameras', 'camera', parseCamera );\n\t\tparseLibrary( collada, 'library_lights', 'light', parseLight );\n\t\tparseLibrary( collada, 'library_geometries', 'geometry', parseGeometry );\n\t\tparseLibrary( collada, 'library_nodes', 'node', parseNode );\n\t\tparseLibrary( collada, 'library_visual_scenes', 'visual_scene', parseVisualScene );\n\t\tparseLibrary( collada, 'library_kinematics_models', 'kinematics_model', parseKinematicsModel );\n\t\tparseLibrary( collada, 'library_physics_models', 'physics_model', parsePhysicsModel );\n\t\tparseLibrary( collada, 'scene', 'instance_kinematics_scene', parseKinematicsScene );\n\n\t\tbuildLibrary( library.animations, buildAnimation );\n\t\tbuildLibrary( library.clips, buildAnimationClip );\n\t\tbuildLibrary( library.controllers, buildController );\n\t\tbuildLibrary( library.images, buildImage );\n\t\tbuildLibrary( library.effects, buildEffect );\n\t\tbuildLibrary( library.materials, buildMaterial );\n\t\tbuildLibrary( library.cameras, buildCamera );\n\t\tbuildLibrary( library.lights, buildLight );\n\t\tbuildLibrary( library.geometries, buildGeometry );\n\t\tbuildLibrary( library.visualScenes, buildVisualScene );\n\n\t\tsetupAnimations();\n\t\tsetupKinematics();\n\n\t\tconst scene = parseScene( getElementsByTagName( collada, 'scene' )[ 0 ] );\n\t\tscene.animations = animations;\n\n\t\tif ( asset.upAxis === 'Z_UP' ) {\n\n\t\t\tconsole.warn( 'THREE.ColladaLoader: You are loading an asset with a Z-UP coordinate system. The loader just rotates the asset to transform it into Y-UP. The vertex data are not converted, see #24289.' );\n\t\t\tscene.rotation.set( - Math.PI / 2, 0, 0 );\n\n\t\t}\n\n\t\tscene.scale.multiplyScalar( asset.unit );\n\n\t\treturn {\n\t\t\tget animations() {\n\n\t\t\t\tconsole.warn( 'THREE.ColladaLoader: Please access animations over scene.animations now.' );\n\t\t\t\treturn animations;\n\n\t\t\t},\n\t\t\tkinematics: kinematics,\n\t\t\tlibrary: library,\n\t\t\tscene: scene\n\t\t};\n\n\t}\n\n}\n\nexport { ColladaLoader };\n","import {\n\tColor,\n\tShaderMaterial,\n\tUniformsLib,\n\tUniformsUtils,\n} from 'three';\n\n/**\n * A special line material for meshes loaded via {@link LDrawLoader}.\n *\n * This module can only be used with {@link WebGLRenderer}. When using {@link WebGPURenderer},\n * import the class from `LDrawConditionalLineNodeMaterial.js`.\n *\n * @augments ShaderMaterial\n * @three_import import { LDrawConditionalLineMaterial } from 'three/addons/materials/LDrawConditionalLineMaterial.js';\n */\nclass LDrawConditionalLineMaterial extends ShaderMaterial {\n\n\tstatic get type() {\n\n\t\treturn 'LDrawConditionalLineMaterial';\n\n\t}\n\n\t/**\n\t * Constructs a new conditional line material.\n\t *\n\t * @param {Object} [parameters] - An object with one or more properties\n\t * defining the material's appearance. Any property of the material\n\t * (including any property from inherited materials) can be passed\n\t * in here. Color values can be passed any type of value accepted\n\t * by {@link Color#set}.\n\t */\n\tconstructor( parameters ) {\n\n\t\tsuper( {\n\n\t\t\tuniforms: UniformsUtils.merge( [\n\t\t\t\tUniformsLib.fog,\n\t\t\t\t{\n\t\t\t\t\tdiffuse: {\n\t\t\t\t\t\tvalue: new Color()\n\t\t\t\t\t},\n\t\t\t\t\topacity: {\n\t\t\t\t\t\tvalue: 1.0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t] ),\n\n\t\t\tvertexShader: /* glsl */`\n\t\t\t\tattribute vec3 control0;\n\t\t\t\tattribute vec3 control1;\n\t\t\t\tattribute vec3 direction;\n\t\t\t\tvarying float discardFlag;\n\n\t\t\t\t#include <common>\n\t\t\t\t#include <color_pars_vertex>\n\t\t\t\t#include <fog_pars_vertex>\n\t\t\t\t#include <logdepthbuf_pars_vertex>\n\t\t\t\t#include <clipping_planes_pars_vertex>\n\t\t\t\tvoid main() {\n\t\t\t\t\t#include <color_vertex>\n\n\t\t\t\t\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t\t\t\t// Transform the line segment ends and control points into camera clip space\n\t\t\t\t\tvec4 c0 = projectionMatrix * modelViewMatrix * vec4( control0, 1.0 );\n\t\t\t\t\tvec4 c1 = projectionMatrix * modelViewMatrix * vec4( control1, 1.0 );\n\t\t\t\t\tvec4 p0 = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tvec4 p1 = projectionMatrix * modelViewMatrix * vec4( position + direction, 1.0 );\n\n\t\t\t\t\tc0.xy /= c0.w;\n\t\t\t\t\tc1.xy /= c1.w;\n\t\t\t\t\tp0.xy /= p0.w;\n\t\t\t\t\tp1.xy /= p1.w;\n\n\t\t\t\t\t// Get the direction of the segment and an orthogonal vector\n\t\t\t\t\tvec2 dir = p1.xy - p0.xy;\n\t\t\t\t\tvec2 norm = vec2( -dir.y, dir.x );\n\n\t\t\t\t\t// Get control point directions from the line\n\t\t\t\t\tvec2 c0dir = c0.xy - p1.xy;\n\t\t\t\t\tvec2 c1dir = c1.xy - p1.xy;\n\n\t\t\t\t\t// If the vectors to the controls points are pointed in different directions away\n\t\t\t\t\t// from the line segment then the line should not be drawn.\n\t\t\t\t\tfloat d0 = dot( normalize( norm ), normalize( c0dir ) );\n\t\t\t\t\tfloat d1 = dot( normalize( norm ), normalize( c1dir ) );\n\t\t\t\t\tdiscardFlag = float( sign( d0 ) != sign( d1 ) );\n\n\t\t\t\t\t#include <logdepthbuf_vertex>\n\t\t\t\t\t#include <clipping_planes_vertex>\n\t\t\t\t\t#include <fog_vertex>\n\t\t\t\t}\n\t\t\t`,\n\n\t\t\tfragmentShader: /* glsl */`\n\t\t\tuniform vec3 diffuse;\n\t\t\tuniform float opacity;\n\t\t\tvarying float discardFlag;\n\n\t\t\t#include <common>\n\t\t\t#include <color_pars_fragment>\n\t\t\t#include <fog_pars_fragment>\n\t\t\t#include <logdepthbuf_pars_fragment>\n\t\t\t#include <clipping_planes_pars_fragment>\n\t\t\tvoid main() {\n\n\t\t\t\tif ( discardFlag > 0.5 ) discard;\n\n\t\t\t\t#include <clipping_planes_fragment>\n\t\t\t\tvec3 outgoingLight = vec3( 0.0 );\n\t\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t\t\t\t#include <logdepthbuf_fragment>\n\t\t\t\t#include <color_fragment>\n\t\t\t\toutgoingLight = diffuseColor.rgb; // simple shader\n\t\t\t\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t\t\t\t#include <tonemapping_fragment>\n\t\t\t\t#include <colorspace_fragment>\n\t\t\t\t#include <fog_fragment>\n\t\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t}\n\t\t\t`,\n\n\t\t} );\n\n\t\tObject.defineProperties( this, {\n\n\t\t\t/**\n\t\t\t * The material's opacity.\n\t\t\t *\n\t\t\t * @name LDrawConditionalLineMaterial#opacity\n\t\t\t * @type {number}\n\t\t\t * @default 1\n\t\t\t */\n\t\t\topacity: {\n\t\t\t\tget: function () {\n\n\t\t\t\t\treturn this.uniforms.opacity.value;\n\n\t\t\t\t},\n\n\t\t\t\tset: function ( value ) {\n\n\t\t\t\t\tthis.uniforms.opacity.value = value;\n\n\t\t\t\t}\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * The material's color.\n\t\t\t *\n\t\t\t * @name LDrawConditionalLineMaterial#color\n\t\t\t * @type {Color}\n\t\t\t * @default (1,1,1)\n\t\t\t */\n\t\t\tcolor: {\n\t\t\t\tget: function () {\n\n\t\t\t\t\treturn this.uniforms.diffuse.value;\n\n\t\t\t\t}\n\t\t\t}\n\n\t\t} );\n\n\t\tthis.setValues( parameters );\n\n\t\t/**\n\t\t * This flag can be used for type testing.\n\t\t *\n\t\t * @type {boolean}\n\t\t * @readonly\n\t\t * @default true\n\t\t */\n\t\tthis.isLDrawConditionalLineMaterial = true;\n\n\t}\n\n}\n\nexport { LDrawConditionalLineMaterial };\n","/**\r\n * ImageRenderModal - Modal for rendering path-traced images\r\n * Supports PNG, JPG, PSD formats with resolutions up to 8K (16K causes context loss)\r\n * Includes sample control slider for quality vs speed tradeoff\r\n */\r\n\r\nexport class ImageRenderModal {\r\n\r\n\tconstructor(pathTracer, renderer, scene, camera) {\r\n\r\n\t\tthis.pathTracer = pathTracer;\r\n\t\tthis.renderer = renderer;\r\n\t\tthis.scene = scene;\r\n\t\tthis.camera = camera;\r\n\r\n\t\t// Store original renderer size to restore later\r\n\t\tthis.originalSize = { width: 0, height: 0 };\r\n\t\tthis.originalPixelRatio = 1;\r\n\r\n\t\t// Store original path tracer settings to restore later\r\n\t\tthis.originalSettings = {\r\n\t\t\ttiles: { x: 1, y: 1 },\r\n\t\t\tbounces: 5,\r\n\t\t\trenderScale: 1,\r\n\t\t\tfilterGlossyFactor: 0.1,\r\n\t\t\tmultipleImportanceSampling: true,\r\n\t\t\ttoneMapping: null\r\n\t\t};\r\n\r\n\t\t// Modal state\r\n\t\tthis.isOpen = false;\r\n\t\tthis.isRendering = false;\r\n\r\n\t\t// Render settings\r\n\t\tthis.settings = {\r\n\t\t\tresolution: '4K',\r\n\t\t\taspectRatio: '16:9',\r\n\t\t\tformat: 'PNG',\r\n\t\t\ttargetSamples: 1000,\r\n\t\t\tbackgroundMode: 'without',\r\n\t\t\tfileName: 'render'\r\n\t\t};\r\n\r\n\t\t// When user clicks \"Stop & capture\" during render, we exit the sample loop and capture at current samples\r\n\t\tthis.stopRequested = false;\r\n\r\n\t\t// Resolution map\r\n\t\tthis.resolutions = {\r\n\t\t\t'1K': { '16:9': [1920, 1080], '1:1': [1920, 1920], '4:3': [1920, 1440] },\r\n\t\t\t'2K': { '16:9': [2560, 1440], '1:1': [2560, 2560], '4:3': [2560, 1920] },\r\n\t\t\t'4K': { '16:9': [3840, 2160], '1:1': [3840, 3840], '4:3': [3840, 2880] },\r\n\t\t\t'8K': { '16:9': [7680, 4320], '1:1': [7680, 7680], '4:3': [7680, 5760] },\r\n\t\t\t// 16K removed: 15360x8640 = 132.7 MP exceeds safe 64 MP limit and causes WebGL context loss\r\n\t\t\t// Maximum safe resolution is 8K (7680x4320 = 33.2 MP)\r\n\t\t};\r\n\r\n\t\t// Get GPU maximum texture size\r\n\t\tconst gl = this.renderer.getContext();\r\n\t\tthis.maxTextureSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);\r\n\t\tthis.maxRenderbufferSize = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE);\r\n\t\tthis.maxSize = Math.min(this.maxTextureSize, this.maxRenderbufferSize);\r\n\r\n\t\tconsole.log(` GPU Limits: Max Texture Size: ${this.maxTextureSize}, Max Renderbuffer Size: ${this.maxRenderbufferSize}, Using: ${this.maxSize}`);\r\n\r\n\t\tthis.createModal();\r\n\t\tthis.attachEventListeners();\r\n\r\n\t}\r\n\r\n\tcreateModal() {\r\n\r\n\t\tconst modalHTML = `\r\n\t\t\t<div id=\"imageRenderModal\" class=\"image-render-modal\" style=\"display: none;\">\r\n\t\t\t\t<div class=\"modal-overlay\"></div>\r\n\t\t\t\t<div class=\"modal-content\">\r\n\t\t\t\t\t<div class=\"modal-header\">\r\n\t\t\t\t\t\t<h2>Render Image</h2>\r\n\t\t\t\t\t\t<button class=\"close-btn\" id=\"closeModalBtn\">&times;</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"modal-body\">\r\n\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t<label for=\"resolution\">Resolution:</label>\r\n\t\t\t\t\t\t\t<select id=\"resolution\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t<option value=\"1K\">1K (1920x1080)</option>\r\n\t\t\t\t\t\t\t\t<option value=\"2K\">2K (2560x1440)</option>\r\n\t\t\t\t\t\t\t\t<option value=\"4K\" selected>4K (3840x2160)</option>\r\n\t\t\t\t\t\t\t\t<option value=\"8K\">8K (7680x4320)</option>\r\n\t\t\t\t\t\t\t\t<!-- 16K removed: Causes WebGL context loss due to memory limits. Max safe: 8K -->\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t<label for=\"aspectRatio\">Aspect Ratio:</label>\r\n\t\t\t\t\t\t\t<select id=\"aspectRatio\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t<option value=\"16:9\" selected>16:9</option>\r\n\t\t\t\t\t\t\t\t<option value=\"1:1\">1:1</option>\r\n\t\t\t\t\t\t\t\t<option value=\"4:3\">4:3</option>\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t<label for=\"format\">Format:</label>\r\n\t\t\t\t\t\t\t<select id=\"format\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t<option value=\"PNG\" selected>PNG</option>\r\n\t\t\t\t\t\t\t\t<option value=\"JPG\">JPG</option>\r\n\t\t\t\t\t\t\t\t<option value=\"PSD\">PSD</option>\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t<label for=\"samples\">\r\n\t\t\t\t\t\t\t\tTarget Samples: <span id=\"samplesValue\">1000</span>\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t<input type=\"range\" id=\"samples\" min=\"0\" max=\"10000\" step=\"100\" value=\"1000\" class=\"slider\">\r\n\t\t\t\t\t\t\t<div class=\"slider-info\">\r\n\t\t\t\t\t\t\t\t<span>0 (instant)</span>\r\n\t\t\t\t\t\t\t\t<span>10000 (high quality)</span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t<label for=\"backgroundMode\">Background:</label>\r\n\t\t\t\t\t\t\t<select id=\"backgroundMode\" class=\"form-control\">\r\n\t\t\t\t\t\t\t\t<option value=\"without\" selected>Without Background</option>\r\n\t\t\t\t\t\t\t\t<option value=\"with\">With Background</option>\r\n\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"form-group\">\r\n\t\t\t\t\t\t\t<label for=\"fileName\">File Name:</label>\r\n\t\t\t\t\t\t\t<input type=\"text\" id=\"fileName\" value=\"render\" class=\"form-control\">\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div id=\"renderProgress\" class=\"render-progress\" style=\"display: none;\">\r\n\t\t\t\t\t\t\t<div class=\"progress-bar\">\r\n\t\t\t\t\t\t\t\t<div class=\"progress-fill\" id=\"progressFill\"></div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div class=\"progress-text\" id=\"progressText\">Preparing render...</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"modal-footer\">\r\n\t\t\t\t\t\t<button id=\"cancelBtn\" class=\"btn btn-secondary\">Cancel</button>\r\n\t\t\t\t\t\t<button id=\"stopAndCaptureBtn\" class=\"btn btn-warning\" style=\"display: none;\">Stop & capture</button>\r\n\t\t\t\t\t\t<button id=\"renderBtn\" class=\"btn btn-primary\">Render</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t`;\r\n\r\n\t\t// Add modal to body if it doesn't exist\r\n\t\tif (!document.getElementById('imageRenderModal')) {\r\n\r\n\t\t\tdocument.body.insertAdjacentHTML('beforeend', modalHTML);\r\n\r\n\t\t}\r\n\r\n\t\tthis.modal = document.getElementById('imageRenderModal');\r\n\t\tthis.updateSamplesDisplay();\r\n\r\n\t}\r\n\r\n\tattachEventListeners() {\r\n\r\n\t\t// Close button\r\n\t\tdocument.getElementById('closeModalBtn').addEventListener('click', () => this.close());\r\n\t\tdocument.getElementById('cancelBtn').addEventListener('click', () => this.close());\r\n\r\n\t\t// Overlay click\r\n\t\tthis.modal.querySelector('.modal-overlay').addEventListener('click', () => this.close());\r\n\r\n\t\t// Render button\r\n\t\tdocument.getElementById('renderBtn').addEventListener('click', () => this.handleRender());\r\n\r\n\t\t// Samples slider\r\n\t\tdocument.getElementById('samples').addEventListener('input', (e) => {\r\n\r\n\t\t\tthis.settings.targetSamples = parseInt(e.target.value);\r\n\t\t\tthis.updateSamplesDisplay();\r\n\r\n\t\t});\r\n\r\n\t\t// Stop & capture: stop sample accumulation and capture at current samples\r\n\t\tdocument.getElementById('stopAndCaptureBtn').addEventListener('click', () => {\r\n\r\n\t\t\tif (this.isRendering) this.stopRequested = true;\r\n\r\n\t\t});\r\n\r\n\t\t// Settings changes\r\n\t\t['resolution', 'aspectRatio', 'format', 'backgroundMode', 'fileName'].forEach(id => {\r\n\r\n\t\t\tdocument.getElementById(id).addEventListener('change', (e) => {\r\n\r\n\t\t\t\tthis.settings[id === 'fileName' ? 'fileName' : id] = e.target.value;\r\n\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t\t// ESC key to close\r\n\t\tdocument.addEventListener('keydown', (e) => {\r\n\r\n\t\t\tif (e.key === 'Escape' && this.isOpen) {\r\n\r\n\t\t\t\tthis.close();\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tupdateSamplesDisplay() {\r\n\r\n\t\tconst value = this.settings.targetSamples;\r\n\t\tdocument.getElementById('samplesValue').textContent = value.toLocaleString();\r\n\t\tdocument.getElementById('samples').value = value;\r\n\r\n\t}\r\n\r\n\topen() {\r\n\r\n\t\tif (this.onOpen) this.onOpen();\r\n\t\tthis.isOpen = true;\r\n\t\tthis.modal.style.display = 'flex';\r\n\t\tdocument.body.style.overflow = 'hidden';\r\n\r\n\t}\r\n\r\n\tclose() {\r\n\r\n\t\tif (this.isRendering) {\r\n\r\n\t\t\tif (!confirm('Rendering in progress. Are you sure you want to cancel?')) {\r\n\r\n\t\t\t\treturn;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tthis.cancelRender();\r\n\r\n\t\t}\r\n\r\n\t\tthis.isOpen = false;\r\n\t\tthis.modal.style.display = 'none';\r\n\t\tdocument.body.style.overflow = '';\r\n\t\tif (this.onClose) this.onClose();\r\n\r\n\t}\r\n\r\n\tasync handleRender() {\r\n\r\n\t\tif (this.isRendering) return;\r\n\r\n\t\t// Turn path tracer back on so canvas accumulates and we can capture (main point of render)\r\n\t\tif (this.onBeforeRender) this.onBeforeRender();\r\n\r\n\t\tthis.isRendering = true;\r\n\t\tthis.stopRequested = false;\r\n\t\tconst renderBtn = document.getElementById('renderBtn');\r\n\t\tconst stopBtn = document.getElementById('stopAndCaptureBtn');\r\n\t\tconst progressDiv = document.getElementById('renderProgress');\r\n\t\tconst progressFill = document.getElementById('progressFill');\r\n\t\tconst progressText = document.getElementById('progressText');\r\n\r\n\t\trenderBtn.disabled = true;\r\n\t\trenderBtn.style.display = 'none';\r\n\t\tif (stopBtn) stopBtn.style.display = 'inline-block';\r\n\t\tprogressDiv.style.display = 'block';\r\n\r\n\t\ttry {\r\n\r\n\t\t\t// Background mode from dropdown; PNG + \"without\" = auto transparent\r\n\t\t\tconst isPNG = this.settings.format.toUpperCase() === 'PNG';\r\n\t\t\tconst shouldCaptureBackground = this.settings.backgroundMode === 'with';\r\n\t\t\tconst bgImageSrc = window.backgroundImageSrc || null;\r\n\t\t\tconst bgImageW = window.backgroundImageNaturalWidth || 0;\r\n\t\t\tconst bgImageH = window.backgroundImageNaturalHeight || 0;\r\n\r\n\t\t\t// Get target dimensions\r\n\t\t\tconst res = this.resolutions[this.settings.resolution];\r\n\t\t\tlet [width, height] = res[this.settings.aspectRatio];\r\n\r\n\t\t\t// If \"with background\" and we have image dimensions, preserve background aspect ratio\r\n\t\t\tif (shouldCaptureBackground && bgImageSrc && bgImageW > 0 && bgImageH > 0) {\r\n\r\n\t\t\t\tconst bgAspect = bgImageW / bgImageH;\r\n\t\t\t\tconst baseAspect = width / height;\r\n\r\n\t\t\t\tif (bgAspect > baseAspect) {\r\n\r\n\t\t\t\t\theight = Math.round(width / bgAspect);\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\twidth = Math.round(height * bgAspect);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconsole.log(` [Render] Adjusted to background aspect ratio: ${width}x${height} (image: ${bgImageW}x${bgImageH})`);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Transparent background handling\r\n\t\t\tlet originalBackground = this.scene.background;\r\n\t\t\tlet originalClearAlpha = this.renderer.getClearAlpha();\r\n\t\t\tlet didSetTransparent = false;\r\n\r\n\t\t\t// PNG + \"without background\" = auto transparent PNG (no need for separate checkbox)\r\n\t\t\tif ( isPNG && ! shouldCaptureBackground ) {\r\n\r\n\t\t\t\tthis.scene.background = null;\r\n\t\t\t\tthis.renderer.setClearAlpha( 0 );\r\n\t\t\t\tthis.pathTracer.updateEnvironment();\r\n\t\t\t\tdidSetTransparent = true;\r\n\t\t\t\tconsole.log( ` [Render] PNG without background  transparent background auto-enabled` );\r\n\r\n\t\t\t} else if ( shouldCaptureBackground && bgImageSrc ) {\r\n\r\n\t\t\t\t// \"With background\" selected: render transparent, composite bg image behind\r\n\t\t\t\tthis.scene.background = null;\r\n\t\t\t\tthis.renderer.setClearAlpha( 0 );\r\n\t\t\t\tthis.pathTracer.updateEnvironment();\r\n\t\t\t\tdidSetTransparent = true;\r\n\t\t\t\tconsole.log( ` [Render] With background  set transparent for compositing` );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// CRITICAL: Clamp resolution to GPU limits BEFORE any operations\r\n\t\t\tconst originalWidth = width;\r\n\t\t\tconst originalHeight = height;\r\n\r\n\t\t\tconsole.log(` [Render] Initial resolution: ${width}x${height}, GPU max: ${this.maxSize}`);\r\n\r\n\t\t\t// CRITICAL: Check total pixel count to prevent context loss (matches reference implementation)\r\n\t\t\tconst totalPixels = width * height;\r\n\t\t\tconst maxSafePixels = 4096 * 4096; // 16MP safe limit\r\n\t\t\tconst maxMemoryPixels = 8192 * 8192; // 64MP absolute limit (matches reference)\r\n\r\n\t\t\t// Check pixel count limits first (prevents context loss)\r\n\t\t\tif (totalPixels > maxMemoryPixels) {\r\n\r\n\t\t\t\t// Calculate safe resolution that fits within memory limit\r\n\t\t\t\tconst safeScale = Math.sqrt(maxMemoryPixels / totalPixels);\r\n\t\t\t\tconst newWidth = Math.floor(width * safeScale);\r\n\t\t\t\tconst newHeight = Math.floor(height * safeScale);\r\n\r\n\t\t\t\tconst errorMsg = `Resolution ${this.settings.resolution} (${originalWidth}x${originalHeight}, ${totalPixels.toLocaleString()} pixels) exceeds memory limit (${maxMemoryPixels.toLocaleString()} pixels). Maximum safe resolution is 8192x8192. Clamping to ${newWidth}x${newHeight}`;\r\n\t\t\t\tconsole.error(errorMsg);\r\n\t\t\t\tprogressText.textContent = errorMsg;\r\n\t\t\t\talert(errorMsg + '\\n\\nPlease select a lower resolution (8K or below).');\r\n\r\n\t\t\t\twidth = newWidth;\r\n\t\t\t\theight = newHeight;\r\n\r\n\t\t\t} else if (totalPixels > maxSafePixels) {\r\n\r\n\t\t\t\tconsole.warn(` High resolution detected: ${width}x${height} (${totalPixels.toLocaleString()} pixels). This may cause performance issues or context loss.`);\r\n\t\t\t\tprogressText.textContent = `Preparing render at ${width}x${height}... (High resolution - may be slow)`;\r\n\r\n\t\t\t} else if (width > this.maxSize || height > this.maxSize) {\r\n\r\n\t\t\t\t// Check GPU texture/renderbuffer limits\r\n\t\t\t\tconst scale = Math.min(this.maxSize / width, this.maxSize / height);\r\n\t\t\t\tconst newWidth = Math.floor(width * scale);\r\n\t\t\t\tconst newHeight = Math.floor(height * scale);\r\n\r\n\t\t\t\tconsole.log(` [Render] Clamping: scale=${scale.toFixed(4)}, ${width}x${height} -> ${newWidth}x${newHeight}`);\r\n\r\n\t\t\t\twidth = newWidth;\r\n\t\t\t\theight = newHeight;\r\n\r\n\t\t\t\tconst warningMsg = ` Resolution ${this.settings.resolution} (${originalWidth}x${originalHeight}) exceeds GPU limit (${this.maxSize}). Clamping to ${width}x${height}`;\r\n\t\t\t\tconsole.warn(warningMsg);\r\n\t\t\t\tprogressText.textContent = warningMsg;\r\n\t\t\t\talert(warningMsg + '\\n\\nPlease select a lower resolution.');\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tprogressText.textContent = `Preparing render at ${width}x${height}...`;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Double-check dimensions are valid (should never fail after clamping, but safety check)\r\n\t\t\tif (width <= 0 || height <= 0 || width > this.maxSize || height > this.maxSize) {\r\n\r\n\t\t\t\tthrow new Error(`Invalid resolution: ${width}x${height}. Maximum supported: ${this.maxSize}x${this.maxSize}`);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(` [Render] Final target resolution: ${width}x${height} (clamped from ${originalWidth}x${originalHeight})`);\r\n\r\n\t\t\t// Store original renderer CSS size (NOT drawing buffer size)\r\n\t\t\t// renderer.domElement.width/height = CSS size  pixelRatio (drawing buffer)\r\n\t\t\t// renderer.setSize() expects CSS pixels and multiplies by pixelRatio internally\r\n\t\t\tthis.originalPixelRatio = this.renderer.getPixelRatio();\r\n\t\t\tthis.originalSize.width = Math.round(this.renderer.domElement.width / this.originalPixelRatio);\r\n\t\t\tthis.originalSize.height = Math.round(this.renderer.domElement.height / this.originalPixelRatio);\r\n\r\n\t\t\t// Store original path tracer settings (to restore after rendering)\r\n\t\t\tthis.originalSettings.tiles.x = this.pathTracer.tiles.x;\r\n\t\t\tthis.originalSettings.tiles.y = this.pathTracer.tiles.y;\r\n\t\t\tthis.originalSettings.bounces = this.pathTracer.bounces;\r\n\t\t\tthis.originalSettings.renderScale = this.pathTracer.renderScale;\r\n\t\t\tthis.originalSettings.filterGlossyFactor = this.pathTracer.filterGlossyFactor;\r\n\t\t\tthis.originalSettings.multipleImportanceSampling = this.pathTracer.multipleImportanceSampling;\r\n\t\t\tthis.originalSettings.toneMapping = this.renderer.toneMapping;\r\n\t\t\tthis.originalSettings.textureSize = this.pathTracer.textureSize.clone();\r\n\r\n\t\t\t// Bump texture atlas to full 4K for final render quality\r\n\t\t\tthis.pathTracer.textureSize.set(4096, 4096);\r\n\r\n\t\t\t// CRITICAL: Account for renderScale when checking GPU limits\r\n\t\t\t// The path tracer multiplies renderer size by renderScale to get actual render target size\r\n\t\t\t// Temporarily set renderScale to 1.0 for high-resolution renders to avoid exceeding GPU limits\r\n\t\t\tconst originalRenderScale = this.pathTracer.renderScale;\r\n\t\t\tthis.pathTracer.renderScale = 1.0; // Use 1:1 scale for rendering to avoid GPU limit issues\r\n\r\n\t\t\tconsole.log(` [Render] Renderer size: ${width}x${height}, renderScale set to 1.0 for rendering (was ${originalRenderScale})`);\r\n\r\n\t\t\t// Apply optimal settings for rendering\r\n\t\t\t// Set tiles to 1 for maximum rendering speed (faster than higher tile counts)\r\n\t\t\t// Keep all other settings (bounces, renderScale, filterGlossyFactor, etc.) \r\n\t\t\t// from the GUI controls - these are already applied and should be preserved\r\n\t\t\tthis.pathTracer.tiles.set(1, 1);\r\n\r\n\t\t\t// CRITICAL: Check current resolution FIRST - don't resize if not needed\r\n\t\t\tconst currentWidth = this.renderer.domElement.width;\r\n\t\t\tconst currentHeight = this.renderer.domElement.height;\r\n\r\n\t\t\tconsole.log(` [Path Tracer] Current resolution: ${currentWidth}x${currentHeight}`);\r\n\t\t\tconsole.log(` [Path Tracer] Target resolution: ${width}x${height}`);\r\n\r\n\t\t\t// STEP 1: Only resize if resolution doesn't match\r\n\t\t\tif (currentWidth !== width || currentHeight !== height) {\r\n\r\n\t\t\t\tconsole.log(` [Path Tracer] Resolution mismatch - resizing from ${currentWidth}x${currentHeight} to ${width}x${height}`);\r\n\t\t\t\tprogressText.textContent = `Resizing path tracer to ${width}x${height}...`;\r\n\r\n\t\t\t\t// Check WebGL context before resizing (prevent context loss)\r\n\t\t\t\tconst gl = this.renderer.getContext();\r\n\t\t\t\tif (gl && gl.isContextLost && gl.isContextLost()) {\r\n\r\n\t\t\t\t\tthrow new Error('WebGL context has been lost. Please refresh the page and try again.');\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Resize renderer (dimensions should already be clamped, but double-check)\r\n\t\t\t\tif (width > this.maxSize || height > this.maxSize) {\r\n\r\n\t\t\t\t\tthrow new Error(`Cannot resize renderer to ${width}x${height}. GPU maximum is ${this.maxSize}x${this.maxSize}. This should have been clamped earlier.`);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Resize renderer\r\n\t\t\t\tthis.renderer.setSize(width, height);\r\n\t\t\t\tthis.renderer.setPixelRatio(1);\r\n\r\n\t\t\t\t// Check context after resize\r\n\t\t\t\tif (gl && gl.isContextLost && gl.isContextLost()) {\r\n\r\n\t\t\t\t\tthrow new Error(`WebGL context lost after resizing to ${width}x${height}. Resolution too high for your GPU. Please try a lower resolution.`);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Update camera aspect ratio\r\n\t\t\t\tif (this.camera.isPerspectiveCamera) {\r\n\r\n\t\t\t\t\tthis.camera.aspect = width / height;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\r\n\t\t\t\t} else if (this.camera.isOrthographicCamera) {\r\n\r\n\t\t\t\t\t// For orthographic cameras, update the frustum size\r\n\t\t\t\t\tconst aspect = width / height;\r\n\t\t\t\t\tconst orthoHeight = this.camera.top - this.camera.bottom;\r\n\t\t\t\t\tconst orthoWidth = orthoHeight * aspect;\r\n\t\t\t\t\tthis.camera.left = - orthoWidth / 2;\r\n\t\t\t\t\tthis.camera.right = orthoWidth / 2;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Check context before resizing path tracer\r\n\t\t\t\tif (gl && gl.isContextLost && gl.isContextLost()) {\r\n\r\n\t\t\t\t\tthrow new Error('WebGL context lost before path tracer resize. Please try a lower resolution.');\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Try to resize path tracer instance (EXACTLY like reference implementation)\r\n\t\t\t\t// Note: WebGLPathTracer doesn't have setSize, but internal _pathTracer does\r\n\t\t\t\tif (this.pathTracer._pathTracer && typeof this.pathTracer._pathTracer.setSize === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer._pathTracer.setSize(width, height);\r\n\r\n\t\t\t\t} else if (typeof this.pathTracer.setSize === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer.setSize(width, height);\r\n\r\n\t\t\t\t} else if (typeof this.pathTracer.resize === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer.resize(width, height);\r\n\r\n\t\t\t\t} else if (this.pathTracer.renderer && typeof this.pathTracer.renderer.setSize === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer.renderer.setSize(width, height);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Check context after path tracer resize\r\n\t\t\t\tif (gl && gl.isContextLost && gl.isContextLost()) {\r\n\r\n\t\t\t\t\tthrow new Error(`WebGL context lost after path tracer resize to ${width}x${height}. Resolution too high. Please try a lower resolution (8K or below).`);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// CRITICAL: Update path tracer environment/scene after resize\r\n\t\t\t\t// This ensures the path tracer regenerates its internal buffers\r\n\t\t\t\tif (typeof this.pathTracer.updateEnvironment === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer.updateEnvironment();\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (typeof this.pathTracer.setScene === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer.setScene(this.scene, this.camera);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Wait a few frames for the path tracer to initialize at new resolution\r\n\t\t\t\tawait this.waitFrames(2);\r\n\r\n\t\t\t\t// Force a sample render to kickstart accumulation at new resolution\r\n\t\t\t\tthis.pathTracer.renderSample();\r\n\t\t\t\tawait this.waitFrames(1);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.log(` [Path Tracer] Resolution matches - preserving current samples!`);\r\n\t\t\t\tprogressText.textContent = `Path tracer resolution matches - checking samples...`;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Store original path tracer state\r\n\t\t\tconst originalEnablePathTracing = this.pathTracer.enablePathTracing;\r\n\t\t\tconst originalPausePathTracing = this.pathTracer.pausePathTracing;\r\n\t\t\tconst originalRenderToCanvas = this.pathTracer.renderToCanvas;\r\n\r\n\t\t\t// Ensure path tracer is enabled, not paused, and rendering to canvas\r\n\t\t\tthis.pathTracer.enablePathTracing = true;\r\n\t\t\tthis.pathTracer.pausePathTracing = false;\r\n\t\t\tthis.pathTracer.renderToCanvas = true;\r\n\r\n\t\t\t// Update path tracer camera\r\n\t\t\tthis.pathTracer.updateCamera();\r\n\r\n\t\t\t// Wait for target samples\r\n\t\t\tif (this.settings.targetSamples > 0) {\r\n\r\n\t\t\t\tawait this.waitForSamples(progressFill, progressText);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t// If 0 samples requested, render at least a few to get something visible\r\n\t\t\t\tprogressText.textContent = 'Rendering initial samples...';\r\n\t\t\t\tconst minSamples = 10; // Minimum samples to ensure something is visible\r\n\t\t\t\tfor (let i = 0; i < minSamples; i++) {\r\n\r\n\t\t\t\t\tthis.pathTracer.renderSample();\r\n\t\t\t\t\tawait this.waitFrames(1);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Render final sample to ensure everything is up to date\r\n\t\t\tthis.pathTracer.renderSample();\r\n\t\t\tawait this.waitFrames(2);\r\n\r\n\t\t\tprogressText.textContent = 'Capturing image...';\r\n\t\t\tprogressFill.style.width = '100%';\r\n\r\n\t\t\t// Ensure one final render to canvas before capture\r\n\t\t\tthis.pathTracer.renderSample();\r\n\t\t\tawait this.waitFrames(1);\r\n\r\n\t\t\t// CRITICAL: Check WebGL context before capture\r\n\t\t\tconst gl = this.renderer.getContext();\r\n\t\t\tif (gl && gl.isContextLost && gl.isContextLost()) {\r\n\r\n\t\t\t\tthrow new Error(`WebGL context lost before capture. Resolution ${width}x${height} is too high for your GPU. Please try a lower resolution (8K or below).`);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Capture canvas (EXACTLY like reference implementation)\r\n\t\t\tconst canvas = this.renderer.domElement;\r\n\t\t\tlet imageData;\r\n\r\n\t\t\t// Verify canvas dimensions match target (matches reference check)\r\n\t\t\tif (canvas && canvas.width === width && canvas.height === height) {\r\n\r\n\t\t\t\tconsole.log(` Capturing canvas at ${canvas.width}x${canvas.height}...`);\r\n\t\t\t\timageData = await this.captureImage(canvas);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.warn(` Canvas size mismatch: expected ${width}x${height}, got ${canvas?.width}x${canvas?.height}`);\r\n\r\n\t\t\t\t// Fallback: try to capture anyway if canvas exists\r\n\t\t\t\tif (!canvas || canvas.width === 0 || canvas.height === 0) {\r\n\r\n\t\t\t\t\tthrow new Error(`Canvas has zero dimensions (${canvas?.width}x${canvas?.height}). Please check renderer setup.`);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Use actual canvas dimensions\r\n\t\t\t\tconsole.log(` Capturing canvas at actual size ${canvas.width}x${canvas.height}...`);\r\n\t\t\t\timageData = await this.captureImage(canvas);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Composite the CSS background image behind the transparent path-traced render\r\n\t\t\tif (shouldCaptureBackground && bgImageSrc) {\r\n\r\n\t\t\t\tprogressText.textContent = 'Compositing background image...';\r\n\t\t\t\timageData = await this.compositeWithBackground(imageData, bgImageSrc, canvas.width, canvas.height);\r\n\t\t\t\tconsole.log(` [Render] Composited background image`);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Download image\r\n\t\t\tthis.downloadImage(imageData, this.settings.fileName, this.settings.format);\r\n\r\n\t\t\tprogressText.textContent = 'Render complete!';\r\n\r\n\t\t\t// Restore original path tracer state (after capture)\r\n\t\t\tthis.pathTracer.enablePathTracing = originalEnablePathTracing;\r\n\t\t\tthis.pathTracer.pausePathTracing = originalPausePathTracing;\r\n\t\t\tthis.pathTracer.renderToCanvas = originalRenderToCanvas;\r\n\t\t\tthis.pathTracer.renderScale = originalRenderScale; // Restore original renderScale\r\n\r\n\t\t\t// Restore background/environment\r\n\t\t\tif ( didSetTransparent ) {\r\n\r\n\t\t\t\tthis.scene.background = originalBackground;\r\n\t\t\t\tthis.renderer.setClearAlpha( originalClearAlpha );\r\n\t\t\t\tthis.pathTracer.updateEnvironment();\r\n\r\n\t\t\t}\r\n\r\n\t\t\tsetTimeout(() => {\r\n\r\n\t\t\t\tthis.close();\r\n\t\t\t\tthis.restoreRenderer();\r\n\r\n\t\t\t}, 1000);\r\n\r\n\t\t} catch (error) {\r\n\r\n\t\t\tconsole.error('Render error:', error);\r\n\t\t\tprogressText.textContent = `Error: ${error.message}`;\r\n\t\t\talert(`Render failed: ${error.message}`);\r\n\r\n\t\t\t// Restore background/environment on error\r\n\t\t\tif (shouldCaptureBackground && bgImageSrc) {\r\n\r\n\t\t\t\tthis.scene.background = originalBackground;\r\n\t\t\t\tthis.renderer.setClearAlpha(originalClearAlpha);\r\n\t\t\t\tthis.pathTracer.updateEnvironment();\r\n\r\n\t\t\t}\r\n\r\n\t\t\tthis.restoreRenderer();\r\n\r\n\t\t} finally {\r\n\r\n\t\t\tthis.isRendering = false;\r\n\t\t\tthis.stopRequested = false;\r\n\t\t\trenderBtn.disabled = false;\r\n\t\t\trenderBtn.textContent = 'Render';\r\n\t\t\trenderBtn.style.display = '';\r\n\t\t\tif (document.getElementById('stopAndCaptureBtn')) document.getElementById('stopAndCaptureBtn').style.display = 'none';\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tcancelRender() {\r\n\r\n\t\tthis.isRendering = false;\r\n\t\tthis.stopRequested = false;\r\n\t\tthis.restoreRenderer();\r\n\t\tdocument.getElementById('renderProgress').style.display = 'none';\r\n\t\tdocument.getElementById('renderBtn').style.display = '';\r\n\t\tconst stopBtn = document.getElementById('stopAndCaptureBtn');\r\n\t\tif (stopBtn) stopBtn.style.display = 'none';\r\n\r\n\t}\r\n\r\n\tasync waitFrames(count) {\r\n\r\n\t\tfor (let i = 0; i < count; i++) {\r\n\r\n\t\t\tawait new Promise(resolve => requestAnimationFrame(resolve));\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tasync waitForSamples(progressFill, progressText) {\r\n\r\n\t\treturn new Promise((resolve) => {\r\n\r\n\t\t\tconst targetSamples = this.settings.targetSamples;\r\n\t\t\tlet lastUpdate = 0;\r\n\r\n\t\t\tconst checkSamples = () => {\r\n\r\n\t\t\t\tif (!this.isRendering) {\r\n\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// User clicked \"Stop & capture\": exit loop and capture at current samples\r\n\t\t\t\tif (this.stopRequested) {\r\n\r\n\t\t\t\t\tconst currentSamples = Math.floor(this.pathTracer.samples);\r\n\t\t\t\t\tprogressText.textContent = `Stopped at ${currentSamples.toLocaleString()} samples  capturing...`;\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst currentSamples = Math.floor(this.pathTracer.samples);\r\n\t\t\t\tconst progress = Math.min(100, (currentSamples / targetSamples) * 100);\r\n\r\n\t\t\t\t// Update progress bar\r\n\t\t\t\tprogressFill.style.width = `${progress}%`;\r\n\r\n\t\t\t\t// Update text (throttle to avoid too many updates)\r\n\t\t\t\tconst now = Date.now();\r\n\t\t\t\tif (now - lastUpdate > 100) {\r\n\r\n\t\t\t\t\tprogressText.textContent = `Rendering... ${currentSamples.toLocaleString()} / ${targetSamples.toLocaleString()} samples (${Math.round(progress)}%)`;\r\n\t\t\t\t\tlastUpdate = now;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (currentSamples >= targetSamples) {\r\n\r\n\t\t\t\t\tresolve();\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t// Continue rendering - ensure path tracer is enabled\r\n\t\t\t\t\tif (this.pathTracer.enablePathTracing && !this.pathTracer.pausePathTracing) {\r\n\r\n\t\t\t\t\t\tthis.pathTracer.renderSample();\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\trequestAnimationFrame(checkSamples);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t};\r\n\r\n\t\t\tcheckSamples();\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tasync captureImage(canvas) {\r\n\r\n\t\tconst format = this.settings.format.toUpperCase();\r\n\r\n\t\tif (format === 'PNG') {\r\n\r\n\t\t\treturn canvas.toDataURL('image/png', 1.0);\r\n\r\n\t\t} else if (format === 'JPG' || format === 'JPEG') {\r\n\r\n\t\t\t// Convert PNG to JPG (requires background)\r\n\t\t\treturn this.convertToJPG(canvas);\r\n\r\n\t\t} else if (format === 'PSD') {\r\n\r\n\t\t\t// For PSD, we'll export as PNG with .psd extension\r\n\t\t\t// Full PSD support would require a library like psd.js\r\n\t\t\tconsole.warn('PSD format not fully supported, exporting as PNG with .psd extension');\r\n\t\t\treturn canvas.toDataURL('image/png', 1.0);\r\n\r\n\t\t}\r\n\r\n\t\tthrow new Error(`Unsupported format: ${format}`);\r\n\r\n\t}\r\n\r\n\t/**\r\n\t * Composite a background image behind the path-traced render.\r\n\t * The render has transparent background; we draw the bg image first,\r\n\t * then the render on top, preserving alpha compositing.\r\n\t * Returns a data URL of the composited image.\r\n\t */\r\n\tasync compositeWithBackground(renderDataUrl, bgImageSrc, width, height) {\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\r\n\t\t\tconst bgImg = new Image();\r\n\t\t\tbgImg.onload = () => {\r\n\r\n\t\t\t\tconst tempCanvas = document.createElement('canvas');\r\n\t\t\t\ttempCanvas.width = width;\r\n\t\t\t\ttempCanvas.height = height;\r\n\t\t\t\tconst ctx = tempCanvas.getContext('2d');\r\n\r\n\t\t\t\t// Draw background image  fill canvas using \"contain\" logic (same as CSS object-fit: contain)\r\n\t\t\t\tconst bgAspect = bgImg.width / bgImg.height;\r\n\t\t\t\tconst canvasAspect = width / height;\r\n\t\t\t\tlet drawW, drawH, drawX, drawY;\r\n\r\n\t\t\t\tif (bgAspect > canvasAspect) {\r\n\r\n\t\t\t\t\t// Image is wider  fit to width\r\n\t\t\t\t\tdrawW = width;\r\n\t\t\t\t\tdrawH = width / bgAspect;\r\n\t\t\t\t\tdrawX = 0;\r\n\t\t\t\t\tdrawY = (height - drawH) / 2;\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t// Image is taller  fit to height\r\n\t\t\t\t\tdrawH = height;\r\n\t\t\t\t\tdrawW = height * bgAspect;\r\n\t\t\t\t\tdrawX = (width - drawW) / 2;\r\n\t\t\t\t\tdrawY = 0;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Black background fill for letterbox areas\r\n\t\t\t\tctx.fillStyle = '#000000';\r\n\t\t\t\tctx.fillRect(0, 0, width, height);\r\n\r\n\t\t\t\t// Draw background image\r\n\t\t\t\tctx.drawImage(bgImg, drawX, drawY, drawW, drawH);\r\n\r\n\t\t\t\t// Draw the path-traced render on top (with alpha compositing)\r\n\t\t\t\tconst renderImg = new Image();\r\n\t\t\t\trenderImg.onload = () => {\r\n\r\n\t\t\t\t\tctx.drawImage(renderImg, 0, 0, width, height);\r\n\r\n\t\t\t\t\tconst format = this.settings.format.toUpperCase();\r\n\t\t\t\t\tif (format === 'JPG' || format === 'JPEG') {\r\n\r\n\t\t\t\t\t\tresolve(tempCanvas.toDataURL('image/jpeg', 0.95));\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\tresolve(tempCanvas.toDataURL('image/png', 1.0));\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t};\r\n\t\t\t\trenderImg.onerror = reject;\r\n\t\t\t\trenderImg.src = renderDataUrl;\r\n\r\n\t\t\t};\r\n\t\t\tbgImg.onerror = reject;\r\n\t\t\tbgImg.src = bgImageSrc;\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tconvertToJPG(canvas, quality = 0.95) {\r\n\r\n\t\t// Create a temporary canvas with white background\r\n\t\tconst tempCanvas = document.createElement('canvas');\r\n\t\ttempCanvas.width = canvas.width;\r\n\t\ttempCanvas.height = canvas.height;\r\n\t\tconst ctx = tempCanvas.getContext('2d');\r\n\r\n\t\t// Fill with white background\r\n\t\tctx.fillStyle = '#FFFFFF';\r\n\t\tctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);\r\n\r\n\t\t// Draw original canvas on top\r\n\t\tctx.drawImage(canvas, 0, 0);\r\n\r\n\t\t// Convert to JPG\r\n\t\treturn tempCanvas.toDataURL('image/jpeg', quality);\r\n\r\n\t}\r\n\r\n\tdownloadImage(dataUrl, fileName, format) {\r\n\r\n\t\tconst link = document.createElement('a');\r\n\t\tlink.download = `${fileName}.${format.toLowerCase()}`;\r\n\t\tlink.href = dataUrl;\r\n\t\tdocument.body.appendChild(link);\r\n\t\tlink.click();\r\n\t\tdocument.body.removeChild(link);\r\n\r\n\t}\r\n\r\n\trestoreRenderer() {\r\n\r\n\t\t// Restore original path tracer settings\r\n\t\tthis.pathTracer.tiles.set(this.originalSettings.tiles.x, this.originalSettings.tiles.y);\r\n\t\tthis.pathTracer.bounces = this.originalSettings.bounces;\r\n\t\tthis.pathTracer.renderScale = this.originalSettings.renderScale; // Restore original renderScale\r\n\t\tthis.pathTracer.filterGlossyFactor = this.originalSettings.filterGlossyFactor;\r\n\t\tthis.pathTracer.multipleImportanceSampling = this.originalSettings.multipleImportanceSampling;\r\n\t\tif (this.originalSettings.textureSize) {\r\n\r\n\t\t\tthis.pathTracer.textureSize.copy(this.originalSettings.textureSize);\r\n\t\t\t// Repack texture atlas at preview resolution\r\n\t\t\tif (typeof this.pathTracer.updateMaterials === 'function') {\r\n\r\n\t\t\t\tthis.pathTracer.updateMaterials();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\tif (this.originalSettings.toneMapping !== null) {\r\n\r\n\t\t\tthis.renderer.toneMapping = this.originalSettings.toneMapping;\r\n\r\n\t\t}\r\n\r\n\t\t// Restore renderer to current window size (most robust  handles resize during render)\r\n\t\tconst restoreW = window.innerWidth;\r\n\t\tconst restoreH = window.innerHeight;\r\n\t\tconst restoreDPR = window.devicePixelRatio;\r\n\t\tif (restoreW > 0 && restoreH > 0) {\r\n\r\n\t\t\tthis.renderer.setPixelRatio(restoreDPR);\r\n\t\t\tthis.renderer.setSize(restoreW, restoreH);\r\n\r\n\t\t\t// Update camera aspect (restore to current window)\r\n\t\t\tif (this.camera.isPerspectiveCamera) {\r\n\r\n\t\t\t\tconst aspect = restoreW / restoreH;\r\n\t\t\t\tthis.camera.aspect = aspect;\r\n\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\r\n\t\t\t} else if (this.camera.isOrthographicCamera) {\r\n\r\n\t\t\t\t// For orthographic cameras, restore original frustum\r\n\t\t\t\t// Note: Original frustum values aren't stored, so this is a best-effort restore\r\n\t\t\t\t// The camera should be restored by the main application\r\n\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Resize path tracer back to match the restored canvas drawing buffer\r\n\t\t\tconst drawW = restoreW * restoreDPR;\r\n\t\t\tconst drawH = restoreH * restoreDPR;\r\n\t\t\tconst w = Math.floor(this.originalSettings.renderScale * drawW);\r\n\t\t\tconst h = Math.floor(this.originalSettings.renderScale * drawH);\r\n\t\t\tif (this.pathTracer._pathTracer && typeof this.pathTracer._pathTracer.setSize === 'function') {\r\n\r\n\t\t\t\tthis.pathTracer._pathTracer.setSize(w, h);\r\n\t\t\t\tconst lowResScale = this.pathTracer.lowResScale != null ? this.pathTracer.lowResScale : 0.25;\r\n\t\t\t\tif (this.pathTracer._lowResPathTracer && typeof this.pathTracer._lowResPathTracer.setSize === 'function') {\r\n\r\n\t\t\t\t\tthis.pathTracer._lowResPathTracer.setSize(Math.floor(w * lowResScale), Math.floor(h * lowResScale));\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else if (typeof this.pathTracer.setSize === 'function') {\r\n\r\n\t\t\t\tthis.pathTracer.setSize(w, h);\r\n\r\n\t\t\t} else if (typeof this.pathTracer.resize === 'function') {\r\n\r\n\t\t\t\tthis.pathTracer.resize(w, h);\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Update path tracer camera\r\n\t\t\tthis.pathTracer.updateCamera();\r\n\r\n\t\t}\r\n\r\n\t\t// Re-sync path tracer with scene (background, env map, clear alpha) so the live canvas\r\n\t\t// shows the correct background/wallpaper again after render\r\n\t\tif (typeof this.pathTracer.updateEnvironment === 'function') {\r\n\r\n\t\t\tthis.pathTracer.updateEnvironment();\r\n\r\n\t\t}\r\n\r\n\t\t// Force clean restart so the preview begins accumulating from scratch\r\n\t\tthis.pathTracer.reset();\r\n\r\n\t}\r\n\r\n}\r\n","import {\r\n\tACESFilmicToneMapping,\r\n\tNoToneMapping,\r\n\tBox3,\r\n\tLoadingManager,\r\n\tSphere,\r\n\tDoubleSide,\r\n\tMesh,\r\n\tMeshStandardMaterial,\r\n\tMeshBasicMaterial,\r\n\tPlaneGeometry,\r\n\tMeshPhysicalMaterial,\r\n\tScene,\r\n\tPerspectiveCamera,\r\n\tOrthographicCamera,\r\n\tWebGLRenderer,\r\n\tEquirectangularReflectionMapping,\r\n\tTexture,\r\n\tTextureLoader,\r\n\tColor,\r\n\tVector3,\r\n\tVector2,\r\n\tRaycaster,\r\n\tMathUtils,\r\n\tSRGBColorSpace,\r\n\tLinearMipmapLinearFilter,\r\n\tLinearFilter,\r\n\tAnimationMixer,\r\n\tClampToEdgeWrapping,\r\n\tGroup,\r\n\tDataTexture,\r\n\tFloatType,\r\n\tRGBAFormat,\r\n\tEuler,\r\n} from 'three';\r\nimport { MeshoptDecoder } from 'three/examples/jsm/libs/meshopt_decoder.module.js';\r\nimport { HDRLoader } from 'three/examples/jsm/loaders/HDRLoader.js';\r\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\r\nimport { ColladaLoader } from 'three/examples/jsm/loaders/ColladaLoader.js';\r\nimport { LDrawLoader } from 'three/examples/jsm/loaders/LDrawLoader.js';\r\nimport { LDrawUtils } from 'three/examples/jsm/utils/LDrawUtils.js';\r\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\r\nimport Stats from 'three/examples/jsm/libs/stats.module.js';\r\nimport { generateRadialFloorTexture } from './utils/generateRadialFloorTexture.js';\r\nimport { MODEL_LIST } from './utils/modelList.js';\r\nimport { GradientEquirectTexture, WebGLPathTracer, PhysicalCamera } from '../src/index.js';\r\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\r\nimport { getScaledSettings } from './utils/getScaledSettings.js';\r\nimport { LoaderElement } from './utils/LoaderElement.js';\r\nimport { ParallelMeshBVHWorker, GenerateMeshBVHWorker } from 'three-mesh-bvh/worker';\r\nimport { LDrawConditionalLineMaterial } from 'three/addons/materials/LDrawConditionalLineMaterial.js';\r\nimport { ImageRenderModal } from './ImageRenderModal.js';\r\nimport './ImageRenderModal.css';\r\n\r\nconst envMaps = {\r\n\t'Royal Esplanade': 'https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/royal_esplanade_1k.hdr',\r\n\t'Moonless Golf': 'https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/moonless_golf_1k.hdr',\r\n\t'Overpass': 'https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/pedestrian_overpass_1k.hdr',\r\n\t'Venice Sunset': 'https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/venice_sunset_1k.hdr',\r\n\t'Small Studio': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/studio_small_05_1k.hdr',\r\n\t'Pfalzer Forest': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/phalzer_forest_01_1k.hdr',\r\n\t'Leadenhall Market': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/leadenhall_market_1k.hdr',\r\n\t'Kloppenheim': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/kloppenheim_05_1k.hdr',\r\n\t'Hilly Terrain': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/hilly_terrain_01_1k.hdr',\r\n\t'Circus Arena': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/circus_arena_1k.hdr',\r\n\t'Chinese Garden': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/chinese_garden_1k.hdr',\r\n\t'Autoshop': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/autoshop_01_1k.hdr',\r\n\r\n\t'Measuring Lab': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/vintage_measuring_lab_2k.hdr',\r\n\t'Whale Skeleton': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/whale_skeleton_2k.hdr',\r\n\t'Hall of Mammals': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/hall_of_mammals_2k.hdr',\r\n\r\n\t'Drachenfels Cellar': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/drachenfels_cellar_2k.hdr',\r\n\t'Adams Place Bridge': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/adams_place_bridge_2k.hdr',\r\n\t'Sepulchral Chapel Rotunda': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/sepulchral_chapel_rotunda_2k.hdr',\r\n\t'Peppermint Powerplant': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/peppermint_powerplant_2k.hdr',\r\n\t'Noon Grass': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/noon_grass_2k.hdr',\r\n\t'Narrow Moonlit Road': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/narrow_moonlit_road_2k.hdr',\r\n\t'St Peters Square Night': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/st_peters_square_night_2k.hdr',\r\n\t'Brown Photostudio 01': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_01_2k.hdr',\r\n\t'Rainforest Trail': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/rainforest_trail_2k.hdr',\r\n\t'Brown Photostudio 07': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_07_2k.hdr',\r\n\t'Brown Photostudio 06': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_06_2k.hdr',\r\n\t'Dancing Hall': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/dancing_hall_2k.hdr',\r\n\t'Aristea Wreck Puresky': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/aristea_wreck_puresky_2k.hdr',\r\n\t'Modern Buildings 2': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/modern_buildings_2_2k.hdr',\r\n\t'Thatch Chapel': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/thatch_chapel_2k.hdr',\r\n\t'Vestibule': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/vestibule_2k.hdr',\r\n\t'Blocky Photo Studio': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/blocky_photo_studio_1k.hdr',\r\n\t'Christmas Photo Studio 07': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/christmas_photo_studio_07_2k.hdr',\r\n\t'Aerodynamics Workshop': 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/aerodynamics_workshop_1k.hdr',\r\n\r\n\t'Custom HDRI': '__CUSTOM__',\r\n\r\n};\r\n\r\nconst params = {\r\n\r\n\tmultipleImportanceSampling: true,\r\n\tacesToneMapping: true,\r\n\t...getScaledSettings(),\r\n\trenderScale: 2.0,\r\n\ttiles: 5,\r\n\r\n\tmodel: '',\r\n\r\n\tenvMap: envMaps['Aristea Wreck Puresky'],\r\n\r\n\tgradientTop: '#bfd8ff',\r\n\tgradientBottom: '#ffffff',\r\n\r\n\tenvironmentIntensity: 1.0,\r\n\tenvironmentRotation: 0,\r\n\tenvironmentSaturation: 1.0,\r\n\r\n\tproductSaturation: 1.0,\r\n\tproductContrast: 1.0,\r\n\r\n\tcameraProjection: 'Perspective',\r\n\tfocalLength: 35,\r\n\r\n\t// Depth of Field controls\r\n\tenableDoF: false,\r\n\tfocusDistance: 5,\r\n\tfStop: 1.4,\r\n\tapertureBlades: 6,\r\n\tapertureRotation: 0,\r\n\tanamorphicRatio: 1,\r\n\r\n\tbackgroundType: 'Gradient',\r\n\tbgGradientTop: '#111111',\r\n\tbgGradientBottom: '#000000',\r\n\tbackgroundBlur: 0.0,\r\n\ttransparentBackground: false,\r\n\tcheckerboardTransparency: true,\r\n\r\n\tenable: true,\r\n\tbounces: 5,\r\n\tfilterGlossyFactor: 0.1,\r\n\tpause: false,\r\n\tpreviewSamplesMax: 100,  // cap preview accumulation  final render uses its own target\r\n\r\n\tfloorMode: 'Shadow Catcher',  // 'Solid Ground' | 'Shadow Catcher' | 'Material alpha'\r\n\tfloorColor: '#111111',\r\n\tfloorOpacity: 1.0,\r\n\tfloorShadowOpacity: 0.5,  // Shadow Catcher only: intensity of shadow on ground (02)\r\n\tfloorReflectionIntensity: 2.0,  // Shadow Catcher: intensity of reflection on ground (010, high = brighter)\r\n\tfloorRoughness: 0.2,\r\n\tfloorMetalness: 0.2,\r\n\tfloorTransmission: 0.0,\r\n\tfloorIOR: 1.5,\r\n\tfloorShadowReflectionCatcher: true,  // derived from floorMode (true only for Shadow Catcher)\r\n\r\n\tscreenBrightness: 1, // Predefined wallpapers: 1; custom wallpaper defaults to 4.5 when selected\r\n\tscreenWallpaper: 'blank_screen', // Selected wallpaper\r\n\tscreenSaturation: 1, // Predefined wallpapers: 1; custom wallpaper defaults to 0.9 when selected (0 = grayscale, 1 = normal, 2 = oversaturated)\r\n\r\n\t// Background image (rendered as emissive plane inside canvas)\r\n\tbackgroundImageEnabled: false,\r\n\tbackgroundImageEmissive: 4.5, // Emissive intensity for background image (0 = no light, 10 = very bright)\r\n\r\n\t// Background image as HDRI (converts LDR image to environment lighting via PMREM)\r\n\tbackgroundAsHDRI: false, // Toggle: use background image as environment lighting\r\n\tbackgroundHDRIIntensity: 1.0, // Intensity of the converted HDRI (independent of visual background)\r\n\r\n\t// Animation frame control (like GLBViewer: 0150 frames at 30fps)\r\n\tanimationFrame: 35,\r\n\t// Screen on/off in Animation folder (On | Off screen)\r\n\tanimationScreen: 'On',\r\n\r\n};\r\n\r\nlet floorPlane, gui, stats;\r\nlet pathTracer, renderer, orthoCamera, perspectiveCamera, activeCamera;\r\nlet controls, scene, model;\r\nlet gradientMap;\r\nlet loader;\r\nlet models;\r\nlet screenMesh = null;\r\nlet uploadedTexture = null;\r\nlet uploadedImage = null; //  NEW: Store original image for brightness/saturation reprocessing\r\nlet wallpaperMeshes = {}; // Store all wallpaper meshes: { 'blank_screen': mesh, 'blue_bloom': mesh, etc. }\r\nlet currentWallpaper = 'blank_screen'; // Current selected wallpaper\r\nlet imageRenderModal = null; // Image render modal instance\r\n\r\n// Pause state: distinguish user-paused vs auto-paused (reached target samples)\r\nlet _autoPausedDueToSamples = false;\r\nlet enableController = null; // GUI controller for params.enable (Path Tracer checkbox)\r\n\r\n// Click-to-focus for DoF\r\nlet sceneBvh = null; // BVH from setSceneAsync for raycasting\r\nconst focusMouse = new Vector2(); // Mouse position for click-to-focus\r\n// Environment rotation slider: pause path tracer while dragging so rotation is visible in raster view\r\nlet _envRotationDragging = false;\r\nlet _envRotPrevEnable = null;\r\n\r\n// Background image state (CSS overlay behind canvas + HDRI conversion)\r\nlet backgroundOverlay = null; // CSS <img> element behind the canvas\r\nlet backgroundPlane = null; // Legacy: kept for drag/zoom model interaction\r\nlet backgroundTexture = null; // The texture for background image (kept for HDRI conversion)\r\nlet backgroundImageSrc = null; // The image source URL (data URL)\r\nlet backgroundImageOriginal = null; // The original Image element for reprocessing\r\nlet backgroundImageNaturalWidth = 0;\r\nlet backgroundImageNaturalHeight = 0;\r\nlet backgroundHDRITexture = null; // PMREM-converted environment texture from background image\r\nlet previousEnvironment = null; // Store original environment before HDRI override\r\nlet customEnvTexture = null; // User-loaded HDRI for \"Custom HDRI\" option\r\nlet fallbackEnvMap = null; // Bright fallback environment used until HDRI loads (don't dispose)\r\nlet animationMixer = null;\r\nlet mainAnimAction = null;\r\nlet mainAnimClip = null;\r\nconst ANIMATION_FRAME_RATE = 30;\r\nconst ANIMATION_MAX_FRAME = 150;\r\n\r\n//  Product Color mesh groups (detected dynamically from GLB) \r\nlet colorMeshGroups = {};      // { charcoal: { prefix, names[], hexCode } }\r\nlet currentColorGroup = null;  // currently active color key\r\n\r\nconst orthoWidth = 2;\r\nlet contentGroup = null;\r\n\r\ninit();\r\n\r\nasync function waitFrame() {\r\n\r\n\treturn new Promise(resolve => requestAnimationFrame(resolve));\r\n\r\n}\r\n\r\nasync function init() {\r\n\r\n\t// Wait for the models list to be available since vite doesn't guarantee execution order\r\n\t// of module tags and we rely on the other script to define the set of models for display\r\n\t// in this example. TODO: handle this more gracefully.\r\n\tmodels = MODEL_LIST;\r\n\r\n\tloader = new LoaderElement();\r\n\tloader.attach(document.body);\r\n\r\n\t// renderer  alpha + premultipliedAlpha:false so CSS background shows through\r\n\trenderer = new WebGLRenderer({ antialias: true, alpha: true, premultipliedAlpha: false, preserveDrawingBuffer: true });\r\n\trenderer.toneMapping = ACESFilmicToneMapping;\r\n\trenderer.toneMappingExposure = 1.0;\r\n\trenderer.outputColorSpace = SRGBColorSpace;\r\n\r\n\t// Wrap canvas + CSS background overlay in a container (like StudioX)\r\n\tconst canvasContainer = document.createElement('div');\r\n\tcanvasContainer.id = 'canvas-container';\r\n\tcanvasContainer.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;';\r\n\tdocument.body.appendChild(canvasContainer);\r\n\r\n\t// CSS background overlay  behind the canvas inside the container\r\n\tbackgroundOverlay = document.createElement('img');\r\n\tbackgroundOverlay.id = 'background-overlay';\r\n\tbackgroundOverlay.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;display:none;pointer-events:none;background:#000;';\r\n\tcanvasContainer.appendChild(backgroundOverlay);\r\n\r\n\t// Canvas on top of the overlay (position only  renderer.setSize handles dimensions)\r\n\trenderer.domElement.style.position = 'absolute';\r\n\trenderer.domElement.style.top = '0';\r\n\trenderer.domElement.style.left = '0';\r\n\tcanvasContainer.appendChild(renderer.domElement);\r\n\r\n\t// path tracer\r\n\tpathTracer = new WebGLPathTracer(renderer);\r\n\tpathTracer.setBVHWorker(new GenerateMeshBVHWorker());\r\n\tpathTracer.physicallyCorrectLights = true;\r\n\tpathTracer.tiles.set(params.tiles, params.tiles);\r\n\tpathTracer.multipleImportanceSampling = params.multipleImportanceSampling;\r\n\tpathTracer.transmissiveBounces = 10;\r\n\tpathTracer.minSamples = 1;\r\n\r\n\t// Override rasterizeSceneCallback to ensure environment is always set for raster fallback\r\n\tpathTracer.rasterizeSceneCallback = (s, c) => {\r\n\r\n\t\t// Ensure environment is set before raster render (fallback if null)\r\n\t\tif (!s.environment && fallbackEnvMap) {\r\n\r\n\t\t\ts.environment = fallbackEnvMap;\r\n\r\n\t\t}\r\n\t\t// Ensure environment intensity is always positive for visible lighting\r\n\t\tif (s.environmentIntensity === undefined || s.environmentIntensity <= 0) {\r\n\r\n\t\t\ts.environmentIntensity = params.environmentIntensity || 1.0;\r\n\r\n\t\t}\r\n\t\trenderer.render(s, c);\r\n\r\n\t};\r\n\r\n\t// camera (using PhysicalCamera for DoF support)\r\n\tconst aspect = window.innerWidth / window.innerHeight;\r\n\tperspectiveCamera = new PhysicalCamera(60, aspect, 0.025, 500);\r\n\tperspectiveCamera.position.set(- 1, 0.25, 1);\r\n\t// Initialize DoF settings from params\r\n\tperspectiveCamera.focusDistance = params.focusDistance;\r\n\tperspectiveCamera.fStop = params.enableDoF ? params.fStop : 1e10; // Very high fStop disables DoF (bokehSize0)\r\n\tperspectiveCamera.apertureBlades = params.apertureBlades;\r\n\tperspectiveCamera.apertureRotation = params.apertureRotation;\r\n\tperspectiveCamera.anamorphicRatio = params.anamorphicRatio;\r\n\r\n\tconst orthoHeight = orthoWidth / aspect;\r\n\torthoCamera = new OrthographicCamera(orthoWidth / - 2, orthoWidth / 2, orthoHeight / 2, orthoHeight / - 2, 0, 100);\r\n\torthoCamera.position.set(- 1, 0.25, 1);\r\n\r\n\t// background map\r\n\tgradientMap = new GradientEquirectTexture();\r\n\tgradientMap.topColor.set(params.bgGradientTop);\r\n\tgradientMap.bottomColor.set(params.bgGradientBottom);\r\n\tgradientMap.update();\r\n\r\n\t// controls\r\n\tcontrols = new OrbitControls(perspectiveCamera, renderer.domElement);\r\n\tcontrols.addEventListener('change', () => {\r\n\r\n\t\tpathTracer.updateCamera();\r\n\t\t// Reset accumulation for new view and resume if we had auto-paused at target samples\r\n\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\t});\r\n\r\n\t// Background-mode interactions (rotate/zoom model, keep wallpaper fixed)\r\n\trenderer.domElement.addEventListener('mousedown', startBackgroundDrag);\r\n\trenderer.domElement.addEventListener('mousemove', moveBackgroundDrag);\r\n\trenderer.domElement.addEventListener('mouseup', () => endBackgroundDrag().catch(() => { }));\r\n\trenderer.domElement.addEventListener('mouseleave', () => endBackgroundDrag().catch(() => { }));\r\n\trenderer.domElement.addEventListener('wheel', onBackgroundWheel, { passive: false });\r\n\r\n\t// Prevent context menu on right click\r\n\trenderer.domElement.addEventListener('contextmenu', (e) => {\r\n\t\tif (isBackgroundModeActive()) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t});\r\n\r\n\t// scene\r\n\tscene = new Scene();\r\n\tscene.background = gradientMap;\r\n\t// Create a bright fallback environment (white/grey gradient) so raster view has lighting until HDRI loads\r\n\t// gradientMap is too dark (#111111/#000000) to provide meaningful lighting\r\n\tfallbackEnvMap = new GradientEquirectTexture();\r\n\tfallbackEnvMap.topColor.set('#ffffff');\r\n\tfallbackEnvMap.bottomColor.set('#cccccc');\r\n\tfallbackEnvMap.update();\r\n\tscene.environment = fallbackEnvMap;\r\n\t// Use higher intensity for the fallback to ensure visible lighting\r\n\tscene.environmentIntensity = Math.max(params.environmentIntensity, 1.0);\r\n\t// Add cameras to scene so camera-attached background plane is included in path tracing\r\n\tscene.add(perspectiveCamera);\r\n\tscene.add(orthoCamera);\r\n\r\n\t// Group for model + floor so we can rotate/zoom them together when background is enabled\r\n\tcontentGroup = new Group();\r\n\tcontentGroup.name = 'contentGroup';\r\n\tscene.add(contentGroup);\r\n\r\n\t// Solid ground: path tracer uses hit-flag (SKIP_SURFACE/HIT_SURFACE) + alpha-based transparency (alpha test or stochastic alpha) + transmission.\r\n\t// getSurfaceRecord() returns SKIP when transparent/alpha test; transmission and attenuateHit() handle glass-like floor. No luminance for PNG transparency.\r\n\tconst floorTex = generateRadialFloorTexture(2048);\r\n\tfloorPlane = new Mesh(\r\n\t\tnew PlaneGeometry(),\r\n\t\tnew MeshPhysicalMaterial({\r\n\t\t\tmap: floorTex,\r\n\t\t\ttransparent: true,\r\n\t\t\tcolor: 0x111111,\r\n\t\t\troughness: 0.1,\r\n\t\t\tmetalness: 0.0,\r\n\t\t\ttransmission: 0.0,\r\n\t\t\tior: 1.5,\r\n\t\t\tside: DoubleSide,\r\n\t\t\tshadowReflectionCatcher: params.floorShadowReflectionCatcher,\r\n\t\t})\r\n\t);\r\n\tfloorPlane.scale.setScalar(5);\r\n\tfloorPlane.rotation.x = - Math.PI / 2;\r\n\tcontentGroup.add(floorPlane);\r\n\r\n\tstats = new Stats();\r\n\tdocument.body.appendChild(stats.dom);\r\n\r\n\t// Initialize image render modal (will be updated when camera changes)\r\n\timageRenderModal = new ImageRenderModal(pathTracer, renderer, scene, activeCamera);\r\n\r\n\tupdateCameraProjection(params.cameraProjection);\r\n\tscene.userData.environmentSaturation = params.environmentSaturation;\r\n\tif ( params.focalLength != null && params.focalLength > 0 ) {\r\n\r\n\t\tconst filmHeight = 24;\r\n\t\tperspectiveCamera.fov = MathUtils.radToDeg( 2 * Math.atan( ( filmHeight / 2 ) / params.focalLength ) );\r\n\t\tperspectiveCamera.updateProjectionMatrix();\r\n\r\n\t}\r\n\tonHashChange();\r\n\tupdateEnvMap();\r\n\tonResize();\r\n\r\n\tanimate();\r\n\r\n\twindow.addEventListener('resize', onResize);\r\n\twindow.addEventListener('hashchange', onHashChange);\r\n\r\n\t// Click-to-focus for Depth of Field\r\n\twindow.addEventListener('pointerdown', onFocusPointerDown);\r\n\twindow.addEventListener('pointerup', onFocusPointerUp);\r\n\r\n}\r\n\r\nfunction animate() {\r\n\r\n\trequestAnimationFrame(animate);\r\n\r\n\tstats.update();\r\n\r\n\tif (!model) {\r\n\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\tif (params.enable) {\r\n\r\n\t\t// If we were auto-paused but current samples dropped below target (e.g. reset, scene/camera change), resume\r\n\t\tif ( _autoPausedDueToSamples && pathTracer.samples < params.previewSamplesMax ) {\r\n\r\n\t\t\t_autoPausedDueToSamples = false;\r\n\t\t\tparams.pause = false;\r\n\r\n\t\t}\r\n\r\n\t\t// Auto-pause when we reach target samples (performance: stop accumulation)\r\n\t\tif ( pathTracer.samples >= params.previewSamplesMax && pathTracer.samples >= 1 ) {\r\n\r\n\t\t\tif ( ! params.pause ) {\r\n\r\n\t\t\t\tparams.pause = true;\r\n\t\t\t\t_autoPausedDueToSamples = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t} else if ( ! params.pause || pathTracer.samples < 1 ) {\r\n\r\n\t\t\tif ( pathTracer.samples < params.previewSamplesMax ) {\r\n\r\n\t\t\t\tpathTracer.renderSample();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t} else {\r\n\r\n\t\t// Ensure scene.environment is always set for raster view (fallback if null)\r\n\t\tif ( !scene.environment && fallbackEnvMap ) {\r\n\r\n\t\t\tscene.environment = fallbackEnvMap;\r\n\r\n\t\t}\r\n\t\trenderer.render(scene, activeCamera);\r\n\r\n\t}\r\n\r\n\tloader.setSamples(pathTracer.samples, pathTracer.isCompiling, params.previewSamplesMax);\r\n\r\n}\r\n\r\n// Wrapper: reset path tracer and, if we had auto-paused due to samples, resume (unpause)\r\nfunction resetPathTracerAndResumeIfAutoPaused() {\r\n\r\n\tpathTracer.reset();\r\n\tif ( _autoPausedDueToSamples ) {\r\n\r\n\t\t_autoPausedDueToSamples = false;\r\n\t\tparams.pause = false;\r\n\r\n\t}\r\n\r\n}\r\n\r\n// Sync only scene environment/background from params (no path tracer calls).\r\n// Applies to any HDRI source: preset env maps, Custom HDRI, or BG Image as HDRI.\r\n// Use during rotation drag so raster view shows exact intensity, saturation, rotation, background.\r\nfunction syncSceneEnvironmentFromParams() {\r\n\r\n\tscene.environmentIntensity = params.environmentIntensity;\r\n\tscene.environmentRotation.y = params.environmentRotation;\r\n\tscene.userData.environmentSaturation = params.environmentSaturation;\r\n\tscene.backgroundBlurriness = params.backgroundBlur;\r\n\r\n\tif (params.backgroundType === 'Gradient') {\r\n\r\n\t\tgradientMap.topColor.set(params.bgGradientTop);\r\n\t\tgradientMap.bottomColor.set(params.bgGradientBottom);\r\n\t\tgradientMap.update();\r\n\r\n\t\tscene.background = gradientMap;\r\n\t\tscene.backgroundIntensity = 1;\r\n\r\n\t\t// Keep scene.environmentRotation from params so path tracer matches raster view (no zeroing)\r\n\r\n\t} else {\r\n\r\n\t\tscene.background = scene.environment;\r\n\t\tscene.backgroundIntensity = params.environmentIntensity;\r\n\t\tscene.backgroundRotation.y = params.environmentRotation;\r\n\r\n\t}\r\n\r\n\tif (params.transparentBackground || params.backgroundImageEnabled) {\r\n\r\n\t\tscene.background = null;\r\n\t\trenderer.setClearAlpha(0);\r\n\r\n\t}\r\n\r\n\t// Sync material envMapRotation for rasterizer view\r\n\t// Three.js materials have their own envMapRotation that needs to be updated\r\n\t// separately from scene.environmentRotation for the WebGL renderer to show\r\n\t// rotated reflections on materials during live preview\r\n\tsyncMaterialEnvMapRotation();\r\n\r\n}\r\n\r\n// Sync the environment rotation to all materials in the scene (preset, custom, or BG-as-HDRI).\r\n// Three.js WebGLRenderer uses material.envMapRotation for reflection sampling.\r\nfunction syncMaterialEnvMapRotation() {\r\n\r\n\tif (!model) return;\r\n\r\n\t// Same rotation for all HDRI sources so raster and path tracer match\r\n\tconst rotationY = params.environmentRotation;\r\n\r\n\t// Create an Euler with the rotation\r\n\tconst envRotation = new Euler(0, rotationY, 0);\r\n\r\n\t// Update all materials in the model\r\n\tmodel.traverse((child) => {\r\n\r\n\t\tif (child.isMesh && child.material) {\r\n\r\n\t\t\tconst materials = Array.isArray(child.material) ? child.material : [child.material];\r\n\t\t\tmaterials.forEach((material) => {\r\n\r\n\t\t\t\t// MeshStandardMaterial and MeshPhysicalMaterial have envMapRotation\r\n\t\t\t\tif (material.envMapRotation) {\r\n\r\n\t\t\t\t\tmaterial.envMapRotation.copy(envRotation);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t// Also update floor plane material\r\n\tif (floorPlane && floorPlane.material && floorPlane.material.envMapRotation) {\r\n\r\n\t\tfloorPlane.material.envMapRotation.copy(envRotation);\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction onParamsChange() {\r\n\r\n\tpathTracer.multipleImportanceSampling = params.multipleImportanceSampling;\r\n\tpathTracer.bounces = params.bounces;\r\n\tpathTracer.filterGlossyFactor = params.filterGlossyFactor;\r\n\tpathTracer.renderScale = params.renderScale;\r\n\tpathTracer.productSaturation = params.productSaturation;\r\n\tpathTracer.productContrast = params.productContrast;\r\n\r\n\tfloorPlane.material.color.set(params.floorColor);\r\n\tfloorPlane.material.roughness = params.floorRoughness;\r\n\tfloorPlane.material.metalness = params.floorMetalness;\r\n\tfloorPlane.material.transmission = params.floorTransmission;\r\n\tfloorPlane.material.ior = params.floorIOR;\r\n\tfloorPlane.material.shadowReflectionCatcher = params.floorShadowReflectionCatcher;\r\n\tfloorPlane.material.shadowCatcherReflectionIntensity = params.floorReflectionIntensity;\r\n\tif ( params.floorMode === 'Shadow Catcher' ) {\r\n\r\n\t\tfloorPlane.material.opacity = Math.min( 1, params.floorShadowOpacity );\r\n\t\tfloorPlane.material.transparent = true;\r\n\r\n\t} else if ( params.floorMode === 'Material alpha' ) {\r\n\r\n\t\tfloorPlane.material.opacity = params.floorOpacity;\r\n\t\tfloorPlane.material.transparent = true;\r\n\r\n\t} else {\r\n\r\n\t\tfloorPlane.material.opacity = params.floorOpacity;\r\n\t\tfloorPlane.material.transparent = params.floorOpacity < 1 || params.floorTransmission > 0;\r\n\r\n\t}\r\n\r\n\tsyncSceneEnvironmentFromParams();\r\n\r\n\tif ( params.focalLength != null && params.focalLength > 0 ) {\r\n\r\n\t\tconst filmHeight = 24;\r\n\t\tperspectiveCamera.fov = MathUtils.radToDeg( 2 * Math.atan( ( filmHeight / 2 ) / params.focalLength ) );\r\n\t\tperspectiveCamera.updateProjectionMatrix();\r\n\t\tpathTracer.updateCamera();\r\n\r\n\t}\r\n\r\n\t// Sync Depth of Field settings to camera\r\n\tperspectiveCamera.focusDistance = params.focusDistance;\r\n\tperspectiveCamera.fStop = params.enableDoF ? params.fStop : 1e10; // Very high fStop disables DoF\r\n\tperspectiveCamera.apertureBlades = params.apertureBlades;\r\n\tperspectiveCamera.apertureRotation = params.apertureRotation;\r\n\tperspectiveCamera.anamorphicRatio = params.anamorphicRatio;\r\n\tpathTracer.updateCamera();\r\n\r\n\tpathTracer.updateMaterials();\r\n\tpathTracer.updateEnvironment();\r\n\r\n}\r\n\r\n// ============================================================\r\n// Background Image (Emissive Plane inside canvas)\r\n// Rendered as a plane attached to the active camera (screen-space).\r\n// This keeps the wallpaper fixed even when orbit/zoom happens.\r\n// ============================================================\r\n\r\nconst BACKGROUND_PLANE_DISTANCE = 2.0;\r\n\r\nlet _bgDragActive = false;\r\nlet _bgPrevEnable = null;\r\nlet _bgPrevPause = null;\r\nlet _bgPrevX = 0;\r\nlet _bgPrevY = 0;\r\n\r\nfunction isBackgroundModeActive() {\r\n\r\n\treturn Boolean(params.backgroundImageEnabled && backgroundPlane && backgroundPlane.visible);\r\n\r\n}\r\n\r\nfunction setBackgroundControlsEnabled(enabled) {\r\n\r\n\t// When background is enabled we disable orbit controls to prevent the perspective \"card\" effect.\r\n\tcontrols.enabled = enabled;\r\n\r\n}\r\n\r\nfunction startBackgroundDrag(e) {\r\n\r\n\tif (!isBackgroundModeActive() || !contentGroup) return;\r\n\r\n\t_bgDragActive = true;\r\n\t_bgPrevX = e.clientX;\r\n\t_bgPrevY = e.clientY;\r\n\r\n\t// Pause path tracing and show raster preview during interaction\r\n\t_bgPrevEnable = params.enable;\r\n\t_bgPrevPause = params.pause;\r\n\tparams.enable = false;\r\n\tparams.pause = true;\r\n\tsetBackgroundControlsEnabled(false);\r\n\r\n}\r\n\r\nfunction moveBackgroundDrag(e) {\r\n\r\n\tif (!_bgDragActive || !contentGroup) return;\r\n\r\n\tconst dx = e.clientX - _bgPrevX;\r\n\tconst dy = e.clientY - _bgPrevY;\r\n\r\n\t// Check mouse buttons: 1 = Left (Rotate), 2 = Right (Pan)\r\n\t// (Note: e.buttons is a bitmask, 1=left, 2=right, 4=middle)\r\n\tif (e.buttons & 1) { // Left click: Rotate\r\n\r\n\t\tconst rotSpeed = 0.005;\r\n\t\tcontentGroup.rotation.y += dx * rotSpeed;\r\n\t\tcontentGroup.rotation.x += dy * rotSpeed;\r\n\t\tcontentGroup.rotation.x = Math.max(- Math.PI / 2, Math.min(Math.PI / 2, contentGroup.rotation.x));\r\n\r\n\t} else if (e.buttons & 2) { // Right click: Pan\r\n\r\n\t\t// Panning moves the contentGroup relative to the camera\r\n\t\t// Since background plane is fixed to camera, moving contentGroup works well.\r\n\t\t// We need to move it in camera-space X/Y, but contentGroup is in world space.\r\n\t\t// For simplicity, assuming camera is roughly looking at Z, we pan X/Y.\r\n\t\t// For better panning, we should use camera right/up vectors, but simple X/Y pan matches the screen plane roughly for this view.\r\n\r\n\t\tconst panSpeed = 0.005 * (activeCamera.position.z || 5); // Scale with distance roughly\r\n\t\tconst panX = dx * panSpeed * 0.2; // Adjust sensitivity\r\n\t\tconst panY = -dy * panSpeed * 0.2;\r\n\r\n\t\t// Move contentGroup in camera space\r\n\t\tconst right = new Vector3(1, 0, 0).applyQuaternion(activeCamera.quaternion);\r\n\t\tconst up = new Vector3(0, 1, 0).applyQuaternion(activeCamera.quaternion);\r\n\r\n\t\tcontentGroup.position.addScaledVector(right, panX);\r\n\t\tcontentGroup.position.addScaledVector(up, panY);\r\n\r\n\t}\r\n\r\n\t_bgPrevX = e.clientX;\r\n\t_bgPrevY = e.clientY;\r\n\r\n}\r\n\r\nasync function endBackgroundDrag() {\r\n\r\n\tif (!_bgDragActive) return;\r\n\t_bgDragActive = false;\r\n\r\n\t// Restore tracing settings\r\n\tparams.enable = _bgPrevEnable ?? params.enable;\r\n\tparams.pause = _bgPrevPause ?? params.pause;\r\n\tsetBackgroundControlsEnabled(true);\r\n\r\n\t// Rebuild path tracer scene because contentGroup transforms changed\r\n\tscene.updateMatrixWorld(true);\r\n\tconst bgResult = await pathTracer.setSceneAsync(scene, activeCamera);\r\n\tsceneBvh = bgResult?.bvh || null;\r\n\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n}\r\n\r\nfunction onBackgroundWheel(e) {\r\n\r\n\tif (!isBackgroundModeActive() || !contentGroup) return;\r\n\r\n\te.preventDefault();\r\n\r\n\t// Zoom model by scaling contentGroup (keeps wallpaper fixed)\r\n\tconst delta = Math.sign(e.deltaY);\r\n\tconst factor = delta > 0 ? 0.95 : 1.05;\r\n\tconst next = MathUtils.clamp(contentGroup.scale.x * factor, 0.25, 4.0);\r\n\tcontentGroup.scale.setScalar(next);\r\n\r\n\t// Pause path tracing while zooming\r\n\tparams.enable = false;\r\n\tparams.pause = true;\r\n\r\n\t// Debounced rebuild (use a microtask-ish timeout)\r\n\tclearTimeout(onBackgroundWheel._t);\r\n\tonBackgroundWheel._t = setTimeout(() => {\r\n\r\n\t\tendBackgroundDrag().catch(() => { });\r\n\r\n\t}, 150);\r\n\r\n}\r\n\r\nfunction createBackgroundPlane() {\r\n\r\n\t// Create a plane attached to the active camera (screen-space background)\r\n\tif (backgroundPlane) return;\r\n\r\n\tconst geometry = new PlaneGeometry(1, 1);\r\n\tconst material = new MeshStandardMaterial({\r\n\t\tcolor: 0xffffff,\r\n\t\temissive: 0xffffff,\r\n\t\temissiveIntensity: params.backgroundImageEmissive,\r\n\t\troughness: 1,\r\n\t\tmetalness: 0,\r\n\t\tside: DoubleSide,\r\n\t});\r\n\r\n\tbackgroundPlane = new Mesh(geometry, material);\r\n\tbackgroundPlane.name = 'backgroundImagePlane';\r\n\tbackgroundPlane.position.set(0, 0, - BACKGROUND_PLANE_DISTANCE);\r\n\tbackgroundPlane.visible = false; // Hidden until image is uploaded\r\n\t// Attach to current camera so it stays fixed on screen\r\n\tactiveCamera.add(backgroundPlane);\r\n\r\n\tconsole.log(' Background plane created');\r\n\r\n}\r\n\r\nfunction updateBackgroundPlaneTransform() {\r\n\r\n\tif (!backgroundPlane || !activeCamera) return;\r\n\r\n\t// Ensure it's parented to the current camera\r\n\tif (backgroundPlane.parent !== activeCamera) {\r\n\r\n\t\tif (backgroundPlane.parent) backgroundPlane.parent.remove(backgroundPlane);\r\n\t\tactiveCamera.add(backgroundPlane);\r\n\r\n\t}\r\n\r\n\t// Keep the plane behind the traced content (behind the controls target)\r\n\tconst distToTarget = controls?.target ? activeCamera.position.distanceTo(controls.target) : BACKGROUND_PLANE_DISTANCE;\r\n\tconst planeDist = Math.max(distToTarget + 0.1, activeCamera.near + 0.1, BACKGROUND_PLANE_DISTANCE);\r\n\r\n\tbackgroundPlane.position.set(0, 0, - planeDist);\r\n\tbackgroundPlane.rotation.set(0, 0, 0);\r\n\r\n\t// View frustum size at planeDist (full canvas in world units)\r\n\tlet viewW = 1;\r\n\tlet viewH = 1;\r\n\r\n\tif (activeCamera.isPerspectiveCamera) {\r\n\r\n\t\tconst vFov = MathUtils.degToRad(activeCamera.fov);\r\n\t\tviewH = 2 * planeDist * Math.tan(vFov / 2);\r\n\t\tviewW = viewH * activeCamera.aspect;\r\n\r\n\t} else if (activeCamera.isOrthographicCamera) {\r\n\r\n\t\tviewW = activeCamera.right - activeCamera.left;\r\n\t\tviewH = activeCamera.top - activeCamera.bottom;\r\n\r\n\t}\r\n\r\n\t// Size plane to exact image dimensions (aspect ratio): contain inside view, no stretch\r\n\tlet planeW = viewW;\r\n\tlet planeH = viewH;\r\n\tif (backgroundImageNaturalWidth > 0 && backgroundImageNaturalHeight > 0) {\r\n\r\n\t\tconst imageAspect = backgroundImageNaturalWidth / backgroundImageNaturalHeight;\r\n\t\tconst viewAspect = viewW / viewH;\r\n\t\tif (imageAspect > viewAspect) {\r\n\r\n\t\t\t// Image wider than view  fit width, letterbox top/bottom\r\n\t\t\tplaneH = viewW / imageAspect;\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// Image taller than view  fit height, letterbox left/right\r\n\t\t\tplaneW = viewH * imageAspect;\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tbackgroundPlane.scale.set(planeW, planeH, 1);\r\n\r\n}\r\n\r\nfunction updateBackgroundTextureUVFit() {\r\n\r\n\tif (!backgroundTexture || !activeCamera) return;\r\n\r\n\t// Plane is now sized to exact image aspect (updateBackgroundPlaneTransform), so show\r\n\t// full texture 1:1 on the plane  no repeat/offset letterbox, no stretched edges.\r\n\t// V flip so image top = screen top (PlaneGeometry convention).\r\n\tbackgroundTexture.wrapS = ClampToEdgeWrapping;\r\n\tbackgroundTexture.wrapT = ClampToEdgeWrapping;\r\n\tbackgroundTexture.repeat.set(1, - 1);\r\n\tbackgroundTexture.offset.set(0, 1);\r\n\tbackgroundTexture.needsUpdate = true;\r\n\r\n}\r\n\r\nfunction updateBackgroundPlaneTexture(img) {\r\n\r\n\tif (!backgroundPlane) {\r\n\r\n\t\tcreateBackgroundPlane();\r\n\r\n\t}\r\n\r\n\t//  NEW: Apply brightness to the image before creating texture\r\n\t// Using params.backgroundImageEmissive as the brightness value (0-10)\r\n\tconsole.log(` Updating background texture with brightness: ${params.backgroundImageEmissive}`);\r\n\r\n\tconst processedCanvas = applyBrightnessSaturationToImage(\r\n\t\timg,\r\n\t\tparams.backgroundImageEmissive, // Use as direct brightness multiplier (0-10)\r\n\t\t1.0 // Default saturation (1.0)\r\n\t);\r\n\r\n\t// Create texture from processed image\r\n\tconst texture = new Texture(processedCanvas);\r\n\r\n\t//  FIX: Match Custom Wallpaper settings for consistency\r\n\t// - flipY: false (images loaded via Image() are naturally upright, texture default needs control)\r\n\t// - sRGB: Correct color interpretation\r\n\t// - Anisotropy: Better oblique viewing\r\n\ttexture.flipY = false;\r\n\ttexture.colorSpace = SRGBColorSpace;\r\n\ttexture.generateMipmaps = true;\r\n\ttexture.minFilter = LinearMipmapLinearFilter;\r\n\ttexture.magFilter = LinearFilter;\r\n\ttexture.anisotropy = 16;\r\n\ttexture.needsUpdate = true;\r\n\r\n\t// Dispose old texture\r\n\tif (backgroundTexture) {\r\n\r\n\t\tbackgroundTexture.dispose();\r\n\r\n\t}\r\n\r\n\tbackgroundTexture = texture;\r\n\r\n\t// Update material\r\n\tconst material = backgroundPlane.material;\r\n\tmaterial.map = texture;\r\n\tmaterial.emissiveMap = texture;\r\n\tmaterial.emissive = new Color(0xffffff);\r\n\t//  Fixed to 1.0: Brightness is now baked into the texture pixels\r\n\t// This ensures consistency with custom wallpaper and path tracer light accumulation\r\n\tmaterial.emissiveIntensity = 1.0;\r\n\tmaterial.roughness = 1.0;\r\n\tmaterial.metalness = 0.0;\r\n\tmaterial.needsUpdate = true;\r\n\r\n\tupdateBackgroundPlaneTransform();\r\n\tupdateBackgroundTextureUVFit();\r\n\r\n\t// Show the plane\r\n\tbackgroundPlane.visible = true;\r\n\r\n\t// Update path tracer\r\n\tpathTracer.updateMaterials();\r\n\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\tconsole.log(` Background plane texture updated (brightness baked: ${params.backgroundImageEmissive})`);\r\n\r\n}\r\n\r\nasync function updateBackgroundEmissive() {\r\n\r\n\tif (!backgroundPlane || !backgroundImageOriginal) return;\r\n\r\n\t// Re-process the texture to bake in the new brightness\r\n\t// This replaces the old logic of just changing emissiveIntensity\r\n\tupdateBackgroundPlaneTexture(backgroundImageOriginal);\r\n\r\n}\r\n\r\nasync function showBackgroundPlane() {\r\n\r\n\tif (backgroundOverlay && backgroundImageSrc) {\r\n\r\n\t\tbackgroundOverlay.src = backgroundImageSrc;\r\n\t\tbackgroundOverlay.style.display = 'block';\r\n\r\n\t}\r\n\r\n}\r\n\r\nasync function hideBackgroundPlane() {\r\n\r\n\tif (backgroundOverlay) {\r\n\r\n\t\tbackgroundOverlay.style.display = 'none';\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction applyBackgroundAsHDRI() {\r\n\r\n\tif ( !backgroundImageOriginal || !params.backgroundAsHDRI ) {\r\n\r\n\t\t// Disable: restore original environment (preset or custom HDRI)\r\n\t\tif ( previousEnvironment !== null ) {\r\n\r\n\t\t\tscene.environment = previousEnvironment;\r\n\t\t\tpreviousEnvironment = null;\r\n\r\n\t\t}\r\n\r\n\t\tif ( backgroundHDRITexture ) {\r\n\r\n\t\t\tbackgroundHDRITexture.dispose();\r\n\t\t\tbackgroundHDRITexture = null;\r\n\r\n\t\t}\r\n\r\n\t\t// Re-apply rotation/intensity/saturation to restored env so all HDRI sources behave the same\r\n\t\tsyncSceneEnvironmentFromParams();\r\n\t\tpathTracer.updateEnvironment();\r\n\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\t// Convert LDR image to DataTexture with raw RGBA float pixel data.\r\n\t// The path tracer's EquirectHdrInfoUniform.updateFrom() needs image.data\r\n\t// as a typed array for importance sampling  PMREM/GPU textures won't work.\r\n\tconst img = backgroundImageOriginal;\r\n\tconst cvs = document.createElement( 'canvas' );\r\n\tcvs.width = img.width;\r\n\tcvs.height = img.height;\r\n\tconst ctx = cvs.getContext( '2d' );\r\n\tctx.drawImage( img, 0, 0 );\r\n\tconst pixels = ctx.getImageData( 0, 0, img.width, img.height );\r\n\r\n\t// Convert sRGB Uint8  linear Float32\r\n\tconst floatData = new Float32Array( img.width * img.height * 4 );\r\n\tfor ( let i = 0; i < pixels.data.length; i += 4 ) {\r\n\r\n\t\tfloatData[ i ] = Math.pow( pixels.data[ i ] / 255, 2.2 );\r\n\t\tfloatData[ i + 1 ] = Math.pow( pixels.data[ i + 1 ] / 255, 2.2 );\r\n\t\tfloatData[ i + 2 ] = Math.pow( pixels.data[ i + 2 ] / 255, 2.2 );\r\n\t\tfloatData[ i + 3 ] = 1.0;\r\n\r\n\t}\r\n\r\n\tconst envDataTexture = new DataTexture( floatData, img.width, img.height, RGBAFormat, FloatType );\r\n\tenvDataTexture.mapping = EquirectangularReflectionMapping;\r\n\tenvDataTexture.needsUpdate = true;\r\n\r\n\t// Dispose old HDRI texture\r\n\tif ( backgroundHDRITexture ) {\r\n\r\n\t\tbackgroundHDRITexture.dispose();\r\n\r\n\t}\r\n\r\n\tbackgroundHDRITexture = envDataTexture;\r\n\r\n\t// Store original environment if not already stored\r\n\tif ( previousEnvironment === null ) {\r\n\r\n\t\tpreviousEnvironment = scene.environment;\r\n\r\n\t}\r\n\r\n\t// Apply as environment lighting (does NOT affect the CSS background overlay)\r\n\tscene.environment = envDataTexture;\r\n\t// Apply rotation/intensity/saturation so BG-as-HDRI matches preset/custom behavior\r\n\tsyncSceneEnvironmentFromParams();\r\n\r\n\tpathTracer.updateEnvironment();\r\n\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\tconsole.log( ` Background image converted to HDRI environment (${img.width}x${img.height} DataTexture)` );\r\n\r\n}\r\n\r\nfunction updateBackgroundHDRIIntensity() {\r\n\r\n\tif ( !params.backgroundAsHDRI || !backgroundHDRITexture ) return;\r\n\r\n\tscene.environmentIntensity = params.environmentIntensity;\r\n\tpathTracer.updateEnvironment();\r\n\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n}\r\n\r\nfunction handleBackgroundImageUpload(file) {\r\n\r\n\tif (!file || !file.type.startsWith('image/')) {\r\n\r\n\t\talert('Please upload an image file');\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\tconst reader = new FileReader();\r\n\treader.onload = (e) => {\r\n\r\n\t\tconst img = new Image();\r\n\t\timg.onload = async () => {\r\n\r\n\t\t\tbackgroundImageSrc = e.target.result;\r\n\t\t\tbackgroundImageNaturalWidth = img.width;\r\n\t\t\tbackgroundImageNaturalHeight = img.height;\r\n\t\t\tbackgroundImageOriginal = img; // Store for HDRI conversion\r\n\r\n\t\t\t// Enable background\r\n\t\t\tparams.backgroundImageEnabled = true;\r\n\r\n\t\t\t// Show as CSS overlay behind the canvas\r\n\t\t\tif (backgroundOverlay) {\r\n\r\n\t\t\t\tbackgroundOverlay.src = backgroundImageSrc;\r\n\t\t\t\tbackgroundOverlay.style.display = 'block';\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Expose to window for ImageRenderModal capture\r\n\t\t\twindow.backgroundImageSrc = backgroundImageSrc;\r\n\t\t\twindow.backgroundImageNaturalWidth = backgroundImageNaturalWidth;\r\n\t\t\twindow.backgroundImageNaturalHeight = backgroundImageNaturalHeight;\r\n\r\n\t\t\t// Auto-apply as HDRI if toggle is on\r\n\t\t\tif (params.backgroundAsHDRI) {\r\n\r\n\t\t\t\tapplyBackgroundAsHDRI();\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Set canvas transparent so CSS overlay shows through\r\n\t\t\tonParamsChange();\r\n\r\n\t\t\t// Rebuild GUI\r\n\t\t\tbuildGui();\r\n\r\n\t\t\tconsole.log(` Background image loaded: ${img.width}x${img.height} (CSS overlay)`);\r\n\r\n\t\t};\r\n\t\timg.src = e.target.result;\r\n\r\n\t};\r\n\treader.readAsDataURL(file);\r\n\r\n}\r\n\r\nfunction onHashChange() {\r\n\r\n\tlet hashModel = '';\r\n\tif (window.location.hash) {\r\n\r\n\t\tconst modelName = decodeURI(window.location.hash.substring(1));\r\n\t\tif (modelName in models) {\r\n\r\n\t\t\thashModel = modelName;\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tif (!(hashModel in models)) {\r\n\r\n\t\t// Default to Headphone Static if available, otherwise first model in list\r\n\t\thashModel = 'Headphone Static' in models ? 'Headphone Static' : Object.keys(models)[0];\r\n\r\n\t}\r\n\r\n\tparams.model = hashModel;\r\n\tupdateModel();\r\n\r\n}\r\n\r\nfunction onResize() {\r\n\r\n\tconst w = window.innerWidth;\r\n\tconst h = window.innerHeight;\r\n\tconst dpr = window.devicePixelRatio;\r\n\r\n\trenderer.setSize(w, h);\r\n\trenderer.setPixelRatio(dpr);\r\n\r\n\tconst aspect = w / h;\r\n\tperspectiveCamera.aspect = aspect;\r\n\tperspectiveCamera.updateProjectionMatrix();\r\n\r\n\tconst orthoHeight = orthoWidth / aspect;\r\n\torthoCamera.top = orthoHeight / 2;\r\n\torthoCamera.bottom = orthoHeight / - 2;\r\n\torthoCamera.updateProjectionMatrix();\r\n\r\n\tpathTracer.updateCamera();\r\n\tupdateBackgroundPlaneTransform();\r\n\tupdateBackgroundTextureUVFit();\r\n\r\n}\r\n\r\n// ============================================================\r\n// Click-to-Focus for Depth of Field\r\n// Click on any point in the scene to set focus distance\r\n// ============================================================\r\n\r\nfunction onFocusPointerDown( e ) {\r\n\r\n\tfocusMouse.set( e.clientX, e.clientY );\r\n\r\n}\r\n\r\nfunction onFocusPointerUp( e ) {\r\n\r\n\t// Only trigger on small mouse movements (click, not drag)\r\n\tconst deltaMouse = Math.abs( focusMouse.x - e.clientX ) + Math.abs( focusMouse.y - e.clientY );\r\n\tif ( deltaMouse < 5 && sceneBvh && params.enableDoF ) {\r\n\r\n\t\tconst raycaster = new Raycaster();\r\n\t\traycaster.setFromCamera( {\r\n\t\t\tx: ( e.clientX / window.innerWidth ) * 2 - 1,\r\n\t\t\ty: - ( e.clientY / window.innerHeight ) * 2 + 1,\r\n\t\t}, activeCamera );\r\n\r\n\t\tconst hit = sceneBvh.raycastFirst( raycaster.ray );\r\n\t\tif ( hit ) {\r\n\r\n\t\t\tparams.focusDistance = Math.max( 0.1, hit.distance - activeCamera.near );\r\n\t\t\tperspectiveCamera.focusDistance = params.focusDistance;\r\n\t\t\tpathTracer.updateCamera();\r\n\r\n\t\t\t// Update the GUI slider to reflect the new value\r\n\t\t\tif ( gui ) {\r\n\r\n\t\t\t\tgui.controllersRecursive().forEach( c => {\r\n\r\n\t\t\t\t\tif ( c.property === 'focusDistance' ) c.updateDisplay();\r\n\r\n\t\t\t\t} );\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction buildGui() {\r\n\r\n\tif (gui) {\r\n\r\n\t\tgui.destroy();\r\n\r\n\t}\r\n\r\n\tgui = new GUI();\r\n\r\n\tgui.add(params, 'model', Object.keys(models).sort()).onChange(v => {\r\n\r\n\t\twindow.location.hash = v;\r\n\r\n\t});\r\n\r\n\t// Animation frame control at top (like GLBViewer ControlPanel: Frames 0150)\r\n\tif (animationMixer && mainAnimAction && mainAnimClip) {\r\n\r\n\t\tconst animationFolder = gui.addFolder('Animation');\r\n\t\tconst maxFrame = Math.floor( ( mainAnimClip.duration || 5 ) * ANIMATION_FRAME_RATE );\r\n\t\tlet _animFrameDebounce = null;\r\n\t\tlet _animDragging = false;\r\n\t\tlet _animPrevPause = false;\r\n\t\tanimationFolder.add(params, 'animationFrame', 0, maxFrame, 1).name(`Frame (0${maxFrame})`).onChange(( frame ) => {\r\n\r\n\t\t\t// Pause path tracing on first drag tick so the GPU isn't fighting us\r\n\t\t\tif ( ! _animDragging ) {\r\n\r\n\t\t\t\t_animDragging = true;\r\n\t\t\t\t_animPrevPause = params.pause;\r\n\t\t\t\tparams.pause = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// 1. Pose update  cheap\r\n\t\t\tconst timeInSeconds = Math.min(frame / ANIMATION_FRAME_RATE, mainAnimClip.duration || 5);\r\n\t\t\tmainAnimAction.time = timeInSeconds;\r\n\t\t\tanimationMixer.update(0);\r\n\t\t\tscene.updateMatrixWorld(true);\r\n\r\n\t\t\t// 2. Quick raster preview\r\n\t\t\trenderer.render( scene, activeCamera );\r\n\r\n\t\t\t// 3. Debounce heavy BVH rebuild  2 s after the user stops dragging\r\n\t\t\tclearTimeout( _animFrameDebounce );\r\n\t\t\t_animFrameDebounce = setTimeout( async () => {\r\n\r\n\t\t\t\ttry {\r\n\r\n\t\t\t\t\tconst animResult = await pathTracer.setSceneAsync( scene, activeCamera );\r\n\t\t\t\t\tsceneBvh = animResult?.bvh || null;\r\n\t\t\t\t\tpathTracer.updateCamera();\r\n\t\t\t\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\t\t\t\t} catch (e) {\r\n\r\n\t\t\t\t\tconsole.error('Failed to update path tracer scene for animation frame', e);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Restore pause state so path tracing resumes\r\n\t\t\t\t_animDragging = false;\r\n\t\t\t\tparams.pause = _animPrevPause;\r\n\r\n\t\t\t}, 2000 );\r\n\r\n\t\t});\r\n\t\t// Include Off screen in Animation folder only when wallpaper meshes were detected\r\n\t\tif (Object.keys(wallpaperMeshes).some(key => wallpaperMeshes[key] !== null)) {\r\n\r\n\t\t\tparams.animationScreen = (currentWallpaper === 'off_screen' || currentWallpaper === 'Off screen') ? 'Off screen' : 'On';\r\n\t\t\tanimationFolder.add(params, 'animationScreen', ['On', 'Off screen']).name('Screen').onChange(async (value) => {\r\n\r\n\t\t\t\tif (value === 'Off screen') {\r\n\r\n\t\t\t\t\tcurrentWallpaper = 'off_screen';\r\n\t\t\t\t\tparams.screenWallpaper = 'off_screen';\r\n\t\t\t\t\tawait updateWallpaperVisibility('off_screen');\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\tconst toShow = (params.screenWallpaper === 'off_screen' || params.screenWallpaper === 'Off screen') ? 'blank_screen' : params.screenWallpaper;\r\n\t\t\t\t\tcurrentWallpaper = toShow;\r\n\t\t\t\t\tparams.screenWallpaper = toShow;\r\n\t\t\t\t\tawait updateWallpaperVisibility(toShow);\r\n\r\n\t\t\t\t}\r\n\t\t\t\tpathTracer.updateMaterials();\r\n\t\t\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t\tanimationFolder.open();\r\n\r\n\t}\r\n\r\n\t//  Product Color controls (dynamic  only shown when GLB has productColor meshes) \r\n\tconst colorKeys = Object.keys( colorMeshGroups );\r\n\tif ( colorKeys.length > 0 ) {\r\n\r\n\t\tconst colorFolder = gui.addFolder( 'Product Color' );\r\n\r\n\t\t// Build a friendly label  key map for the dropdown\r\n\t\tconst colorLabels = {};\r\n\t\tcolorKeys.forEach( key => {\r\n\r\n\t\t\tconst grp = colorMeshGroups[ key ];\r\n\t\t\tconst label = grp.prefix.charAt( 0 ).toUpperCase() + grp.prefix.slice( 1 );\r\n\t\t\tcolorLabels[ label ] = key;\r\n\r\n\t\t} );\r\n\r\n\t\tparams.productColor = currentColorGroup || colorKeys[ 0 ];\r\n\r\n\t\tcolorFolder.add( params, 'productColor', colorLabels ).name( 'Color' ).onChange( async ( key ) => {\r\n\r\n\t\t\t// Hide all color meshes\r\n\t\t\tObject.values( colorMeshGroups ).forEach( grp => {\r\n\r\n\t\t\t\tgrp.names.forEach( meshName => {\r\n\r\n\t\t\t\t\tconst m = model.getObjectByName( meshName );\r\n\t\t\t\t\tif ( m ) m.visible = false;\r\n\r\n\t\t\t\t} );\r\n\r\n\t\t\t} );\r\n\r\n\t\t\t// Show selected group\r\n\t\t\tconst selected = colorMeshGroups[ key ];\r\n\t\t\tif ( selected ) {\r\n\r\n\t\t\t\tselected.names.forEach( meshName => {\r\n\r\n\t\t\t\t\tconst m = model.getObjectByName( meshName );\r\n\t\t\t\t\tif ( m ) m.visible = true;\r\n\r\n\t\t\t\t} );\r\n\r\n\t\t\t}\r\n\t\t\tcurrentColorGroup = key;\r\n\r\n\t\t\t// Immediate raster preview so the user sees the change while BVH rebuilds\r\n\t\t\trenderer.render( scene, activeCamera );\r\n\r\n\t\t\t// Rebuild path tracer BVH so the visibility change is reflected\r\n\t\t\tscene.updateMatrixWorld( true );\r\n\t\t\ttry {\r\n\r\n\t\t\t\tconst colorResult = await pathTracer.setSceneAsync( scene, activeCamera );\r\n\t\t\t\tsceneBvh = colorResult?.bvh || null;\r\n\r\n\t\t\t} catch ( e ) {\r\n\r\n\t\t\t\tconsole.error( 'Failed to update path tracer after color change', e );\r\n\r\n\t\t\t}\r\n\t\t\tpathTracer.updateMaterials();\r\n\t\t\tpathTracer.updateCamera();   // force the path tracer to recognise the new scene state\r\n\t\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\t\t} );\r\n\r\n\t\tcolorFolder.open();\r\n\r\n\t}\r\n\r\n\tconst pathTracingFolder = gui.addFolder('Path Tracer');\r\n\tenableController = pathTracingFolder.add(params, 'enable');\r\n\tpathTracingFolder.add(params, 'pause').onChange(() => {\r\n\r\n\t\t_autoPausedDueToSamples = false;\r\n\r\n\t});\r\n\t// When modal closes, re-enable path tracer checkbox so user can turn preview back on\r\n\tif ( imageRenderModal ) imageRenderModal.onClose = () => {\r\n\r\n\t\tparams.enable = true;\r\n\t\tif ( enableController ) enableController.disable( false );\r\n\r\n\t};\r\n\t// When user clicks Render, turn path tracer on immediately so canvas accumulates and we can capture\r\n\tif ( imageRenderModal ) imageRenderModal.onBeforeRender = () => {\r\n\r\n\t\tparams.enable = true;\r\n\t\tif ( enableController ) enableController.disable( false );\r\n\r\n\t};\r\n\tpathTracingFolder.add(params, 'multipleImportanceSampling').onChange(onParamsChange);\r\n\tpathTracingFolder.add(params, 'acesToneMapping').onChange(v => {\r\n\r\n\t\trenderer.toneMapping = v ? ACESFilmicToneMapping : NoToneMapping;\r\n\r\n\t});\r\n\tpathTracingFolder.add(params, 'bounces', 1, 30, 1).onChange(onParamsChange);\r\n\tpathTracingFolder.add(params, 'filterGlossyFactor', 0, 1).onChange(onParamsChange);\r\n\t// Allow very high internal resolution up to 8x (can be heavy on GPU)\r\n\tpathTracingFolder.add(params, 'renderScale', 0.1, 2.0, 0.01).onChange(() => {\r\n\r\n\t\tonParamsChange();\r\n\r\n\t});\r\n\tpathTracingFolder.add(params, 'tiles', 1, 10, 1).onChange(v => {\r\n\r\n\t\tpathTracer.tiles.set(v, v);\r\n\r\n\t});\r\n\tpathTracingFolder.add(params, 'previewSamplesMax', 100, 5000, 100).name('Preview Sample Cap');\r\n\tpathTracingFolder.add(params, 'cameraProjection', ['Perspective', 'Orthographic']).onChange(v => {\r\n\r\n\t\tupdateCameraProjection(v);\r\n\r\n\t});\r\n\tpathTracingFolder.add(params, 'focalLength', 15, 100, 1).onChange(onParamsChange).name('Focal length (mm)');\r\n\tpathTracingFolder.add(params, 'productSaturation', 0, 2, 0.01).onChange(onParamsChange).name('Product saturation');\r\n\tpathTracingFolder.add(params, 'productContrast', 0.5, 2, 0.01).onChange(onParamsChange).name('Product contrast');\r\n\tconst renderImageController = pathTracingFolder.add({\r\n\t\trenderImage: () => {\r\n\r\n\t\t\tif (imageRenderModal) {\r\n\r\n\t\t\t\t// Disable path tracer while modal is open (reduce load until user clicks Render)\r\n\t\t\t\tparams.enable = false;\r\n\t\t\t\tif ( enableController ) enableController.disable();\r\n\t\t\t\timageRenderModal.open();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}, 'renderImage').name('Render Image...');\r\n\r\n\t// Add custom class to highlight the render button\r\n\tif (renderImageController && renderImageController.domElement) {\r\n\r\n\t\trenderImageController.domElement.classList.add('render-image-button');\r\n\t\tconst button = renderImageController.domElement.querySelector('button');\r\n\t\tif (button) {\r\n\r\n\t\t\tbutton.classList.add('render-image-btn');\r\n\r\n\t\t}\r\n\r\n\t}\r\n\tpathTracingFolder.open();\r\n\r\n\t// Depth of Field controls\r\n\tconst dofFolder = gui.addFolder('Depth of Field');\r\n\tdofFolder.add(params, 'enableDoF').name('Enable DoF').onChange(onParamsChange);\r\n\tdofFolder.add(params, 'focusDistance', 0.1, 50, 0.1).name('Focus Distance').onChange(onParamsChange);\r\n\tdofFolder.add(params, 'fStop', 0.5, 22, 0.1).name('f-Stop (Aperture)').onChange(onParamsChange);\r\n\tdofFolder.add(params, 'apertureBlades', 0, 10, 1).name('Aperture Blades').onChange(onParamsChange);\r\n\tdofFolder.add(params, 'apertureRotation', 0, Math.PI, 0.01).name('Aperture Rotation').onChange(onParamsChange);\r\n\tdofFolder.add(params, 'anamorphicRatio', 0.5, 2, 0.01).name('Anamorphic Ratio').onChange(onParamsChange);\r\n\tdofFolder.close();\r\n\r\n\tconst environmentFolder = gui.addFolder('environment');\r\n\tenvironmentFolder.add(params, 'envMap', envMaps).name('map').onChange(updateEnvMap);\r\n\tenvironmentFolder.add({ loadCustomHDRI }, 'loadCustomHDRI').name('Load Custom HDRI');\r\n\tenvironmentFolder.add(params, 'environmentIntensity', 0.0, 10.0).onChange(onParamsChange).name('intensity');\r\n\tenvironmentFolder.add(params, 'environmentRotation', 0, 2 * Math.PI)\r\n\t\t.name('rotation')\r\n\t\t.onChange(() => {\r\n\t\t\t// While dragging: pause path tracer and show HDRI rotation live in raster view\r\n\t\t\tif (!_envRotationDragging) {\r\n\t\t\t\t_envRotationDragging = true;\r\n\t\t\t\t_envRotPrevEnable = params.enable;\r\n\t\t\t\tparams.enable = false;\r\n\t\t\t}\r\n\t\t\tsyncSceneEnvironmentFromParams();\r\n\t\t\t// During rotation drag show current HDRI as background (preset, custom, or BG-as-HDRI) so user sees it rotate\r\n\t\t\tif (!params.transparentBackground && !params.backgroundImageEnabled && scene.environment) {\r\n\t\t\t\tscene.background = scene.environment;\r\n\t\t\t\tscene.backgroundIntensity = params.environmentIntensity;\r\n\t\t\t\tscene.backgroundRotation.y = params.environmentRotation;\r\n\t\t\t}\r\n\t\t})\r\n\t\t.onFinishChange(() => {\r\n\t\t\t_envRotationDragging = false;\r\n\t\t\tonParamsChange();\r\n\t\t\tparams.enable = _envRotPrevEnable ?? true;\r\n\t\t});\r\n\tenvironmentFolder.add(params, 'environmentSaturation', 0, 2).onChange(onParamsChange).name('HDRI saturation');\r\n\r\n\t// Use background image as environment lighting (PMREM conversion)\r\n\tenvironmentFolder.add(params, 'backgroundAsHDRI').name('BG Image as HDRI').onChange(() => {\r\n\r\n\t\tapplyBackgroundAsHDRI();\r\n\r\n\t});\r\n\r\n\tenvironmentFolder.open();\r\n\r\n\tconst backgroundFolder = gui.addFolder('background');\r\n\tbackgroundFolder.add(params, 'backgroundType', ['Environment', 'Gradient']).onChange(onParamsChange);\r\n\tbackgroundFolder.addColor(params, 'bgGradientTop').onChange(onParamsChange);\r\n\tbackgroundFolder.addColor(params, 'bgGradientBottom').onChange(onParamsChange);\r\n\tbackgroundFolder.add(params, 'backgroundBlur', 0, 1).onChange(onParamsChange);\r\n\t// transparentBackground and checkerboardTransparency removed  PNG auto-handles transparency\r\n\r\n\t// Background image upload (emissive plane inside canvas)\r\n\tbackgroundFolder.add({\r\n\t\tuploadBackgroundImage: () => {\r\n\r\n\t\t\tconst fileInput = document.createElement('input');\r\n\t\t\tfileInput.type = 'file';\r\n\t\t\tfileInput.accept = 'image/*';\r\n\t\t\tfileInput.style.display = 'none';\r\n\t\t\tfileInput.addEventListener('change', (e) => {\r\n\r\n\t\t\t\tif (e.target.files[0]) {\r\n\r\n\t\t\t\t\thandleBackgroundImageUpload(e.target.files[0]);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\t\tfileInput.click();\r\n\r\n\t\t}\r\n\t}, 'uploadBackgroundImage').name('Upload Background');\r\n\r\n\tbackgroundFolder.add(params, 'backgroundImageEnabled').name('Show Background Image').onChange((v) => {\r\n\r\n\t\tif (v && backgroundImageSrc) {\r\n\r\n\t\t\tshowBackgroundPlane();\r\n\r\n\t\t} else {\r\n\r\n\t\t\thideBackgroundPlane();\r\n\r\n\t\t}\r\n\r\n\t\tonParamsChange(); // Update canvas transparency\r\n\r\n\t});\r\n\r\n\tbackgroundFolder.add({\r\n\t\tremoveBackgroundImage: async () => {\r\n\r\n\t\t\tbackgroundImageSrc = null;\r\n\t\t\tbackgroundImageNaturalWidth = 0;\r\n\t\t\tbackgroundImageNaturalHeight = 0;\r\n\t\t\tbackgroundImageOriginal = null;\r\n\t\t\tparams.backgroundImageEnabled = false;\r\n\r\n\t\t\t// Clear window references\r\n\t\t\twindow.backgroundImageSrc = null;\r\n\t\t\twindow.backgroundImageNaturalWidth = 0;\r\n\t\t\twindow.backgroundImageNaturalHeight = 0;\r\n\r\n\t\t\t// Hide CSS overlay\r\n\t\t\tif (backgroundOverlay) {\r\n\r\n\t\t\t\tbackgroundOverlay.style.display = 'none';\r\n\t\t\t\tbackgroundOverlay.src = '';\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Clean up HDRI conversion\r\n\t\t\tparams.backgroundAsHDRI = false;\r\n\t\t\tif ( backgroundHDRITexture ) {\r\n\r\n\t\t\t\t// Restore original environment\r\n\t\t\t\tif ( previousEnvironment !== null ) {\r\n\r\n\t\t\t\t\tscene.environment = previousEnvironment;\r\n\t\t\t\t\tscene.environmentIntensity = params.environmentIntensity;\r\n\t\t\t\t\tpreviousEnvironment = null;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbackgroundHDRITexture.dispose();\r\n\t\t\t\tbackgroundHDRITexture = null;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Refresh path tracer environment and params\r\n\t\t\tonParamsChange();\r\n\t\t\tbuildGui();\r\n\r\n\t\t}\r\n\t}, 'removeBackgroundImage').name('Remove Background');\r\n\r\n\tconst floorFolder = gui.addFolder( 'Floor' );\r\n\r\n\t// Shadow Catcher = transparent ground + reflections/shadows (alpha from geometry). Material alpha = transparent from opacity/alpha only (hit-flag, no luminance).\r\n\tconst floorModeCtrl = floorFolder.add( params, 'floorMode', [ 'Solid Ground', 'Shadow Catcher', 'Material alpha' ] ).name( 'Mode' );\r\n\r\n\t// Solid + Material alpha: color, opacity, transmission, IOR (hidden in Shadow Catcher mode)\r\n\tconst solidControls = [];\r\n\tsolidControls.push( floorFolder.addColor( params, 'floorColor' ).onChange( onParamsChange ) );\r\n\tsolidControls.push( floorFolder.add( params, 'floorOpacity', 0, 1 ).onChange( onParamsChange ).name( 'Opacity' ) );\r\n\tsolidControls.push( floorFolder.add( params, 'floorTransmission', 0, 1 ).name( 'Transmission' ).onChange( onParamsChange ) );\r\n\tsolidControls.push( floorFolder.add( params, 'floorIOR', 1.0, 2.0, 0.01 ).name( 'IOR' ).onChange( onParamsChange ) );\r\n\r\n\t// Shadow Catcheronly: shadow opacity (intensity of shadow on ground)\r\n\tconst shadowOpacityCtrl = floorFolder.add( params, 'floorShadowOpacity', 0, 2 ).onChange( onParamsChange ).name( 'Shadow opacity' );\r\n\r\n\t// Shadow Catcher: reflection intensity on ground (high = brighter reflection)\r\n\tfloorFolder.add( params, 'floorReflectionIntensity', 0, 10, 0.1 ).onChange( onParamsChange ).name( 'Reflection intensity' );\r\n\r\n\t// Shared controls (visible in all modes)\r\n\tfloorFolder.add( params, 'floorRoughness', 0, 1 ).onChange( onParamsChange );\r\n\tfloorFolder.add( params, 'floorMetalness', 0, 1 ).onChange( onParamsChange );\r\n\r\n\tfunction applyFloorMode( mode ) {\r\n\r\n\t\tconst isCatcher = mode === 'Shadow Catcher';\r\n\t\tconst isMaterialAlpha = mode === 'Material alpha';\r\n\t\tparams.floorShadowReflectionCatcher = isCatcher;\r\n\r\n\t\t// All floor controls visible for all modes (no hiding)\r\n\t\tsolidControls.forEach( ctrl => { ctrl.domElement.style.display = ''; } );\r\n\t\tshadowOpacityCtrl.domElement.style.display = '';\r\n\r\n\t\tif ( isCatcher ) {\r\n\r\n\t\t\tfloorPlane.material.opacity = Math.min( 1, params.floorShadowOpacity );\r\n\t\t\tfloorPlane.material.transparent = true;\r\n\r\n\t\t} else if ( isMaterialAlpha ) {\r\n\r\n\t\t\tfloorPlane.material.opacity = params.floorOpacity;\r\n\t\t\tfloorPlane.material.transparent = true;\r\n\r\n\t\t} else {\r\n\r\n\t\t\tfloorPlane.material.opacity = params.floorOpacity;\r\n\t\t\tfloorPlane.material.transparent = params.floorOpacity < 1 || params.floorTransmission > 0;\r\n\r\n\t\t}\r\n\r\n\t\tonParamsChange();\r\n\r\n\t}\r\n\r\n\tfloorModeCtrl.onChange( applyFloorMode );\r\n\t// Apply initial state\r\n\tapplyFloorMode( params.floorMode );\r\n\r\n\tfloorFolder.open();\r\n\r\n\t// Screen controls: only show when wallpaper meshes were detected\r\n\tif (Object.keys(wallpaperMeshes).some(key => wallpaperMeshes[key] !== null)) {\r\n\r\n\t\tconst screenFolder = gui.addFolder('Screen');\r\n\r\n\t\t// Build wallpaper options list - include \"Off screen\" option to hide all wallpapers\r\n\t\tconst wallpaperOptions = ['off_screen', 'blank_screen', 'blue_bloom', 'aurora_borealis', 'feather_light', 'asus_1', 'asus_2', 'custom'];\r\n\t\tconst availableWallpapers = wallpaperOptions.filter(option => {\r\n\t\t\tif (option === 'custom' || option === 'off_screen') return true;\r\n\t\t\treturn wallpaperMeshes[option] !== null;\r\n\t\t});\r\n\r\n\t\t// Add wallpaper dropdown (includes off_screen)\r\n\t\tscreenFolder.add(params, 'screenWallpaper', availableWallpapers).name('Wallpaper').onChange(async (value) => {\r\n\r\n\t\t\tcurrentWallpaper = value;\r\n\t\t\tparams.screenWallpaper = value;\r\n\t\t\t// Custom wallpaper: defaults 4.5 brightness, 0.9 saturation; predefined: 1 and 1\r\n\t\t\tif (value === 'custom') {\r\n\t\t\t\tparams.screenBrightness = 4.5;\r\n\t\t\t\tparams.screenSaturation = 0.9;\r\n\t\t\t} else {\r\n\t\t\t\tparams.screenBrightness = 1;\r\n\t\t\t\tparams.screenSaturation = 1;\r\n\t\t\t}\r\n\t\t\tif (params.animationScreen !== undefined) {\r\n\t\t\t\tparams.animationScreen = (value === 'off_screen' || value === 'Off screen') ? 'Off screen' : 'On';\r\n\t\t\t}\r\n\t\t\tawait updateWallpaperVisibility(value);\r\n\r\n\t\t});\r\n\r\n\t\t// Add upload button\r\n\t\tscreenFolder.add({\r\n\t\t\tuploadImage: () => {\r\n\r\n\t\t\t\tconst fileInput = document.createElement('input');\r\n\t\t\t\tfileInput.type = 'file';\r\n\t\t\t\tfileInput.accept = 'image/*';\r\n\t\t\t\tfileInput.style.display = 'none';\r\n\t\t\t\tfileInput.addEventListener('change', (e) => {\r\n\r\n\t\t\t\t\tif (e.target.files[0]) {\r\n\r\n\t\t\t\t\t\thandleImageUpload(e.target.files[0]);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t});\r\n\t\t\t\tfileInput.click();\r\n\r\n\t\t\t}\r\n\t\t}, 'uploadImage').name('Upload Custom');\r\n\r\n\t\t//  FIX: Improved brightness control matching reference GLBViewer implementation\r\n\t\t// For custom wallpapers: re-processes the image with new brightness (baked into texture)\r\n\t\t// For predefined wallpapers: uses emissiveIntensity (immediate but slightly different)\r\n\t\tscreenFolder.add(params, 'screenBrightness', 0, 10, 0.1).onChange(async (value) => {\r\n\r\n\t\t\tparams.screenBrightness = value; // Update params\r\n\r\n\t\t\t// For custom wallpapers, reprocess the entire image with new brightness\r\n\t\t\tif (currentWallpaper === 'custom' && uploadedImage) {\r\n\r\n\t\t\t\tconsole.log(` Brightness changed to ${value} - reprocessing custom image`);\r\n\t\t\t\tawait updateScreenTextureWithSettings();\r\n\r\n\t\t\t} else if (screenMesh && screenMesh.material) {\r\n\r\n\t\t\t\t// For predefined wallpapers, use emissiveIntensity (fallback behavior)\r\n\t\t\t\tconst materials = Array.isArray(screenMesh.material)\r\n\t\t\t\t\t? screenMesh.material\r\n\t\t\t\t\t: [screenMesh.material];\r\n\t\t\t\tmaterials.forEach((material) => {\r\n\r\n\t\t\t\t\tmaterial.emissiveIntensity = value;\r\n\r\n\t\t\t\t\tif (material.emissive) {\r\n\t\t\t\t\t\tmaterial.emissive.setHex(0xffffff);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t\tpathTracer.updateMaterials();\r\n\t\t\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\t\t\t}\r\n\r\n\t\t}).name('Brightness');\r\n\r\n\t\t//  NEW: Saturation control matching reference GLBViewer implementation\r\n\t\t// Re-processes the custom image with new saturation (0 = grayscale, 1 = normal, 2 = oversaturated)\r\n\t\tscreenFolder.add(params, 'screenSaturation', 0, 2, 0.1).onChange(async (value) => {\r\n\r\n\t\t\tparams.screenSaturation = value; // Update params\r\n\r\n\t\t\t// Only works for custom wallpapers with uploaded image\r\n\t\t\tif (currentWallpaper === 'custom' && uploadedImage) {\r\n\r\n\t\t\t\tconsole.log(` Saturation changed to ${value} - reprocessing custom image`);\r\n\t\t\t\tawait updateScreenTextureWithSettings();\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.log(` Saturation control only works with custom uploaded images`);\r\n\r\n\t\t\t}\r\n\r\n\t\t}).name('Saturation');\r\n\r\n\t\tscreenFolder.close();\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction updateEnvMap() {\r\n\r\n\tif ( params.envMap === '__CUSTOM__' ) {\r\n\r\n\t\t// Custom HDRI: apply same rotation/intensity/saturation as preset/BG-as-HDRI\r\n\t\tif ( customEnvTexture ) {\r\n\r\n\t\t\tif ( scene.environment !== customEnvTexture ) {\r\n\r\n\t\t\t\tif ( scene.environment && scene.environment !== gradientMap && scene.environment !== fallbackEnvMap ) {\r\n\r\n\t\t\t\t\tscene.environment.dispose();\r\n\r\n\t\t\t\t}\r\n\t\t\t\tscene.environment = customEnvTexture;\r\n\t\t\t\tpathTracer.updateEnvironment();\r\n\t\t\t\tonParamsChange();\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\t// If Custom selected but no file loaded yet, keep current scene.environment so raster view still has light\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\t// Store previous environment so we don't lose it during async load (prevents black raster fallback)\r\n\t// Don't dispose until new HDRI is successfully loaded - keeps raster fallback lit during load\r\n\tconst previousEnvDuringLoad = scene.environment;\r\n\r\n\tnew HDRLoader()\r\n\t\t.load(params.envMap, (texture) => {\r\n\r\n\t\t\t// Dispose old environment only after new one is successfully loaded\r\n\t\t\t// Don't dispose gradientMap/fallbackEnvMap (reusable) or customEnvTexture (handled separately)\r\n\t\t\tif ( previousEnvDuringLoad && previousEnvDuringLoad !== texture && previousEnvDuringLoad !== gradientMap && previousEnvDuringLoad !== fallbackEnvMap ) {\r\n\r\n\t\t\t\tif ( previousEnvDuringLoad === customEnvTexture ) customEnvTexture = null;\r\n\t\t\t\tpreviousEnvDuringLoad.dispose();\r\n\r\n\t\t\t}\r\n\r\n\t\t\ttexture.mapping = EquirectangularReflectionMapping;\r\n\t\t\t// Ensure optimal settings for Raster view (prevents black texture on NPOT)\r\n\t\t\ttexture.minFilter = LinearFilter;\r\n\t\t\ttexture.magFilter = LinearFilter;\r\n\t\t\ttexture.generateMipmaps = false;\r\n\r\n\t\t\tscene.environment = texture;\r\n\t\t\tpathTracer.updateEnvironment();\r\n\t\t\tonParamsChange();\r\n\r\n\t\t}, undefined, (err) => {\r\n\r\n\t\t\tconsole.warn('HDRI preset load failed, keeping current environment:', params.envMap, err);\r\n\t\t\t// On error: ensure scene.environment is never null (use previous if current was cleared)\r\n\t\t\tif ( !scene.environment && previousEnvDuringLoad ) {\r\n\r\n\t\t\t\tscene.environment = previousEnvDuringLoad;\r\n\r\n\t\t\t}\r\n\t\t\tpathTracer.updateEnvironment();\r\n\r\n\t\t});\r\n\r\n}\r\n\r\nfunction loadCustomHDRI() {\r\n\r\n\tconst fileInput = document.createElement('input');\r\n\tfileInput.type = 'file';\r\n\tfileInput.accept = '.hdr,.hrd';\r\n\tfileInput.style.display = 'none';\r\n\tfileInput.addEventListener('change', (e) => {\r\n\r\n\t\tconst file = e.target.files && e.target.files[0];\r\n\t\tif ( !file ) return;\r\n\r\n\t\tconst url = URL.createObjectURL(file);\r\n\t\tnew HDRLoader().load(url, (texture) => {\r\n\r\n\t\t\tURL.revokeObjectURL(url);\r\n\r\n\t\t\tif ( customEnvTexture ) customEnvTexture.dispose();\r\n\t\t\tcustomEnvTexture = texture;\r\n\t\t\tcustomEnvTexture.mapping = EquirectangularReflectionMapping;\r\n\t\t\t// Ensure optimal settings for Raster view\r\n\t\t\tcustomEnvTexture.minFilter = LinearFilter;\r\n\t\t\tcustomEnvTexture.magFilter = LinearFilter;\r\n\t\t\tcustomEnvTexture.generateMipmaps = false;\r\n\r\n\t\t\t// Don't dispose reusable environments (gradientMap, fallbackEnvMap)\r\n\t\t\tif ( scene.environment && scene.environment !== customEnvTexture && scene.environment !== gradientMap && scene.environment !== fallbackEnvMap ) {\r\n\r\n\t\t\t\tscene.environment.dispose();\r\n\r\n\t\t\t}\r\n\t\t\tscene.environment = customEnvTexture;\r\n\t\t\tpathTracer.updateEnvironment();\r\n\r\n\t\t\tparams.envMap = '__CUSTOM__';\r\n\t\t\t// Full sync so custom HDRI gets same rotation/intensity/saturation as any other source\r\n\t\t\tonParamsChange();\r\n\r\n\t\t}, undefined, (err) => {\r\n\r\n\t\t\tURL.revokeObjectURL(url);\r\n\t\t\tconsole.error('Custom HDRI load failed:', err);\r\n\r\n\t\t});\r\n\r\n\t});\r\n\tfileInput.click();\r\n\r\n}\r\n\r\nfunction updateCameraProjection(cameraProjection) {\r\n\r\n\t// sync position\r\n\tif (activeCamera) {\r\n\r\n\t\tperspectiveCamera.position.copy(activeCamera.position);\r\n\t\torthoCamera.position.copy(activeCamera.position);\r\n\r\n\t}\r\n\r\n\t// set active camera\r\n\tif (cameraProjection === 'Perspective') {\r\n\r\n\t\tactiveCamera = perspectiveCamera;\r\n\r\n\t} else {\r\n\r\n\t\tactiveCamera = orthoCamera;\r\n\r\n\t}\r\n\r\n\tcontrols.object = activeCamera;\r\n\tcontrols.update();\r\n\r\n\tpathTracer.setCamera(activeCamera);\r\n\tupdateBackgroundPlaneTransform();\r\n\tupdateBackgroundTextureUVFit();\r\n\r\n\t// Update modal camera reference\r\n\tif (imageRenderModal) {\r\n\r\n\t\timageRenderModal.camera = activeCamera;\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction convertOpacityToTransmission(model, ior) {\r\n\r\n\tmodel.traverse(c => {\r\n\r\n\t\tif (c.material) {\r\n\r\n\t\t\tconst material = c.material;\r\n\t\t\tif (material.opacity < 0.65 && material.opacity > 0.2) {\r\n\r\n\t\t\t\tconst newMaterial = new MeshPhysicalMaterial();\r\n\t\t\t\tfor (const key in material) {\r\n\r\n\t\t\t\t\tif (key in material) {\r\n\r\n\t\t\t\t\t\tif (material[key] === null) {\r\n\r\n\t\t\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (material[key].isTexture) {\r\n\r\n\t\t\t\t\t\t\tnewMaterial[key] = material[key];\r\n\r\n\t\t\t\t\t\t} else if (material[key].copy && material[key].constructor === newMaterial[key].constructor) {\r\n\r\n\t\t\t\t\t\t\tnewMaterial[key].copy(material[key]);\r\n\r\n\t\t\t\t\t\t} else if ((typeof material[key]) === 'number') {\r\n\r\n\t\t\t\t\t\t\tnewMaterial[key] = material[key];\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnewMaterial.opacity = 1.0;\r\n\t\t\t\tnewMaterial.transmission = 1.0;\r\n\t\t\t\tnewMaterial.ior = ior;\r\n\r\n\t\t\t\tconst hsl = {};\r\n\t\t\t\tnewMaterial.color.getHSL(hsl);\r\n\t\t\t\thsl.l = Math.max(hsl.l, 0.35);\r\n\t\t\t\tnewMaterial.color.setHSL(hsl.h, hsl.s, hsl.l);\r\n\r\n\t\t\t\tc.material = newMaterial;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n}\r\n\r\n// Function to find the screen mesh by traversing the model\r\nfunction findScreenMesh(model) {\r\n\r\n\tlet foundMesh = null;\r\n\tlet priorityMesh = null; // For exact \"screen_blank\" match\r\n\r\n\tmodel.traverse((child) => {\r\n\r\n\t\tif (child.isMesh) {\r\n\r\n\t\t\t// Check if this mesh is part of the screen\r\n\t\t\tconst name = child.name.toLowerCase();\r\n\t\t\tconst parentName = child.parent?.name?.toLowerCase() || '';\r\n\r\n\t\t\t// Priority: Look for exact \"screen_blank\" match first\r\n\t\t\tif (name.includes('screen_blank') || name === 'screen_blank') {\r\n\r\n\t\t\t\tif (child.material) {\r\n\r\n\t\t\t\t\tpriorityMesh = child;\r\n\t\t\t\t\tconsole.log('Found priority screen mesh (screen_blank):', child.name, 'Parent:', child.parent?.name);\r\n\t\t\t\t\treturn; // Found the exact match, we can stop\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Skip covers, panels, and other non-screen parts\r\n\t\t\tif (name.includes('cover') || name.includes('panel') || name.includes('back') || name.startsWith('a_')) {\r\n\r\n\t\t\t\treturn; // Skip this mesh\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// Secondary: Look for other screen-related meshes (but not covers)\r\n\t\t\tif (\r\n\t\t\t\t(name.includes('screen') && name.includes('blank')) ||\r\n\t\t\t\t(name.includes('blank') && parentName.includes('screen')) ||\r\n\t\t\t\t(name === 'blank' && parentName.includes('screen'))\r\n\t\t\t) {\r\n\r\n\t\t\t\t// Check if it has a material with emissive properties (likely the screen)\r\n\t\t\t\tif (child.material) {\r\n\r\n\t\t\t\t\t// Prefer meshes with emissive maps\r\n\t\t\t\t\tif (!foundMesh || child.material.emissiveMap) {\r\n\r\n\t\t\t\t\t\tfoundMesh = child;\r\n\t\t\t\t\t\tconsole.log('Found screen mesh:', child.name, 'Parent:', child.parent?.name);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t// Return priority mesh if found, otherwise return the found mesh\r\n\tif (priorityMesh) {\r\n\r\n\t\treturn priorityMesh;\r\n\r\n\t}\r\n\r\n\t// If not found by name, try finding by material properties (but exclude covers/panels)\r\n\tif (!foundMesh) {\r\n\r\n\t\tmodel.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh && child.material) {\r\n\r\n\t\t\t\tconst name = child.name.toLowerCase();\r\n\t\t\t\t// Skip covers, panels, and other non-screen parts\r\n\t\t\t\tif (name.includes('cover') || name.includes('panel') || name.includes('back')) {\r\n\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst material = Array.isArray(child.material) ? child.material[0] : child.material;\r\n\r\n\t\t\t\t// Look for materials that already have emissive properties\r\n\t\t\t\tif (material.emissiveMap || material.emissiveIntensity > 0) {\r\n\r\n\t\t\t\t\tfoundMesh = child;\r\n\t\t\t\t\tconsole.log('Found screen by material:', child.name);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\treturn foundMesh;\r\n\r\n}\r\n\r\n// Function to find all wallpaper meshes/groups\r\n// Uses dynamic detection based on numeric prefix pattern (e.g., 01_Blue_Bloom, 03_Feather_Light)\r\n// Similar to the reference implementation in GLBViewer.jsx\r\nfunction findAllWallpaperMeshes(model) {\r\n\r\n\tconst wallpapers = {\r\n\t\t'blank_screen': null,\r\n\t\t'blue_bloom': null,\r\n\t\t'aurora_borealis': null,\r\n\t\t'feather_light': null,\r\n\t\t'asus_1': null,\r\n\t\t'asus_2': null,\r\n\t};\r\n\r\n\t// Map to store all found wallpaper meshes by their actual mesh name\r\n\tconst wallpaperMeshesByName = new Map();\r\n\r\n\t// Also look for screen_blank for custom wallpapers\r\n\tlet wallpaperGroup = null;\r\n\tlet screenBlankMesh = null;\r\n\r\n\t// First pass: Look for meshes with numeric prefix pattern (e.g., 01_Blue_Bloom, 03_Feather_Light)\r\n\t// This is the dynamic approach - detects wallpapers based on actual GLB structure\r\n\tmodel.traverse((child) => {\r\n\r\n\t\tif (child.isGroup && child.name === 'wallpaper') {\r\n\t\t\twallpaperGroup = child;\r\n\t\t\tconsole.log(` [WALLPAPER GROUP] Found: ${child.name}`);\r\n\t\t}\r\n\r\n\t\tif (child.isMesh && child.material) {\r\n\r\n\t\t\tconst name = child.name;\r\n\t\t\tconst nameLower = name.toLowerCase();\r\n\t\t\tconst parentName = child.parent?.name || '';\r\n\t\t\tconst parentNameLower = parentName.toLowerCase();\r\n\r\n\t\t\t// Find screen_blank for custom wallpapers\r\n\t\t\tif (name === 'screen_blank') {\r\n\t\t\t\tscreenBlankMesh = child;\r\n\t\t\t\tconsole.log(` [SCREEN BLANK] Found: ${name} (parent: ${parentName})`);\r\n\t\t\t}\r\n\r\n\t\t\t// Look for meshes with numeric prefix pattern: /^\\d+_/\r\n\t\t\t// This matches patterns like: 01_Blue_Bloom, 02_Aurora_Borealis, 03_Feather_Light\r\n\t\t\tconst numericPrefixMatch = name.match(/^(\\d+)_(.+)/);\r\n\r\n\t\t\tif (numericPrefixMatch) {\r\n\t\t\t\t// Found a mesh with numeric prefix - this is likely a wallpaper\r\n\t\t\t\tconst wallpaperName = numericPrefixMatch[2]; // The name after the prefix\r\n\t\t\t\tconst wallpaperNameLower = wallpaperName.toLowerCase();\r\n\r\n\t\t\t\t// Store by actual mesh name\r\n\t\t\t\twallpaperMeshesByName.set(name, child);\r\n\t\t\t\tconsole.log(` [WALLPAPER MESH] Found: ${name} (parent: ${parentName})`);\r\n\r\n\t\t\t\t// Also try to map to normalized keys for backward compatibility\r\n\t\t\t\t// Extract core name (remove \"vertical\" prefix if present)\r\n\t\t\t\tlet coreName = wallpaperNameLower;\r\n\t\t\t\tcoreName = coreName.replace(/^vertical_?/i, '');\r\n\t\t\t\tcoreName = coreName.replace(/_?vertical_?/i, '');\r\n\t\t\t\tcoreName = coreName.replace(/__+/g, '_');\r\n\t\t\t\tcoreName = coreName.replace(/^_+|_+$/g, '');\r\n\r\n\t\t\t\t// Map to known wallpaper keys based on core name\r\n\t\t\t\t// This allows matching \"feather_light\" even if the mesh is named \"03_Feather_Light\" or \"03_feather_light\"\r\n\t\t\t\tif (coreName.includes('blank') || coreName.includes('screen_blank')) {\r\n\t\t\t\t\tif (!wallpapers['blank_screen']) {\r\n\t\t\t\t\t\twallpapers['blank_screen'] = child;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (coreName.includes('blue') && coreName.includes('bloom')) {\r\n\t\t\t\t\tif (!wallpapers['blue_bloom']) {\r\n\t\t\t\t\t\twallpapers['blue_bloom'] = child;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (coreName.includes('aurora') || coreName.includes('borealis')) {\r\n\t\t\t\t\tif (!wallpapers['aurora_borealis']) {\r\n\t\t\t\t\t\twallpapers['aurora_borealis'] = child;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (coreName.includes('feather') && coreName.includes('light')) {\r\n\t\t\t\t\t//  FIX: Only match if BOTH \"feather\" AND \"light\" are present\r\n\t\t\t\t\t// This prevents false matches with meshes that only have \"feather\" or only \"light\"\r\n\t\t\t\t\tif (!wallpapers['feather_light']) {\r\n\t\t\t\t\t\twallpapers['feather_light'] = child;\r\n\t\t\t\t\t\tconsole.log(` Mapped \"${name}\" to \"feather_light\" (core: \"${coreName}\")`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (coreName === 'asus_1' || coreName === 'asus1') {\r\n\t\t\t\t\tif (!wallpapers['asus_1']) {\r\n\t\t\t\t\t\twallpapers['asus_1'] = child;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (coreName === 'asus_2' || coreName === 'asus2') {\r\n\t\t\t\t\tif (!wallpapers['asus_2']) {\r\n\t\t\t\t\t\twallpapers['asus_2'] = child;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Also check for meshes inside \"wallpaper\" group (if parent is \"wallpaper\")\r\n\t\t\t// This matches the reference implementation pattern\r\n\t\t\tif (parentNameLower === 'wallpaper' && /^\\d+_/.test(name)) {\r\n\t\t\t\t// Already handled above, but ensure it's stored\r\n\t\t\t\tif (!wallpaperMeshesByName.has(name)) {\r\n\t\t\t\t\twallpaperMeshesByName.set(name, child);\r\n\t\t\t\t\tconsole.log(` [WALLPAPER MESH] Found in wallpaper group: ${name}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t// Store screen_blank if found  and assign it to wallpapers['blank_screen']\r\n\tif (screenBlankMesh) {\r\n\t\twallpaperMeshesByName.set('screen_blank', screenBlankMesh);\r\n\t\tif (!wallpapers['blank_screen']) {\r\n\t\t\twallpapers['blank_screen'] = screenBlankMesh;\r\n\t\t}\r\n\t}\r\n\r\n\t// Log all found wallpapers\r\n\tconsole.log(` Available wallpaper meshes (${wallpaperMeshesByName.size} total):`);\r\n\twallpaperMeshesByName.forEach((mesh, name) => {\r\n\t\tconsole.log(`   - ${name}`);\r\n\t});\r\n\r\n\t// Store the map for use in updateWallpaperVisibility\r\n\twallpaperMeshesByName._wallpaperGroup = wallpaperGroup;\r\n\twallpaperMeshesByName._screenBlank = screenBlankMesh;\r\n\r\n\treturn wallpapers;\r\n\r\n}\r\n\r\n// Function to show/hide wallpapers based on selection\r\nasync function updateWallpaperVisibility(selectedWallpaper) {\r\n\r\n\tif (!model) {\r\n\r\n\t\tconsole.error(' updateWallpaperVisibility: model is null!');\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\tconsole.log(`\\n ========== UPDATE WALLPAPER VISIBILITY ==========`);\r\n\tconsole.log(` Selected wallpaper: \"${selectedWallpaper}\"`);\r\n\tconsole.log(` Current screenMesh:`, screenMesh ? screenMesh.name : 'null');\r\n\tconsole.log(` Available wallpapers:`, Object.keys(wallpaperMeshes).filter(k => wallpaperMeshes[k] !== null));\r\n\r\n\t// First, collect ALL screen-related meshes with their positions and priority\r\n\tconst allScreenMeshes = [];\r\n\tmodel.traverse((child) => {\r\n\r\n\t\tif (child.isMesh) {\r\n\r\n\t\t\tconst name = child.name.toLowerCase();\r\n\t\t\tconst parentName = child.parent?.name?.toLowerCase() || '';\r\n\r\n\t\t\t// Check if this is a wallpaper mesh (NOT screen component meshes)\r\n\t\t\t// Screen components like screen_panel, screen_backlight, screen_filter, screen_mirror, screen_bezel should NOT be collected\r\n\t\t\tconst isScreenComponent = name.includes('screen_panel') ||\r\n\t\t\t\tname.includes('screen_backlight') ||\r\n\t\t\t\tname.includes('screen_filter') ||\r\n\t\t\t\tname.includes('screen_mirror') ||\r\n\t\t\t\tname.includes('screen_bezel') ||\r\n\t\t\t\tname.includes('display008') ||\r\n\t\t\t\tname.includes('display006') ||\r\n\t\t\t\tname.includes('display005') ||\r\n\t\t\t\tname.includes('display007') ||\r\n\t\t\t\tparentName.includes('screen_backlight') ||\r\n\t\t\t\tparentName.includes('screen_filter') ||\r\n\t\t\t\tparentName.includes('screen_mirror') ||\r\n\t\t\t\tparentName.includes('screen_rgb') ||\r\n\t\t\t\t(parentName.includes('displayctrl') && !parentName.includes('wallpaper'));\r\n\r\n\t\t\t//  DYNAMIC DETECTION: Use actual found wallpaper meshes instead of hardcoded patterns\r\n\t\t\t// Check if this mesh is one of the found wallpaper meshes\r\n\t\t\tconst originalName = child.name; // Keep original case for matching\r\n\t\t\tconst isFoundWallpaper = Object.values(wallpaperMeshes).some(mesh => mesh === child);\r\n\t\t\tconst hasNumericPrefix = /^\\d+_/.test(originalName);\r\n\t\t\tconst isInWallpaperGroup = parentName === 'wallpaper';\r\n\t\t\tconst isScreenBlank = originalName === 'screen_blank';\r\n\r\n\t\t\t// Collect meshes that are:\r\n\t\t\t// 1. Found wallpapers from findAllWallpaperMeshes\r\n\t\t\t// 2. Meshes with numeric prefix (dynamic wallpaper detection)\r\n\t\t\t// 3. screen_blank for custom wallpapers\r\n\t\t\t// 4. Meshes in wallpaper group\r\n\t\t\t// 5. screen_rgb meshes (legacy support)\r\n\t\t\tconst isWallpaperMesh = !isScreenComponent && (\r\n\t\t\t\tisFoundWallpaper ||\r\n\t\t\t\t(hasNumericPrefix && (isInWallpaperGroup || true)) || // Allow numeric prefix anywhere\r\n\t\t\t\tisScreenBlank ||\r\n\t\t\t\t(name.includes('rgb') && parentName.includes('screen') && !parentName.includes('screenctrl'))\r\n\t\t\t);\r\n\r\n\t\t\tif (isWallpaperMesh) {\r\n\r\n\t\t\t\t// Get world position to determine depth/priority (Z position = distance from camera/screen)\r\n\t\t\t\tchild.updateMatrixWorld(true);\r\n\t\t\t\tconst worldPos = new Vector3();\r\n\t\t\t\tchild.getWorldPosition(worldPos);\r\n\r\n\t\t\t\t//  DYNAMIC PRIORITY: Determine wallpaper type based on actual found meshes\r\n\t\t\t\tlet priority = 0;\r\n\t\t\t\tlet wallpaperType = 'unknown';\r\n\r\n\t\t\t\t// Check against found wallpaper meshes first (most reliable)\r\n\t\t\t\tif (wallpaperMeshes['blank_screen'] === child || isScreenBlank) {\r\n\t\t\t\t\tpriority = 100;\r\n\t\t\t\t\twallpaperType = 'blank_screen';\r\n\t\t\t\t} else if (wallpaperMeshes['blue_bloom'] === child) {\r\n\t\t\t\t\tpriority = 90;\r\n\t\t\t\t\twallpaperType = 'blue_bloom';\r\n\t\t\t\t} else if (wallpaperMeshes['aurora_borealis'] === child) {\r\n\t\t\t\t\tpriority = 80;\r\n\t\t\t\t\twallpaperType = 'aurora_borealis';\r\n\t\t\t\t} else if (wallpaperMeshes['feather_light'] === child) {\r\n\t\t\t\t\t//  FIX: Use the actual found mesh instead of pattern matching\r\n\t\t\t\t\tpriority = 70;\r\n\t\t\t\t\twallpaperType = 'feather_light';\r\n\t\t\t\t} else if (wallpaperMeshes['asus_1'] === child) {\r\n\t\t\t\t\tpriority = 60;\r\n\t\t\t\t\twallpaperType = 'asus_1';\r\n\t\t\t\t} else if (wallpaperMeshes['asus_2'] === child) {\r\n\t\t\t\t\tpriority = 55;\r\n\t\t\t\t\twallpaperType = 'asus_2';\r\n\t\t\t\t} else if (name.includes('rgb') && parentName.includes('screen') && !parentName.includes('screenctrl')) {\r\n\t\t\t\t\tpriority = 50;\r\n\t\t\t\t\twallpaperType = 'screen_rgb';\r\n\t\t\t\t} else if (hasNumericPrefix) {\r\n\t\t\t\t\t// Dynamic wallpaper with numeric prefix - extract core name for type\r\n\t\t\t\t\tconst match = originalName.match(/^\\d+_(.+)/);\r\n\t\t\t\t\tif (match) {\r\n\t\t\t\t\t\tlet coreName = match[1].toLowerCase();\r\n\t\t\t\t\t\tcoreName = coreName.replace(/^vertical_?/i, '');\r\n\t\t\t\t\t\tcoreName = coreName.replace(/_?vertical_?/i, '');\r\n\t\t\t\t\t\tcoreName = coreName.replace(/__+/g, '_');\r\n\t\t\t\t\t\tcoreName = coreName.replace(/^_+|_+$/g, '');\r\n\r\n\t\t\t\t\t\t// Map to known types based on core name\r\n\t\t\t\t\t\tif (coreName.includes('blank')) {\r\n\t\t\t\t\t\t\tpriority = 100;\r\n\t\t\t\t\t\t\twallpaperType = 'blank_screen';\r\n\t\t\t\t\t\t} else if (coreName.includes('blue') && coreName.includes('bloom')) {\r\n\t\t\t\t\t\t\tpriority = 90;\r\n\t\t\t\t\t\t\twallpaperType = 'blue_bloom';\r\n\t\t\t\t\t\t} else if (coreName.includes('aurora') || coreName.includes('borealis')) {\r\n\t\t\t\t\t\t\tpriority = 80;\r\n\t\t\t\t\t\t\twallpaperType = 'aurora_borealis';\r\n\t\t\t\t\t\t} else if (coreName.includes('feather') && coreName.includes('light')) {\r\n\t\t\t\t\t\t\t//  FIX: Require BOTH \"feather\" AND \"light\" to prevent false matches\r\n\t\t\t\t\t\t\tpriority = 70;\r\n\t\t\t\t\t\t\twallpaperType = 'feather_light';\r\n\t\t\t\t\t\t} else if (coreName === 'asus_1' || coreName === 'asus1') {\r\n\t\t\t\t\t\t\tpriority = 60;\r\n\t\t\t\t\t\t\twallpaperType = 'asus_1';\r\n\t\t\t\t\t\t} else if (coreName === 'asus_2' || coreName === 'asus2') {\r\n\t\t\t\t\t\t\tpriority = 55;\r\n\t\t\t\t\t\t\twallpaperType = 'asus_2';\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpriority = 40;\r\n\t\t\t\t\t\t\twallpaperType = coreName; // Use core name as type\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tpriority = 40;\r\n\t\t\t\t\t\twallpaperType = 'wallpaper';\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (isInWallpaperGroup) {\r\n\t\t\t\t\tpriority = 40;\r\n\t\t\t\t\twallpaperType = 'wallpaper';\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpriority = 10;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tallScreenMeshes.push({\r\n\t\t\t\t\tmesh: child,\r\n\t\t\t\t\tname: child.name,\r\n\t\t\t\t\tparent: child.parent?.name || 'none',\r\n\t\t\t\t\tvisible: child.visible,\r\n\t\t\t\t\thasMaterial: !!child.material,\r\n\t\t\t\t\thasEmissiveMap: !!(child.material && child.material.emissiveMap),\r\n\t\t\t\t\tworldPosition: { x: worldPos.x.toFixed(2), y: worldPos.y.toFixed(2), z: worldPos.z.toFixed(2) },\r\n\t\t\t\t\tpriority: priority,\r\n\t\t\t\t\twallpaperType: wallpaperType,\r\n\t\t\t\t\tdepth: worldPos.z // Z position = depth (lower Z = closer to screen/front)\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\t// Sort by priority (higher first), then by depth (lower Z = closer to screen = higher priority)\r\n\tallScreenMeshes.sort((a, b) => {\r\n\t\tif (b.priority !== a.priority) return b.priority - a.priority;\r\n\t\treturn a.depth - b.depth; // Lower Z = closer to screen\r\n\t});\r\n\r\n\tconsole.log(`\\n ALL SCREEN MESHES FOUND (${allScreenMeshes.length} total):`);\r\n\tconsole.log(`   Sorted by Priority (higher = more important)  Depth (lower Z = closer to screen)`);\r\n\tconsole.log(`   `);\r\n\tconsole.log(`    Priority  Depth (Z)  Visible  Has Emissive  Type               Name                `);\r\n\tconsole.log(`   `);\r\n\r\n\tallScreenMeshes.forEach((info, idx) => {\r\n\r\n\t\tconst priorityStr = String(info.priority).padStart(3);\r\n\t\tconst depthStr = info.depth.toFixed(2).padStart(8);\r\n\t\tconst visibleStr = (info.visible ? ' YES' : ' NO ').padEnd(7);\r\n\t\tconst emissiveStr = (info.hasEmissiveMap ? ' YES' : ' NO ').padEnd(12);\r\n\t\tconst typeStr = info.wallpaperType.padEnd(18);\r\n\t\tconst nameStr = (info.name.length > 20 ? info.name.substring(0, 17) + '...' : info.name).padEnd(20);\r\n\r\n\t\tconsole.log(`    ${priorityStr}      ${depthStr}  ${visibleStr}  ${emissiveStr}  ${typeStr}  ${nameStr} `);\r\n\r\n\t});\r\n\r\n\tconsole.log(`   `);\r\n\r\n\t// Hide ALL screen meshes first - also hide their parent groups if they only contain wallpapers\r\n\tconsole.log(`\\n HIDING ALL SCREEN MESHES AND PARENT GROUPS:`);\r\n\tconst hiddenGroups = new Set();\r\n\tconst hiddenMeshesList = [];\r\n\r\n\tallScreenMeshes.forEach((info) => {\r\n\r\n\t\tconst wasVisible = info.mesh.visible;\r\n\t\tinfo.mesh.visible = false;\r\n\t\thiddenMeshesList.push(info);\r\n\r\n\t\t// Also hide parent groups that might contain wallpapers\r\n\t\t// IMPORTANT: Only hide groups that are specifically wallpaper groups, NOT screen component groups\r\n\t\tlet parent = info.mesh.parent;\r\n\t\twhile (parent && parent !== model) {\r\n\r\n\t\t\tconst parentName = parent.name?.toLowerCase() || '';\r\n\t\t\t// Only hide groups that are specifically wallpaper groups\r\n\t\t\t// Do NOT hide screenCTRL, displayCTRL, or screen component groups (screen_backlight, screen_filter, etc.)\r\n\t\t\tif (parentName.includes('wallpaper')) {\r\n\r\n\t\t\t\tif (!hiddenGroups.has(parent)) {\r\n\r\n\t\t\t\t\tconst wasGroupVisible = parent.visible;\r\n\t\t\t\t\tparent.visible = false;\r\n\t\t\t\t\thiddenGroups.add(parent);\r\n\t\t\t\t\tif (wasGroupVisible) {\r\n\r\n\t\t\t\t\t\tconsole.log(`    HID GROUP: \"${parent.name}\" (contains \"${info.name}\")`);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\tparent = parent.parent;\r\n\r\n\t\t}\r\n\r\n\t\tif (wasVisible) {\r\n\r\n\t\t\tconsole.log(`    HID MESH: \"${info.name}\" (Priority: ${info.priority}, Depth: ${info.depth.toFixed(2)})`);\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tconsole.log(`    Summary: Hid ${hiddenMeshesList.length} meshes and ${hiddenGroups.size} groups`);\r\n\r\n\t// Show ONLY the selected wallpaper\r\n\tlet targetMesh = null;\r\n\tlet targetMeshInfo = null;\r\n\r\n\t//  FIX: Handle \"Off screen\" mode - hide ALL wallpapers, don't show anything\r\n\tconst isScreenOff = selectedWallpaper === 'off_screen' || selectedWallpaper === 'Off screen' || !selectedWallpaper;\r\n\r\n\tif (isScreenOff) {\r\n\r\n\t\tconsole.log(`\\n SCREEN OFF MODE - Hiding all wallpapers`);\r\n\t\tconsole.log(`   All ${hiddenMeshesList.length} meshes remain hidden`);\r\n\t\tconsole.log(`   No target mesh will be shown`);\r\n\t\t// Don't set targetMesh - all wallpapers stay hidden\r\n\t\t// This is the correct behavior for \"Off screen\"\r\n\r\n\t} else if (selectedWallpaper === 'custom') {\r\n\r\n\t\tconsole.log(`\\n CUSTOM WALLPAPER MODE`);\r\n\t\tconsole.log(`   screenMesh exists:`, !!screenMesh);\r\n\t\tconsole.log(`   screenMesh name:`, screenMesh?.name);\r\n\r\n\t\t// Find the screenMesh in our collected list\r\n\t\tif (screenMesh) {\r\n\r\n\t\t\ttargetMeshInfo = allScreenMeshes.find(info => info.mesh === screenMesh);\r\n\t\t\ttargetMesh = screenMesh;\r\n\r\n\t\t\tif (targetMeshInfo) {\r\n\r\n\t\t\t\tconsole.log(`    Found screenMesh in list: Priority ${targetMeshInfo.priority}, Depth ${targetMeshInfo.depth.toFixed(2)}`);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.log(`    screenMesh not found in collected list, using directly`);\r\n\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\tconsole.error(`    screenMesh is null! Cannot show custom wallpaper.`);\r\n\t\t\tconsole.log(`    Trying to find best screen mesh from collected list...`);\r\n\r\n\t\t\t// Try to find the highest priority mesh with emissive map\r\n\t\t\ttargetMeshInfo = allScreenMeshes.find(info => info.hasEmissiveMap || info.priority > 50);\r\n\t\t\tif (targetMeshInfo) {\r\n\r\n\t\t\t\ttargetMesh = targetMeshInfo.mesh;\r\n\t\t\t\tscreenMesh = targetMesh;\r\n\t\t\t\tconsole.log(`    Using fallback mesh: \"${targetMesh.name}\"`);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t} else if (wallpaperMeshes[selectedWallpaper]) {\r\n\r\n\t\tconst selectedMesh = wallpaperMeshes[selectedWallpaper];\r\n\t\tconsole.log(`\\n PREDEFINED WALLPAPER MODE: \"${selectedWallpaper}\"`);\r\n\t\tconsole.log(`   Selected mesh: \"${selectedMesh.name}\"`);\r\n\r\n\t\t// Find it in our collected list\r\n\t\ttargetMeshInfo = allScreenMeshes.find(info => info.mesh === selectedMesh);\r\n\t\ttargetMesh = selectedMesh;\r\n\r\n\t\tif (targetMeshInfo) {\r\n\r\n\t\t\tconsole.log(`    Found in list: Priority ${targetMeshInfo.priority}, Depth ${targetMeshInfo.depth.toFixed(2)}`);\r\n\r\n\t\t}\r\n\r\n\t\t// Update screenMesh reference\r\n\t\tscreenMesh = selectedMesh;\r\n\r\n\t} else {\r\n\r\n\t\tconsole.warn(`\\n Wallpaper \"${selectedWallpaper}\" not found in wallpaperMeshes!`);\r\n\t\tconsole.log(`   Available keys:`, Object.keys(wallpaperMeshes));\r\n\t\tconsole.log(`   Values:`, Object.entries(wallpaperMeshes).map(([k, v]) => `${k}: ${v ? v.name : 'null'}`));\r\n\r\n\t}\r\n\r\n\t// Show the target mesh\r\n\tif (targetMesh) {\r\n\r\n\t\ttargetMesh.visible = true;\r\n\t\tconsole.log(`\\n SHOWING TARGET MESH:`);\r\n\t\tconsole.log(`   Name: \"${targetMesh.name}\"`);\r\n\t\tif (targetMeshInfo) {\r\n\r\n\t\t\tconsole.log(`   Priority: ${targetMeshInfo.priority} (${targetMeshInfo.wallpaperType})`);\r\n\t\t\tconsole.log(`   Depth (Z): ${targetMeshInfo.depth.toFixed(2)} (${targetMeshInfo.depth < 0 ? 'FRONT/CLOSER' : 'BACK/FARTHER'})`);\r\n\t\t\tconsole.log(`   Position: (${targetMeshInfo.worldPosition.x}, ${targetMeshInfo.worldPosition.y}, ${targetMeshInfo.worldPosition.z})`);\r\n\r\n\t\t}\r\n\t\tconsole.log(`   Has EmissiveMap: ${targetMeshInfo?.hasEmissiveMap ? ' YES' : ' NO'}`);\r\n\t\tconsole.log(`    Set visible = true`);\r\n\r\n\t\t// Predefined wallpapers: apply default brightness (1) and saturation (1) so they display correctly when switching from custom\r\n\t\tconst isPredefined = selectedWallpaper !== 'custom' && !isScreenOff && wallpaperMeshes[selectedWallpaper];\r\n\t\tif (isPredefined && targetMesh.material) {\r\n\t\t\tconst materials = Array.isArray(targetMesh.material) ? targetMesh.material : [targetMesh.material];\r\n\t\t\tmaterials.forEach((material) => {\r\n\t\t\t\tmaterial.emissiveIntensity = params.screenBrightness;\r\n\t\t\t\tif (material.emissive) material.emissive.setHex(0xffffff);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t});\r\n\t\t\tif (pathTracer) {\r\n\t\t\t\tpathTracer.updateMaterials();\r\n\t\t\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Also make sure parent groups are visible - but ONLY the chain leading to targetMesh\r\n\t\tlet parent = targetMesh.parent;\r\n\t\tlet parentCount = 0;\r\n\t\tconst visibleParentChain = new Set();\r\n\r\n\t\twhile (parent && parent !== model) {\r\n\r\n\t\t\tparent.visible = true;\r\n\t\t\tvisibleParentChain.add(parent);\r\n\t\t\tconsole.log(`    Made parent visible: \"${parent.name}\"`);\r\n\t\t\tparent = parent.parent;\r\n\t\t\tparentCount++;\r\n\t\t\tif (parentCount > 10) break; // Safety limit\r\n\r\n\t\t}\r\n\r\n\t\t// IMPORTANT: Hide any sibling groups that might contain other wallpapers\r\n\t\t// Traverse the model and hide any wallpaper groups that are NOT in the visible chain\r\n\t\t// ONLY hide wallpaper groups, NOT screen component groups\r\n\t\tmodel.traverse((child) => {\r\n\r\n\t\t\tif (child.isGroup) {\r\n\r\n\t\t\t\tconst name = child.name?.toLowerCase() || '';\r\n\t\t\t\t// Only hide groups that are specifically wallpaper groups\r\n\t\t\t\t// Do NOT hide screenCTRL, displayCTRL, or screen component groups\r\n\t\t\t\tif (name.includes('wallpaper') &&\r\n\t\t\t\t\t!visibleParentChain.has(child) &&\r\n\t\t\t\t\tchild !== targetMesh.parent) {\r\n\r\n\t\t\t\t\tchild.visible = false;\r\n\t\t\t\t\tconsole.log(`    Hid sibling group: \"${child.name}\" (not in visible chain)`);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t} else {\r\n\r\n\t\tconsole.error(`    No target mesh found! Cannot show wallpaper.`);\r\n\r\n\t}\r\n\r\n\t// Verify final state - show what's actually visible now\r\n\tconsole.log(`\\n FINAL STATE - VISIBLE MESHES ON SCREEN:`);\r\n\tconst visibleMeshes = allScreenMeshes.filter(info => info.mesh.visible);\r\n\r\n\tif (visibleMeshes.length === 0) {\r\n\r\n\t\tconsole.log(`    NO MESHES ARE VISIBLE! This is a problem.`);\r\n\r\n\t} else {\r\n\r\n\t\tconsole.log(`    ${visibleMeshes.length} mesh(es) visible:`);\r\n\t\tvisibleMeshes.forEach((info, idx) => {\r\n\r\n\t\t\tconsole.log(`   ${idx + 1}. \"${info.name}\"`);\r\n\t\t\tconsole.log(`      Priority: ${info.priority} (${info.wallpaperType})`);\r\n\t\t\tconsole.log(`      Depth: ${info.depth.toFixed(2)} (${info.depth < 0 ? 'FRONT' : 'BACK'})`);\r\n\t\t\tconsole.log(`      Has EmissiveMap: ${info.hasEmissiveMap ? ' YES' : ' NO'}`);\r\n\t\t\tconsole.log(`      Parent: \"${info.parent}\"`);\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\t// Show hidden meshes for reference\r\n\tconst hiddenMeshes = allScreenMeshes.filter(info => !info.mesh.visible);\r\n\tif (hiddenMeshes.length > 0) {\r\n\r\n\t\tconsole.log(`\\n    ${hiddenMeshes.length} mesh(es) HIDDEN (should not appear):`);\r\n\t\thiddenMeshes.slice(0, 5).forEach((info) => {\r\n\r\n\t\t\tconsole.log(`      - \"${info.name}\" (Priority: ${info.priority}, Type: ${info.wallpaperType})`);\r\n\r\n\t\t});\r\n\t\tif (hiddenMeshes.length > 5) {\r\n\r\n\t\t\tconsole.log(`      ... and ${hiddenMeshes.length - 5} more`);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// Force update the path tracer scene to reflect visibility changes\r\n\t// IMPORTANT: Use setSceneAsync to ensure visibility is properly respected\r\n\tconsole.log(`\\n Updating path tracer scene (rebuilding with only visible meshes)...`);\r\n\r\n\t// Small delay to ensure visibility updates are processed\r\n\tawait new Promise(resolve => setTimeout(resolve, 10));\r\n\r\n\t// Ensure current animation pose and world matrices are up-to-date before rebuilding\r\n\t// Without this, the path tracer may capture a stale skeleton pose\r\n\tif (animationMixer && mainAnimAction) {\r\n\t\tanimationMixer.update(0);\r\n\t}\r\n\tscene.updateMatrixWorld(true);\r\n\r\n\t// Rebuild the scene - this will use traverseVisible() which only includes visible meshes\r\n\tconst visResult = await pathTracer.setSceneAsync(scene, activeCamera, {\r\n\t\tonProgress: (v) => {\r\n\r\n\t\t\tif (v === 1) {\r\n\r\n\t\t\t\tconsole.log(` Path tracer scene rebuilt - only visible meshes included\\n`);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t});\r\n\tsceneBvh = visResult?.bvh || null; // Update BVH for click-to-focus\r\n\r\n}\r\n\r\n//  NEW: Apply brightness and saturation to image canvas before creating texture\r\n// This matches the reference GLBViewer shader implementation:\r\n// - brightness: multiplies color values (1.0 = normal, 0.5 = darker, 2.0 = brighter)\r\n// - saturation: interpolates between grayscale and original (0 = grayscale, 1 = normal, 2 = oversaturated)\r\nfunction applyBrightnessSaturationToImage(img, brightness, saturation) {\r\n\r\n\tconst canvas = document.createElement('canvas');\r\n\tcanvas.width = img.width;\r\n\tcanvas.height = img.height;\r\n\tconst ctx = canvas.getContext('2d');\r\n\tctx.drawImage(img, 0, 0);\r\n\r\n\tconst imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n\tconst data = imageData.data;\r\n\r\n\t// Convert brightness from 0-10 range to shader range (0-2.0)\r\n\t// Reference uses brightness directly as multiplier\r\n\tconst brightnessMultiplier = brightness / 5.0; // 0-10 -> 0-2.0, with 5.0 being normal (1.0x)\r\n\r\n\tfor (let i = 0; i < data.length; i += 4) {\r\n\r\n\t\tlet r = data[i] / 255;\r\n\t\tlet g = data[i + 1] / 255;\r\n\t\tlet b = data[i + 2] / 255;\r\n\r\n\t\t// 1. Apply brightness (multiply color values)\r\n\t\tr *= brightnessMultiplier;\r\n\t\tg *= brightnessMultiplier;\r\n\t\tb *= brightnessMultiplier;\r\n\r\n\t\t// 2. Apply saturation using luma (same coefficients as reference shader)\r\n\t\t// luma = dot(color, vec3(0.299, 0.587, 0.114))\r\n\t\tconst luma = 0.299 * r + 0.587 * g + 0.114 * b;\r\n\r\n\t\t// mix(gray, color, saturation) = gray + saturation * (color - gray)\r\n\t\tr = luma + saturation * (r - luma);\r\n\t\tg = luma + saturation * (g - luma);\r\n\t\tb = luma + saturation * (b - luma);\r\n\r\n\t\t// Clamp values to 0-255 range\r\n\t\tdata[i] = Math.max(0, Math.min(255, Math.round(r * 255)));\r\n\t\tdata[i + 1] = Math.max(0, Math.min(255, Math.round(g * 255)));\r\n\t\tdata[i + 2] = Math.max(0, Math.min(255, Math.round(b * 255)));\r\n\t\t// Alpha (data[i + 3]) remains unchanged\r\n\r\n\t}\r\n\r\n\tctx.putImageData(imageData, 0, 0);\r\n\treturn canvas;\r\n\r\n}\r\n\r\n//  NEW: Helper to update screen texture with current brightness/saturation settings\r\nasync function updateScreenTextureWithSettings() {\r\n\r\n\tif (!uploadedImage || !screenMesh || !screenMesh.material) {\r\n\r\n\t\tconsole.warn(' Cannot update screen texture - missing image or screenMesh');\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\tconsole.log(` Updating screen texture with brightness: ${params.screenBrightness}, saturation: ${params.screenSaturation}`);\r\n\r\n\t// Apply brightness and saturation to stored original image\r\n\tconst processedCanvas = applyBrightnessSaturationToImage(\r\n\t\tuploadedImage,\r\n\t\tparams.screenBrightness,\r\n\t\tparams.screenSaturation\r\n\t);\r\n\r\n\t// Create new texture from processed canvas\r\n\tconst texture = new Texture(processedCanvas);\r\n\r\n\t//  FIX: flipY = false to match reference GLBViewer implementation\r\n\ttexture.flipY = false;\r\n\r\n\t//  FIX: Proper color space for correct color reproduction\r\n\ttexture.colorSpace = SRGBColorSpace;\r\n\r\n\t//  FIX: Enable mipmaps for better quality in PathTracer\r\n\ttexture.generateMipmaps = true;\r\n\ttexture.minFilter = LinearMipmapLinearFilter;\r\n\ttexture.magFilter = LinearFilter;\r\n\r\n\t//  FIX: Anisotropic filtering for sharper textures at angles\r\n\ttexture.anisotropy = 16;\r\n\r\n\ttexture.needsUpdate = true;\r\n\r\n\t// Apply to materials\r\n\tconst materials = Array.isArray(screenMesh.material)\r\n\t\t? screenMesh.material\r\n\t\t: [screenMesh.material];\r\n\r\n\tmaterials.forEach((material) => {\r\n\r\n\t\t// Dispose old texture if exists\r\n\t\tif (material.emissiveMap && material.emissiveMap !== uploadedTexture) {\r\n\r\n\t\t\tmaterial.emissiveMap.dispose();\r\n\r\n\t\t}\r\n\r\n\t\tmaterial.emissiveMap = texture;\r\n\t\t// Keep emissiveIntensity at 1.0 since brightness is now baked into the texture\r\n\t\tmaterial.emissiveIntensity = 1.0;\r\n\t\tmaterial.emissive = new Color(0xffffff);\r\n\t\t// Match predefined wallpapers: glossy screen look (low roughness, no metalness)\r\n\t\tmaterial.roughness = 1;\r\n\t\tmaterial.metalness = 1;\r\n\t\tmaterial.needsUpdate = true;\r\n\r\n\t});\r\n\r\n\t// Store the new texture reference\r\n\tuploadedTexture = texture;\r\n\r\n\t// Update path tracer\r\n\tpathTracer.updateMaterials();\r\n\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\tconsole.log(` Screen texture updated successfully`);\r\n\r\n}\r\n\r\n// Function to handle image upload\r\nasync function handleImageUpload(file) {\r\n\r\n\tconsole.log(`\\n ========== IMAGE UPLOAD STARTED ==========`);\r\n\tconsole.log(` File:`, file.name, `(${file.type}, ${(file.size / 1024).toFixed(2)} KB)`);\r\n\r\n\tif (!file || !file.type.startsWith('image/')) {\r\n\r\n\t\talert('Please upload an image file');\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\tconst reader = new FileReader();\r\n\treader.onload = async (e) => {\r\n\r\n\t\tconsole.log(` File read successfully`);\r\n\r\n\t\tconst img = new Image();\r\n\t\timg.onload = async () => {\r\n\r\n\t\t\tconsole.log(` Image loaded: ${img.width}x${img.height}`);\r\n\r\n\t\t\t//  NEW: Store the original image for later brightness/saturation updates\r\n\t\t\tuploadedImage = img;\r\n\t\t\tconsole.log(` Stored original image for brightness/saturation processing`);\r\n\r\n\t\t\t// Custom wallpaper defaults: 4.5 brightness, 0.9 saturation\r\n\t\t\tparams.screenBrightness = 4.5;\r\n\t\t\tparams.screenSaturation = 0.9;\r\n\r\n\t\t\t// Find the screen mesh if not already found\r\n\t\t\tif (!screenMesh && model) {\r\n\r\n\t\t\t\tconsole.log(` screenMesh not found, searching...`);\r\n\t\t\t\tscreenMesh = findScreenMesh(model);\r\n\t\t\t\tconsole.log(` Found screenMesh:`, screenMesh ? screenMesh.name : 'null');\r\n\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(`\\n BEFORE APPLYING TEXTURE:`);\r\n\t\t\tconsole.log(`   screenMesh:`, screenMesh ? screenMesh.name : 'null');\r\n\t\t\tconsole.log(`   screenMesh.visible:`, screenMesh?.visible);\r\n\t\t\tconsole.log(`   screenMesh.material exists:`, !!screenMesh?.material);\r\n\t\t\tconsole.log(`   currentWallpaper:`, currentWallpaper);\r\n\t\t\tconsole.log(`   params.screenWallpaper:`, params.screenWallpaper);\r\n\r\n\t\t\tif (screenMesh && screenMesh.material) {\r\n\r\n\t\t\t\t//  NEW: Apply brightness and saturation to the image before creating texture\r\n\t\t\t\tconsole.log(`\\n    Applying brightness: ${params.screenBrightness}, saturation: ${params.screenSaturation}`);\r\n\t\t\t\tconst processedCanvas = applyBrightnessSaturationToImage(\r\n\t\t\t\t\timg,\r\n\t\t\t\t\tparams.screenBrightness,\r\n\t\t\t\t\tparams.screenSaturation\r\n\t\t\t\t);\r\n\r\n\t\t\t\t// Create texture from processed image\r\n\t\t\t\tconst texture = new Texture(processedCanvas);\r\n\r\n\t\t\t\t//  FIX: flipY = false to match reference GLBViewer implementation\r\n\t\t\t\ttexture.flipY = false;\r\n\r\n\t\t\t\t//  FIX: Proper color space for correct color reproduction\r\n\t\t\t\ttexture.colorSpace = SRGBColorSpace;\r\n\r\n\t\t\t\t//  FIX: Enable mipmaps for better quality in PathTracer\r\n\t\t\t\ttexture.generateMipmaps = true;\r\n\t\t\t\ttexture.minFilter = LinearMipmapLinearFilter;\r\n\t\t\t\ttexture.magFilter = LinearFilter;\r\n\r\n\t\t\t\t//  FIX: Anisotropic filtering for sharper textures at angles\r\n\t\t\t\ttexture.anisotropy = 16;\r\n\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconsole.log(` Texture created with proper quality settings (flipY: false, colorSpace: sRGB, mipmaps: enabled, brightness/saturation applied)`);\r\n\r\n\t\t\t\t// Handle array materials (if mesh has multiple materials)\r\n\t\t\t\tconst materials = Array.isArray(screenMesh.material)\r\n\t\t\t\t\t? screenMesh.material\r\n\t\t\t\t\t: [screenMesh.material];\r\n\r\n\t\t\t\tconsole.log(`   Materials count:`, materials.length);\r\n\r\n\t\t\t\t// Store the uploaded texture\r\n\t\t\t\tuploadedTexture = texture;\r\n\t\t\t\tconsole.log(`    Stored uploadedTexture`);\r\n\r\n\t\t\t\tmaterials.forEach((material, idx) => {\r\n\r\n\t\t\t\t\tconsole.log(`\\n    Processing material ${idx + 1}:`);\r\n\t\t\t\t\tconsole.log(`      Has emissiveMap:`, !!material.emissiveMap);\r\n\t\t\t\t\tconsole.log(`      emissiveIntensity:`, material.emissiveIntensity);\r\n\r\n\t\t\t\t\t// Dispose old texture if exists (but not if it's the one we just uploaded)\r\n\t\t\t\t\tif (material.emissiveMap && material.emissiveMap !== uploadedTexture) {\r\n\r\n\t\t\t\t\t\tconsole.log(`       Disposing old emissiveMap`);\r\n\t\t\t\t\t\tmaterial.emissiveMap.dispose();\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Set the new emissive map (same texture for all materials)\r\n\t\t\t\t\tmaterial.emissiveMap = texture;\r\n\t\t\t\t\t//  FIX: Set emissiveIntensity to 1.0 since brightness is baked into texture\r\n\t\t\t\t\tmaterial.emissiveIntensity = 1.0;\r\n\t\t\t\t\tmaterial.emissive = new Color(0xffffff); // White base\r\n\t\t\t\t\t// Match predefined wallpapers: glossy screen look (low roughness, no metalness)\r\n\t\t\t\t\tmaterial.roughness = 1;\r\n\t\t\t\t\tmaterial.metalness = 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\r\n\t\t\t\t\tconsole.log(`       Applied new emissiveMap`);\r\n\t\t\t\t\tconsole.log(`       Set emissiveIntensity to: 1.0 (brightness baked into texture)`);\r\n\t\t\t\t\tconsole.log(`       Set emissive color to white`);\r\n\t\t\t\t\tconsole.log(`       Set roughness=0, metalness=0 for glossy screen`);\r\n\t\t\t\t\tconsole.log(`       Set needsUpdate = true`);\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Set wallpaper to custom\r\n\t\t\t\tparams.screenWallpaper = 'custom';\r\n\t\t\t\tcurrentWallpaper = 'custom';\r\n\t\t\t\tconsole.log(`\\n    Set params.screenWallpaper = 'custom'`);\r\n\t\t\t\tconsole.log(`    Set currentWallpaper = 'custom'`);\r\n\r\n\t\t\t\t// Hide all predefined wallpapers and show custom\r\n\t\t\t\tconsole.log(`\\n    Calling updateWallpaperVisibility('custom')...`);\r\n\t\t\t\tawait updateWallpaperVisibility('custom');\r\n\r\n\t\t\t\t// Update the path tracer with new materials\r\n\t\t\t\tconsole.log(`\\n    Updating path tracer materials...`);\r\n\t\t\t\tpathTracer.updateMaterials();\r\n\r\n\t\t\t\t// Reset rendering to see changes immediately\r\n\t\t\t\tconsole.log(`    Resetting path tracer...`);\r\n\t\t\t\tresetPathTracerAndResumeIfAutoPaused();\r\n\r\n\t\t\t\t// Rebuild GUI to update the screen folder\r\n\t\t\t\tconsole.log(`    Rebuilding GUI...`);\r\n\t\t\t\tbuildGui();\r\n\r\n\t\t\t\tconsole.log(`\\n ========== IMAGE UPLOAD COMPLETE ==========\\n`);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.error(`\\n ========== IMAGE UPLOAD FAILED ==========`);\r\n\t\t\t\tconsole.error(`   screenMesh:`, screenMesh);\r\n\t\t\t\tconsole.error(`   screenMesh.material:`, screenMesh?.material);\r\n\t\t\t\tconsole.error(`   model:`, model);\r\n\t\t\t\talert('Screen mesh not found in model. Check console for details.');\r\n\r\n\t\t\t}\r\n\r\n\t\t};\r\n\t\timg.onerror = () => {\r\n\r\n\t\t\tconsole.error(' Failed to load image');\r\n\t\t\talert('Failed to load image file');\r\n\r\n\t\t};\r\n\t\timg.src = e.target.result;\r\n\r\n\t};\r\n\treader.onerror = () => {\r\n\r\n\t\tconsole.error(' Failed to read file');\r\n\t\talert('Failed to read file');\r\n\r\n\t};\r\n\treader.readAsDataURL(file);\r\n\r\n}\r\n\r\n\r\nasync function updateModel() {\r\n\r\n\tif (gui) {\r\n\r\n\t\tdocument.body.classList.remove('checkerboard');\r\n\t\tgui.destroy();\r\n\t\tgui = null;\r\n\r\n\t}\r\n\r\n\tconst modelInfo = models[params.model];\r\n\r\n\trenderer.domElement.style.visibility = 'hidden';\r\n\tloader.setPercentage(0);\r\n\r\n\tif (model) {\r\n\r\n\t\tmodel.traverse(c => {\r\n\r\n\t\t\tif (c.material) {\r\n\r\n\t\t\t\tconst material = c.material;\r\n\t\t\t\tfor (const key in material) {\r\n\r\n\t\t\t\t\tif (material[key] && material[key].isTexture) {\r\n\r\n\t\t\t\t\t\tmaterial[key].dispose();\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\tcontentGroup?.remove(model);\r\n\t\tmodel = null;\r\n\r\n\t}\r\n\r\n\t// Yield one frame so we don't start load in the same frame as dispose (reduces GPU/main-thread burst)\r\n\tawait new Promise( r => requestAnimationFrame( r ) );\r\n\r\n\tlet loadResult;\r\n\ttry {\r\n\r\n\t\tloadResult = await loadModel(modelInfo.url, v => {\r\n\r\n\t\t\tloader.setPercentage(0.5 * v);\r\n\r\n\t\t});\r\n\r\n\t} catch (err) {\r\n\r\n\t\tloader.setCredits('Failed to load model:' + err.message);\r\n\t\tloader.setPercentage(1);\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\t// Support both { scene, animations } and legacy plain scene return\r\n\tmodel = loadResult.scene ?? loadResult;\r\n\tconst animations = loadResult.animations ?? [];\r\n\r\n\tif (!model) {\r\n\r\n\t\treturn;\r\n\r\n\t}\r\n\r\n\t// update after model load\r\n\t// TODO: clean up\r\n\tif (modelInfo.removeEmission) {\r\n\r\n\t\tmodel.traverse(c => {\r\n\r\n\t\t\tif (c.material) {\r\n\r\n\t\t\t\tc.material.emissiveMap = null;\r\n\t\t\t\tc.material.emissiveIntensity = 0;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\tif (modelInfo.opacityToTransmission) {\r\n\r\n\t\tconvertOpacityToTransmission(model, modelInfo.ior || 1.5);\r\n\r\n\t}\r\n\r\n\tmodel.traverse(c => {\r\n\r\n\t\tif (c.material) {\r\n\r\n\t\t\t// set the thickness so we render the material as a volumetric object\r\n\t\t\tc.material.thickness = 1.0;\r\n\r\n\t\t\t// Ensure materials can respond to scene.environment for raster view\r\n\t\t\t// envMapIntensity controls how much the environment affects the material (default 1)\r\n\t\t\tif (c.material.envMapIntensity === undefined || c.material.envMapIntensity === 0) {\r\n\r\n\t\t\t\tc.material.envMapIntensity = 1.0;\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t});\r\n\r\n\tif (modelInfo.postProcess) {\r\n\r\n\t\tmodelInfo.postProcess(model);\r\n\r\n\t}\r\n\r\n\t// rotate model after so it doesn't affect the bounding sphere scale\r\n\tif (modelInfo.rotation) {\r\n\r\n\t\tmodel.rotation.set(...modelInfo.rotation);\r\n\r\n\t}\r\n\r\n\t// center the model\r\n\tconst box = new Box3();\r\n\tbox.setFromObject(model);\r\n\tmodel.position\r\n\t\t.addScaledVector(box.min, - 0.5)\r\n\t\t.addScaledVector(box.max, - 0.5);\r\n\r\n\tconst sphere = new Sphere();\r\n\tbox.getBoundingSphere(sphere);\r\n\r\n\tmodel.scale.setScalar(1 / sphere.radius);\r\n\tmodel.position.multiplyScalar(1 / sphere.radius);\r\n\tbox.setFromObject(model);\r\n\tfloorPlane.position.y = box.min.y;\r\n\r\n\tcontentGroup.add(model);\r\n\r\n\t// 0. Detect productColor meshes and group them (like GLBViewer reference)\r\n\tcolorMeshGroups = {};\r\n\tcurrentColorGroup = null;\r\n\t{\r\n\r\n\t\tconst productColorMatcher = /^productColor_([A-Za-z0-9]+?)(\\d*)_([a-f0-9]{6})$/i;\r\n\t\tconst allColorMeshes = [];\r\n\r\n\t\tmodel.traverse( ( obj ) => {\r\n\r\n\t\t\tif ( ! obj || ! obj.isMesh || ! obj.name ) return;\r\n\t\t\tconst match = obj.name.match( productColorMatcher );\r\n\t\t\tif ( match ) {\r\n\r\n\t\t\t\tconst colorName = match[ 1 ];\r\n\t\t\t\tconst hexCode = match[ 3 ];\r\n\t\t\t\tobj.visible = false; // hide all color meshes initially\r\n\t\t\t\tallColorMeshes.push( { mesh: obj, name: obj.name, colorName, hexCode } );\r\n\r\n\t\t\t}\r\n\r\n\t\t} );\r\n\r\n\t\t// Group by base color name (strip trailing digits)\r\n\t\tconst groupsByName = {};\r\n\t\tallColorMeshes.forEach( item => {\r\n\r\n\t\t\tconst key = item.colorName.toLowerCase().replace( /\\d+$/, '' );\r\n\t\t\tif ( ! groupsByName[ key ] ) {\r\n\r\n\t\t\t\tgroupsByName[ key ] = { prefix: item.colorName.replace( /\\d+$/, '' ), names: [], hexCode: item.hexCode };\r\n\r\n\t\t\t}\r\n\t\t\tgroupsByName[ key ].names.push( item.name );\r\n\r\n\t\t} );\r\n\r\n\t\tcolorMeshGroups = groupsByName;\r\n\r\n\t\t// Show the first color group as default\r\n\t\tconst keys = Object.keys( colorMeshGroups );\r\n\t\tif ( keys.length > 0 ) {\r\n\r\n\t\t\tcurrentColorGroup = keys[ 0 ];\r\n\t\t\tcolorMeshGroups[ keys[ 0 ] ].names.forEach( meshName => {\r\n\r\n\t\t\t\tconst m = model.getObjectByName( meshName );\r\n\t\t\t\tif ( m ) m.visible = true;\r\n\r\n\t\t\t} );\r\n\t\t\tconsole.log( ` Product colors detected: ${ keys.join( ', ' ) }. Default: ${ keys[ 0 ] }` );\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// 1. Find all wallpaper meshes BEFORE building the path tracer scene\r\n\twallpaperMeshes = findAllWallpaperMeshes(model);\r\n\tconsole.log(' Found wallpapers:', Object.keys(wallpaperMeshes).filter(key => wallpaperMeshes[key] !== null));\r\n\r\n\t// 2. Find the screen mesh (default to blank_screen)\r\n\tscreenMesh = wallpaperMeshes['blank_screen'] || findScreenMesh(model);\r\n\tif (screenMesh) {\r\n\r\n\t\tconsole.log(' Screen mesh found:', screenMesh.name);\r\n\r\n\t} else {\r\n\r\n\t\tconsole.warn(' Screen mesh not found - upload may not work');\r\n\r\n\t}\r\n\r\n\t// 3. Set wallpaper visibility (hides non-selected wallpapers) BEFORE scene build\r\n\t//    This avoids building the BVH twice  once with all visible, then again after hiding.\r\n\tcurrentWallpaper = params.screenWallpaper || 'blank_screen';\r\n\t{\r\n\r\n\t\t// Inline visibility setup without setSceneAsync (we'll do that once below)\r\n\t\t// Hide all wallpaper meshes first\r\n\t\tmodel.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh && child.material) {\r\n\r\n\t\t\t\tconst name = child.name;\r\n\t\t\t\tconst isWallpaper = /^\\d+_/.test(name) || name === 'screen_blank';\r\n\t\t\t\tif (isWallpaper) {\r\n\r\n\t\t\t\t\tchild.visible = false;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\tif (child.isGroup && child.name?.toLowerCase() === 'wallpaper') {\r\n\r\n\t\t\t\tchild.visible = false;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\t// Show only the selected wallpaper\r\n\t\tconst targetMesh = wallpaperMeshes[currentWallpaper];\r\n\t\tif (targetMesh) {\r\n\r\n\t\t\ttargetMesh.visible = true;\r\n\t\t\t// Make parent chain visible\r\n\t\t\tlet parent = targetMesh.parent;\r\n\t\t\twhile (parent && parent !== model) {\r\n\r\n\t\t\t\tparent.visible = true;\r\n\t\t\t\tparent = parent.parent;\r\n\r\n\t\t\t}\r\n\t\t\tconsole.log(` Initial wallpaper \"${currentWallpaper}\" visible: ${targetMesh.name}`);\r\n\r\n\t\t} else {\r\n\r\n\t\t\tconsole.warn(` Initial wallpaper \"${currentWallpaper}\" not found, all wallpapers hidden`);\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t// 4. Animation: setup mixer and pose BEFORE building the path tracer scene\r\n\tif (animationMixer) {\r\n\r\n\t\tanimationMixer.stopAllAction();\r\n\t\tanimationMixer.uncacheRoot(model);\r\n\t\tanimationMixer = null;\r\n\t\tmainAnimAction = null;\r\n\t\tmainAnimClip = null;\r\n\r\n\t}\r\n\tif (animations.length > 0) {\r\n\r\n\t\tanimationMixer = new AnimationMixer(model);\r\n\t\tconst expectedNames = ['mainAnim', 'Animation'];\r\n\t\tlet mainClip = animations.find(c => expectedNames.includes(c.name))\r\n\t\t\t|| animations.find(c => c.name.toLowerCase().includes('main'))\r\n\t\t\t|| animations[0];\r\n\t\tmainAnimClip = mainClip;\r\n\t\tmainAnimAction = animationMixer.clipAction(mainClip);\r\n\t\tmainAnimAction.play();\r\n\t\tmainAnimAction.paused = true;\r\n\t\tconst timeInSeconds = Math.min(params.animationFrame / ANIMATION_FRAME_RATE, mainClip.duration || 5);\r\n\t\tmainAnimAction.time = timeInSeconds;\r\n\t\tparams.animationFrame = Math.round( timeInSeconds * ANIMATION_FRAME_RATE );\r\n\t\tanimationMixer.update(0);\r\n\r\n\t}\r\n\r\n\t// Yield one frame after model ready so geometry merge doesn't run in same tick as post-load traversals\r\n\tawait new Promise( r => requestAnimationFrame( r ) );\r\n\r\n\t// 5. Now build the path tracer scene ONCE with correct visibility + animation pose\r\n\tscene.updateMatrixWorld(true);\r\n\tconst sceneResult = await pathTracer.setSceneAsync(scene, activeCamera, {\r\n\r\n\t\tonProgress: v => loader.setPercentage(0.5 + 0.5 * v),\r\n\r\n\t});\r\n\tsceneBvh = sceneResult?.bvh || null; // Store BVH for click-to-focus\r\n\t// Compile path tracer material before first frame (reduces GPU load)\r\n\tawait pathTracer.compileAsync();\r\n\t// Two rAFs after compile so we don't show + first path trace in the same frame as compile\r\n\tawait new Promise( r => requestAnimationFrame( r ) );\r\n\tawait new Promise( r => requestAnimationFrame( r ) );\r\n\r\n\tloader.setPercentage(1);\r\n\tloader.setCredits(modelInfo.credit || '');\r\n\tparams.bounces = modelInfo.bounces || 5;\r\nparams.floorColor = modelInfo.floorColor || '#111111';\r\n\t\t\tparams.floorRoughness = modelInfo.floorRoughness || 0.2;\r\n\t\t\tparams.floorMetalness = modelInfo.floorMetalness || 0.2;\r\n\t\t\tif ( modelInfo.floorTransmission !== undefined ) params.floorTransmission = modelInfo.floorTransmission;\r\n\t\t\tif ( modelInfo.floorIOR !== undefined ) params.floorIOR = modelInfo.floorIOR;\r\n\tparams.bgGradientTop = modelInfo.gradientTop || '#111111';\r\n\tparams.bgGradientBottom = modelInfo.gradientBot || '#000000';\r\n\r\n\tbuildGui();\r\n\tonParamsChange();\r\n\r\n\t// Start at lower scale and higher delay to avoid GPU exhaustion on first frames\r\n\tpathTracer.renderScale = 0.5;\r\n\tpathTracer.renderDelay = 500;\r\n\tsetTimeout( () => {\r\n\r\n\t\tpathTracer.renderDelay = 100;\r\n\t\tpathTracer.renderScale = params.renderScale;\r\n\r\n\t}, 3000 );\r\n\r\n\trenderer.domElement.style.visibility = 'visible';\r\n\tif (params.checkerboardTransparency) {\r\n\r\n\t\tdocument.body.classList.add('checkerboard');\r\n\r\n\t}\r\n\r\n}\r\n\r\nasync function loadModel(url, onProgress) {\r\n\r\n\t// TODO: clean up\r\n\tconst manager = new LoadingManager();\r\n\tif (/dae$/i.test(url)) {\r\n\r\n\t\tconst complete = new Promise(resolve => manager.onLoad = resolve);\r\n\t\tconst res = await new ColladaLoader(manager).loadAsync(url, progress => {\r\n\r\n\t\t\tif (progress.total !== 0 && progress.total >= progress.loaded) {\r\n\r\n\t\t\t\tonProgress(progress.loaded / progress.total);\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\t\tawait complete;\r\n\r\n\t\tres.scene.scale.setScalar(1);\r\n\t\tres.scene.traverse(c => {\r\n\r\n\t\t\tconst { material } = c;\r\n\t\t\tif (material && material.isMeshPhongMaterial) {\r\n\r\n\t\t\t\tc.material = new MeshStandardMaterial({\r\n\r\n\t\t\t\t\tcolor: material.color,\r\n\t\t\t\t\troughness: material.roughness || 0,\r\n\t\t\t\t\tmetalness: material.metalness || 0,\r\n\t\t\t\t\tmap: material.map || null,\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\treturn { scene: res.scene, animations: [] };\r\n\r\n\t} else if (/(gltf|glb)$/i.test(url)) {\r\n\r\n\t\tconst dracoLoader = new DRACOLoader(manager);\r\n\t\tdracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.7/');\r\n\r\n\t\tconst complete = new Promise(resolve => manager.onLoad = resolve);\r\n\t\tconst gltf = await new GLTFLoader(manager)\r\n\t\t\t.setDRACOLoader(dracoLoader)\r\n\t\t\t.setMeshoptDecoder(MeshoptDecoder)\r\n\t\t\t.loadAsync(url, progress => {\r\n\r\n\t\t\t\tif (progress.total !== 0 && progress.total >= progress.loaded) {\r\n\r\n\t\t\t\t\tonProgress(progress.loaded / progress.total);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\tawait complete;\r\n\r\n\t\treturn { scene: gltf.scene, animations: gltf.animations || [] };\r\n\r\n\t} else if (/mpd$/i.test(url)) {\r\n\r\n\t\tmanager.onProgress = (url, loaded, total) => {\r\n\r\n\t\t\tonProgress(loaded / total);\r\n\r\n\t\t};\r\n\r\n\t\tconst complete = new Promise(resolve => manager.onLoad = resolve);\r\n\t\tconst ldrawLoader = new LDrawLoader(manager);\r\n\t\tldrawLoader.setConditionalLineMaterial(LDrawConditionalLineMaterial);\r\n\t\tawait ldrawLoader.preloadMaterials('https://raw.githubusercontent.com/gkjohnson/ldraw-parts-library/master/colors/ldcfgalt.ldr');\r\n\t\tconst result = await ldrawLoader\r\n\t\t\t.setPartsLibraryPath('https://raw.githubusercontent.com/gkjohnson/ldraw-parts-library/master/complete/ldraw/')\r\n\t\t\t.loadAsync(url);\r\n\t\tawait complete;\r\n\r\n\t\tconst model = LDrawUtils.mergeObject(result);\r\n\t\tmodel.rotation.set(Math.PI, 0, 0);\r\n\r\n\t\tconst toRemove = [];\r\n\t\tmodel.traverse(c => {\r\n\r\n\t\t\tif (c.isLineSegments) {\r\n\r\n\t\t\t\ttoRemove.push(c);\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif (c.isMesh) {\r\n\r\n\t\t\t\tc.material.roughness *= 0.25;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\ttoRemove.forEach(c => {\r\n\r\n\t\t\tc.parent.remove(c);\r\n\r\n\t\t});\r\n\r\n\t\treturn { scene: model, animations: [] };\r\n\r\n\t}\r\n\r\n}\r\n"],"names":["TGALoader","DataTextureLoader","manager","buffer","tgaCheckHeader","header","TGA_TYPE_INDEXED","TGA_TYPE_RLE_INDEXED","TGA_TYPE_RGB","TGA_TYPE_GREY","TGA_TYPE_RLE_RGB","TGA_TYPE_RLE_GREY","TGA_TYPE_NO_DATA","tgaParse","use_rle","use_pal","offset","data","pixel_data","palettes","pixel_size","pixel_total","c","count","i","shift","pixels","tgaGetImageData8bits","imageData","y_start","y_step","y_end","x_start","x_step","x_end","image","colormap","color","x","y","width","tgaGetImageData16bits","tgaGetImageData24bits","tgaGetImageData32bits","tgaGetImageDataGrey8bits","tgaGetImageDataGrey16bits","getTgaRGBA","height","palette","TGA_ORIGIN_MASK","TGA_ORIGIN_SHIFT","TGA_ORIGIN_UL","TGA_ORIGIN_BL","TGA_ORIGIN_UR","TGA_ORIGIN_BR","use_grey","content","result","LinearMipmapLinearFilter","ColladaLoader","Loader","url","onLoad","onProgress","onError","scope","path","LoaderUtils","loader","FileLoader","text","e","getElementsByTagName","xml","name","array","childNodes","l","child","parseStrings","parts","parseFloats","parseInts","parseId","generateId","isEmpty","object","parseAsset","parseAssetUnit","parseAssetUpAxis","parseLibrary","libraryName","nodeName","parser","library","elements","buildLibrary","builder","getBuild","parseAnimation","hasChildren","id","parseSource","parseAnimationSampler","parseAnimationChannel","MathUtils","semantic","sid","arraySyntax","memberSyntax","indices","buildAnimation","tracks","channels","samplers","sources","target","channel","sampler","inputId","outputId","inputSource","outputSource","animation","buildAnimationChannel","createKeyframeTracks","getAnimation","node","object3D","getNode","transform","defaultMatrix","time","stride","il","j","jl","value","index","keyframes","prepareAnimationData","ascending","transformAnimationData","a","b","position","Vector3","scale","quaternion","Quaternion","times","positionData","quaternionData","scaleData","keyframe","matrix","VectorKeyframeTrack","QuaternionKeyframeTrack","property","defaultValue","empty","createMissingKeyframes","prev","next","getPrev","getNext","interpolate","key","parseAnimationClip","buildAnimationClip","duration","animations","animationTracks","AnimationClip","getAnimationClip","parseController","parseSkin","parseJoints","parseVertexWeights","buildController","build","geometry","buildSkin","vertexWeights","vcount","v","jointOffset","weightOffset","jointSource","inverseSource","weights","jointCount","vertexSkinData","skinIndex","weightId","skinWeight","descending","d","Matrix4","boneInverse","getController","parseImage","buildImage","getImage","parseEffect","parseEffectProfileCOMMON","parseEffectNewparam","parseEffectTechnique","parseEffectExtra","parseEffectSurface","parseEffectSampler","parseEffectParameters","parseEffectParameter","parseEffectParameterTexture","parseEffectParameterTextureExtra","parseEffectParameterTextureExtraTechnique","parseEffectExtraTechniqueBump","parseEffectExtraTechnique","buildEffect","getEffect","parseMaterial","getTextureLoader","extension","tgaLoader","textureLoader","buildMaterial","effect","technique","material","MeshPhongMaterial","MeshLambertMaterial","MeshBasicMaterial","getTexture","textureObject","colorSpace","surface","texture","extra","RepeatWrapping","ClampToEdgeWrapping","parameters","parameter","SRGBColorSpace","ColorManagement","transparent","transparency","techniques","k","DoubleSide","FrontSide","Vector2","getMaterial","parseCamera","parseCameraOptics","parseCameraTechnique","parseCameraParameters","buildCamera","camera","PerspectiveCamera","ymag","xmag","aspectRatio","OrthographicCamera","getCamera","parseLight","parseLightTechnique","parseLightParameters","Color","f","buildLight","light","DirectionalLight","PointLight","SpotLight","AmbientLight","getLight","parseGeometry","mesh","parseGeometryVertices","parseGeometryPrimitive","accessor","primitive","set","inputname","groupPrimitives","primitives","checkUVCoordinates","buildGeometry","vertices","groupedPrimitives","type","primitiveType","buildGeometryType","normal","uv","uv1","BufferGeometry","materialKeys","start","p","inputs","g","vc","input","prevLength","buildGeometryData","Float32BufferAttribute","source","isColor","pushVector","sourceStride","length","sourceArray","startIndex","tempColor","kl","getGeometry","parseKinematicsModel","parseKinematicsTechniqueCommon","buildKinematicsModel","getKinematicsModel","parseKinematicsJoint","parseKinematicsLink","parseKinematicsJointParameter","max","min","parseKinematicsAttachment","parseKinematicsTransform","parsePhysicsModel","parsePhysicsRigidBody","parsePhysicsTechniqueCommon","parseKinematicsScene","parseKinematicsBindJointAxis","param","tmpJointIndex","buildKinematicsScene","getKinematicsScene","setupKinematics","kinematicsModelId","kinematicsSceneId","visualSceneId","kinematicsModel","kinematicsScene","visualScene","getVisualScene","bindJointAxis","jointMap","axis","targetElement","collada","parentVisualElement","connect","jointIndex","visualElement","visualElementName","joint","buildTransformList","m0","kinematics","jointData","transforms","vector","angle","prepareNodes","element","parseNode","parseNodeInstance","hasNode","instances","instance","symbol","buildSkeleton","skeletons","joints","boneData","sortedBoneData","skeleton","root","buildBoneHierarchy","hasVisualScene","children","bones","boneInverses","Skeleton","buildNode","objects","nodes","instanceCameras","instanceControllers","instanceLights","instanceGeometries","instanceNodes","instanceCamera","controller","geometries","newObjects","buildObjects","instanceLight","Bone","Group","fallbackMaterial","resolveMaterialBinding","keys","instanceMaterials","materials","LineBasicMaterial","lineMaterial","skinning","LineSegments","Line","SkinnedMesh","Mesh","parseVisualScene","buildVisualScene","group","parseScene","setupAnimations","clips","parserErrorToText","parserError","stack","Scene","errorElement","errorText","version","asset","TextureLoader","scene","LDrawConditionalLineMaterial","ShaderMaterial","UniformsUtils","UniformsLib","ImageRenderModal","pathTracer","renderer","gl","renderBtn","stopBtn","progressDiv","progressFill","progressText","isPNG","shouldCaptureBackground","bgImageSrc","bgImageW","bgImageH","res","bgAspect","baseAspect","originalBackground","originalClearAlpha","didSetTransparent","originalWidth","originalHeight","totalPixels","maxSafePixels","maxMemoryPixels","safeScale","newWidth","newHeight","errorMsg","warningMsg","originalRenderScale","currentWidth","currentHeight","aspect","orthoWidth","originalEnablePathTracing","originalPausePathTracing","originalRenderToCanvas","minSamples","canvas","error","resolve","targetSamples","lastUpdate","checkSamples","currentSamples","progress","now","format","renderDataUrl","reject","bgImg","tempCanvas","ctx","canvasAspect","drawW","drawH","drawX","drawY","renderImg","quality","dataUrl","fileName","link","restoreW","restoreH","restoreDPR","w","h","lowResScale","envMaps","params","getScaledSettings","floorPlane","gui","stats","orthoCamera","perspectiveCamera","activeCamera","controls","model","gradientMap","models","screenMesh","uploadedTexture","uploadedImage","wallpaperMeshes","currentWallpaper","imageRenderModal","_autoPausedDueToSamples","enableController","sceneBvh","focusMouse","_envRotationDragging","_envRotPrevEnable","backgroundOverlay","backgroundPlane","backgroundImageSrc","backgroundImageOriginal","backgroundImageNaturalWidth","backgroundImageNaturalHeight","backgroundHDRITexture","previousEnvironment","customEnvTexture","fallbackEnvMap","animationMixer","mainAnimAction","mainAnimClip","ANIMATION_FRAME_RATE","colorMeshGroups","currentColorGroup","contentGroup","init","MODEL_LIST","LoaderElement","WebGLRenderer","ACESFilmicToneMapping","canvasContainer","WebGLPathTracer","GenerateMeshBVHWorker","s","PhysicalCamera","orthoHeight","GradientEquirectTexture","OrbitControls","resetPathTracerAndResumeIfAutoPaused","startBackgroundDrag","moveBackgroundDrag","endBackgroundDrag","onBackgroundWheel","isBackgroundModeActive","floorTex","generateRadialFloorTexture","PlaneGeometry","MeshPhysicalMaterial","Stats","updateCameraProjection","onHashChange","updateEnvMap","onResize","animate","onFocusPointerDown","onFocusPointerUp","syncSceneEnvironmentFromParams","syncMaterialEnvMapRotation","rotationY","envRotation","Euler","onParamsChange","_bgDragActive","_bgPrevEnable","_bgPrevPause","_bgPrevX","_bgPrevY","setBackgroundControlsEnabled","enabled","dx","dy","panSpeed","panX","panY","right","up","bgResult","factor","showBackgroundPlane","hideBackgroundPlane","applyBackgroundAsHDRI","img","cvs","floatData","envDataTexture","DataTexture","RGBAFormat","FloatType","EquirectangularReflectionMapping","handleBackgroundImageUpload","file","reader","buildGui","hashModel","modelName","updateModel","dpr","raycaster","Raycaster","hit","GUI","animationFolder","maxFrame","_animFrameDebounce","_animDragging","_animPrevPause","frame","timeInSeconds","animResult","updateWallpaperVisibility","toShow","colorKeys","colorFolder","colorLabels","grp","label","meshName","m","selected","colorResult","pathTracingFolder","NoToneMapping","renderImageController","button","dofFolder","environmentFolder","loadCustomHDRI","backgroundFolder","fileInput","floorFolder","floorModeCtrl","solidControls","shadowOpacityCtrl","applyFloorMode","mode","isCatcher","isMaterialAlpha","ctrl","screenFolder","availableWallpapers","option","handleImageUpload","updateScreenTextureWithSettings","previousEnvDuringLoad","HDRLoader","LinearFilter","err","cameraProjection","convertOpacityToTransmission","ior","newMaterial","hsl","findScreenMesh","foundMesh","priorityMesh","parentName","_b","_a","_c","_d","findAllWallpaperMeshes","wallpapers","wallpaperMeshesByName","wallpaperGroup","screenBlankMesh","parentNameLower","numericPrefixMatch","wallpaperNameLower","coreName","selectedWallpaper","allScreenMeshes","isScreenComponent","originalName","isFoundWallpaper","hasNumericPrefix","isInWallpaperGroup","isScreenBlank","worldPos","priority","wallpaperType","match","info","idx","priorityStr","depthStr","visibleStr","emissiveStr","typeStr","nameStr","hiddenGroups","hiddenMeshesList","wasVisible","parent","wasGroupVisible","targetMesh","targetMeshInfo","isScreenOff","selectedMesh","parentCount","visibleParentChain","visibleMeshes","hiddenMeshes","visResult","applyBrightnessSaturationToImage","brightness","saturation","brightnessMultiplier","r","luma","processedCanvas","Texture","modelInfo","loadResult","loadModel","box","Box3","sphere","Sphere","productColorMatcher","allColorMeshes","obj","colorName","hexCode","groupsByName","item","AnimationMixer","expectedNames","mainClip","sceneResult","LoadingManager","complete","MeshStandardMaterial","dracoLoader","DRACOLoader","gltf","GLTFLoader","MeshoptDecoder","loaded","total","ldrawLoader","LDrawLoader","LDrawUtils","toRemove"],"mappings":"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","x_google_ignoreList":[0,1,2]}