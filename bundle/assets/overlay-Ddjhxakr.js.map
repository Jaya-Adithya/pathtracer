{"version":3,"file":"overlay-Ddjhxakr.js","sources":["../../example/overlay.js"],"sourcesContent":["import {\r\n\tACESFilmicToneMapping,\r\n\tBox3,\r\n\tBoxGeometry,\r\n\tColor,\r\n\tCylinderGeometry,\r\n\tEquirectangularReflectionMapping,\r\n\tMesh,\r\n\tMeshBasicMaterial,\r\n\tMeshStandardMaterial,\r\n\tPerspectiveCamera,\r\n\tScene,\r\n\tWebGLRenderer,\r\n} from 'three';\r\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\r\nimport { WebGLPathTracer } from '../src/index.js';\r\nimport { HDRLoader } from 'three/examples/jsm/loaders/HDRLoader.js';\r\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\r\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\r\nimport { MeshoptDecoder } from 'three/examples/jsm/libs/meshopt_decoder.module.js';\r\nimport { ParallelMeshBVHWorker } from 'three-mesh-bvh/worker';\r\nimport { getScaledSettings } from './utils/getScaledSettings.js';\r\nimport { LoaderElement } from './utils/LoaderElement.js';\r\nimport { MODEL_LIST, DEFAULT_MODEL_KEY } from './utils/modelList.js';\r\n\r\nconst ENV_URL = 'https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/royal_esplanade_1k.hdr';\r\n\r\nlet pathTracer, renderer, controls, scene, camera;\r\nlet overlayScene, floatingObjects, currentModel = null;\r\nlet loader;\r\n\r\nconst params = {\r\n\r\n\tmodel: DEFAULT_MODEL_KEY,\r\n\t// path tracer settings\r\n\tbounces: 5,\r\n\trenderScale: 1 / window.devicePixelRatio,\r\n\tfilterGlossyFactor: 0.5,\r\n\ttiles: 1,\r\n\tmultipleImportanceSampling: true,\r\n\r\n\tenabled: true,\r\n\r\n\t...getScaledSettings(),\r\n\r\n};\r\n\r\ninit();\r\n\r\nasync function init() {\r\n\r\n\tloader = new LoaderElement();\r\n\tloader.attach( document.body );\r\n\r\n\t// renderer\r\n\trenderer = new WebGLRenderer( { antialias: true } );\r\n\trenderer.toneMapping = ACESFilmicToneMapping;\r\n\tdocument.body.appendChild( renderer.domElement );\r\n\r\n\t// path tracer\r\n\tpathTracer = new WebGLPathTracer( renderer );\r\n\tpathTracer.tiles.set( params.tiles, params.tiles );\r\n\tpathTracer.setBVHWorker( new ParallelMeshBVHWorker() );\r\n\r\n\t// camera\r\n\tcamera = new PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.025, 500 );\r\n\tcamera.position.set( 2.996, 3.795, 0.697 );\r\n\r\n\t// controls\r\n\tcontrols = new OrbitControls( camera, renderer.domElement );\r\n\tcontrols.target.set( 0.311, 1.13, 0.489 );\r\n\tcontrols.addEventListener( 'change', () => pathTracer.updateCamera() );\r\n\tcontrols.update();\r\n\r\n\t// init scene\r\n\tscene = new Scene();\r\n\r\n\t// init overlayScene\r\n\toverlayScene = new Scene();\r\n\r\n\t// load the env\r\n\tconst envTexture = await new HDRLoader().loadAsync( ENV_URL );\r\n\tenvTexture.mapping = EquirectangularReflectionMapping;\r\n\tscene.background = envTexture;\r\n\tscene.environment = envTexture;\r\n\r\n\tasync function loadAndSetModel( modelKey ) {\r\n\r\n\t\tconst entry = MODEL_LIST[ modelKey ];\r\n\t\tif ( ! entry || ! entry.url ) return;\r\n\t\tif ( currentModel ) scene.remove( currentModel );\r\n\t\tloader.setPercentage( 0 );\r\n\t\tconst dracoLoader = new DRACOLoader();\r\n\t\tdracoLoader.setDecoderPath( 'https://www.gstatic.com/draco/versioned/decoders/1.5.7/' );\r\n\t\tconst gltf = await new GLTFLoader()\r\n\t\t\t.setDRACOLoader( dracoLoader )\r\n\t\t\t.setMeshoptDecoder( MeshoptDecoder )\r\n\t\t\t.loadAsync( entry.url );\r\n\t\tdracoLoader.dispose();\r\n\t\tconst model = gltf.scene;\r\n\t\tif ( entry.postProcess ) entry.postProcess( model );\r\n\t\tmodel.traverse( c => { if ( c.material ) c.material.map = null; } );\r\n\t\tmodel.updateMatrixWorld( true );\r\n\t\tconst box = new Box3();\r\n\t\tbox.setFromObject( model );\r\n\t\tmodel.position.y -= box.min.y;\r\n\t\tscene.add( model );\r\n\t\tcurrentModel = model;\r\n\t\tscene.updateMatrixWorld( true );\r\n\t\tawait pathTracer.setSceneAsync( scene, camera, { onProgress: v => loader.setPercentage( v ) } );\r\n\t\tloader.setCredits( entry.credit || '' );\r\n\t}\r\n\r\n\tawait loadAndSetModel( params.model );\r\n\r\n\t// set the floor\r\n\tconst floorGeom = new CylinderGeometry( 3.5, 3.5, 0.05, 60 );\r\n\tconst floorMat = new MeshStandardMaterial( { color: new Color( 0x999999 ), metalness: 0.2, roughness: 0.02 } );\r\n\tconst floor = new Mesh( floorGeom, floorMat );\r\n\tfloor.position.y = - 0.025;\r\n\tscene.add( floor );\r\n\r\n\t// set floating Objects\r\n\tfloatingObjects = [];\r\n\tconst sampleMesh = new Mesh( new CylinderGeometry( 0.5, 0.5, 0.5, 32 ), new MeshBasicMaterial( { color: 0xff0000 } ) );\r\n\tconst sampleMesh2 = new Mesh( new BoxGeometry( 0.3, 0.3, 0.3 ), new MeshBasicMaterial( { color: 0x00ff00 } ) );\r\n\tsampleMesh.position.set( - 1, 0, 1 );\r\n\tsampleMesh2.position.set( 1, 0, - 1 );\r\n\tfloatingObjects.push( sampleMesh, sampleMesh2 );\r\n\toverlayScene.add( sampleMesh, sampleMesh2 );\r\n\r\n\t// initialize scene\r\n\tawait pathTracer.setSceneAsync( scene, camera, {\r\n\t\tonProgress: v => {\r\n\r\n\t\t\tloader.setPercentage( v );\r\n\r\n\t\t}\r\n\t} );\r\n\r\n\t// gui\r\n\tconst gui = new GUI();\r\n\tgui.add( params, 'model', Object.keys( MODEL_LIST ).sort() ).onChange( async ( v ) => { await loadAndSetModel( v ); } );\r\n\tconst ptFolder = gui.addFolder( 'Path Tracer' );\r\n\tptFolder.add( params, 'tiles', 1, 4, 1 ).onChange( value => {\r\n\r\n\t\tpathTracer.tiles.set( value, value );\r\n\r\n\t} );\r\n\tptFolder.add( params, 'filterGlossyFactor', 0, 1 ).onChange( onParamsChange );\r\n\tptFolder.add( params, 'bounces', 1, 15, 1 ).onChange( onParamsChange );\r\n\tptFolder.add( params, 'renderScale', 0.1, 1 ).onChange( onParamsChange );\r\n\tptFolder.add( params, 'multipleImportanceSampling' ).onChange( onParamsChange );\r\n\tptFolder.close();\r\n\r\n\tonParamsChange();\r\n\tonResize();\r\n\twindow.addEventListener( 'resize', onResize );\r\n\r\n\tanimate();\r\n\r\n}\r\n\r\nfunction onParamsChange() {\r\n\r\n\tpathTracer.filterGlossyFactor = params.filterGlossyFactor;\r\n\tpathTracer.bounces = params.bounces;\r\n\tpathTracer.renderScale = params.renderScale;\r\n\tpathTracer.multipleImportanceSampling = params.multipleImportanceSampling;\r\n\r\n}\r\n\r\nfunction onResize() {\r\n\r\n\trenderer.setSize( window.innerWidth, window.innerHeight );\r\n\trenderer.setPixelRatio( window.devicePixelRatio );\r\n\tcamera.aspect = window.innerWidth / window.innerHeight;\r\n\tcamera.updateProjectionMatrix();\r\n\r\n\tpathTracer.updateCamera();\r\n\r\n}\r\n\r\n// it's a dummy material for rendering depth only\r\nconst depthMaterial = new MeshBasicMaterial( { colorWrite: false } );\r\n\r\nfunction updateFloatingObjects() {\r\n\r\n\tfor ( let i = 0; i < floatingObjects.length; i ++ ) {\r\n\r\n\t\tconst obj = floatingObjects[ i ];\r\n\t\t// controlled y value by sin value\r\n\t\tobj.position.y = Math.sin( Date.now() * 0.001 + i );\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction animate() {\r\n\r\n\trequestAnimationFrame( animate );\r\n\r\n\tupdateFloatingObjects();\r\n\tpathTracer.renderSample();\r\n\r\n\tconst originalAutoClear = renderer.autoClear;\r\n\tconst originalBackground = scene.background;\r\n\trenderer.autoClear = false;\r\n\tscene.background = null;\r\n\tscene.overrideMaterial = depthMaterial;\r\n\trenderer.clearDepth();\r\n\t// render depth of the scene\r\n\trenderer.render( scene, camera );\r\n\tscene.overrideMaterial = null;\r\n\tscene.background = originalBackground;\r\n\r\n\t// render real time floating objects\r\n\trenderer.render( overlayScene, camera );\r\n\trenderer.autoClear = originalAutoClear;\r\n\r\n\tloader.setSamples( pathTracer.samples, pathTracer.isCompiling );\r\n\r\n}\r\n"],"names":["ENV_URL","pathTracer","renderer","controls","scene","camera","overlayScene","floatingObjects","currentModel","loader","params","DEFAULT_MODEL_KEY","getScaledSettings","init","LoaderElement","WebGLRenderer","ACESFilmicToneMapping","WebGLPathTracer","ParallelMeshBVHWorker","PerspectiveCamera","OrbitControls","Scene","envTexture","HDRLoader","EquirectangularReflectionMapping","loadAndSetModel","modelKey","entry","MODEL_LIST","dracoLoader","DRACOLoader","gltf","GLTFLoader","MeshoptDecoder","model","c","box","Box3","v","floorGeom","CylinderGeometry","floorMat","MeshStandardMaterial","Color","floor","Mesh","sampleMesh","MeshBasicMaterial","sampleMesh2","BoxGeometry","gui","GUI","ptFolder","value","onParamsChange","onResize","animate","depthMaterial","updateFloatingObjects","i","obj","originalAutoClear","originalBackground"],"mappings":"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"}