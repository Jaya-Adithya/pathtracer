{"version":3,"file":"depthOfField-kxPziq0k.js","sources":["../../example/depthOfField.js"],"sourcesContent":["import {\r\n\tVector2,\r\n\tVector3,\r\n\tACESFilmicToneMapping,\r\n\tScene,\r\n\tSphereGeometry,\r\n\tMeshStandardMaterial,\r\n\tMesh,\r\n\tRaycaster,\r\n\tWebGLRenderer,\r\n} from 'three';\r\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\r\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\r\nimport { PhysicalCamera, BlurredEnvMapGenerator, GradientEquirectTexture, WebGLPathTracer } from '../src/index.js';\r\nimport { HDRLoader } from 'three/examples/jsm/loaders/HDRLoader.js';\r\nimport { MeshoptDecoder } from 'three/examples/jsm/libs/meshopt_decoder.module.js';\r\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\r\nimport { getScaledSettings } from './utils/getScaledSettings.js';\r\nimport { LoaderElement } from './utils/LoaderElement.js';\r\nimport { MODEL_LIST, DEFAULT_MODEL_KEY } from './utils/modelList.js';\r\nimport { ParallelMeshBVHWorker } from 'three-mesh-bvh/worker';\r\n\r\nconst ENV_URL = 'https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/royal_esplanade_1k.hdr';\r\nconst DESCRIPTION = 'Path tracing with configurable bokeh and depth of field. Click point in scene to focus.';\r\n\r\nlet pathTracer, renderer, controls, camera, scene, bvh;\r\nlet loader, currentModel = null;\r\nconst mouse = new Vector2();\r\nconst focusPoint = new Vector3();\r\nconst params = {\r\n\r\n\tmodel: DEFAULT_MODEL_KEY,\r\n\tbounces: 3,\r\n\trenderScale: 1 / window.devicePixelRatio,\r\n\tfilterGlossyFactor: 0.5,\r\n\ttiles: 1,\r\n\tautoFocus: true,\r\n\r\n\t...getScaledSettings(),\r\n\r\n};\r\n\r\ninit();\r\n\r\nasync function loadAndSetModel( modelKey ) {\r\n\r\n\tconst entry = MODEL_LIST[ modelKey ];\r\n\tif ( ! entry || ! entry.url ) return;\r\n\r\n\tif ( currentModel ) {\r\n\r\n\t\tscene.remove( currentModel );\r\n\t\tcurrentModel = null;\r\n\r\n\t}\r\n\r\n\tloader.setPercentage( 0 );\r\n\tconst dracoLoader = new DRACOLoader();\r\n\tdracoLoader.setDecoderPath( 'https://www.gstatic.com/draco/versioned/decoders/1.5.7/' );\r\n\tconst gltf = await new GLTFLoader()\r\n\t\t.setDRACOLoader( dracoLoader )\r\n\t\t.setMeshoptDecoder( MeshoptDecoder )\r\n\t\t.loadAsync( entry.url );\r\n\tdracoLoader.dispose();\r\n\tconst model = gltf.scene;\r\n\tif ( entry.postProcess ) entry.postProcess( model );\r\n\tmodel.scale.setScalar( 0.5 );\r\n\tmodel.traverse( c => {\r\n\r\n\t\tif ( c.material ) {\r\n\r\n\t\t\tc.material.roughness = 0.05;\r\n\t\t\tc.material.metalness = 0.05;\r\n\r\n\t\t}\r\n\r\n\t} );\r\n\tscene.add( model );\r\n\tcurrentModel = model;\r\n\tscene.updateMatrixWorld( true );\r\n\r\n\tconst results = await pathTracer.setSceneAsync( scene, camera, {\r\n\t\tonProgress: v => loader.setPercentage( v ),\r\n\t} );\r\n\tbvh = results && results.bvh ? results.bvh : null;\r\n\tloader.setCredits( entry.credit || '' );\r\n\tonParamsChange();\r\n\r\n}\r\n\r\nasync function init() {\r\n\r\n\tloader = new LoaderElement();\r\n\tloader.attach( document.body );\r\n\r\n\t// renderer\r\n\trenderer = new WebGLRenderer( { antialias: true } );\r\n\trenderer.toneMapping = ACESFilmicToneMapping;\r\n\tdocument.body.appendChild( renderer.domElement );\r\n\r\n\t// path tracer\r\n\tpathTracer = new WebGLPathTracer( renderer );\r\n\tpathTracer.setBVHWorker( new ParallelMeshBVHWorker() );\r\n\tpathTracer.tiles.set( params.tiles, params.tiles );\r\n\r\n\t// camera\r\n\tcamera = new PhysicalCamera( 60, window.innerWidth / window.innerHeight, 0.025, 500 );\r\n\tcamera.position.set( - 0.262, 0.5276, - 1.1606 );\r\n\tcamera.apertureBlades = 6;\r\n\tcamera.fStop = 0.6;\r\n\tcamera.focusDistance = 1.1878;\r\n\tfocusPoint.set( - 0.5253353217832674, 0.3031596413506029, 0.000777794185259223 );\r\n\r\n\t// background\r\n\tconst gradientMap = new GradientEquirectTexture();\r\n\tgradientMap.topColor.set( 0x390f20 ).convertSRGBToLinear();\r\n\tgradientMap.bottomColor.set( 0x151b1f ).convertSRGBToLinear();\r\n\tgradientMap.update();\r\n\r\n\t// scene\r\n\tscene = new Scene();\r\n\tscene.background = gradientMap;\r\n\tscene.environmentIntensity = 0.5;\r\n\r\n\t// controls\r\n\tcontrols = new OrbitControls( camera, renderer.domElement );\r\n\tcontrols.target.set( - 0.182, 0.147, 0.06 );\r\n\tcontrols.update();\r\n\tcontrols.addEventListener( 'change', () => {\r\n\r\n\t\tif ( params.autoFocus ) {\r\n\r\n\t\t\tcamera.focusDistance = camera.position.distanceTo( focusPoint ) - camera.near;\r\n\r\n\t\t}\r\n\r\n\t\tpathTracer.updateCamera();\r\n\r\n\t} );\r\n\r\n\tconst [ envTexture ] = await Promise.all( [\r\n\t\tnew HDRLoader().loadAsync( ENV_URL ),\r\n\t] );\r\n\r\n\t// set up environment map\r\n\tconst generator = new BlurredEnvMapGenerator( renderer );\r\n\tconst blurredTex = generator.generate( envTexture, 0.35 );\r\n\tgenerator.dispose();\r\n\tenvTexture.dispose();\r\n\r\n\tscene.environment = blurredTex;\r\n\r\n\t// create bright points around the scene (kept when switching models)\r\n\tconst geometry = new SphereGeometry( 1, 10, 10 );\r\n\tconst mat = new MeshStandardMaterial( { emissiveIntensity: 10, emissive: 0xffffff } );\r\n\tfor ( let i = 0; i < 300; i ++ ) {\r\n\r\n\t\tconst m = new Mesh( geometry, mat );\r\n\t\tm.scale.setScalar( 0.075 * Math.random() + 0.03 );\r\n\t\tm.position.randomDirection().multiplyScalar( 30 + Math.random() * 15 );\r\n\t\tscene.add( m );\r\n\r\n\t}\r\n\r\n\tawait loadAndSetModel( params.model );\r\n\r\n\tloader.setDescription( DESCRIPTION );\r\n\tonParamsChange();\r\n\tonResize();\r\n\r\n\twindow.addEventListener( 'resize', onResize );\r\n\trenderer.domElement.addEventListener( 'mouseup', onMouseUp );\r\n\trenderer.domElement.addEventListener( 'mousedown', onMouseDown );\r\n\r\n\t// gui\r\n\tconst gui = new GUI();\r\n\tgui.add( params, 'model', Object.keys( MODEL_LIST ).sort() ).onChange( async ( v ) => {\r\n\t\tawait loadAndSetModel( v );\r\n\t} );\r\n\tconst ptFolder = gui.addFolder( 'Path Tracer' );\r\n\tptFolder.add( params, 'tiles', 1, 4, 1 ).onChange( value => {\r\n\r\n\t\tpathTracer.tiles.set( value, value );\r\n\r\n\t} );\r\n\tptFolder.add( params, 'bounces', 1, 30, 1 ).onChange( onParamsChange );\r\n\tptFolder.add( params, 'renderScale', 0.1, 1 ).onChange( onParamsChange );\r\n\r\n\tconst cameraFolder = gui.addFolder( 'Camera' );\r\n\tcameraFolder.add( camera, 'focusDistance', 1, 100 ).onChange( onParamsChange ).listen();\r\n\tcameraFolder.add( camera, 'apertureBlades', 0, 10, 1 ).onChange( function ( v ) {\r\n\r\n\t\tcamera.apertureBlades = v === 0 ? 0 : Math.max( v, 3 );\r\n\t\tthis.updateDisplay();\r\n\t\tonParamsChange();\r\n\r\n\r\n\t} );\r\n\tcameraFolder.add( camera, 'apertureRotation', 0, 12.5 ).onChange( onParamsChange );\r\n\tcameraFolder.add( camera, 'anamorphicRatio', 0.1, 10.0 ).onChange( onParamsChange );\r\n\tcameraFolder.add( camera, 'bokehSize', 0, 100 ).onChange( onParamsChange ).listen();\r\n\tcameraFolder.add( camera, 'fStop', 0.02, 20 ).onChange( onParamsChange ).listen();\r\n\tcameraFolder.add( camera, 'fov', 25, 100 ).onChange( () => {\r\n\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tpathTracer.updateCamera();\r\n\r\n\t} ).listen();\r\n\tcameraFolder.add( params, 'autoFocus' );\r\n\r\n\tanimate();\r\n\r\n}\r\n\r\n// mouse events for focusing on clicked poin\r\nfunction onMouseDown( e ) {\r\n\r\n\tmouse.set( e.clientX, e.clientY );\r\n\r\n}\r\n\r\nfunction onMouseUp( e ) {\r\n\r\n\tconst deltaMouse = Math.abs( mouse.x - e.clientX ) + Math.abs( mouse.y - e.clientY );\r\n\tif ( deltaMouse < 2 && bvh ) {\r\n\r\n\t\tconst raycaster = new Raycaster();\r\n\t\traycaster.setFromCamera( {\r\n\r\n\t\t\tx: ( e.clientX / window.innerWidth ) * 2 - 1,\r\n\t\t\ty: - ( e.clientY / window.innerHeight ) * 2 + 1,\r\n\r\n\t\t}, camera );\r\n\r\n\t\tconst hit = bvh.raycastFirst( raycaster.ray );\r\n\t\tif ( hit ) {\r\n\r\n\t\t\tfocusPoint.copy( hit.point );\r\n\t\t\tcamera.focusDistance = hit.distance - camera.near;\r\n\t\t\tpathTracer.updateCamera();\r\n\r\n\t\t}\r\n\r\n\t}\r\n\r\n}\r\n\r\nfunction onResize() {\r\n\r\n\trenderer.setSize( window.innerWidth, window.innerHeight );\r\n\trenderer.setPixelRatio( window.devicePixelRatio );\r\n\tcamera.aspect = window.innerWidth / window.innerHeight;\r\n\tcamera.updateProjectionMatrix();\r\n\r\n\tpathTracer.updateCamera();\r\n\r\n}\r\n\r\nfunction onParamsChange() {\r\n\r\n\tpathTracer.filterGlossyFactor = params.filterGlossyFactor;\r\n\tpathTracer.bounces = params.bounces;\r\n\tpathTracer.renderScale = params.renderScale;\r\n\r\n\tpathTracer.updateCamera();\r\n\tpathTracer.reset();\r\n\r\n}\r\n\r\nfunction animate() {\r\n\r\n\trequestAnimationFrame( animate );\r\n\r\n\tpathTracer.renderSample();\r\n\r\n\tloader.setSamples( pathTracer.samples, pathTracer.isCompiling );\r\n\r\n}\r\n"],"names":["ENV_URL","DESCRIPTION","pathTracer","renderer","controls","camera","scene","bvh","loader","currentModel","mouse","Vector2","focusPoint","Vector3","params","DEFAULT_MODEL_KEY","getScaledSettings","init","loadAndSetModel","modelKey","entry","MODEL_LIST","dracoLoader","DRACOLoader","gltf","GLTFLoader","MeshoptDecoder","model","results","v","onParamsChange","LoaderElement","WebGLRenderer","ACESFilmicToneMapping","WebGLPathTracer","ParallelMeshBVHWorker","PhysicalCamera","gradientMap","GradientEquirectTexture","Scene","OrbitControls","envTexture","HDRLoader","generator","BlurredEnvMapGenerator","blurredTex","geometry","SphereGeometry","mat","MeshStandardMaterial","i","m","Mesh","onResize","onMouseUp","onMouseDown","gui","GUI","ptFolder","value","cameraFolder","animate","e","raycaster","Raycaster","hit"],"mappings":"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"}