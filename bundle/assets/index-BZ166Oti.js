import{n as Va,x as Ot,L as un,p as Ka,g as Ya,t as Ne,s as De,Z as pn,aw as En,T as Ja,C as it,a6 as ze,a9 as mn,aW as Xa,aX as hn,l as mt,h as Re,V as Cn,c as Mn,ah as Za,a5 as fn,a7 as An,aY as Qa,S as eo,q as to,r as no,a4 as At,Q as ao,ae as gn,ag as oo,j as so,aZ as Ye,aa as ro,Y as bn,$ as io,d as Nn,a1 as lo,a0 as co,a8 as uo,G as ht,K as yn,aS as po,a_ as mo,aE as ho,au as fo,av as Rn,aG as go,b as In,E as Gt,o as st,B as bo,aj as yo,aF as wo,aI as ko,f as vo,aJ as xo,a as _o,R as So,F as To,ad as Pn,a$ as Eo,az as Co}from"./MaterialBase-D0apYRZI.js";import{M as Mo}from"./meshopt_decoder.module-j6OW_3Rk.js";import{H as Ln}from"./HDRLoader-QyionP9_.js";import{G as Ao}from"./GLTFLoader-CZoURFu4.js";import{D as No}from"./DRACOLoader-Y9SiWgF2.js";import{L as Ro,a as Io}from"./LDrawUtils-H_yeDVKr.js";import{g as Po}from"./lil-gui.module.min-BH_YJbPT.js";import{S as Lo}from"./stats.module--VATS4Kh.js";import{g as $o}from"./__vite-browser-external-HRF1ghZK.js";import{M as Fo}from"./modelList-BunZDs6G.js";import{O as Bo}from"./OrbitControls-QPbjf6RX.js";import{g as Oo}from"./getScaledSettings-nzgggDDj.js";import{L as Go}from"./LoaderElement-DklLdAaa.js";import{G as Do}from"./GenerateMeshBVHWorker-CSNZTU94.js";import{W as jo,G as wn}from"./WebGLPathTracer-BkY-ibNS.js";import{P as Ho}from"./PathTracingRenderer-CqRsglCw.js";class kn extends Va{constructor(r){super(r)}parse(r){function g(S){switch(S.image_type){case w:case C:if(S.colormap_length>256||S.colormap_size!==24||S.colormap_type!==1)throw new Error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case b:case _:case K:case le:if(S.colormap_type)throw new Error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case v:throw new Error("THREE.TGALoader: No data.");default:throw new Error("THREE.TGALoader: Invalid type "+S.image_type)}if(S.width<=0||S.height<=0)throw new Error("THREE.TGALoader: Invalid image size.");if(S.pixel_size!==8&&S.pixel_size!==16&&S.pixel_size!==24&&S.pixel_size!==32)throw new Error("THREE.TGALoader: Invalid pixel size "+S.pixel_size)}function i(S,te,q,ae,he){let Q,re;const U=q.pixel_size>>3,j=q.width*q.height*U;if(te&&(re=he.subarray(ae,ae+=q.colormap_length*(q.colormap_size>>3))),S){Q=new Uint8Array(j);let B,M,G,ce=0;const Ee=new Uint8Array(U);for(;ce<j;)if(B=he[ae++],M=(B&127)+1,B&128){for(G=0;G<U;++G)Ee[G]=he[ae++];for(G=0;G<M;++G)Q.set(Ee,ce+G*U);ce+=U*M}else{for(M*=U,G=0;G<M;++G)Q[ce+G]=he[ae++];ce+=M}}else Q=he.subarray(ae,ae+=te?q.width*q.height:j);return{pixel_data:Q,palettes:re}}function p(S,te,q,ae,he,Q,re,U,j){const B=j;let M,G=0,ce,Ee;const et=se.width;for(Ee=te;Ee!==ae;Ee+=q)for(ce=he;ce!==re;ce+=Q,G++)M=U[G],S[(ce+et*Ee)*4+3]=255,S[(ce+et*Ee)*4+2]=B[M*3+0],S[(ce+et*Ee)*4+1]=B[M*3+1],S[(ce+et*Ee)*4+0]=B[M*3+2];return S}function l(S,te,q,ae,he,Q,re,U){let j,B=0,M,G;const ce=se.width;for(G=te;G!==ae;G+=q)for(M=he;M!==re;M+=Q,B+=2)j=U[B+0]+(U[B+1]<<8),S[(M+ce*G)*4+0]=(j&31744)>>7,S[(M+ce*G)*4+1]=(j&992)>>2,S[(M+ce*G)*4+2]=(j&31)<<3,S[(M+ce*G)*4+3]=j&32768?0:255;return S}function d(S,te,q,ae,he,Q,re,U){let j=0,B,M;const G=se.width;for(M=te;M!==ae;M+=q)for(B=he;B!==re;B+=Q,j+=3)S[(B+G*M)*4+3]=255,S[(B+G*M)*4+2]=U[j+0],S[(B+G*M)*4+1]=U[j+1],S[(B+G*M)*4+0]=U[j+2];return S}function f(S,te,q,ae,he,Q,re,U){let j=0,B,M;const G=se.width;for(M=te;M!==ae;M+=q)for(B=he;B!==re;B+=Q,j+=4)S[(B+G*M)*4+2]=U[j+0],S[(B+G*M)*4+1]=U[j+1],S[(B+G*M)*4+0]=U[j+2],S[(B+G*M)*4+3]=U[j+3];return S}function k(S,te,q,ae,he,Q,re,U){let j,B=0,M,G;const ce=se.width;for(G=te;G!==ae;G+=q)for(M=he;M!==re;M+=Q,B++)j=U[B],S[(M+ce*G)*4+0]=j,S[(M+ce*G)*4+1]=j,S[(M+ce*G)*4+2]=j,S[(M+ce*G)*4+3]=255;return S}function $(S,te,q,ae,he,Q,re,U){let j=0,B,M;const G=se.width;for(M=te;M!==ae;M+=q)for(B=he;B!==re;B+=Q,j+=2)S[(B+G*M)*4+0]=U[j+0],S[(B+G*M)*4+1]=U[j+0],S[(B+G*M)*4+2]=U[j+0],S[(B+G*M)*4+3]=U[j+1];return S}function m(S,te,q,ae,he){let Q,re,U,j,B,M;switch((se.flags&we)>>_e){default:case Ke:Q=0,U=1,B=te,re=0,j=1,M=q;break;case Be:Q=0,U=1,B=te,re=q-1,j=-1,M=-1;break;case be:Q=te-1,U=-1,B=-1,re=0,j=1,M=q;break;case Le:Q=te-1,U=-1,B=-1,re=q-1,j=-1,M=-1;break}if(Y)switch(se.pixel_size){case 8:k(S,re,j,M,Q,U,B,ae);break;case 16:$(S,re,j,M,Q,U,B,ae);break;default:throw new Error("THREE.TGALoader: Format not supported.")}else switch(se.pixel_size){case 8:p(S,re,j,M,Q,U,B,ae,he);break;case 16:l(S,re,j,M,Q,U,B,ae);break;case 24:d(S,re,j,M,Q,U,B,ae);break;case 32:f(S,re,j,M,Q,U,B,ae);break;default:throw new Error("THREE.TGALoader: Format not supported.")}return S}const v=0,w=1,b=2,_=3,C=9,K=10,le=11,we=48,_e=4,Be=0,Le=1,Ke=2,be=3;if(r.length<19)throw new Error("THREE.TGALoader: Not enough data to contain header.");let O=0;const H=new Uint8Array(r),se={id_length:H[O++],colormap_type:H[O++],image_type:H[O++],colormap_index:H[O++]|H[O++]<<8,colormap_length:H[O++]|H[O++]<<8,colormap_size:H[O++],origin:[H[O++]|H[O++]<<8,H[O++]|H[O++]<<8],width:H[O++]|H[O++]<<8,height:H[O++]|H[O++]<<8,pixel_size:H[O++],flags:H[O++]};if(g(se),se.id_length+O>r.length)throw new Error("THREE.TGALoader: No data.");O+=se.id_length;let ee=!1,Oe=!1,Y=!1;switch(se.image_type){case C:ee=!0,Oe=!0;break;case w:Oe=!0;break;case K:ee=!0;break;case b:break;case le:ee=!0,Y=!0;break;case _:Y=!0;break}const $e=new Uint8Array(se.width*se.height*4),Z=i(ee,Oe,se,O,H);return m($e,se.width,se.height,Z.pixel_data,Z.palettes),{data:$e,width:se.width,height:se.height,flipY:!0,generateMipmaps:!0,minFilter:Ot}}}class zo extends un{load(r,g,i,p){const l=this,d=l.path===""?Ka.extractUrlBase(r):l.path,f=new Ya(l.manager);f.setPath(l.path),f.setRequestHeader(l.requestHeader),f.setWithCredentials(l.withCredentials),f.load(r,function(k){try{g(l.parse(k,d))}catch($){p?p($):console.error($),l.manager.itemError(r)}},i,p)}parse(r,g){function i(t,e){const a=[],n=t.childNodes;for(let o=0,u=n.length;o<u;o++){const h=n[o];h.nodeName===e&&a.push(h)}return a}function p(t){if(t.length===0)return[];const e=t.trim().split(/\s+/),a=new Array(e.length);for(let n=0,o=e.length;n<o;n++)a[n]=e[n];return a}function l(t){if(t.length===0)return[];const e=t.trim().split(/\s+/),a=new Array(e.length);for(let n=0,o=e.length;n<o;n++)a[n]=parseFloat(e[n]);return a}function d(t){if(t.length===0)return[];const e=t.trim().split(/\s+/),a=new Array(e.length);for(let n=0,o=e.length;n<o;n++)a[n]=parseInt(e[n]);return a}function f(t){return t.substring(1)}function k(){return"three_default_"+Wa++}function $(t){return Object.keys(t).length===0}function m(t){return{unit:v(i(t,"unit")[0]),upAxis:w(i(t,"up_axis")[0])}}function v(t){return t!==void 0&&t.hasAttribute("meter")===!0?parseFloat(t.getAttribute("meter")):1}function w(t){return t!==void 0?t.textContent:"Y_UP"}function b(t,e,a,n){const o=i(t,e)[0];if(o!==void 0){const u=i(o,a);for(let h=0;h<u.length;h++)n(u[h])}}function _(t,e){for(const a in t){const n=t[a];n.build=e(t[a])}}function C(t,e){return t.build!==void 0||(t.build=e(t)),t.build}function K(t){const e={sources:{},samplers:{},channels:{}};let a=!1;for(let n=0,o=t.childNodes.length;n<o;n++){const u=t.childNodes[n];if(u.nodeType!==1)continue;let h;switch(u.nodeName){case"source":h=u.getAttribute("id"),e.sources[h]=St(u);break;case"sampler":h=u.getAttribute("id"),e.samplers[h]=le(u);break;case"channel":h=u.getAttribute("target"),e.channels[h]=we(u);break;case"animation":K(u),a=!0;break;default:console.log(u)}}a===!1&&(D.animations[t.getAttribute("id")||ze.generateUUID()]=e)}function le(t){const e={inputs:{}};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"input":const u=f(o.getAttribute("source")),h=o.getAttribute("semantic");e.inputs[h]=u;break}}return e}function we(t){const e={};let n=t.getAttribute("target").split("/");const o=n.shift();let u=n.shift();const h=u.indexOf("(")!==-1,E=u.indexOf(".")!==-1;if(E)n=u.split("."),u=n.shift(),e.member=n.shift();else if(h){const x=u.split("(");u=x.shift();for(let T=0;T<x.length;T++)x[T]=parseInt(x[T].replace(/\)/,""));e.indices=x}return e.id=o,e.sid=u,e.arraySyntax=h,e.memberSyntax=E,e.sampler=f(t.getAttribute("source")),e}function _e(t){const e=[],a=t.channels,n=t.samplers,o=t.sources;for(const u in a)if(a.hasOwnProperty(u)){const h=a[u],E=n[h.sampler],x=E.inputs.INPUT,T=E.inputs.OUTPUT,I=o[x],y=o[T],R=Le(h,I,y);se(R,e)}return e}function Be(t){return C(D.animations[t],_e)}function Le(t,e,a){const n=D.nodes[t.id],o=nt(n.id),u=n.transforms[t.sid],h=n.matrix.clone().transpose();let E,x,T,I,y,R;const A={};switch(u){case"matrix":for(T=0,I=e.array.length;T<I;T++)if(E=e.array[T],x=T*a.stride,A[E]===void 0&&(A[E]={}),t.arraySyntax===!0){const ue=a.array[x],ne=t.indices[0]+4*t.indices[1];A[E][ne]=ue}else for(y=0,R=a.stride;y<R;y++)A[E][y]=a.array[x+y];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',u);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',u);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',u);break}const F=Ke(A,h);return{name:o.uuid,keyframes:F}}function Ke(t,e){const a=[];for(const o in t)a.push({time:parseFloat(o),value:t[o]});a.sort(n);for(let o=0;o<16;o++)ee(a,o,e.elements[o]);return a;function n(o,u){return o.time-u.time}}const be=new Ne,O=new Ne,H=new ao;function se(t,e){const a=t.keyframes,n=t.name,o=[],u=[],h=[],E=[];for(let x=0,T=a.length;x<T;x++){const I=a[x],y=I.time,R=I.value;Se.fromArray(R).transpose(),Se.decompose(be,H,O),o.push(y),u.push(be.x,be.y,be.z),h.push(H.x,H.y,H.z,H.w),E.push(O.x,O.y,O.z)}return u.length>0&&e.push(new gn(n+".position",o,u)),h.length>0&&e.push(new oo(n+".quaternion",o,h)),E.length>0&&e.push(new gn(n+".scale",o,E)),e}function ee(t,e,a){let n,o=!0,u,h;for(u=0,h=t.length;u<h;u++)n=t[u],n.value[e]===void 0?n.value[e]=null:o=!1;if(o===!0)for(u=0,h=t.length;u<h;u++)n=t[u],n.value[e]=a;else Oe(t,e)}function Oe(t,e){let a,n;for(let o=0,u=t.length;o<u;o++){const h=t[o];if(h.value[e]===null){if(a=Y(t,o,e),n=$e(t,o,e),a===null){h.value[e]=n.value[e];continue}if(n===null){h.value[e]=a.value[e];continue}Z(h,a,n,e)}}}function Y(t,e,a){for(;e>=0;){const n=t[e];if(n.value[a]!==null)return n;e--}return null}function $e(t,e,a){for(;e<t.length;){const n=t[e];if(n.value[a]!==null)return n;e++}return null}function Z(t,e,a,n){if(a.time-e.time===0){t.value[n]=e.value[n];return}t.value[n]=(t.time-e.time)*(a.value[n]-e.value[n])/(a.time-e.time)+e.value[n]}function S(t){const e={name:t.getAttribute("id")||"default",start:parseFloat(t.getAttribute("start")||0),end:parseFloat(t.getAttribute("end")||0),animations:[]};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"instance_animation":e.animations.push(f(o.getAttribute("url")));break}}D.clips[t.getAttribute("id")]=e}function te(t){const e=[],a=t.name,n=t.end-t.start||-1,o=t.animations;for(let u=0,h=o.length;u<h;u++){const E=Be(o[u]);for(let x=0,T=E.length;x<T;x++)e.push(E[x])}return new mn(a,n,e)}function q(t){return C(D.clips[t],te)}function ae(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"skin":e.id=f(o.getAttribute("source")),e.skin=he(o);break;case"morph":e.id=f(o.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}D.controllers[t.getAttribute("id")]=e}function he(t){const e={sources:{}};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"bind_shape_matrix":e.bindShapeMatrix=l(o.textContent);break;case"source":const u=o.getAttribute("id");e.sources[u]=St(o);break;case"joints":e.joints=Q(o);break;case"vertex_weights":e.vertexWeights=re(o);break}}return e}function Q(t){const e={inputs:{}};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"input":const u=o.getAttribute("semantic"),h=f(o.getAttribute("source"));e.inputs[u]=h;break}}return e}function re(t){const e={inputs:{}};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"input":const u=o.getAttribute("semantic"),h=f(o.getAttribute("source")),E=parseInt(o.getAttribute("offset"));e.inputs[u]={id:h,offset:E};break;case"vcount":e.vcount=d(o.textContent);break;case"v":e.v=d(o.textContent);break}}return e}function U(t){const e={id:t.id},a=D.geometries[e.id];return t.skin!==void 0&&(e.skin=j(t.skin),a.sources.skinIndices=e.skin.indices,a.sources.skinWeights=e.skin.weights),e}function j(t){const a={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},n=t.sources,o=t.vertexWeights,u=o.vcount,h=o.v,E=o.inputs.JOINT.offset,x=o.inputs.WEIGHT.offset,T=t.sources[t.joints.inputs.JOINT],I=t.sources[t.joints.inputs.INV_BIND_MATRIX],y=n[o.inputs.WEIGHT.id].array;let R=0,A,F,L;for(A=0,L=u.length;A<L;A++){const ne=u[A],J=[];for(F=0;F<ne;F++){const X=h[R+E],Ge=h[R+x],ve=y[Ge];J.push({index:X,weight:ve}),R+=2}for(J.sort(ue),F=0;F<4;F++){const X=J[F];X!==void 0?(a.indices.array.push(X.index),a.weights.array.push(X.weight)):(a.indices.array.push(0),a.weights.array.push(0))}}for(t.bindShapeMatrix?a.bindMatrix=new De().fromArray(t.bindShapeMatrix).transpose():a.bindMatrix=new De().identity(),A=0,L=T.array.length;A<L;A++){const ne=T.array[A],J=new De().fromArray(I.array,A*I.stride).transpose();a.joints.push({name:ne,boneInverse:J})}return a;function ue(ne,J){return J.weight-ne.weight}}function B(t){return C(D.controllers[t],U)}function M(t){const e={init_from:i(t,"init_from")[0].textContent};D.images[t.getAttribute("id")]=e}function G(t){return t.build!==void 0?t.build:t.init_from}function ce(t){const e=D.images[t];return e!==void 0?C(e,G):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",t),null)}function Ee(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"profile_COMMON":e.profile=et(o);break}}D.effects[t.getAttribute("id")]=e}function et(t){const e={surfaces:{},samplers:{}};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"newparam":Wn(o,e);break;case"technique":e.technique=Kn(o);break;case"extra":e.extra=zt(o);break}}return e}function Wn(t,e){const a=t.getAttribute("sid");for(let n=0,o=t.childNodes.length;n<o;n++){const u=t.childNodes[n];if(u.nodeType===1)switch(u.nodeName){case"surface":e.surfaces[a]=qn(u);break;case"sampler2D":e.samplers[a]=Vn(u);break}}}function qn(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"init_from":e.init_from=o.textContent;break}}return e}function Vn(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"source":e.source=o.textContent;break}}return e}function Kn(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"constant":case"lambert":case"blinn":case"phong":e.type=o.nodeName,e.parameters=Yn(o);break;case"extra":e.extra=zt(o);break}}return e}function Yn(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":e[o.nodeName]=jt(o);break;case"transparent":e[o.nodeName]={opaque:o.hasAttribute("opaque")?o.getAttribute("opaque"):"A_ONE",data:jt(o)};break}}return e}function jt(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"color":e[o.nodeName]=l(o.textContent);break;case"float":e[o.nodeName]=parseFloat(o.textContent);break;case"texture":e[o.nodeName]={id:o.getAttribute("texture"),extra:Ht(o)};break}}return e}function Ht(t){const e={technique:{}};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"extra":Jn(o,e);break}}return e}function Jn(t,e){for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"technique":Xn(o,e);break}}}function Xn(t,e){for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":e.technique[o.nodeName]=parseFloat(o.textContent);break;case"wrapU":case"wrapV":o.textContent.toUpperCase()==="TRUE"?e.technique[o.nodeName]=1:o.textContent.toUpperCase()==="FALSE"?e.technique[o.nodeName]=0:e.technique[o.nodeName]=parseInt(o.textContent);break;case"bump":e[o.nodeName]=Ut(o);break}}}function zt(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"technique":e.technique=Zn(o);break}}return e}function Zn(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"double_sided":e[o.nodeName]=parseInt(o.textContent);break;case"bump":e[o.nodeName]=Ut(o);break}}return e}function Ut(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"texture":e[o.nodeName]={id:o.getAttribute("texture"),texcoord:o.getAttribute("texcoord"),extra:Ht(o)};break}}return e}function Wt(t){return t}function Qn(t){return C(D.effects[t],Wt)}function ea(t){const e={name:t.getAttribute("name")};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"instance_effect":e.url=f(o.getAttribute("url"));break}}D.materials[t.getAttribute("id")]=e}function ta(t){let e,a=t.slice((t.lastIndexOf(".")-1>>>0)+2);switch(a=a.toLowerCase(),a){case"tga":e=Ct;break;default:e=ln}return e}function qt(t){const e=Qn(t.url),a=e.profile.technique;let n;switch(a.type){case"phong":case"blinn":n=new hn;break;case"lambert":n=new Xa;break;default:n=new pn;break}n.name=t.name||"";function o(x,T=null){const I=e.profile.samplers[x.id];let y=null;if(I!==void 0){const R=e.profile.surfaces[I.source];y=ce(R.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),y=ce(x.id);if(y!==null){const R=ta(y);if(R!==void 0){const A=R.load(y),F=x.extra;if(F!==void 0&&F.technique!==void 0&&$(F.technique)===!1){const L=F.technique;A.wrapS=L.wrapU?ht:yn,A.wrapT=L.wrapV?ht:yn,A.offset.set(L.offsetU||0,L.offsetV||0),A.repeat.set(L.repeatU||1,L.repeatV||1)}else A.wrapS=ht,A.wrapT=ht;return T!==null&&(A.colorSpace=T),A}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",y),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",x.id),null}const u=a.parameters;for(const x in u){const T=u[x];switch(x){case"diffuse":T.color&&n.color.fromArray(T.color),T.texture&&(n.map=o(T.texture,Re));break;case"specular":T.color&&n.specular&&n.specular.fromArray(T.color),T.texture&&(n.specularMap=o(T.texture));break;case"bump":T.texture&&(n.normalMap=o(T.texture));break;case"ambient":T.texture&&(n.lightMap=o(T.texture,Re));break;case"shininess":T.float&&n.shininess&&(n.shininess=T.float);break;case"emission":T.color&&n.emissive&&n.emissive.fromArray(T.color),T.texture&&(n.emissiveMap=o(T.texture,Re));break}}mt.colorSpaceToWorking(n.color,Re),n.specular&&mt.colorSpaceToWorking(n.specular,Re),n.emissive&&mt.colorSpaceToWorking(n.emissive,Re);let h=u.transparent,E=u.transparency;if(E===void 0&&h&&(E={float:1}),h===void 0&&E&&(h={opaque:"A_ONE",data:{color:[1,1,1,1]}}),h&&E)if(h.data.texture)n.transparent=!0;else{const x=h.data.color;switch(h.opaque){case"A_ONE":n.opacity=x[3]*E.float;break;case"RGB_ZERO":n.opacity=1-x[0]*E.float;break;case"A_ZERO":n.opacity=1-x[3]*E.float;break;case"RGB_ONE":n.opacity=x[0]*E.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',h.opaque)}n.opacity<1&&(n.transparent=!0)}if(a.extra!==void 0&&a.extra.technique!==void 0){const x=a.extra.technique;for(const T in x){const I=x[T];switch(T){case"double_sided":n.side=I===1?Mn:Za;break;case"bump":n.normalMap=o(I.texture),n.normalScale=new Cn(1,1);break}}}return n}function na(t){return C(D.materials[t],qt)}function aa(t){const e={name:t.getAttribute("name")};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"optics":e.optics=oa(o);break}}D.cameras[t.getAttribute("id")]=e}function oa(t){for(let e=0;e<t.childNodes.length;e++){const a=t.childNodes[e];switch(a.nodeName){case"technique_common":return sa(a)}}return{}}function sa(t){const e={};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];switch(n.nodeName){case"perspective":case"orthographic":e.technique=n.nodeName,e.parameters=ra(n);break}}return e}function ra(t){const e={};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];switch(n.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":e[n.nodeName]=parseFloat(n.textContent);break}}return e}function Vt(t){let e;switch(t.optics.technique){case"perspective":e=new fn(t.optics.parameters.yfov,t.optics.parameters.aspect_ratio,t.optics.parameters.znear,t.optics.parameters.zfar);break;case"orthographic":let a=t.optics.parameters.ymag,n=t.optics.parameters.xmag;const o=t.optics.parameters.aspect_ratio;n=n===void 0?a*o:n,a=a===void 0?n/o:a,n*=.5,a*=.5,e=new An(-n,n,a,-a,t.optics.parameters.znear,t.optics.parameters.zfar);break;default:e=new fn;break}return e.name=t.name||"",e}function ia(t){const e=D.cameras[t];return e!==void 0?C(e,Vt):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",t),null)}function la(t){let e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"technique_common":e=ca(o);break}}D.lights[t.getAttribute("id")]=e}function ca(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"directional":case"point":case"spot":case"ambient":e.technique=o.nodeName,e.parameters=da(o)}}return e}function da(t){const e={};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"color":const u=l(o.textContent);e.color=new it().fromArray(u),mt.colorSpaceToWorking(e.color,Re);break;case"falloff_angle":e.falloffAngle=parseFloat(o.textContent);break;case"quadratic_attenuation":const h=parseFloat(o.textContent);e.distance=h?Math.sqrt(1/h):0;break}}return e}function Kt(t){let e;switch(t.technique){case"directional":e=new no;break;case"point":e=new to;break;case"spot":e=new eo;break;case"ambient":e=new Qa;break}return t.parameters.color&&e.color.copy(t.parameters.color),t.parameters.distance&&(e.distance=t.parameters.distance),e}function ua(t){const e=D.lights[t];return e!==void 0?C(e,Kt):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",t),null)}function pa(t){const e={name:t.getAttribute("name"),sources:{},vertices:{},primitives:[]},a=i(t,"mesh")[0];if(a!==void 0){for(let n=0;n<a.childNodes.length;n++){const o=a.childNodes[n];if(o.nodeType!==1)continue;const u=o.getAttribute("id");switch(o.nodeName){case"source":e.sources[u]=St(o);break;case"vertices":e.vertices=ma(o);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",o.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":e.primitives.push(ha(o));break;default:console.log(o)}}D.geometries[t.getAttribute("id")]=e}}function St(t){const e={array:[],stride:3};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"float_array":e.array=l(n.textContent);break;case"Name_array":e.array=p(n.textContent);break;case"technique_common":const o=i(n,"accessor")[0];o!==void 0&&(e.stride=parseInt(o.getAttribute("stride")));break}}return e}function ma(t){const e={};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];n.nodeType===1&&(e[n.getAttribute("semantic")]=f(n.getAttribute("source")))}return e}function ha(t){const e={type:t.nodeName,material:t.getAttribute("material"),count:parseInt(t.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let a=0,n=t.childNodes.length;a<n;a++){const o=t.childNodes[a];if(o.nodeType===1)switch(o.nodeName){case"input":const u=f(o.getAttribute("source")),h=o.getAttribute("semantic"),E=parseInt(o.getAttribute("offset")),x=parseInt(o.getAttribute("set")),T=x>0?h+x:h;e.inputs[T]={id:u,offset:E},e.stride=Math.max(e.stride,E+1),h==="TEXCOORD"&&(e.hasUV=!0);break;case"vcount":e.vcount=d(o.textContent);break;case"p":e.p=d(o.textContent);break}}return e}function fa(t){const e={};for(let a=0;a<t.length;a++){const n=t[a];e[n.type]===void 0&&(e[n.type]=[]),e[n.type].push(n)}return e}function ga(t){let e=0;for(let a=0,n=t.length;a<n;a++)t[a].hasUV===!0&&e++;e>0&&e<t.length&&(t.uvsNeedsFix=!0)}function Yt(t){const e={},a=t.sources,n=t.vertices,o=t.primitives;if(o.length===0)return{};const u=fa(o);for(const h in u){const E=u[h];ga(E),e[h]=ba(E,a,n)}return e}function ba(t,e,a){const n={},o={array:[],stride:0},u={array:[],stride:0},h={array:[],stride:0},E={array:[],stride:0},x={array:[],stride:0},T={array:[],stride:4},I={array:[],stride:4},y=new so,R=[];let A=0;for(let F=0;F<t.length;F++){const L=t[F],ue=L.inputs;let ne=0;switch(L.type){case"lines":case"linestrips":ne=L.count*2;break;case"triangles":ne=L.count*3;break;case"polylist":for(let J=0;J<L.count;J++){const X=L.vcount[J];switch(X){case 3:ne+=3;break;case 4:ne+=6;break;default:ne+=(X-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknown primitive type:",L.type)}y.addGroup(A,ne,F),A+=ne,L.material&&R.push(L.material);for(const J in ue){const X=ue[J];switch(J){case"VERTEX":for(const Ge in a){const ve=a[Ge];switch(Ge){case"POSITION":const at=o.array.length;if(Ae(L,e[ve],X.offset,o.array),o.stride=e[ve].stride,e.skinWeights&&e.skinIndices&&(Ae(L,e.skinIndices,X.offset,T.array),Ae(L,e.skinWeights,X.offset,I.array)),L.hasUV===!1&&t.uvsNeedsFix===!0){const qa=(o.array.length-at)/o.stride;for(let dn=0;dn<qa;dn++)h.array.push(0,0)}break;case"NORMAL":Ae(L,e[ve],X.offset,u.array),u.stride=e[ve].stride;break;case"COLOR":Ae(L,e[ve],X.offset,x.array),x.stride=e[ve].stride;break;case"TEXCOORD":Ae(L,e[ve],X.offset,h.array),h.stride=e[ve].stride;break;case"TEXCOORD1":Ae(L,e[ve],X.offset,E.array),h.stride=e[ve].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',Ge)}}break;case"NORMAL":Ae(L,e[X.id],X.offset,u.array),u.stride=e[X.id].stride;break;case"COLOR":Ae(L,e[X.id],X.offset,x.array,!0),x.stride=e[X.id].stride;break;case"TEXCOORD":Ae(L,e[X.id],X.offset,h.array),h.stride=e[X.id].stride;break;case"TEXCOORD1":Ae(L,e[X.id],X.offset,E.array),E.stride=e[X.id].stride;break}}}return o.array.length>0&&y.setAttribute("position",new Ye(o.array,o.stride)),u.array.length>0&&y.setAttribute("normal",new Ye(u.array,u.stride)),x.array.length>0&&y.setAttribute("color",new Ye(x.array,x.stride)),h.array.length>0&&y.setAttribute("uv",new Ye(h.array,h.stride)),E.array.length>0&&y.setAttribute("uv1",new Ye(E.array,E.stride)),T.array.length>0&&y.setAttribute("skinIndex",new Ye(T.array,T.stride)),I.array.length>0&&y.setAttribute("skinWeight",new Ye(I.array,I.stride)),n.data=y,n.type=t[0].type,n.materialKeys=R,n}function Ae(t,e,a,n,o=!1){const u=t.p,h=t.stride,E=t.vcount;function x(y){let R=u[y+a]*I;const A=R+I;for(;R<A;R++)n.push(T[R]);if(o){const F=n.length-I-1;dt.setRGB(n[F+0],n[F+1],n[F+2],Re),n[F+0]=dt.r,n[F+1]=dt.g,n[F+2]=dt.b}}const T=e.array,I=e.stride;if(t.vcount!==void 0){let y=0;for(let R=0,A=E.length;R<A;R++){const F=E[R];if(F===4){const L=y+h*0,ue=y+h*1,ne=y+h*2,J=y+h*3;x(L),x(ue),x(J),x(ue),x(ne),x(J)}else if(F===3){const L=y+h*0,ue=y+h*1,ne=y+h*2;x(L),x(ue),x(ne)}else if(F>4)for(let L=1,ue=F-2;L<=ue;L++){const ne=y+h*0,J=y+h*L,X=y+h*(L+1);x(ne),x(J),x(X)}y+=h*F}}else for(let y=0,R=u.length;y<R;y+=h)x(y)}function Jt(t){return C(D.geometries[t],Yt)}function ya(t){const e={name:t.getAttribute("name")||"",joints:{},links:[]};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"technique_common":va(n,e);break}}D.kinematicsModels[t.getAttribute("id")]=e}function wa(t){return t.build!==void 0?t.build:t}function ka(t){return C(D.kinematicsModels[t],wa)}function va(t,e){for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"joint":e.joints[n.getAttribute("sid")]=xa(n);break;case"link":e.links.push(Xt(n));break}}}function xa(t){let e;for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"prismatic":case"revolute":e=_a(n);break}}return e}function _a(t){const e={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",axis:new Ne,limits:{min:0,max:0},type:t.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"axis":const o=l(n.textContent);e.axis.fromArray(o);break;case"limits":const u=n.getElementsByTagName("max")[0],h=n.getElementsByTagName("min")[0];e.limits.max=parseFloat(u.textContent),e.limits.min=parseFloat(h.textContent);break}}return e.limits.min>=e.limits.max&&(e.static=!0),e.middlePosition=(e.limits.min+e.limits.max)/2,e}function Xt(t){const e={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",attachments:[],transforms:[]};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"attachment_full":e.attachments.push(Sa(n));break;case"matrix":case"translate":case"rotate":e.transforms.push(Zt(n));break}}return e}function Sa(t){const e={joint:t.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"link":e.links.push(Xt(n));break;case"matrix":case"translate":case"rotate":e.transforms.push(Zt(n));break}}return e}function Zt(t){const e={type:t.nodeName},a=l(t.textContent);switch(e.type){case"matrix":e.obj=new De,e.obj.fromArray(a).transpose();break;case"translate":e.obj=new Ne,e.obj.fromArray(a);break;case"rotate":e.obj=new Ne,e.obj.fromArray(a),e.angle=ze.degToRad(a[3]);break}return e}function Ta(t){const e={name:t.getAttribute("name")||"",rigidBodies:{}};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"rigid_body":e.rigidBodies[n.getAttribute("name")]={},Ea(n,e.rigidBodies[n.getAttribute("name")]);break}}D.physicsModels[t.getAttribute("id")]=e}function Ea(t,e){for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"technique_common":Ca(n,e);break}}}function Ca(t,e){for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"inertia":e.inertia=l(n.textContent);break;case"mass":e.mass=l(n.textContent)[0];break}}}function Ma(t){const e={bindJointAxis:[]};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"bind_joint_axis":e.bindJointAxis.push(Aa(n));break}}D.kinematicsScenes[f(t.getAttribute("url"))]=e}function Aa(t){const e={target:t.getAttribute("target").split("/").pop()};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType===1)switch(n.nodeName){case"axis":const o=n.getElementsByTagName("param")[0];e.axis=o.textContent;const u=e.axis.split("inst_").pop().split("axis")[0];e.jointIndex=u.substring(0,u.length-1);break}}return e}function Na(t){return t.build!==void 0?t.build:t}function Ra(t){return C(D.kinematicsScenes[t],Na)}function Ia(){const t=Object.keys(D.kinematicsModels)[0],e=Object.keys(D.kinematicsScenes)[0],a=Object.keys(D.visualScenes)[0];if(t===void 0||e===void 0)return;const n=ka(t),o=Ra(e),u=on(a),h=o.bindJointAxis,E={};for(let I=0,y=h.length;I<y;I++){const R=h[I],A=fe.querySelector('[sid="'+R.target+'"]');if(A){const F=A.parentElement;x(R.jointIndex,F)}}function x(I,y){const R=y.getAttribute("name"),A=n.joints[I];u.traverse(function(F){F.name===R&&(E[I]={object:F,transforms:Pa(y),joint:A,position:A.zeroPosition})})}const T=new De;cn={joints:n&&n.joints,getJointValue:function(I){const y=E[I];if(y)return y.position;console.warn("THREE.ColladaLoader: Joint "+I+" doesn't exist.")},setJointValue:function(I,y){const R=E[I];if(R){const A=R.joint;if(y>A.limits.max||y<A.limits.min)console.warn("THREE.ColladaLoader: Joint "+I+" value "+y+" outside of limits (min: "+A.limits.min+", max: "+A.limits.max+").");else if(A.static)console.warn("THREE.ColladaLoader: Joint "+I+" is static.");else{const F=R.object,L=A.axis,ue=R.transforms;Se.identity();for(let ne=0;ne<ue.length;ne++){const J=ue[ne];if(J.sid&&J.sid.indexOf(I)!==-1)switch(A.type){case"revolute":Se.multiply(T.makeRotationAxis(L,ze.degToRad(y)));break;case"prismatic":Se.multiply(T.makeTranslation(L.x*y,L.y*y,L.z*y));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+A.type);break}else switch(J.type){case"matrix":Se.multiply(J.obj);break;case"translate":Se.multiply(T.makeTranslation(J.obj.x,J.obj.y,J.obj.z));break;case"scale":Se.scale(J.obj);break;case"rotate":Se.multiply(T.makeRotationAxis(J.obj,J.angle));break}}F.matrix.copy(Se),F.matrix.decompose(F.position,F.quaternion,F.scale),E[I].position=y}}else console.log("THREE.ColladaLoader: "+I+" does not exist.")}}}function Pa(t){const e=[],a=fe.querySelector('[id="'+t.id+'"]');for(let n=0;n<a.childNodes.length;n++){const o=a.childNodes[n];if(o.nodeType!==1)continue;let u,h;switch(o.nodeName){case"matrix":u=l(o.textContent);const E=new De().fromArray(u).transpose();e.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:E});break;case"translate":case"scale":u=l(o.textContent),h=new Ne().fromArray(u),e.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:h});break;case"rotate":u=l(o.textContent),h=new Ne().fromArray(u);const x=ze.degToRad(u[3]);e.push({sid:o.getAttribute("sid"),type:o.nodeName,obj:h,angle:x});break}}return e}function La(t){const e=t.getElementsByTagName("node");for(let a=0;a<e.length;a++){const n=e[a];n.hasAttribute("id")===!1&&n.setAttribute("id",k())}}const Se=new De,tt=new Ne;function Tt(t){const e={name:t.getAttribute("name")||"",type:t.getAttribute("type"),id:t.getAttribute("id"),sid:t.getAttribute("sid"),matrix:new De,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];if(n.nodeType!==1)continue;let o;switch(n.nodeName){case"node":e.nodes.push(n.getAttribute("id")),Tt(n);break;case"instance_camera":e.instanceCameras.push(f(n.getAttribute("url")));break;case"instance_controller":e.instanceControllers.push(Qt(n));break;case"instance_light":e.instanceLights.push(f(n.getAttribute("url")));break;case"instance_geometry":e.instanceGeometries.push(Qt(n));break;case"instance_node":e.instanceNodes.push(f(n.getAttribute("url")));break;case"matrix":o=l(n.textContent),e.matrix.multiply(Se.fromArray(o).transpose()),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"translate":o=l(n.textContent),tt.fromArray(o),e.matrix.multiply(Se.makeTranslation(tt.x,tt.y,tt.z)),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"rotate":o=l(n.textContent);const u=ze.degToRad(o[3]);e.matrix.multiply(Se.makeRotationAxis(tt.fromArray(o),u)),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"scale":o=l(n.textContent),e.matrix.scale(tt.fromArray(o)),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"extra":break;default:console.log(n)}}return nn(e.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",e.id):D.nodes[e.id]=e,e}function Qt(t){const e={id:f(t.getAttribute("url")),materials:{},skeletons:[]};for(let a=0;a<t.childNodes.length;a++){const n=t.childNodes[a];switch(n.nodeName){case"bind_material":const o=n.getElementsByTagName("instance_material");for(let u=0;u<o.length;u++){const h=o[u],E=h.getAttribute("symbol"),x=h.getAttribute("target");e.materials[E]=f(x)}break;case"skeleton":e.skeletons.push(f(n.textContent));break}}return e}function $a(t,e){const a=[],n=[];let o,u,h;for(o=0;o<t.length;o++){const T=t[o];let I;if(nn(T))I=nt(T),en(I,e,a);else if(Da(T)){const R=D.visualScenes[T].children;for(let A=0;A<R.length;A++){const F=R[A];if(F.type==="JOINT"){const L=nt(F.id);en(L,e,a)}}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",T)}for(o=0;o<e.length;o++)for(u=0;u<a.length;u++)if(h=a[u],h.bone.name===e[o].name){n[o]=h,h.processed=!0;break}for(o=0;o<a.length;o++)h=a[o],h.processed===!1&&(n.push(h),h.processed=!0);const E=[],x=[];for(o=0;o<n.length;o++)h=n[o],E.push(h.bone),x.push(h.boneInverse);return new uo(E,x)}function en(t,e,a){t.traverse(function(n){if(n.isBone===!0){let o;for(let u=0;u<e.length;u++){const h=e[u];if(h.name===n.name){o=h.boneInverse;break}}o===void 0&&(o=new De),a.push({bone:n,boneInverse:o,processed:!1})}})}function Fa(t){const e=[],a=t.matrix,n=t.nodes,o=t.type,u=t.instanceCameras,h=t.instanceControllers,E=t.instanceLights,x=t.instanceGeometries,T=t.instanceNodes;for(let y=0,R=n.length;y<R;y++)e.push(nt(n[y]));for(let y=0,R=u.length;y<R;y++){const A=ia(u[y]);A!==null&&e.push(A.clone())}for(let y=0,R=h.length;y<R;y++){const A=h[y],F=B(A.id),L=Jt(F.id),ue=tn(L,A.materials),ne=A.skeletons,J=F.skin.joints,X=$a(ne,J);for(let Ge=0,ve=ue.length;Ge<ve;Ge++){const at=ue[Ge];at.isSkinnedMesh&&(at.bind(X,F.skin.bindMatrix),at.normalizeSkinWeights()),e.push(at)}}for(let y=0,R=E.length;y<R;y++){const A=ua(E[y]);A!==null&&e.push(A.clone())}for(let y=0,R=x.length;y<R;y++){const A=x[y],F=Jt(A.id),L=tn(F,A.materials);for(let ue=0,ne=L.length;ue<ne;ue++)e.push(L[ue])}for(let y=0,R=T.length;y<R;y++)e.push(nt(T[y]).clone());let I;if(n.length===0&&e.length===1)I=e[0];else{I=o==="JOINT"?new ro:new At;for(let y=0;y<e.length;y++)I.add(e[y])}return I.name=o==="JOINT"?t.sid:t.name,I.matrix.copy(a),I.matrix.decompose(I.position,I.quaternion,I.scale),I}const Ba=new pn({name:un.DEFAULT_MATERIAL_NAME,color:16711935});function Oa(t,e){const a=[];for(let n=0,o=t.length;n<o;n++){const u=e[t[n]];u===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",t[n]),a.push(Ba)):a.push(na(u))}return a}function tn(t,e){const a=[];for(const n in t){const o=t[n],u=Oa(o.materialKeys,e);if(u.length===0&&(n==="lines"||n==="linestrips"?u.push(new bn):u.push(new hn)),n==="lines"||n==="linestrips")for(let T=0,I=u.length;T<I;T++){const y=u[T];if(y.isMeshPhongMaterial===!0||y.isMeshLambertMaterial===!0){const R=new bn;R.color.copy(y.color),R.opacity=y.opacity,R.transparent=y.transparent,u[T]=R}}const h=o.data.attributes.skinIndex!==void 0,E=u.length===1?u[0]:u;let x;switch(n){case"lines":x=new co(o.data,E);break;case"linestrips":x=new lo(o.data,E);break;case"triangles":case"polylist":h?x=new io(o.data,E):x=new Nn(o.data,E);break}a.push(x)}return a}function nn(t){return D.nodes[t]!==void 0}function nt(t){return C(D.nodes[t],Fa)}function Ga(t){const e={name:t.getAttribute("name"),children:[]};La(t);const a=i(t,"node");for(let n=0;n<a.length;n++)e.children.push(Tt(a[n]));D.visualScenes[t.getAttribute("id")]=e}function an(t){const e=new At;e.name=t.name;const a=t.children;for(let n=0;n<a.length;n++){const o=a[n];e.add(nt(o.id))}return e}function Da(t){return D.visualScenes[t]!==void 0}function on(t){return C(D.visualScenes[t],an)}function ja(t){const e=i(t,"instance_visual_scene")[0];return on(f(e.getAttribute("url")))}function Ha(){const t=D.clips;if($(t)===!0){if($(D.animations)===!1){const e=[];for(const a in D.animations){const n=Be(a);for(let o=0,u=n.length;o<u;o++)e.push(n[o])}ut.push(new mn("default",-1,e))}}else for(const e in t)ut.push(q(e))}function za(t){let e="";const a=[t];for(;a.length;){const n=a.shift();n.nodeType===Node.TEXT_NODE?e+=n.textContent:(e+=`
`,a.push(...n.childNodes))}return e.trim()}if(r.length===0)return{scene:new En};const sn=new DOMParser().parseFromString(r,"application/xml"),fe=i(sn,"COLLADA")[0],Et=sn.getElementsByTagName("parsererror")[0];if(Et!==void 0){const t=i(Et,"div")[0];let e;return t?e=t.textContent:e=za(Et),console.error(`THREE.ColladaLoader: Failed to parse collada file.
`,e),null}const Ua=fe.getAttribute("version");console.debug("THREE.ColladaLoader: File version",Ua);const rn=m(i(fe,"asset")[0]),ln=new Ja(this.manager);ln.setPath(this.resourcePath||g).setCrossOrigin(this.crossOrigin);let Ct;kn&&(Ct=new kn(this.manager),Ct.setPath(this.resourcePath||g));const dt=new it,ut=[];let cn={},Wa=0;const D={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};b(fe,"library_animations","animation",K),b(fe,"library_animation_clips","animation_clip",S),b(fe,"library_controllers","controller",ae),b(fe,"library_images","image",M),b(fe,"library_effects","effect",Ee),b(fe,"library_materials","material",ea),b(fe,"library_cameras","camera",aa),b(fe,"library_lights","light",la),b(fe,"library_geometries","geometry",pa),b(fe,"library_nodes","node",Tt),b(fe,"library_visual_scenes","visual_scene",Ga),b(fe,"library_kinematics_models","kinematics_model",ya),b(fe,"library_physics_models","physics_model",Ta),b(fe,"scene","instance_kinematics_scene",Ma),_(D.animations,_e),_(D.clips,te),_(D.controllers,U),_(D.images,G),_(D.effects,Wt),_(D.materials,qt),_(D.cameras,Vt),_(D.lights,Kt),_(D.geometries,Yt),_(D.visualScenes,an),Ha(),Ia();const pt=ja(i(fe,"scene")[0]);return pt.animations=ut,rn.upAxis==="Z_UP"&&(console.warn("THREE.ColladaLoader: You are loading an asset with a Z-UP coordinate system. The loader just rotates the asset to transform it into Y-UP. The vertex data are not converted, see #24289."),pt.rotation.set(-Math.PI/2,0,0)),pt.scale.multiplyScalar(rn.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),ut},kinematics:cn,library:D,scene:pt}}}class Uo extends po{static get type(){return"LDrawConditionalLineMaterial"}constructor(r){super({uniforms:mo.merge([ho.fog,{diffuse:{value:new it},opacity:{value:1}}]),vertexShader:`
				attribute vec3 control0;
				attribute vec3 control1;
				attribute vec3 direction;
				varying float discardFlag;

				#include <common>
				#include <color_pars_vertex>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>
				void main() {
					#include <color_vertex>

					vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
					gl_Position = projectionMatrix * mvPosition;

					// Transform the line segment ends and control points into camera clip space
					vec4 c0 = projectionMatrix * modelViewMatrix * vec4( control0, 1.0 );
					vec4 c1 = projectionMatrix * modelViewMatrix * vec4( control1, 1.0 );
					vec4 p0 = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
					vec4 p1 = projectionMatrix * modelViewMatrix * vec4( position + direction, 1.0 );

					c0.xy /= c0.w;
					c1.xy /= c1.w;
					p0.xy /= p0.w;
					p1.xy /= p1.w;

					// Get the direction of the segment and an orthogonal vector
					vec2 dir = p1.xy - p0.xy;
					vec2 norm = vec2( -dir.y, dir.x );

					// Get control point directions from the line
					vec2 c0dir = c0.xy - p1.xy;
					vec2 c1dir = c1.xy - p1.xy;

					// If the vectors to the controls points are pointed in different directions away
					// from the line segment then the line should not be drawn.
					float d0 = dot( normalize( norm ), normalize( c0dir ) );
					float d1 = dot( normalize( norm ), normalize( c1dir ) );
					discardFlag = float( sign( d0 ) != sign( d1 ) );

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>
				}
			`,fragmentShader:`
			uniform vec3 diffuse;
			uniform float opacity;
			varying float discardFlag;

			#include <common>
			#include <color_pars_fragment>
			#include <fog_pars_fragment>
			#include <logdepthbuf_pars_fragment>
			#include <clipping_planes_pars_fragment>
			void main() {

				if ( discardFlag > 0.5 ) discard;

				#include <clipping_planes_fragment>
				vec3 outgoingLight = vec3( 0.0 );
				vec4 diffuseColor = vec4( diffuse, opacity );
				#include <logdepthbuf_fragment>
				#include <color_fragment>
				outgoingLight = diffuseColor.rgb; // simple shader
				gl_FragColor = vec4( outgoingLight, diffuseColor.a );
				#include <tonemapping_fragment>
				#include <colorspace_fragment>
				#include <fog_fragment>
				#include <premultiplied_alpha_fragment>
			}
			`}),Object.defineProperties(this,{opacity:{get:function(){return this.uniforms.opacity.value},set:function(g){this.uniforms.opacity.value=g}},color:{get:function(){return this.uniforms.diffuse.value}}}),this.setValues(r),this.isLDrawConditionalLineMaterial=!0}}class Wo{constructor(r,g,i,p){this.pathTracer=r,this.renderer=g,this.scene=i,this.camera=p,this.originalSize={width:0,height:0},this.originalPixelRatio=1,this.originalSettings={tiles:{x:1,y:1},bounces:5,renderScale:1,filterGlossyFactor:.1,multipleImportanceSampling:!0,toneMapping:null},this.isOpen=!1,this.isRendering=!1,this.settings={resolution:"4K",aspectRatio:"16:9",format:"PNG",targetSamples:1e3,backgroundMode:"without",fileName:"render"},this.stopRequested=!1,this.resolutions={"1K":{"16:9":[1920,1080],"1:1":[1920,1920],"4:3":[1920,1440]},"2K":{"16:9":[2560,1440],"1:1":[2560,2560],"4:3":[2560,1920]},"4K":{"16:9":[3840,2160],"1:1":[3840,3840],"4:3":[3840,2880]},"8K":{"16:9":[7680,4320],"1:1":[7680,7680],"4:3":[7680,5760]}};const l=this.renderer.getContext();this.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE),this.maxRenderbufferSize=l.getParameter(l.MAX_RENDERBUFFER_SIZE),this.maxSize=Math.min(this.maxTextureSize,this.maxRenderbufferSize),console.log(`ðŸŽ® GPU Limits: Max Texture Size: ${this.maxTextureSize}, Max Renderbuffer Size: ${this.maxRenderbufferSize}, Using: ${this.maxSize}`),this.createModal(),this.attachEventListeners()}createModal(){document.getElementById("imageRenderModal")||document.body.insertAdjacentHTML("beforeend",`
			<div id="imageRenderModal" class="image-render-modal" style="display: none;">
				<div class="modal-overlay"></div>
				<div class="modal-content">
					<div class="modal-header">
						<h2>Render Image</h2>
						<button class="close-btn" id="closeModalBtn">&times;</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="resolution">Resolution:</label>
							<select id="resolution" class="form-control">
								<option value="1K">1K (1920x1080)</option>
								<option value="2K">2K (2560x1440)</option>
								<option value="4K" selected>4K (3840x2160)</option>
								<option value="8K">8K (7680x4320)</option>
								<!-- 16K removed: Causes WebGL context loss due to memory limits. Max safe: 8K -->
							</select>
						</div>
						<div class="form-group">
							<label for="aspectRatio">Aspect Ratio:</label>
							<select id="aspectRatio" class="form-control">
								<option value="16:9" selected>16:9</option>
								<option value="1:1">1:1</option>
								<option value="4:3">4:3</option>
							</select>
						</div>
						<div class="form-group">
							<label for="format">Format:</label>
							<select id="format" class="form-control">
								<option value="PNG" selected>PNG</option>
								<option value="JPG">JPG</option>
								<option value="PSD">PSD</option>
							</select>
						</div>
						<div class="form-group">
							<label for="samples">
								Target Samples: <span id="samplesValue">1000</span>
							</label>
							<input type="range" id="samples" min="0" max="10000" step="100" value="1000" class="slider">
							<div class="slider-info">
								<span>0 (instant)</span>
								<span>10000 (high quality)</span>
							</div>
						</div>
						<div class="form-group">
							<label for="backgroundMode">Background:</label>
							<select id="backgroundMode" class="form-control">
								<option value="without" selected>Without Background</option>
								<option value="with">With Background</option>
							</select>
						</div>
						<div class="form-group">
							<label for="fileName">File Name:</label>
							<input type="text" id="fileName" value="render" class="form-control">
						</div>
						<div id="renderProgress" class="render-progress" style="display: none;">
							<div class="progress-bar">
								<div class="progress-fill" id="progressFill"></div>
							</div>
							<div class="progress-text" id="progressText">Preparing render...</div>
						</div>
					</div>
					<div class="modal-footer">
						<button id="cancelBtn" class="btn btn-secondary">Cancel</button>
						<button id="stopAndCaptureBtn" class="btn btn-warning" style="display: none;">Stop & capture</button>
						<button id="renderBtn" class="btn btn-primary">Render</button>
					</div>
				</div>
			</div>
		`),this.modal=document.getElementById("imageRenderModal"),this.updateSamplesDisplay()}attachEventListeners(){document.getElementById("closeModalBtn").addEventListener("click",()=>this.close()),document.getElementById("cancelBtn").addEventListener("click",()=>this.close()),this.modal.querySelector(".modal-overlay").addEventListener("click",()=>this.close()),document.getElementById("renderBtn").addEventListener("click",()=>this.handleRender()),document.getElementById("samples").addEventListener("input",r=>{this.settings.targetSamples=parseInt(r.target.value),this.updateSamplesDisplay()}),document.getElementById("stopAndCaptureBtn").addEventListener("click",()=>{this.isRendering&&(this.stopRequested=!0)}),["resolution","aspectRatio","format","backgroundMode","fileName"].forEach(r=>{document.getElementById(r).addEventListener("change",g=>{this.settings[r==="fileName"?"fileName":r]=g.target.value})}),document.addEventListener("keydown",r=>{r.key==="Escape"&&this.isOpen&&this.close()})}updateSamplesDisplay(){const r=this.settings.targetSamples;document.getElementById("samplesValue").textContent=r.toLocaleString(),document.getElementById("samples").value=r}open(){this.onOpen&&this.onOpen(),this.isOpen=!0,this.modal.style.display="flex",document.body.style.overflow="hidden"}close(){if(this.isRendering){if(!confirm("Rendering in progress. Are you sure you want to cancel?"))return;this.cancelRender()}this.isOpen=!1,this.modal.style.display="none",document.body.style.overflow="",this.onClose&&this.onClose()}async handleRender(){if(this.isRendering)return;this.onBeforeRender&&this.onBeforeRender(),this.isRendering=!0,this.stopRequested=!1;const r=document.getElementById("renderBtn"),g=document.getElementById("stopAndCaptureBtn"),i=document.getElementById("renderProgress"),p=document.getElementById("progressFill"),l=document.getElementById("progressText");r.disabled=!0,r.style.display="none",g&&(g.style.display="inline-block"),i.style.display="block";try{const d=this.settings.format.toUpperCase()==="PNG",f=this.settings.backgroundMode==="with",k=window.backgroundImageSrc||null,$=window.backgroundImageNaturalWidth||0,m=window.backgroundImageNaturalHeight||0,v=this.resolutions[this.settings.resolution];let[w,b]=v[this.settings.aspectRatio];if(f&&k&&$>0&&m>0){const Z=$/m,S=w/b;Z>S?b=Math.round(w/Z):w=Math.round(b*Z),console.log(`ðŸŽ¨ [Render] Adjusted to background aspect ratio: ${w}x${b} (image: ${$}x${m})`)}let _=this.scene.background,C=this.renderer.getClearAlpha(),K=!1;d&&!f?(this.scene.background=null,this.renderer.setClearAlpha(0),this.pathTracer.updateEnvironment(),K=!0,console.log("ðŸŽ¨ [Render] PNG without background â€” transparent background auto-enabled")):f&&k&&(this.scene.background=null,this.renderer.setClearAlpha(0),this.pathTracer.updateEnvironment(),K=!0,console.log("ðŸŽ¨ [Render] With background â€” set transparent for compositing"));const le=w,we=b;console.log(`ðŸ“ [Render] Initial resolution: ${w}x${b}, GPU max: ${this.maxSize}`);const _e=w*b,Be=4096*4096,Le=8192*8192;if(_e>Le){const Z=Math.sqrt(Le/_e),S=Math.floor(w*Z),te=Math.floor(b*Z),q=`Resolution ${this.settings.resolution} (${le}x${we}, ${_e.toLocaleString()} pixels) exceeds memory limit (${Le.toLocaleString()} pixels). Maximum safe resolution is 8192x8192. Clamping to ${S}x${te}`;console.error(q),l.textContent=q,alert(q+`

Please select a lower resolution (8K or below).`),w=S,b=te}else if(_e>Be)console.warn(`âš ï¸ High resolution detected: ${w}x${b} (${_e.toLocaleString()} pixels). This may cause performance issues or context loss.`),l.textContent=`Preparing render at ${w}x${b}... (High resolution - may be slow)`;else if(w>this.maxSize||b>this.maxSize){const Z=Math.min(this.maxSize/w,this.maxSize/b),S=Math.floor(w*Z),te=Math.floor(b*Z);console.log(`ðŸ“ [Render] Clamping: scale=${Z.toFixed(4)}, ${w}x${b} -> ${S}x${te}`),w=S,b=te;const q=`âš ï¸ Resolution ${this.settings.resolution} (${le}x${we}) exceeds GPU limit (${this.maxSize}). Clamping to ${w}x${b}`;console.warn(q),l.textContent=q,alert(q+`

Please select a lower resolution.`)}else l.textContent=`Preparing render at ${w}x${b}...`;if(w<=0||b<=0||w>this.maxSize||b>this.maxSize)throw new Error(`Invalid resolution: ${w}x${b}. Maximum supported: ${this.maxSize}x${this.maxSize}`);console.log(`ðŸ“ [Render] Final target resolution: ${w}x${b} (clamped from ${le}x${we})`),this.originalPixelRatio=this.renderer.getPixelRatio(),this.originalSize.width=Math.round(this.renderer.domElement.width/this.originalPixelRatio),this.originalSize.height=Math.round(this.renderer.domElement.height/this.originalPixelRatio),this.originalSettings.tiles.x=this.pathTracer.tiles.x,this.originalSettings.tiles.y=this.pathTracer.tiles.y,this.originalSettings.bounces=this.pathTracer.bounces,this.originalSettings.renderScale=this.pathTracer.renderScale,this.originalSettings.filterGlossyFactor=this.pathTracer.filterGlossyFactor,this.originalSettings.multipleImportanceSampling=this.pathTracer.multipleImportanceSampling,this.originalSettings.toneMapping=this.renderer.toneMapping,this.originalSettings.textureSize=this.pathTracer.textureSize.clone(),this.pathTracer.textureSize.set(4096,4096);const Ke=this.pathTracer.renderScale;this.pathTracer.renderScale=1,console.log(`ðŸ“ [Render] Renderer size: ${w}x${b}, renderScale set to 1.0 for rendering (was ${Ke})`),this.pathTracer.tiles.set(1,1);const be=this.renderer.domElement.width,O=this.renderer.domElement.height;if(console.log(`ðŸ“ [Path Tracer] Current resolution: ${be}x${O}`),console.log(`ðŸ“ [Path Tracer] Target resolution: ${w}x${b}`),be!==w||O!==b){console.log(`ðŸ“ [Path Tracer] Resolution mismatch - resizing from ${be}x${O} to ${w}x${b}`),l.textContent=`Resizing path tracer to ${w}x${b}...`;const Z=this.renderer.getContext();if(Z&&Z.isContextLost&&Z.isContextLost())throw new Error("WebGL context has been lost. Please refresh the page and try again.");if(w>this.maxSize||b>this.maxSize)throw new Error(`Cannot resize renderer to ${w}x${b}. GPU maximum is ${this.maxSize}x${this.maxSize}. This should have been clamped earlier.`);if(this.renderer.setSize(w,b),this.renderer.setPixelRatio(1),Z&&Z.isContextLost&&Z.isContextLost())throw new Error(`WebGL context lost after resizing to ${w}x${b}. Resolution too high for your GPU. Please try a lower resolution.`);if(this.camera.isPerspectiveCamera)this.camera.aspect=w/b,this.camera.updateProjectionMatrix();else if(this.camera.isOrthographicCamera){const S=w/b,q=(this.camera.top-this.camera.bottom)*S;this.camera.left=-q/2,this.camera.right=q/2,this.camera.updateProjectionMatrix()}if(Z&&Z.isContextLost&&Z.isContextLost())throw new Error("WebGL context lost before path tracer resize. Please try a lower resolution.");if(this.pathTracer._pathTracer&&typeof this.pathTracer._pathTracer.setSize=="function"?this.pathTracer._pathTracer.setSize(w,b):typeof this.pathTracer.setSize=="function"?this.pathTracer.setSize(w,b):typeof this.pathTracer.resize=="function"?this.pathTracer.resize(w,b):this.pathTracer.renderer&&typeof this.pathTracer.renderer.setSize=="function"&&this.pathTracer.renderer.setSize(w,b),Z&&Z.isContextLost&&Z.isContextLost())throw new Error(`WebGL context lost after path tracer resize to ${w}x${b}. Resolution too high. Please try a lower resolution (8K or below).`);typeof this.pathTracer.updateEnvironment=="function"&&this.pathTracer.updateEnvironment(),typeof this.pathTracer.setScene=="function"&&this.pathTracer.setScene(this.scene,this.camera),await this.waitFrames(2),this.pathTracer.renderSample(),await this.waitFrames(1)}else console.log("âœ… [Path Tracer] Resolution matches - preserving current samples!"),l.textContent="Path tracer resolution matches - checking samples...";const H=this.pathTracer.enablePathTracing,se=this.pathTracer.pausePathTracing,ee=this.pathTracer.renderToCanvas;if(this.pathTracer.enablePathTracing=!0,this.pathTracer.pausePathTracing=!1,this.pathTracer.renderToCanvas=!0,this.pathTracer.updateCamera(),this.settings.targetSamples>0)await this.waitForSamples(p,l);else{l.textContent="Rendering initial samples...";const Z=10;for(let S=0;S<Z;S++)this.pathTracer.renderSample(),await this.waitFrames(1)}this.pathTracer.renderSample(),await this.waitFrames(2),l.textContent="Capturing image...",p.style.width="100%",this.pathTracer.renderSample(),await this.waitFrames(1);const Oe=this.renderer.getContext();if(Oe&&Oe.isContextLost&&Oe.isContextLost())throw new Error(`WebGL context lost before capture. Resolution ${w}x${b} is too high for your GPU. Please try a lower resolution (8K or below).`);const Y=this.renderer.domElement;let $e;if(Y&&Y.width===w&&Y.height===b)console.log(`ðŸ“¸ Capturing canvas at ${Y.width}x${Y.height}...`),$e=await this.captureImage(Y);else{if(console.warn(`âš ï¸ Canvas size mismatch: expected ${w}x${b}, got ${Y==null?void 0:Y.width}x${Y==null?void 0:Y.height}`),!Y||Y.width===0||Y.height===0)throw new Error(`Canvas has zero dimensions (${Y==null?void 0:Y.width}x${Y==null?void 0:Y.height}). Please check renderer setup.`);console.log(`ðŸ“¸ Capturing canvas at actual size ${Y.width}x${Y.height}...`),$e=await this.captureImage(Y)}f&&k&&(l.textContent="Compositing background image...",$e=await this.compositeWithBackground($e,k,Y.width,Y.height),console.log("ðŸŽ¨ [Render] Composited background image")),this.downloadImage($e,this.settings.fileName,this.settings.format),l.textContent="Render complete!",this.pathTracer.enablePathTracing=H,this.pathTracer.pausePathTracing=se,this.pathTracer.renderToCanvas=ee,this.pathTracer.renderScale=Ke,K&&(this.scene.background=_,this.renderer.setClearAlpha(C),this.pathTracer.updateEnvironment()),setTimeout(()=>{this.close(),this.restoreRenderer()},1e3)}catch(d){console.error("Render error:",d),l.textContent=`Error: ${d.message}`,alert(`Render failed: ${d.message}`),shouldCaptureBackground&&bgImageSrc&&(this.scene.background=originalBackground,this.renderer.setClearAlpha(originalClearAlpha),this.pathTracer.updateEnvironment()),this.restoreRenderer()}finally{this.isRendering=!1,this.stopRequested=!1,r.disabled=!1,r.textContent="Render",r.style.display="",document.getElementById("stopAndCaptureBtn")&&(document.getElementById("stopAndCaptureBtn").style.display="none")}}cancelRender(){this.isRendering=!1,this.stopRequested=!1,this.restoreRenderer(),document.getElementById("renderProgress").style.display="none",document.getElementById("renderBtn").style.display="";const r=document.getElementById("stopAndCaptureBtn");r&&(r.style.display="none")}async waitFrames(r){for(let g=0;g<r;g++)await new Promise(i=>requestAnimationFrame(i))}async waitForSamples(r,g){return new Promise(i=>{const p=this.settings.targetSamples;let l=0;const d=()=>{if(!this.isRendering){i();return}if(this.stopRequested){const m=Math.floor(this.pathTracer.samples);g.textContent=`Stopped at ${m.toLocaleString()} samples â€” capturing...`,i();return}const f=Math.floor(this.pathTracer.samples),k=Math.min(100,f/p*100);r.style.width=`${k}%`;const $=Date.now();$-l>100&&(g.textContent=`Rendering... ${f.toLocaleString()} / ${p.toLocaleString()} samples (${Math.round(k)}%)`,l=$),f>=p?i():(this.pathTracer.enablePathTracing&&!this.pathTracer.pausePathTracing&&this.pathTracer.renderSample(),requestAnimationFrame(d))};d()})}async captureImage(r){const g=this.settings.format.toUpperCase();if(g==="PNG")return r.toDataURL("image/png",1);if(g==="JPG"||g==="JPEG")return this.convertToJPG(r);if(g==="PSD")return console.warn("PSD format not fully supported, exporting as PNG with .psd extension"),r.toDataURL("image/png",1);throw new Error(`Unsupported format: ${g}`)}async compositeWithBackground(r,g,i,p){return new Promise((l,d)=>{const f=new Image;f.onload=()=>{const k=document.createElement("canvas");k.width=i,k.height=p;const $=k.getContext("2d"),m=f.width/f.height,v=i/p;let w,b,_,C;m>v?(w=i,b=i/m,_=0,C=(p-b)/2):(b=p,w=p*m,_=(i-w)/2,C=0),$.fillStyle="#000000",$.fillRect(0,0,i,p),$.drawImage(f,_,C,w,b);const K=new Image;K.onload=()=>{$.drawImage(K,0,0,i,p);const le=this.settings.format.toUpperCase();l(le==="JPG"||le==="JPEG"?k.toDataURL("image/jpeg",.95):k.toDataURL("image/png",1))},K.onerror=d,K.src=r},f.onerror=d,f.src=g})}convertToJPG(r,g=.95){const i=document.createElement("canvas");i.width=r.width,i.height=r.height;const p=i.getContext("2d");return p.fillStyle="#FFFFFF",p.fillRect(0,0,i.width,i.height),p.drawImage(r,0,0),i.toDataURL("image/jpeg",g)}downloadImage(r,g,i){const p=document.createElement("a");p.download=`${g}.${i.toLowerCase()}`,p.href=r,document.body.appendChild(p),p.click(),document.body.removeChild(p)}restoreRenderer(){this.pathTracer.tiles.set(this.originalSettings.tiles.x,this.originalSettings.tiles.y),this.pathTracer.bounces=this.originalSettings.bounces,this.pathTracer.renderScale=this.originalSettings.renderScale,this.pathTracer.filterGlossyFactor=this.originalSettings.filterGlossyFactor,this.pathTracer.multipleImportanceSampling=this.originalSettings.multipleImportanceSampling,this.originalSettings.textureSize&&(this.pathTracer.textureSize.copy(this.originalSettings.textureSize),typeof this.pathTracer.updateMaterials=="function"&&this.pathTracer.updateMaterials()),this.originalSettings.toneMapping!==null&&(this.renderer.toneMapping=this.originalSettings.toneMapping);const r=window.innerWidth,g=window.innerHeight,i=window.devicePixelRatio;if(r>0&&g>0){if(this.renderer.setPixelRatio(i),this.renderer.setSize(r,g),this.camera.isPerspectiveCamera){const k=r/g;this.camera.aspect=k,this.camera.updateProjectionMatrix()}else this.camera.isOrthographicCamera&&this.camera.updateProjectionMatrix();const p=r*i,l=g*i,d=Math.floor(this.originalSettings.renderScale*p),f=Math.floor(this.originalSettings.renderScale*l);if(this.pathTracer._pathTracer&&typeof this.pathTracer._pathTracer.setSize=="function"){this.pathTracer._pathTracer.setSize(d,f);const k=this.pathTracer.lowResScale!=null?this.pathTracer.lowResScale:.25;this.pathTracer._lowResPathTracer&&typeof this.pathTracer._lowResPathTracer.setSize=="function"&&this.pathTracer._lowResPathTracer.setSize(Math.floor(d*k),Math.floor(f*k))}else typeof this.pathTracer.setSize=="function"?this.pathTracer.setSize(d,f):typeof this.pathTracer.resize=="function"&&this.pathTracer.resize(d,f);this.pathTracer.updateCamera()}typeof this.pathTracer.updateEnvironment=="function"&&this.pathTracer.updateEnvironment(),this.pathTracer.reset()}}const $n={"Royal Esplanade":"https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/royal_esplanade_1k.hdr","Moonless Golf":"https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/moonless_golf_1k.hdr",Overpass:"https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/pedestrian_overpass_1k.hdr","Venice Sunset":"https://raw.githubusercontent.com/mrdoob/three.js/r150/examples/textures/equirectangular/venice_sunset_1k.hdr","Small Studio":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/studio_small_05_1k.hdr","Pfalzer Forest":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/phalzer_forest_01_1k.hdr","Leadenhall Market":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/leadenhall_market_1k.hdr",Kloppenheim:"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/kloppenheim_05_1k.hdr","Hilly Terrain":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/hilly_terrain_01_1k.hdr","Circus Arena":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/circus_arena_1k.hdr","Chinese Garden":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/chinese_garden_1k.hdr",Autoshop:"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/autoshop_01_1k.hdr","Measuring Lab":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/vintage_measuring_lab_2k.hdr","Whale Skeleton":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/whale_skeleton_2k.hdr","Hall of Mammals":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/hall_of_mammals_2k.hdr","Drachenfels Cellar":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/drachenfels_cellar_2k.hdr","Adams Place Bridge":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/adams_place_bridge_2k.hdr","Sepulchral Chapel Rotunda":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/sepulchral_chapel_rotunda_2k.hdr","Peppermint Powerplant":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/peppermint_powerplant_2k.hdr","Noon Grass":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/noon_grass_2k.hdr","Narrow Moonlit Road":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/narrow_moonlit_road_2k.hdr","St Peters Square Night":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/st_peters_square_night_2k.hdr","Brown Photostudio 01":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_01_2k.hdr","Rainforest Trail":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/rainforest_trail_2k.hdr","Brown Photostudio 07":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_07_2k.hdr","Brown Photostudio 06":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_06_2k.hdr","Dancing Hall":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/dancing_hall_2k.hdr","Aristea Wreck Puresky":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/aristea_wreck_puresky_2k.hdr","Modern Buildings 2":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/modern_buildings_2_2k.hdr","Thatch Chapel":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/thatch_chapel_2k.hdr",Vestibule:"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/vestibule_2k.hdr","Blocky Photo Studio":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/blocky_photo_studio_1k.hdr","Christmas Photo Studio 07":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/christmas_photo_studio_07_2k.hdr","Aerodynamics Workshop":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/aerodynamics_workshop_1k.hdr","Custom HDRI":"__CUSTOM__"},s={multipleImportanceSampling:!0,acesToneMapping:!0,...Oo(),renderScale:2,tiles:5,model:"",envMap:$n["Aristea Wreck Puresky"],gradientTop:"#bfd8ff",gradientBottom:"#ffffff",environmentIntensity:1,environmentRotation:0,environmentSaturation:1,productSaturation:1,productContrast:1,cameraProjection:"Perspective",focalLength:35,enableDoF:!1,focusDistance:5,fStop:1.4,apertureBlades:6,apertureRotation:0,anamorphicRatio:1,backgroundType:"Gradient",bgGradientTop:"#111111",bgGradientBottom:"#000000",backgroundBlur:0,transparentBackground:!1,checkerboardTransparency:!0,enable:!0,bounces:5,filterGlossyFactor:.1,pause:!1,previewSamplesMax:100,floorMode:"Shadow Catcher",floorColor:"#111111",floorOpacity:1,floorShadowOpacity:.5,floorReflectionIntensity:2,floorRoughness:.2,floorMetalness:.2,floorTransmission:0,floorIOR:1.5,floorShadowReflectionCatcher:!0,screenBrightness:1,screenWallpaper:"blank_screen",screenSaturation:1,backgroundImageEnabled:!1,backgroundImageEmissive:4.5,backgroundAsHDRI:!1,backgroundHDRIIntensity:1,animationFrame:35,animationScreen:"On"};let oe,ye,Nt,P,ie,Ve,pe,me,lt,N,W,Me,Fe,Xe,z=null,bt=null,ct=null,de={},Te="blank_screen",je=null,ot=!1,Je=null,Qe=null;const Rt=new Cn;let Mt=!1,vn=null,ke=null,xn=null,Ze=null,yt=null,It=0,Pt=0,He=null,Ue=null,xe=null,Ce=null,Ie=null,We=null,rt=null;const wt=30;let qe={},kt=null;const ft=2;let ge=null;qo();async function qo(){Xe=Fo,Fe=new Go,Fe.attach(document.body),ie=new fo({antialias:!0,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),ie.toneMapping=Rn,ie.toneMappingExposure=1,ie.outputColorSpace=Re;const c=document.createElement("div");c.id="canvas-container",c.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;",document.body.appendChild(c),ke=document.createElement("img"),ke.id="background-overlay",ke.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;display:none;pointer-events:none;background:#000;",c.appendChild(ke),ie.domElement.style.position="absolute",ie.domElement.style.top="0",ie.domElement.style.left="0",c.appendChild(ie.domElement),P=new jo(ie),P.setBVHWorker(new Do),P.physicallyCorrectLights=!0,P.tiles.set(s.tiles,s.tiles),P.multipleImportanceSampling=s.multipleImportanceSampling,P.transmissiveBounces=10,P.minSamples=1,P.rasterizeSceneCallback=(p,l)=>{!p.environment&&Ce&&(p.environment=Ce),(p.environmentIntensity===void 0||p.environmentIntensity<=0)&&(p.environmentIntensity=s.environmentIntensity||1),ie.render(p,l)};const r=window.innerWidth/window.innerHeight;pe=new Ho(60,r,.025,500),pe.position.set(-1,.25,1),pe.focusDistance=s.focusDistance,pe.fStop=s.enableDoF?s.fStop:1e10,pe.apertureBlades=s.apertureBlades,pe.apertureRotation=s.apertureRotation,pe.anamorphicRatio=s.anamorphicRatio;const g=ft/r;Ve=new An(ft/-2,ft/2,g/2,g/-2,0,100),Ve.position.set(-1,.25,1),Me=new wn,Me.topColor.set(s.bgGradientTop),Me.bottomColor.set(s.bgGradientBottom),Me.update(),lt=new Bo(pe,ie.domElement),lt.addEventListener("change",()=>{P.updateCamera(),Pe()}),ie.domElement.addEventListener("mousedown",Ko),ie.domElement.addEventListener("mousemove",Yo),ie.domElement.addEventListener("mouseup",()=>Ft().catch(()=>{})),ie.domElement.addEventListener("mouseleave",()=>Ft().catch(()=>{})),ie.domElement.addEventListener("wheel",Bt,{passive:!1}),ie.domElement.addEventListener("contextmenu",p=>{Dt()&&p.preventDefault()}),N=new En,N.background=Me,Ce=new wn,Ce.topColor.set("#ffffff"),Ce.bottomColor.set("#cccccc"),Ce.update(),N.environment=Ce,N.environmentIntensity=Math.max(s.environmentIntensity,1),N.add(pe),N.add(Ve),ge=new At,ge.name="contentGroup",N.add(ge);const i=$o(2048);oe=new Nn(new go,new In({map:i,transparent:!0,color:1118481,roughness:.1,metalness:0,transmission:0,ior:1.5,side:Mn,shadowReflectionCatcher:s.floorShadowReflectionCatcher})),oe.scale.setScalar(5),oe.rotation.x=-Math.PI/2,ge.add(oe),Nt=new Lo,document.body.appendChild(Nt.dom),je=new Wo(P,ie,N,me),Hn(s.cameraProjection),N.userData.environmentSaturation=s.environmentSaturation,s.focalLength!=null&&s.focalLength>0&&(pe.fov=ze.radToDeg(2*Math.atan(24/2/s.focalLength)),pe.updateProjectionMatrix()),_n(),jn(),Sn(),Fn(),window.addEventListener("resize",Sn),window.addEventListener("hashchange",_n),window.addEventListener("pointerdown",Qo),window.addEventListener("pointerup",es)}function Fn(){requestAnimationFrame(Fn),Nt.update(),W&&(s.enable?(ot&&P.samples<s.previewSamplesMax&&(ot=!1,s.pause=!1),P.samples>=s.previewSamplesMax&&P.samples>=1?s.pause||(s.pause=!0,ot=!0):(!s.pause||P.samples<1)&&P.samples<s.previewSamplesMax&&P.renderSample()):(!N.environment&&Ce&&(N.environment=Ce),ie.render(N,me)),Fe.setSamples(P.samples,P.isCompiling,s.previewSamplesMax))}function Pe(){P.reset(),ot&&(ot=!1,s.pause=!1)}function vt(){N.environmentIntensity=s.environmentIntensity,N.environmentRotation.y=s.environmentRotation,N.userData.environmentSaturation=s.environmentSaturation,N.backgroundBlurriness=s.backgroundBlur,s.backgroundType==="Gradient"?(Me.topColor.set(s.bgGradientTop),Me.bottomColor.set(s.bgGradientBottom),Me.update(),N.background=Me,N.backgroundIntensity=1):(N.background=N.environment,N.backgroundIntensity=s.environmentIntensity,N.backgroundRotation.y=s.environmentRotation),(s.transparentBackground||s.backgroundImageEnabled)&&(N.background=null,ie.setClearAlpha(0)),Vo()}function Vo(){if(!W)return;const c=s.environmentRotation,r=new Eo(0,c,0);W.traverse(g=>{g.isMesh&&g.material&&(Array.isArray(g.material)?g.material:[g.material]).forEach(p=>{p.envMapRotation&&p.envMapRotation.copy(r)})}),oe&&oe.material&&oe.material.envMapRotation&&oe.material.envMapRotation.copy(r)}function V(){P.multipleImportanceSampling=s.multipleImportanceSampling,P.bounces=s.bounces,P.filterGlossyFactor=s.filterGlossyFactor,P.renderScale=s.renderScale,P.productSaturation=s.productSaturation,P.productContrast=s.productContrast,oe.material.color.set(s.floorColor),oe.material.roughness=s.floorRoughness,oe.material.metalness=s.floorMetalness,oe.material.transmission=s.floorTransmission,oe.material.ior=s.floorIOR,oe.material.shadowReflectionCatcher=s.floorShadowReflectionCatcher,oe.material.shadowCatcherReflectionIntensity=s.floorReflectionIntensity,s.floorMode==="Shadow Catcher"?(oe.material.opacity=Math.min(1,s.floorShadowOpacity),oe.material.transparent=!0):s.floorMode==="Material alpha"?(oe.material.opacity=s.floorOpacity,oe.material.transparent=!0):(oe.material.opacity=s.floorOpacity,oe.material.transparent=s.floorOpacity<1||s.floorTransmission>0),vt(),s.focalLength!=null&&s.focalLength>0&&(pe.fov=ze.radToDeg(2*Math.atan(24/2/s.focalLength)),pe.updateProjectionMatrix(),P.updateCamera()),pe.focusDistance=s.focusDistance,pe.fStop=s.enableDoF?s.fStop:1e10,pe.apertureBlades=s.apertureBlades,pe.apertureRotation=s.apertureRotation,pe.anamorphicRatio=s.anamorphicRatio,P.updateCamera(),P.updateMaterials(),P.updateEnvironment()}let xt=!1,Bn=null,On=null,Lt=0,$t=0;function Dt(){return!!(s.backgroundImageEnabled&&xn&&xn.visible)}function Gn(c){lt.enabled=c}function Ko(c){!Dt()||!ge||(xt=!0,Lt=c.clientX,$t=c.clientY,Bn=s.enable,On=s.pause,s.enable=!1,s.pause=!0,Gn(!1))}function Yo(c){if(!xt||!ge)return;const r=c.clientX-Lt,g=c.clientY-$t;if(c.buttons&1)ge.rotation.y+=r*.005,ge.rotation.x+=g*.005,ge.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,ge.rotation.x));else if(c.buttons&2){const i=.005*(me.position.z||5),p=r*i*.2,l=-g*i*.2,d=new Ne(1,0,0).applyQuaternion(me.quaternion),f=new Ne(0,1,0).applyQuaternion(me.quaternion);ge.position.addScaledVector(d,p),ge.position.addScaledVector(f,l)}Lt=c.clientX,$t=c.clientY}async function Ft(){if(!xt)return;xt=!1,s.enable=Bn??s.enable,s.pause=On??s.pause,Gn(!0),N.updateMatrixWorld(!0);const c=await P.setSceneAsync(N,me);Qe=(c==null?void 0:c.bvh)||null,Pe()}function Bt(c){if(!Dt()||!ge)return;c.preventDefault();const g=Math.sign(c.deltaY)>0?.95:1.05,i=ze.clamp(ge.scale.x*g,.25,4);ge.scale.setScalar(i),s.enable=!1,s.pause=!0,clearTimeout(Bt._t),Bt._t=setTimeout(()=>{Ft().catch(()=>{})},150)}async function Jo(){ke&&Ze&&(ke.src=Ze,ke.style.display="block")}async function Xo(){ke&&(ke.style.display="none")}function Dn(){if(!yt||!s.backgroundAsHDRI){Ue!==null&&(N.environment=Ue,Ue=null),He&&(He.dispose(),He=null),vt(),P.updateEnvironment(),Pe();return}const c=yt,r=document.createElement("canvas");r.width=c.width,r.height=c.height;const g=r.getContext("2d");g.drawImage(c,0,0);const i=g.getImageData(0,0,c.width,c.height),p=new Float32Array(c.width*c.height*4);for(let d=0;d<i.data.length;d+=4)p[d]=Math.pow(i.data[d]/255,2.2),p[d+1]=Math.pow(i.data[d+1]/255,2.2),p[d+2]=Math.pow(i.data[d+2]/255,2.2),p[d+3]=1;const l=new _o(p,c.width,c.height,So,To);l.mapping=Gt,l.needsUpdate=!0,He&&He.dispose(),He=l,Ue===null&&(Ue=N.environment),N.environment=l,vt(),P.updateEnvironment(),Pe(),console.log(`âœ… Background image converted to HDRI environment (${c.width}x${c.height} DataTexture)`)}function Zo(c){if(!c||!c.type.startsWith("image/")){alert("Please upload an image file");return}const r=new FileReader;r.onload=g=>{const i=new Image;i.onload=async()=>{Ze=g.target.result,It=i.width,Pt=i.height,yt=i,s.backgroundImageEnabled=!0,ke&&(ke.src=Ze,ke.style.display="block"),window.backgroundImageSrc=Ze,window.backgroundImageNaturalWidth=It,window.backgroundImageNaturalHeight=Pt,s.backgroundAsHDRI&&Dn(),V(),_t(),console.log(`âœ… Background image loaded: ${i.width}x${i.height} (CSS overlay)`)},i.src=g.target.result},r.readAsDataURL(c)}function _n(){let c="";if(window.location.hash){const r=decodeURI(window.location.hash.substring(1));r in Xe&&(c=r)}c in Xe||(c="Headphone Static"in Xe?"Headphone Static":Object.keys(Xe)[0]),s.model=c,ss()}function Sn(){const c=window.innerWidth,r=window.innerHeight,g=window.devicePixelRatio;ie.setSize(c,r),ie.setPixelRatio(g);const i=c/r;pe.aspect=i,pe.updateProjectionMatrix();const p=ft/i;Ve.top=p/2,Ve.bottom=p/-2,Ve.updateProjectionMatrix(),P.updateCamera()}function Qo(c){Rt.set(c.clientX,c.clientY)}function es(c){if(Math.abs(Rt.x-c.clientX)+Math.abs(Rt.y-c.clientY)<5&&Qe&&s.enableDoF){const g=new Co;g.setFromCamera({x:c.clientX/window.innerWidth*2-1,y:-(c.clientY/window.innerHeight)*2+1},me);const i=Qe.raycastFirst(g.ray);i&&(s.focusDistance=Math.max(.1,i.distance-me.near),pe.focusDistance=s.focusDistance,P.updateCamera(),ye&&ye.controllersRecursive().forEach(p=>{p.property==="focusDistance"&&p.updateDisplay()}))}}function _t(){if(ye&&ye.destroy(),ye=new Po,ye.add(s,"model",Object.keys(Xe).sort()).onChange(v=>{window.location.hash=v}),Ie&&We&&rt){const v=ye.addFolder("Animation"),w=Math.floor((rt.duration||5)*wt);let b=null,_=!1,C=!1;v.add(s,"animationFrame",0,w,1).name(`Frame (0â€“${w})`).onChange(K=>{_||(_=!0,C=s.pause,s.pause=!0);const le=Math.min(K/wt,rt.duration||5);We.time=le,Ie.update(0),N.updateMatrixWorld(!0),ie.render(N,me),clearTimeout(b),b=setTimeout(async()=>{try{const we=await P.setSceneAsync(N,me);Qe=(we==null?void 0:we.bvh)||null,P.updateCamera(),Pe()}catch(we){console.error("Failed to update path tracer scene for animation frame",we)}_=!1,s.pause=C},2e3)}),Object.keys(de).some(K=>de[K]!==null)&&(s.animationScreen=Te==="off_screen"||Te==="Off screen"?"Off screen":"On",v.add(s,"animationScreen",["On","Off screen"]).name("Screen").onChange(async K=>{if(K==="Off screen")Te="off_screen",s.screenWallpaper="off_screen",await gt("off_screen");else{const le=s.screenWallpaper==="off_screen"||s.screenWallpaper==="Off screen"?"blank_screen":s.screenWallpaper;Te=le,s.screenWallpaper=le,await gt(le)}P.updateMaterials(),Pe()})),v.open()}const c=Object.keys(qe);if(c.length>0){const v=ye.addFolder("Product Color"),w={};c.forEach(b=>{const _=qe[b],C=_.prefix.charAt(0).toUpperCase()+_.prefix.slice(1);w[C]=b}),s.productColor=kt||c[0],v.add(s,"productColor",w).name("Color").onChange(async b=>{Object.values(qe).forEach(C=>{C.names.forEach(K=>{const le=W.getObjectByName(K);le&&(le.visible=!1)})});const _=qe[b];_&&_.names.forEach(C=>{const K=W.getObjectByName(C);K&&(K.visible=!0)}),kt=b,ie.render(N,me),N.updateMatrixWorld(!0);try{const C=await P.setSceneAsync(N,me);Qe=(C==null?void 0:C.bvh)||null}catch(C){console.error("Failed to update path tracer after color change",C)}P.updateMaterials(),P.updateCamera(),Pe()}),v.open()}const r=ye.addFolder("Path Tracer");Je=r.add(s,"enable"),r.add(s,"pause").onChange(()=>{ot=!1}),je&&(je.onClose=()=>{s.enable=!0,Je&&Je.disable(!1)}),je&&(je.onBeforeRender=()=>{s.enable=!0,Je&&Je.disable(!1)}),r.add(s,"multipleImportanceSampling").onChange(V),r.add(s,"acesToneMapping").onChange(v=>{ie.toneMapping=v?Rn:xo}),r.add(s,"bounces",1,30,1).onChange(V),r.add(s,"filterGlossyFactor",0,1).onChange(V),r.add(s,"renderScale",.1,2,.01).onChange(()=>{V()}),r.add(s,"tiles",1,10,1).onChange(v=>{P.tiles.set(v,v)}),r.add(s,"previewSamplesMax",100,5e3,100).name("Preview Sample Cap"),r.add(s,"cameraProjection",["Perspective","Orthographic"]).onChange(v=>{Hn(v)}),r.add(s,"focalLength",15,100,1).onChange(V).name("Focal length (mm)"),r.add(s,"productSaturation",0,2,.01).onChange(V).name("Product saturation"),r.add(s,"productContrast",.5,2,.01).onChange(V).name("Product contrast");const g=r.add({renderImage:()=>{je&&(s.enable=!1,Je&&Je.disable(),je.open())}},"renderImage").name("Render Image...");if(g&&g.domElement){g.domElement.classList.add("render-image-button");const v=g.domElement.querySelector("button");v&&v.classList.add("render-image-btn")}r.open();const i=ye.addFolder("Depth of Field");i.add(s,"enableDoF").name("Enable DoF").onChange(V),i.add(s,"focusDistance",.1,50,.1).name("Focus Distance").onChange(V),i.add(s,"fStop",.5,22,.1).name("f-Stop (Aperture)").onChange(V),i.add(s,"apertureBlades",0,10,1).name("Aperture Blades").onChange(V),i.add(s,"apertureRotation",0,Math.PI,.01).name("Aperture Rotation").onChange(V),i.add(s,"anamorphicRatio",.5,2,.01).name("Anamorphic Ratio").onChange(V),i.close();const p=ye.addFolder("environment");p.add(s,"envMap",$n).name("map").onChange(jn),p.add({loadCustomHDRI:ts},"loadCustomHDRI").name("Load Custom HDRI"),p.add(s,"environmentIntensity",0,10).onChange(V).name("intensity"),p.add(s,"environmentRotation",0,2*Math.PI).name("rotation").onChange(()=>{Mt||(Mt=!0,vn=s.enable,s.enable=!1),vt(),!s.transparentBackground&&!s.backgroundImageEnabled&&N.environment&&(N.background=N.environment,N.backgroundIntensity=s.environmentIntensity,N.backgroundRotation.y=s.environmentRotation)}).onFinishChange(()=>{Mt=!1,V(),s.enable=vn??!0}),p.add(s,"environmentSaturation",0,2).onChange(V).name("HDRI saturation"),p.add(s,"backgroundAsHDRI").name("BG Image as HDRI").onChange(()=>{Dn()}),p.open();const l=ye.addFolder("background");l.add(s,"backgroundType",["Environment","Gradient"]).onChange(V),l.addColor(s,"bgGradientTop").onChange(V),l.addColor(s,"bgGradientBottom").onChange(V),l.add(s,"backgroundBlur",0,1).onChange(V),l.add({uploadBackgroundImage:()=>{const v=document.createElement("input");v.type="file",v.accept="image/*",v.style.display="none",v.addEventListener("change",w=>{w.target.files[0]&&Zo(w.target.files[0])}),v.click()}},"uploadBackgroundImage").name("Upload Background"),l.add(s,"backgroundImageEnabled").name("Show Background Image").onChange(v=>{v&&Ze?Jo():Xo(),V()}),l.add({removeBackgroundImage:async()=>{Ze=null,It=0,Pt=0,yt=null,s.backgroundImageEnabled=!1,window.backgroundImageSrc=null,window.backgroundImageNaturalWidth=0,window.backgroundImageNaturalHeight=0,ke&&(ke.style.display="none",ke.src=""),s.backgroundAsHDRI=!1,He&&(Ue!==null&&(N.environment=Ue,N.environmentIntensity=s.environmentIntensity,Ue=null),He.dispose(),He=null),V(),_t()}},"removeBackgroundImage").name("Remove Background");const d=ye.addFolder("Floor"),f=d.add(s,"floorMode",["Solid Ground","Shadow Catcher","Material alpha"]).name("Mode"),k=[];k.push(d.addColor(s,"floorColor").onChange(V)),k.push(d.add(s,"floorOpacity",0,1).onChange(V).name("Opacity")),k.push(d.add(s,"floorTransmission",0,1).name("Transmission").onChange(V)),k.push(d.add(s,"floorIOR",1,2,.01).name("IOR").onChange(V));const $=d.add(s,"floorShadowOpacity",0,2).onChange(V).name("Shadow opacity");d.add(s,"floorReflectionIntensity",0,10,.1).onChange(V).name("Reflection intensity"),d.add(s,"floorRoughness",0,1).onChange(V),d.add(s,"floorMetalness",0,1).onChange(V);function m(v){const w=v==="Shadow Catcher",b=v==="Material alpha";s.floorShadowReflectionCatcher=w,k.forEach(_=>{_.domElement.style.display=""}),$.domElement.style.display="",w?(oe.material.opacity=Math.min(1,s.floorShadowOpacity),oe.material.transparent=!0):b?(oe.material.opacity=s.floorOpacity,oe.material.transparent=!0):(oe.material.opacity=s.floorOpacity,oe.material.transparent=s.floorOpacity<1||s.floorTransmission>0),V()}if(f.onChange(m),m(s.floorMode),d.open(),Object.keys(de).some(v=>de[v]!==null)){const v=ye.addFolder("Screen"),b=["off_screen","blank_screen","blue_bloom","aurora_borealis","feather_light","asus_1","asus_2","custom"].filter(_=>_==="custom"||_==="off_screen"?!0:de[_]!==null);v.add(s,"screenWallpaper",b).name("Wallpaper").onChange(async _=>{Te=_,s.screenWallpaper=_,_==="custom"?(s.screenBrightness=4.5,s.screenSaturation=.9):(s.screenBrightness=1,s.screenSaturation=1),s.animationScreen!==void 0&&(s.animationScreen=_==="off_screen"||_==="Off screen"?"Off screen":"On"),await gt(_)}),v.add({uploadImage:()=>{const _=document.createElement("input");_.type="file",_.accept="image/*",_.style.display="none",_.addEventListener("change",C=>{C.target.files[0]&&os(C.target.files[0])}),_.click()}},"uploadImage").name("Upload Custom"),v.add(s,"screenBrightness",0,10,.1).onChange(async _=>{s.screenBrightness=_,Te==="custom"&&ct?(console.log(`ðŸŽ¨ Brightness changed to ${_} - reprocessing custom image`),await Tn()):z&&z.material&&((Array.isArray(z.material)?z.material:[z.material]).forEach(K=>{K.emissiveIntensity=_,K.emissive&&K.emissive.setHex(16777215),K.needsUpdate=!0}),P.updateMaterials(),Pe())}).name("Brightness"),v.add(s,"screenSaturation",0,2,.1).onChange(async _=>{s.screenSaturation=_,Te==="custom"&&ct?(console.log(`ðŸŽ¨ Saturation changed to ${_} - reprocessing custom image`),await Tn()):console.log("âš ï¸ Saturation control only works with custom uploaded images")}).name("Saturation"),v.close()}}function jn(){if(s.envMap==="__CUSTOM__"){xe&&N.environment!==xe&&(N.environment&&N.environment!==Me&&N.environment!==Ce&&N.environment.dispose(),N.environment=xe,P.updateEnvironment(),V());return}const c=N.environment;new Ln().load(s.envMap,r=>{c&&c!==r&&c!==Me&&c!==Ce&&(c===xe&&(xe=null),c.dispose()),r.mapping=Gt,r.minFilter=st,r.magFilter=st,r.generateMipmaps=!1,N.environment=r,P.updateEnvironment(),V()},void 0,r=>{console.warn("HDRI preset load failed, keeping current environment:",s.envMap,r),!N.environment&&c&&(N.environment=c),P.updateEnvironment()})}function ts(){const c=document.createElement("input");c.type="file",c.accept=".hdr,.hrd",c.style.display="none",c.addEventListener("change",r=>{const g=r.target.files&&r.target.files[0];if(!g)return;const i=URL.createObjectURL(g);new Ln().load(i,p=>{URL.revokeObjectURL(i),xe&&xe.dispose(),xe=p,xe.mapping=Gt,xe.minFilter=st,xe.magFilter=st,xe.generateMipmaps=!1,N.environment&&N.environment!==xe&&N.environment!==Me&&N.environment!==Ce&&N.environment.dispose(),N.environment=xe,P.updateEnvironment(),s.envMap="__CUSTOM__",V()},void 0,p=>{URL.revokeObjectURL(i),console.error("Custom HDRI load failed:",p)})}),c.click()}function Hn(c){me&&(pe.position.copy(me.position),Ve.position.copy(me.position)),c==="Perspective"?me=pe:me=Ve,lt.object=me,lt.update(),P.setCamera(me),je&&(je.camera=me)}function ns(c,r){c.traverse(g=>{if(g.material){const i=g.material;if(i.opacity<.65&&i.opacity>.2){const p=new In;for(const d in i)if(d in i){if(i[d]===null)continue;i[d].isTexture?p[d]=i[d]:i[d].copy&&i[d].constructor===p[d].constructor?p[d].copy(i[d]):typeof i[d]=="number"&&(p[d]=i[d])}p.opacity=1,p.transmission=1,p.ior=r;const l={};p.color.getHSL(l),l.l=Math.max(l.l,.35),p.color.setHSL(l.h,l.s,l.l),g.material=p}}})}function zn(c){let r=null,g=null;return c.traverse(i=>{var p,l,d,f;if(i.isMesh){const k=i.name.toLowerCase(),$=((l=(p=i.parent)==null?void 0:p.name)==null?void 0:l.toLowerCase())||"";if((k.includes("screen_blank")||k==="screen_blank")&&i.material){g=i,console.log("Found priority screen mesh (screen_blank):",i.name,"Parent:",(d=i.parent)==null?void 0:d.name);return}if(k.includes("cover")||k.includes("panel")||k.includes("back")||k.startsWith("a_"))return;(k.includes("screen")&&k.includes("blank")||k.includes("blank")&&$.includes("screen")||k==="blank"&&$.includes("screen"))&&i.material&&(!r||i.material.emissiveMap)&&(r=i,console.log("Found screen mesh:",i.name,"Parent:",(f=i.parent)==null?void 0:f.name))}}),g||(r||c.traverse(i=>{if(i.isMesh&&i.material){const p=i.name.toLowerCase();if(p.includes("cover")||p.includes("panel")||p.includes("back"))return;const l=Array.isArray(i.material)?i.material[0]:i.material;if(l.emissiveMap||l.emissiveIntensity>0){r=i,console.log("Found screen by material:",i.name);return}}}),r)}function as(c){const r={blank_screen:null,blue_bloom:null,aurora_borealis:null,feather_light:null,asus_1:null,asus_2:null},g=new Map;let i=null,p=null;return c.traverse(l=>{var d;if(l.isGroup&&l.name==="wallpaper"&&(i=l,console.log(`âœ… [WALLPAPER GROUP] Found: ${l.name}`)),l.isMesh&&l.material){const f=l.name;f.toLowerCase();const k=((d=l.parent)==null?void 0:d.name)||"",$=k.toLowerCase();f==="screen_blank"&&(p=l,console.log(`âœ… [SCREEN BLANK] Found: ${f} (parent: ${k})`));const m=f.match(/^(\d+)_(.+)/);if(m){const w=m[2].toLowerCase();g.set(f,l),console.log(`âœ… [WALLPAPER MESH] Found: ${f} (parent: ${k})`);let b=w;b=b.replace(/^vertical_?/i,""),b=b.replace(/_?vertical_?/i,""),b=b.replace(/__+/g,"_"),b=b.replace(/^_+|_+$/g,""),b.includes("blank")||b.includes("screen_blank")?r.blank_screen||(r.blank_screen=l):b.includes("blue")&&b.includes("bloom")?r.blue_bloom||(r.blue_bloom=l):b.includes("aurora")||b.includes("borealis")?r.aurora_borealis||(r.aurora_borealis=l):b.includes("feather")&&b.includes("light")?r.feather_light||(r.feather_light=l,console.log(`âœ… Mapped "${f}" to "feather_light" (core: "${b}")`)):b==="asus_1"||b==="asus1"?r.asus_1||(r.asus_1=l):(b==="asus_2"||b==="asus2")&&(r.asus_2||(r.asus_2=l))}$==="wallpaper"&&/^\d+_/.test(f)&&(g.has(f)||(g.set(f,l),console.log(`âœ… [WALLPAPER MESH] Found in wallpaper group: ${f}`)))}}),p&&(g.set("screen_blank",p),r.blank_screen||(r.blank_screen=p)),console.log(`ðŸ“‹ Available wallpaper meshes (${g.size} total):`),g.forEach((l,d)=>{console.log(`   - ${d}`)}),g._wallpaperGroup=i,g._screenBlank=p,r}async function gt(c){if(!W){console.error("âŒ updateWallpaperVisibility: model is null!");return}console.log(`
ðŸŽ¨ ========== UPDATE WALLPAPER VISIBILITY ==========`),console.log(`ðŸ“Œ Selected wallpaper: "${c}"`),console.log("ðŸ“¦ Current screenMesh:",z?z.name:"null"),console.log("ðŸ“‹ Available wallpapers:",Object.keys(de).filter(m=>de[m]!==null));const r=[];W.traverse(m=>{var v,w,b;if(m.isMesh){const _=m.name.toLowerCase(),C=((w=(v=m.parent)==null?void 0:v.name)==null?void 0:w.toLowerCase())||"",K=_.includes("screen_panel")||_.includes("screen_backlight")||_.includes("screen_filter")||_.includes("screen_mirror")||_.includes("screen_bezel")||_.includes("display008")||_.includes("display006")||_.includes("display005")||_.includes("display007")||C.includes("screen_backlight")||C.includes("screen_filter")||C.includes("screen_mirror")||C.includes("screen_rgb")||C.includes("displayctrl")&&!C.includes("wallpaper"),le=m.name,we=Object.values(de).some(be=>be===m),_e=/^\d+_/.test(le),Be=C==="wallpaper",Le=le==="screen_blank";if(!K&&(we||_e&&(Be||!0)||Le||_.includes("rgb")&&C.includes("screen")&&!C.includes("screenctrl"))){m.updateMatrixWorld(!0);const be=new Ne;m.getWorldPosition(be);let O=0,H="unknown";if(de.blank_screen===m||Le)O=100,H="blank_screen";else if(de.blue_bloom===m)O=90,H="blue_bloom";else if(de.aurora_borealis===m)O=80,H="aurora_borealis";else if(de.feather_light===m)O=70,H="feather_light";else if(de.asus_1===m)O=60,H="asus_1";else if(de.asus_2===m)O=55,H="asus_2";else if(_.includes("rgb")&&C.includes("screen")&&!C.includes("screenctrl"))O=50,H="screen_rgb";else if(_e){const se=le.match(/^\d+_(.+)/);if(se){let ee=se[1].toLowerCase();ee=ee.replace(/^vertical_?/i,""),ee=ee.replace(/_?vertical_?/i,""),ee=ee.replace(/__+/g,"_"),ee=ee.replace(/^_+|_+$/g,""),ee.includes("blank")?(O=100,H="blank_screen"):ee.includes("blue")&&ee.includes("bloom")?(O=90,H="blue_bloom"):ee.includes("aurora")||ee.includes("borealis")?(O=80,H="aurora_borealis"):ee.includes("feather")&&ee.includes("light")?(O=70,H="feather_light"):ee==="asus_1"||ee==="asus1"?(O=60,H="asus_1"):ee==="asus_2"||ee==="asus2"?(O=55,H="asus_2"):(O=40,H=ee)}else O=40,H="wallpaper"}else Be?(O=40,H="wallpaper"):O=10;r.push({mesh:m,name:m.name,parent:((b=m.parent)==null?void 0:b.name)||"none",visible:m.visible,hasMaterial:!!m.material,hasEmissiveMap:!!(m.material&&m.material.emissiveMap),worldPosition:{x:be.x.toFixed(2),y:be.y.toFixed(2),z:be.z.toFixed(2)},priority:O,wallpaperType:H,depth:be.z})}}}),r.sort((m,v)=>v.priority!==m.priority?v.priority-m.priority:m.depth-v.depth),console.log(`
ðŸ“Š ALL SCREEN MESHES FOUND (${r.length} total):`),console.log("   Sorted by Priority (higher = more important) â†’ Depth (lower Z = closer to screen)"),console.log("   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"),console.log("   â”‚ Priority â”‚ Depth (Z) â”‚ Visible â”‚ Has Emissive â”‚ Type              â”‚ Name                â”‚"),console.log("   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"),r.forEach((m,v)=>{const w=String(m.priority).padStart(3),b=m.depth.toFixed(2).padStart(8),_=(m.visible?"âœ… YES":"âŒ NO ").padEnd(7),C=(m.hasEmissiveMap?"âœ… YES":"âŒ NO ").padEnd(12),K=m.wallpaperType.padEnd(18),le=(m.name.length>20?m.name.substring(0,17)+"...":m.name).padEnd(20);console.log(`   â”‚ ${w}     â”‚ ${b} â”‚ ${_} â”‚ ${C} â”‚ ${K} â”‚ ${le} â”‚`)}),console.log("   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"),console.log(`
ðŸ”’ HIDING ALL SCREEN MESHES AND PARENT GROUPS:`);const g=new Set,i=[];r.forEach(m=>{var b;const v=m.mesh.visible;m.mesh.visible=!1,i.push(m);let w=m.mesh.parent;for(;w&&w!==W;){if((((b=w.name)==null?void 0:b.toLowerCase())||"").includes("wallpaper")&&!g.has(w)){const C=w.visible;w.visible=!1,g.add(w),C&&console.log(`   âŒ HID GROUP: "${w.name}" (contains "${m.name}")`)}w=w.parent}v&&console.log(`   âŒ HID MESH: "${m.name}" (Priority: ${m.priority}, Depth: ${m.depth.toFixed(2)})`)}),console.log(`   ðŸ“Š Summary: Hid ${i.length} meshes and ${g.size} groups`);let p=null,l=null;const d=c==="off_screen"||c==="Off screen"||!c;if(d)console.log(`
ðŸ“´ SCREEN OFF MODE - Hiding all wallpapers`),console.log(`   All ${i.length} meshes remain hidden`),console.log("   No target mesh will be shown");else if(c==="custom")console.log(`
ðŸŽ¯ CUSTOM WALLPAPER MODE`),console.log("   screenMesh exists:",!!z),console.log("   screenMesh name:",z==null?void 0:z.name),z?(l=r.find(m=>m.mesh===z),p=z,console.log(l?`   ðŸ“ Found screenMesh in list: Priority ${l.priority}, Depth ${l.depth.toFixed(2)}`:"   âš ï¸ screenMesh not found in collected list, using directly")):(console.error("   âŒ screenMesh is null! Cannot show custom wallpaper."),console.log("   ðŸ’¡ Trying to find best screen mesh from collected list..."),l=r.find(m=>m.hasEmissiveMap||m.priority>50),l&&(p=l.mesh,z=p,console.log(`   âœ… Using fallback mesh: "${p.name}"`)));else if(de[c]){const m=de[c];console.log(`
ðŸŽ¯ PREDEFINED WALLPAPER MODE: "${c}"`),console.log(`   Selected mesh: "${m.name}"`),l=r.find(v=>v.mesh===m),p=m,l&&console.log(`   ðŸ“ Found in list: Priority ${l.priority}, Depth ${l.depth.toFixed(2)}`),z=m}else console.warn(`
âš ï¸ Wallpaper "${c}" not found in wallpaperMeshes!`),console.log("   Available keys:",Object.keys(de)),console.log("   Values:",Object.entries(de).map(([m,v])=>`${m}: ${v?v.name:"null"}`));if(p){p.visible=!0,console.log(`
âœ… SHOWING TARGET MESH:`),console.log(`   Name: "${p.name}"`),l&&(console.log(`   Priority: ${l.priority} (${l.wallpaperType})`),console.log(`   Depth (Z): ${l.depth.toFixed(2)} (${l.depth<0?"FRONT/CLOSER":"BACK/FARTHER"})`),console.log(`   Position: (${l.worldPosition.x}, ${l.worldPosition.y}, ${l.worldPosition.z})`)),console.log(`   Has EmissiveMap: ${l!=null&&l.hasEmissiveMap?"âœ… YES":"âŒ NO"}`),console.log("   âœ… Set visible = true"),c!=="custom"&&!d&&de[c]&&p.material&&((Array.isArray(p.material)?p.material:[p.material]).forEach(C=>{C.emissiveIntensity=s.screenBrightness,C.emissive&&C.emissive.setHex(16777215),C.needsUpdate=!0}),P&&(P.updateMaterials(),Pe()));let v=p.parent,w=0;const b=new Set;for(;v&&v!==W&&(v.visible=!0,b.add(v),console.log(`   âœ… Made parent visible: "${v.name}"`),v=v.parent,w++,!(w>10)););W.traverse(_=>{var C;_.isGroup&&(((C=_.name)==null?void 0:C.toLowerCase())||"").includes("wallpaper")&&!b.has(_)&&_!==p.parent&&(_.visible=!1,console.log(`   ðŸ”’ Hid sibling group: "${_.name}" (not in visible chain)`))})}else console.error("   âŒ No target mesh found! Cannot show wallpaper.");console.log(`
ðŸ“Š FINAL STATE - VISIBLE MESHES ON SCREEN:`);const f=r.filter(m=>m.mesh.visible);f.length===0?console.log("   âš ï¸ NO MESHES ARE VISIBLE! This is a problem."):(console.log(`   âœ… ${f.length} mesh(es) visible:`),f.forEach((m,v)=>{console.log(`   ${v+1}. "${m.name}"`),console.log(`      Priority: ${m.priority} (${m.wallpaperType})`),console.log(`      Depth: ${m.depth.toFixed(2)} (${m.depth<0?"FRONT":"BACK"})`),console.log(`      Has EmissiveMap: ${m.hasEmissiveMap?"âœ… YES":"âŒ NO"}`),console.log(`      Parent: "${m.parent}"`)}));const k=r.filter(m=>!m.mesh.visible);k.length>0&&(console.log(`
   ðŸ”’ ${k.length} mesh(es) HIDDEN (should not appear):`),k.slice(0,5).forEach(m=>{console.log(`      - "${m.name}" (Priority: ${m.priority}, Type: ${m.wallpaperType})`)}),k.length>5&&console.log(`      ... and ${k.length-5} more`)),console.log(`
ðŸ”„ Updating path tracer scene (rebuilding with only visible meshes)...`),await new Promise(m=>setTimeout(m,10)),Ie&&We&&Ie.update(0),N.updateMatrixWorld(!0);const $=await P.setSceneAsync(N,me,{onProgress:m=>{m===1&&console.log(`âœ… Path tracer scene rebuilt - only visible meshes included
`)}});Qe=($==null?void 0:$.bvh)||null}function Un(c,r,g){const i=document.createElement("canvas");i.width=c.width,i.height=c.height;const p=i.getContext("2d");p.drawImage(c,0,0);const l=p.getImageData(0,0,i.width,i.height),d=l.data,f=r/5;for(let k=0;k<d.length;k+=4){let $=d[k]/255,m=d[k+1]/255,v=d[k+2]/255;$*=f,m*=f,v*=f;const w=.299*$+.587*m+.114*v;$=w+g*($-w),m=w+g*(m-w),v=w+g*(v-w),d[k]=Math.max(0,Math.min(255,Math.round($*255))),d[k+1]=Math.max(0,Math.min(255,Math.round(m*255))),d[k+2]=Math.max(0,Math.min(255,Math.round(v*255)))}return p.putImageData(l,0,0),i}async function Tn(){if(!ct||!z||!z.material){console.warn("âš ï¸ Cannot update screen texture - missing image or screenMesh");return}console.log(`ðŸ”„ Updating screen texture with brightness: ${s.screenBrightness}, saturation: ${s.screenSaturation}`);const c=Un(ct,s.screenBrightness,s.screenSaturation),r=new Pn(c);r.flipY=!1,r.colorSpace=Re,r.generateMipmaps=!0,r.minFilter=Ot,r.magFilter=st,r.anisotropy=16,r.needsUpdate=!0,(Array.isArray(z.material)?z.material:[z.material]).forEach(i=>{i.emissiveMap&&i.emissiveMap!==bt&&i.emissiveMap.dispose(),i.emissiveMap=r,i.emissiveIntensity=1,i.emissive=new it(16777215),i.roughness=1,i.metalness=1,i.needsUpdate=!0}),bt=r,P.updateMaterials(),Pe(),console.log("âœ… Screen texture updated successfully")}async function os(c){if(console.log(`
ðŸ“¤ ========== IMAGE UPLOAD STARTED ==========`),console.log("ðŸ“ File:",c.name,`(${c.type}, ${(c.size/1024).toFixed(2)} KB)`),!c||!c.type.startsWith("image/")){alert("Please upload an image file");return}const r=new FileReader;r.onload=async g=>{console.log("âœ… File read successfully");const i=new Image;i.onload=async()=>{if(console.log(`âœ… Image loaded: ${i.width}x${i.height}`),ct=i,console.log("âœ… Stored original image for brightness/saturation processing"),s.screenBrightness=4.5,s.screenSaturation=.9,!z&&W&&(console.log("ðŸ” screenMesh not found, searching..."),z=zn(W),console.log("ðŸ” Found screenMesh:",z?z.name:"null")),console.log(`
ðŸ“Š BEFORE APPLYING TEXTURE:`),console.log("   screenMesh:",z?z.name:"null"),console.log("   screenMesh.visible:",z==null?void 0:z.visible),console.log("   screenMesh.material exists:",!!(z!=null&&z.material)),console.log("   currentWallpaper:",Te),console.log("   params.screenWallpaper:",s.screenWallpaper),z&&z.material){console.log(`
   ðŸŽ¨ Applying brightness: ${s.screenBrightness}, saturation: ${s.screenSaturation}`);const p=Un(i,s.screenBrightness,s.screenSaturation),l=new Pn(p);l.flipY=!1,l.colorSpace=Re,l.generateMipmaps=!0,l.minFilter=Ot,l.magFilter=st,l.anisotropy=16,l.needsUpdate=!0,console.log("âœ… Texture created with proper quality settings (flipY: false, colorSpace: sRGB, mipmaps: enabled, brightness/saturation applied)");const d=Array.isArray(z.material)?z.material:[z.material];console.log("   Materials count:",d.length),bt=l,console.log("   âœ… Stored uploadedTexture"),d.forEach((f,k)=>{console.log(`
   ðŸ“ Processing material ${k+1}:`),console.log("      Has emissiveMap:",!!f.emissiveMap),console.log("      emissiveIntensity:",f.emissiveIntensity),f.emissiveMap&&f.emissiveMap!==bt&&(console.log("      ðŸ—‘ï¸ Disposing old emissiveMap"),f.emissiveMap.dispose()),f.emissiveMap=l,f.emissiveIntensity=1,f.emissive=new it(16777215),f.roughness=1,f.metalness=1,f.needsUpdate=!0,console.log("      âœ… Applied new emissiveMap"),console.log("      âœ… Set emissiveIntensity to: 1.0 (brightness baked into texture)"),console.log("      âœ… Set emissive color to white"),console.log("      âœ… Set roughness=0, metalness=0 for glossy screen"),console.log("      âœ… Set needsUpdate = true")}),s.screenWallpaper="custom",Te="custom",console.log(`
   âœ… Set params.screenWallpaper = 'custom'`),console.log("   âœ… Set currentWallpaper = 'custom'"),console.log(`
   ðŸŽ¨ Calling updateWallpaperVisibility('custom')...`),await gt("custom"),console.log(`
   ðŸ”„ Updating path tracer materials...`),P.updateMaterials(),console.log("   ðŸ”„ Resetting path tracer..."),Pe(),console.log("   ðŸ”„ Rebuilding GUI..."),_t(),console.log(`
âœ… ========== IMAGE UPLOAD COMPLETE ==========
`)}else console.error(`
âŒ ========== IMAGE UPLOAD FAILED ==========`),console.error("   screenMesh:",z),console.error("   screenMesh.material:",z==null?void 0:z.material),console.error("   model:",W),alert("Screen mesh not found in model. Check console for details.")},i.onerror=()=>{console.error("âŒ Failed to load image"),alert("Failed to load image file")},i.src=g.target.result},r.onerror=()=>{console.error("âŒ Failed to read file"),alert("Failed to read file")},r.readAsDataURL(c)}async function ss(){ye&&(document.body.classList.remove("checkerboard"),ye.destroy(),ye=null);const c=Xe[s.model];ie.domElement.style.visibility="hidden",Fe.setPercentage(0),W&&(W.traverse(d=>{if(d.material){const f=d.material;for(const k in f)f[k]&&f[k].isTexture&&f[k].dispose()}}),ge==null||ge.remove(W),W=null),await new Promise(d=>requestAnimationFrame(d));let r;try{r=await rs(c.url,d=>{Fe.setPercentage(.5*d)})}catch(d){Fe.setCredits("Failed to load model:"+d.message),Fe.setPercentage(1);return}W=r.scene??r;const g=r.animations??[];if(!W)return;c.removeEmission&&W.traverse(d=>{d.material&&(d.material.emissiveMap=null,d.material.emissiveIntensity=0)}),c.opacityToTransmission&&ns(W,c.ior||1.5),W.traverse(d=>{d.material&&(d.material.thickness=1,(d.material.envMapIntensity===void 0||d.material.envMapIntensity===0)&&(d.material.envMapIntensity=1))}),c.postProcess&&c.postProcess(W),c.rotation&&W.rotation.set(...c.rotation);const i=new bo;i.setFromObject(W),W.position.addScaledVector(i.min,-.5).addScaledVector(i.max,-.5);const p=new yo;i.getBoundingSphere(p),W.scale.setScalar(1/p.radius),W.position.multiplyScalar(1/p.radius),i.setFromObject(W),oe.position.y=i.min.y,ge.add(W),qe={},kt=null;{const d=/^productColor_([A-Za-z0-9]+?)(\d*)_([a-f0-9]{6})$/i,f=[];W.traverse(m=>{if(!m||!m.isMesh||!m.name)return;const v=m.name.match(d);if(v){const w=v[1],b=v[3];m.visible=!1,f.push({mesh:m,name:m.name,colorName:w,hexCode:b})}});const k={};f.forEach(m=>{const v=m.colorName.toLowerCase().replace(/\d+$/,"");k[v]||(k[v]={prefix:m.colorName.replace(/\d+$/,""),names:[],hexCode:m.hexCode}),k[v].names.push(m.name)}),qe=k;const $=Object.keys(qe);$.length>0&&(kt=$[0],qe[$[0]].names.forEach(m=>{const v=W.getObjectByName(m);v&&(v.visible=!0)}),console.log(`ðŸŽ¨ Product colors detected: ${$.join(", ")}. Default: ${$[0]}`))}de=as(W),console.log("ðŸ“‹ Found wallpapers:",Object.keys(de).filter(d=>de[d]!==null)),z=de.blank_screen||zn(W),z?console.log("âœ… Screen mesh found:",z.name):console.warn("âš ï¸ Screen mesh not found - upload may not work"),Te=s.screenWallpaper||"blank_screen";{W.traverse(f=>{var k;if(f.isMesh&&f.material){const $=f.name;(/^\d+_/.test($)||$==="screen_blank")&&(f.visible=!1)}f.isGroup&&((k=f.name)==null?void 0:k.toLowerCase())==="wallpaper"&&(f.visible=!1)});const d=de[Te];if(d){d.visible=!0;let f=d.parent;for(;f&&f!==W;)f.visible=!0,f=f.parent;console.log(`âœ… Initial wallpaper "${Te}" visible: ${d.name}`)}else console.warn(`âš ï¸ Initial wallpaper "${Te}" not found, all wallpapers hidden`)}if(Ie&&(Ie.stopAllAction(),Ie.uncacheRoot(W),Ie=null,We=null,rt=null),g.length>0){Ie=new wo(W);const d=["mainAnim","Animation"];let f=g.find($=>d.includes($.name))||g.find($=>$.name.toLowerCase().includes("main"))||g[0];rt=f,We=Ie.clipAction(f),We.play(),We.paused=!0;const k=Math.min(s.animationFrame/wt,f.duration||5);We.time=k,s.animationFrame=Math.round(k*wt),Ie.update(0)}await new Promise(d=>requestAnimationFrame(d)),N.updateMatrixWorld(!0);const l=await P.setSceneAsync(N,me,{onProgress:d=>Fe.setPercentage(.5+.5*d)});Qe=(l==null?void 0:l.bvh)||null,await P.compileAsync(),await new Promise(d=>requestAnimationFrame(d)),await new Promise(d=>requestAnimationFrame(d)),Fe.setPercentage(1),Fe.setCredits(c.credit||""),s.bounces=c.bounces||5,s.floorColor=c.floorColor||"#111111",s.floorRoughness=c.floorRoughness||.2,s.floorMetalness=c.floorMetalness||.2,c.floorTransmission!==void 0&&(s.floorTransmission=c.floorTransmission),c.floorIOR!==void 0&&(s.floorIOR=c.floorIOR),s.bgGradientTop=c.gradientTop||"#111111",s.bgGradientBottom=c.gradientBot||"#000000",_t(),V(),P.renderScale=.5,P.renderDelay=500,setTimeout(()=>{P.renderDelay=100,P.renderScale=s.renderScale},3e3),ie.domElement.style.visibility="visible",s.checkerboardTransparency&&document.body.classList.add("checkerboard")}async function rs(c,r){const g=new ko;if(/dae$/i.test(c)){const i=new Promise(l=>g.onLoad=l),p=await new zo(g).loadAsync(c,l=>{l.total!==0&&l.total>=l.loaded&&r(l.loaded/l.total)});return await i,p.scene.scale.setScalar(1),p.scene.traverse(l=>{const{material:d}=l;d&&d.isMeshPhongMaterial&&(l.material=new vo({color:d.color,roughness:d.roughness||0,metalness:d.metalness||0,map:d.map||null}))}),{scene:p.scene,animations:[]}}else if(/(gltf|glb)$/i.test(c)){const i=new No(g);i.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.7/");const p=new Promise(d=>g.onLoad=d),l=await new Ao(g).setDRACOLoader(i).setMeshoptDecoder(Mo).loadAsync(c,d=>{d.total!==0&&d.total>=d.loaded&&r(d.loaded/d.total)});return await p,{scene:l.scene,animations:l.animations||[]}}else if(/mpd$/i.test(c)){g.onProgress=(k,$,m)=>{r($/m)};const i=new Promise(k=>g.onLoad=k),p=new Ro(g);p.setConditionalLineMaterial(Uo),await p.preloadMaterials("https://raw.githubusercontent.com/gkjohnson/ldraw-parts-library/master/colors/ldcfgalt.ldr");const l=await p.setPartsLibraryPath("https://raw.githubusercontent.com/gkjohnson/ldraw-parts-library/master/complete/ldraw/").loadAsync(c);await i;const d=Io.mergeObject(l);d.rotation.set(Math.PI,0,0);const f=[];return d.traverse(k=>{k.isLineSegments&&f.push(k),k.isMesh&&(k.material.roughness*=.25)}),f.forEach(k=>{k.parent.remove(k)}),{scene:d,animations:[]}}}
//# sourceMappingURL=index-BZ166Oti.js.map
